<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">At-Least-Once Dead Lettering | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2022/03/29/at-least-once-dead-lettering"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="At-Least-Once Dead Lettering | RabbitMQ"><meta data-rh="true" name="description" content="Quorum queues in RabbitMQ 3.10 provide a safer form of dead lettering that uses at-least-once guarantees for the message transfer between queues."><meta data-rh="true" property="og:description" content="Quorum queues in RabbitMQ 3.10 provide a safer form of dead lettering that uses at-least-once guarantees for the message transfer between queues."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-03-29T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ansd,https://github.com/kjnilsson"><meta data-rh="true" property="article:tag" content="Resiliency,New Features"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2022/03/29/at-least-once-dead-lettering"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2022/03/29/at-least-once-dead-lettering" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2022/03/29/at-least-once-dead-lettering" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2022/03/29/at-least-once-dead-lettering","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2022/03/29/at-least-once-dead-lettering","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2022/03/29/at-least-once-dead-lettering","headline":"At-Least-Once Dead Lettering","name":"At-Least-Once Dead Lettering","description":"Quorum queues in RabbitMQ 3.10 provide a safer form of dead lettering that uses at-least-once guarantees for the message transfer between queues.","datePublished":"2022-03-29T00:00:00.000Z","author":[{"@type":"Person","name":"David Ansari","url":"https://github.com/ansd","image":"https://github.com/ansd.png"},{"@type":"Person","name":"Karl Nilsson","url":"https://github.com/kjnilsson","image":"https://github.com/kjnilsson.png"}],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">At-Least-Once Dead Lettering</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-03-29T00:00:00.000Z">March 29, 2022</time> · <!-- -->20 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/ansd.png" alt="David Ansari"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">David Ansari</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/ansd/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://m.ansd.xyz/@ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Mastodon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 61 65" width="1em" height="1em" class="authorSocialLink_owbf"><path fill="url(#:Rv7dbeh:)" d="M60.754 14.39C59.814 7.406 53.727 1.903 46.512.836 45.294.656 40.682 0 29.997 0h-.08C19.23 0 16.938.656 15.72.836 8.705 1.873 2.299 6.82.745 13.886c-.748 3.48-.828 7.338-.689 10.877.198 5.075.237 10.142.697 15.197a71.482 71.482 0 0 0 1.664 9.968c1.477 6.056 7.458 11.096 13.317 13.152a35.718 35.718 0 0 0 19.484 1.028 28.365 28.365 0 0 0 2.107-.576c1.572-.5 3.413-1.057 4.766-2.038a.154.154 0 0 0 .062-.118v-4.899a.146.146 0 0 0-.055-.111.145.145 0 0 0-.122-.028 54 54 0 0 1-12.644 1.478c-7.328 0-9.298-3.478-9.863-4.925a15.258 15.258 0 0 1-.857-3.882.142.142 0 0 1 .178-.145 52.976 52.976 0 0 0 12.437 1.477c1.007 0 2.012 0 3.02-.026 4.213-.119 8.654-.334 12.8-1.144.103-.02.206-.038.295-.065 6.539-1.255 12.762-5.196 13.394-15.176.024-.393.083-4.115.083-4.523.003-1.386.446-9.829-.065-15.017Z"></path><path fill="#fff" d="M50.394 22.237v17.35H43.52V22.749c0-3.545-1.478-5.353-4.483-5.353-3.303 0-4.958 2.139-4.958 6.364v9.217h-6.835V23.76c0-4.225-1.657-6.364-4.96-6.364-2.988 0-4.48 1.808-4.48 5.353v16.84H10.93V22.237c0-3.545.905-6.362 2.715-8.45 1.868-2.082 4.317-3.152 7.358-3.152 3.519 0 6.178 1.354 7.951 4.057l1.711 2.871 1.714-2.871c1.773-2.704 4.432-4.056 7.945-4.056 3.038 0 5.487 1.069 7.36 3.152 1.81 2.085 2.712 4.902 2.71 8.449Z"></path><defs><linearGradient id=":Rv7dbeh:" x1="30.5" x2="30.5" y1="0" y2="65" gradientUnits="userSpaceOnUse"><stop stop-color="#6364FF"></stop><stop offset="1" stop-color="#563ACC"></stop></linearGradient></defs></svg></a><a href="https://bsky.app/profile/ansd.xyz" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/kjnilsson" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/kjnilsson.png" alt="Karl Nilsson"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/kjnilsson" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Karl Nilsson</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/kjnilsson" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/kjnils/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://bsky.app/profile/kjnilsson.bsky.social" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Quorum queues in <a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.10.0" target="_blank" rel="noopener noreferrer">RabbitMQ 3.10</a> provide a safer form of dead lettering that uses at-least-once guarantees for the message transfer between queues.
This blog post explains everything you need to know to start using at-least-once dead lettering.</p>
<p>This post also introduces two other <a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.10.0" target="_blank" rel="noopener noreferrer">RabbitMQ 3.10</a> features: message Time-To-Live (TTL) for quorum queues and Prometheus metrics for dead lettered messages.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Some messages stored in RabbitMQ queues will expire or be negatively acknowledged by consumers.
Instead of silently dropping them, RabbitMQ can be configured to <a href="/rabbitmq-website/docs/dlx#overview">&quot;dead letter&quot;</a> them instead,
that is to republish those messages to a special-purpose exchange.</p>
<p>Prior to RabbitMQ 3.10 dead lettering has not been <a href="/rabbitmq-website/docs/dlx#safety">safe</a>.
Messages that get dead lettered from a queue (the &quot;source queue&quot;) are not guaranteed to be delivered to the queues routed to by the
exchange configured in the <code>dead-letter-exchange</code> policy (henceforth the &quot;target queues&quot;).</p>
<p>This is because messages are dead lettered without publisher confirms turned on internally.
We call it the &quot;at-most-once&quot; dead letter strategy.
Dead lettered messages may arrive at the target queues.
They may also get lost for a variety of reasons:</p>
<ul>
<li>The target queue is unavailable. For example, a classic queue&#x27;s host node is down or being upgraded or a quorum queue loses a majority of its nodes temporarily.</li>
<li>The target queue&#x27;s <a href="/rabbitmq-website/docs/maxlength">length limit</a> is reached while its <a href="/rabbitmq-website/docs/maxlength#overflow-behaviour">overflow behaviour</a>
is set to <code>reject-publish</code> rejecting any incoming messages.</li>
<li>A network partition prevents communication between source queue and target queue.</li>
<li>The dead letter routing topology is not configured correctly. For example, the configured <code>dead-letter-exchange</code> does not exist or no target queue is bound
to the <code>dead-letter-exchange</code>.</li>
</ul>
<p>RabbitMQ 3.10 introduces a new feature called <a href="/rabbitmq-website/docs/quorum-queues#dead-lettering">&quot;at-least-once&quot; dead lettering</a>.
It is an opt-in feature available for source queues being quorum queues.
This new feature ensures that all messages dead lettered in the source quorum queue will arrive at the target queues (classic queue, quorum queue, or stream) eventually
even in the scenarios described above where messages would have been lost with the &quot;at-most-once&quot; strategy.</p>
<p>This blog post covers instructions how to enable at-least-once dead lettering, provides a detailed example, and describes caveats and best practices of this new feature.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="usage">Usage<a href="#usage" class="hash-link" aria-label="Direct link to Usage" title="Direct link to Usage">​</a></h2>
<p>To enable <code>at-least-once</code> dead-lettering for a source quorum queue, we need to apply the following policies
(or their equivalent queue arguments starting with <code>x-</code>):</p>
<ul>
<li><code>dead-letter-strategy</code> is set to <code>at-least-once</code>. The default is <code>at-most-once</code>.</li>
<li><code>overflow</code> is set to <code>reject-publish</code>. The default is <code>drop-head</code>.</li>
<li><code>dead-letter-exchange</code> is configured.</li>
</ul>
<p>Furthermore, the <a href="/rabbitmq-website/docs/feature-flags">feature flag</a> <code>stream_queue</code> must be enabled. By default that feature flag is enabled for RabbitMQ clusters created since 3.9.
Even though streams are not used in at-least-once dead lettering (unless a target queue happens to be a stream) the <code>stream_queue</code> feature flag is required because
at-least-once dead lettering relies on some implementation details that come with that feature flag.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h2>
<p>Following this example requires <a href="https://kubernetes.io/docs/tasks/tools/#kubectl" target="_blank" rel="noopener noreferrer">kubectl</a> client to be installed and pointing against any running Kubernetes cluster v1.19 or newer.</p>
<p>If you do not have a Kubernetes cluster available, the quickest way is to install <a href="https://kubernetes.io/docs/tasks/tools/#kind" target="_blank" rel="noopener noreferrer">kind</a> to start a local Kubernetes cluster in Docker:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kind create cluster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install the <a href="https://github.com/rabbitmq/cluster-operator" target="_blank" rel="noopener noreferrer">rabbitmq/cluster-operator</a>:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Deploy a 3-node RabbitMQ cluster:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; cat &lt;&lt;EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rabbitmq.com/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: RabbitmqCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-rabbit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image: rabbitmq:3.10.0-management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once all 3 pods are ready (which takes less than 1 minute), we create a source queue and a target queue:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqadmin declare queue name=my-source-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    durable=true queue_type=quorum arguments=&#x27;{&quot;x-dead-letter-exchange&quot; : &quot;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;x-dead-letter-routing-key&quot; : &quot;my-target-queue&quot; , &quot;x-overflow&quot; : &quot;reject-publish&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqadmin declare queue name=my-target-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    durable=true queue_type=classic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The last two commands declare a queue by executing the <code>rabbitmqadmin</code> command in the RabbitMQ container of pod <code>my-rabbit-server-0</code>.</p>
<p>The <code>rabbitmqadmin</code> command is a Python script that talks against the RabbitMQ Management API.
The <code>rabbitmqadmin</code> command is not the recommended way to declare queues and to send messages.
We use it in this blog post since it is the simplest way for you to follow the examples.</p>
<p>The rabbitmq/cluster-operator creates pod names in the format <code>&lt;rabbitmq-cluster-name&gt;-server-&lt;index&gt;</code>.
In the YAML above, we defined <code>&lt;rabbitmq-cluster-name&gt;</code> to be <code>my-rabbit</code>.</p>
<p>The first command creates the source queue. For at-least-once dead lettering to work it must be of <code>queue_type=quorum</code>.
For the source queue, we define further queue arguments (starting with <code>x-</code>) encoded in JSON format:</p>
<ul>
<li><code>x-dead-letter-exchange</code> set to the empty string (<code>&quot;&quot;</code>) means that messages dead lettered by the source queue are published to the default exchange.
(While we could have created a new dead letter exchange, dead-lettering to the default exchange keeps this example simpler.)</li>
<li><code>x-dead-letter-routing-key</code> set to <code>my-target-queue</code> means that dead lettered messages will be published with routing
key <code>my-target-queue</code>. Since this routing key matches the queue name of the target queue (created by the 2nd command), dead letter messages
will be routed by the default exchange to the target queue without the need to create any further bindings.</li>
<li>As stated above <code>x-overflow</code> must be set to <code>reject-publish</code> as a prerequisite for at-least-once dead lettering.</li>
</ul>
<p>The second command creates the target queue. It can be of any queue type. In this example we choose a classic queue.
Note that compared to the source quorum queue having 3 replicas on all 3 nodes, the target classic queue is not highly available
and resides on a single node.</p>
<p>Let us publish our first message <code>msg1</code>:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqadmin publish exchange=amq.default routing_key=my-source-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload=msg1 properties=&#x27;{&quot;expiration&quot; : &quot;1000&quot;, &quot;delivery_mode&quot; : 2}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This command demonstrates another new feature of RabbitMQ 3.10: <a href="/rabbitmq-website/docs/ttl">Message TTL</a> is supported for quorum queues.
The following figure illustrates how the message flows:</p>
<ol>
<li>We publish one message to the default exchange.</li>
<li>It gets routed to the source quorum queue where it expires after 1 second (1000 milliseconds).</li>
<li>The expiration causes the message to be dead lettered to the default exchange.</li>
<li>It gets routed to the target classic queue.</li>
</ol>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 1: Dead letter routing topology (at-most-once)" src="/rabbitmq-website/assets/images/at-least-once-dead-lettering-42376b1538cf6aadc848541304dd7db1.svg" width="1134" height="473" class="img_ev3q"><figcaption>Figure 1: Dead letter routing topology (at-most-once)</figcaption></figure><p></p>
<p>Note that we set the <code>delivery_mode</code> to the integer <code>2</code> which denotes that the message is persisted.
That flag does not matter when publishing the message to the source quorum queue initially because all messages in quorum queues
are written to disk anyway. However, that persistence flag becomes important once the message will be dead lettered
to a target queue (which may not be a quorum queue).</p>
<p>We can validate that the message arrived in the target queue:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqctl list_queues --formatter=pretty_table --quiet \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name type messages messages_ready messages_unacknowledged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────┬─────────┬──────────┬────────────────┬─────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name            │ type    │ messages │ messages_ready │ messages_unacknowledged │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼─────────┼──────────┼────────────────┼─────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-target-queue │ classic │ 1        │ 1              │ 0                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼─────────┼──────────┼───────  ─────────┼─────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-source-queue │ quorum  │ 0        │ 0              │ 0                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┴─────────┴──────────┴────────────────┴─────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, let us try out what happens when the target queue becomes unavailable.
One way to determine the host node of the target classic queue is listing the queue&#x27;s process identifier (PID):</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqctl list_queues --quiet name pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name	pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my-target-queue	&lt;rabbit@my-rabbit-server-0.my-rabbit-nodes.default.1646297039.856.0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my-source-queue	&lt;rabbit@my-rabbit-server-0.my-rabbit-nodes.default.1646297039.821.0&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The PID shows that both the target classic queue process and the source quorum queue leader process
reside in pod <code>my-rabbit-server-0</code>.
Let us stop that RabbitMQ server:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqctl stop_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stopping rabbit application on node rabbit@my-rabbit-server-0.my-rabbit-nodes.default ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The source quorum queue will still be available because a majority of nodes (2 out of 3) are available and another node becomes the new leader.</p>
<p>As before we again send a message to the source queue and let it expire after 1 second.
Since the RabbitMQ node in pod <code>my-rabbit-server-0</code> is down, we execute the following commands
in <code>my-rabbit-server-1</code>:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-1 -c rabbitmq -- rabbitmqadmin publish exchange=amq.default routing_key=my-source-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload=msg2 properties=&#x27;{&quot;expiration&quot; : &quot;1000&quot;, &quot;delivery_mode&quot; : 2}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since the target queue is down, it will not report its statistics:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt;  kubectl exec my-rabbit-server-1 -c rabbitmq -- rabbitmqctl list_queues --formatter=pretty_table --quiet \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name type messages messages_ready messages_unacknowledged state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────┬──────────────────────┬──────────┬────────────────┬─────────────────────────┬─────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name            │ type                 │ messages │ messages_ready │ messages_unacknowledged │ state   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼──────────────────────┼──────  ────┼────────────────┼─────────────────────────┼─────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-target-queue │ rabbit_classic_queue │          │                │                         │ down    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼──────────────────────┼──────────┼────────────────┼─────────────────────────┼─────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-source-queue │ quorum               │ 0        │ 0              │ 0                       │ running │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┴──────────────────────┴──────────┴────────────────┴─────────────────────────┴─────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, because the target queue is down and because the source queue does not contain any messages we know that the second message
got lost while it was dead lettered!</p>
<p>Since we did not yet define <code>dead-letter-strategy</code> to be <code>at-least-once</code> when declaring the source queue above,
the source queue uses the default strategy <code>at-most-once</code>.
We can do better. In this example, we switch the dead letter strategy dynamically to <code>at-least-once</code> by applying a policy:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-1 -c rabbitmq -- rabbitmqctl set_policy --apply-to queues \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my-policy my-source-queue &#x27;{&quot;dead-letter-strategy&quot; : &quot;at-least-once&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting policy &quot;my-policy&quot; for pattern &quot;my-source-queue&quot; to &quot;{&quot;dead-letter-strategy&quot; : &quot;at-least-once&quot;}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">with priority &quot;0&quot; for vhost &quot;/&quot; ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let us send a third message:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-1 -c rabbitmq -- rabbitmqadmin publish exchange=amq.default routing_key=my-source-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload=msg3 properties=&#x27;{&quot;expiration&quot; : &quot;1000&quot;, &quot;delivery_mode&quot; : 2}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With the new <code>at-least-once</code> strategy when the 3rd message expires and gets dead lettered, it will be stored
by the source queue since the target queue is not available:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-1 -c rabbitmq -- rabbitmqctl list_queues --formatter=pretty_table --quiet \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name type messages messages_ready messages_unacknowledged state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────┬──────────────────────┬──────────┬────────────────┬─────────────────────────┬─────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name            │ type                 │ messages │ messages_ready │ messages_unacknowledged │ state   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼──────────────────────┼──────────┼────────────────┼─────────────────────────┼─────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-target-queue │ rabbit_classic_queue │          │                │                         │ down    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼──────────────────  ────┼──────────┼────────────────┼─────────────────────────┼─────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-source-queue │ quorum               │ 1        │ 0              │ 0                       │ running │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┴──────────────────────┴──────────┴────────────────┴─────────────────────────┴─────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The message is neither &quot;ready&quot; (i.e. available for normal queue consumers) nor &quot;unacknowledged&quot; (i.e. consumed by normal queue consumers but not yet acknowledged).
However, the message is kept safely in the source quorum queue in a separate data structure that is only available for consumption
by a special RabbitMQ internal dead letter consumer process.</p>
<p>Let us output the logs of that dead letter consumer process.
The dead letter consumer process is co-located on the quorum queue leader node.
We first need figure out which node became the new leader:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-1 -c rabbitmq -- rabbitmqctl list_queues --formatter=pretty_table --quiet name leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────┬───────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name            │ leader                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼───────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-target-queue │                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼───────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-source-queue │ rabbit@my-rabbit-server-1.my-rabbit-nodes.default │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────── ───────────┴───────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In our example the new leader happens to be on pod <code>my-rabbit-server-1</code>.
When you run this example, it could also be <code>my-rabbit-server-2</code> in which case you will need replace <code>1</code> with <code>2</code> in below commands.</p>
<p>The log displays a descriptive warning message:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl logs my-rabbit-server-1 -c rabbitmq | grep dead-letter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[warn] &lt;0.4156.0&gt; Cannot forward any dead-letter messages from source quorum queue &#x27;my-source-queue&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in vhost &#x27;/&#x27; with configured dead-letter-exchange exchange &#x27;&#x27; in vhost &#x27;/&#x27; and configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dead-letter-routing-key &#x27;my-target-queue&#x27;. This can happen either if the dead-letter routing topology is misconfigured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(for example no queue bound to dead-letter-exchange or wrong dead-letter-routing-key configured)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or if non-mirrored classic queues are bound whose host node is down.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fix this issue to prevent dead-lettered messages from piling up in the source quorum queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This message will not be logged again.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We fix this issue by restarting the target classic queue&#x27;s host node:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqctl start_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting node rabbit@my-rabbit-server-0.my-rabbit-nodes.default ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The internal dead letter consumer process retries to send the message periodically.
The current default retry interval is 3 minutes.
After no later than 3 minutes the 3rd message should have made it to the target queue:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqctl list_queues --formatter=pretty_table --quiet \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name type messages messages_ready messages_unacknowledged state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────┬─────────┬──────────┬────────────────┬─────────────────────────┬─────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name            │ type    │ messages │ messages_ready │ messages_unacknowledged │ state   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼─────────┼──────────┼────────────────┼─────────────────────────┼─────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-source-queue │ quorum  │ 0        │ 0              │ 0                       │ running │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────┼─────────┼──────────┼────────────────┼─────────────────────────┼─────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-target-queue │ classic │ 2        │ 2              │ 0                       │ running │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┴─────────┴──────────┴────────────────┴─────────────────────────┴─────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Our understanding is that the 1st and 3rd message are in the target queue but that the 2nd message got lost
because it used <code>at-most-once</code> dead lettering while the target queue was down:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl exec my-rabbit-server-0 -c rabbitmq -- rabbitmqadmin get queue=my-target-queue count=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------+---------------+---------+---------------+------------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   routing_key   | exchange | message_count | payload | payload_bytes | payload_encoding | redelivered |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------+---------------+---------+---------------+------------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| my-target-queue |          | 1             | msg1    | 4             | string           | False       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| my-target-queue |          | 0             | msg3    | 4             | string           | False       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------+---------------+---------+---------------+------------------+-------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>payload</code> column validates that our understanding is correct and that <code>at-least-once</code> dead lettering works as expected.
Even though the target queue was unavailable, the dead letter message made it to the target queue once it became available again.
The 1st message is still stored in the target queue because we published to the source quorum queue setting the persistence flag.
If we did not set the persistence flag, the 1st message would have been lost as well.</p>
<p>The following figure summarises the flow of the 3rd message.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 2: Dead letter routing topology (at-least-once)" src="/rabbitmq-website/assets/images/at-least-once-dead-lettering-worker-e555a518e5752708681be6117bb1b4b0.svg" width="1134" height="473" class="img_ev3q"><figcaption>Figure 2: Dead letter routing topology (at-least-once)</figcaption></figure><p></p>
<ol>
<li>The message is published to the default exchange.</li>
<li>The message is routed to the source quorum queue. A quorum queue is a replicated state machine in the Raft consensus algorithm.
A quorum queue&#x27;s state consists of more than a queue data structure where messages from publishers are enqueued:
The state also includes data about publishers, consumers as well as messages sent to (but not yet acknowledged by) consumers, and some other statistics.
<code>At-least-once</code> dead lettering adds yet another queue data structure to the quorum queue&#x27;s state: a queue that contains only dead lettered messages.
So when the message expires after 1 second it is moved from the &quot;normal&quot; message queue to the dead letter message queue.
The message remains safely stored there until it gets acknowledged by step 7.</li>
<li>There is one (RabbitMQ internal) dead letter consumer process co-located on the node of the quorum queue leader.
Its job is to consume messages from a single source quorum queue&#x27;s dead letter message queue, forward them to all target queues,
waiting until <strong>all</strong> publisher confirmations are received (step 6) and finally acknowledge the dead lettered message
back to the source quorum queue (step 7).</li>
<li>The dead letter consumer routes dead lettered messages via the configured <code>dead-letter-exchange</code>. In our example, we configured the default exchange
to be the dead letter exchange. If a route does not exist, the dead letter consumer will try to route again after some time.</li>
<li>If a route exists the message is sent to the target queue.</li>
<li>The target queue sends a publisher confirmation back to the dead letter consumer.</li>
<li>The dead letter consumer sends a consumer acknowledgement back to the source quorum queue where the dead lettered message will be deleted.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus-metrics">Prometheus metrics<a href="#prometheus-metrics" class="hash-link" aria-label="Direct link to Prometheus metrics" title="Direct link to Prometheus metrics">​</a></h3>
<p>RabbitMQ 3.10 comes with another new feature: Prometheus metrics for dead lettered messages.
Node-global counters will return the number of messages that get dead lettered broken down by the following dimensions:</p>
<ol>
<li>
<p>dead letter reason:</p>
<ul>
<li><code>expired</code>: Message TTL exceeded (as in our example).</li>
<li><code>rejected</code>: Consumer sent <code>basic.reject</code> or <code>basic.nack</code> without requeue option.</li>
<li><code>maxlen</code>: Queue length exceeded with <code>overflow</code> set to <code>drop-head</code> or <code>reject-publish-dlx</code>. (The latter setting applies only to classic queues.)</li>
<li><code>delivery_limit</code>: Delivery limit exceeded. (Applies only to quorum queues). Message got requeued too often,
for example because consumer sent <code>basic.reject</code> or <code>basic.nack</code> with requeue option or consumer got disconnected from the quorum queue leader.</li>
</ul>
</li>
<li>
<p>source queue type. i.e. queue type where messages were dead lettered <strong>from</strong>:</p>
<ul>
<li><code>rabbit_classic_queue</code></li>
<li><code>rabbit_quorum_queue</code></li>
<li>(Streams do not dead letter messages because they are append-only logs where messages get truncated according to retention policies.)</li>
</ul>
</li>
<li>
<p>dead letter strategy:</p>
<ul>
<li><code>disabled</code>: Queue has no <code>dead-letter-exchange</code> configured or configured <code>dead-letter-exchange</code> does not exist implying messages get dropped.</li>
<li><code>at_most_once</code>: Queue&#x27;s configured dead-lettered-exchange exists.</li>
<li><code>at_least_once</code>: Queue type is <code>rabbit_quorum_queue</code>, <code>dead-letter-exchange</code> is configured, <code>dead-letter-strategy</code> is set to <code>at-least-once</code>, <code>overflow</code> is set to <code>reject-publish</code>.</li>
</ul>
</li>
</ol>
<p>Following our example let us output these metrics.
In a shell window port-forward RabbitMQ&#x27;s Prometheus port <code>15692</code>:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl port-forward pod/my-rabbit-server-1 15692</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In another shell window scrape the Prometheus endpoint:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; curl --silent localhost:15692/metrics/ | grep rabbitmq_global_messages_dead_lettered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE rabbitmq_global_messages_dead_lettered_confirmed_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP rabbitmq_global_messages_dead_lettered_confirmed_total Total number of messages dead-lettered and confirmed by target queues</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_confirmed_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_least_once&quot;} 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE rabbitmq_global_messages_dead_lettered_delivery_limit_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP rabbitmq_global_messages_dead_lettered_delivery_limit_total Total number of messages dead-lettered due to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># delivery-limit exceeded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_delivery_limit_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_least_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_delivery_limit_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_delivery_limit_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;disabled&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE rabbitmq_global_messages_dead_lettered_expired_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP rabbitmq_global_messages_dead_lettered_expired_total Total number of messages dead-lettered due to message TTL exceeded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_expired_total{queue_type=&quot;rabbit_classic_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_expired_total{queue_type=&quot;rabbit_classic_queue&quot;,dead_letter_strategy=&quot;disabled&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_expired_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_least_once&quot;} 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_expired_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_expired_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;disabled&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE rabbitmq_global_messages_dead_lettered_maxlen_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP rabbitmq_global_messages_dead_lettered_maxlen_total Total number of messages dead-lettered due to overflow drop-head</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># or reject-publish-dlx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_maxlen_total{queue_type=&quot;rabbit_classic_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_maxlen_total{queue_type=&quot;rabbit_classic_queue&quot;,dead_letter_strategy=&quot;disabled&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_maxlen_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_maxlen_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;disabled&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE rabbitmq_global_messages_dead_lettered_rejected_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP rabbitmq_global_messages_dead_lettered_rejected_total Total number of messages dead-lettered due to basic.reject or basic.nack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_rejected_total{queue_type=&quot;rabbit_classic_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_rejected_total{queue_type=&quot;rabbit_classic_queue&quot;,dead_letter_strategy=&quot;disabled&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_rejected_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_least_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_rejected_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_rejected_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;disabled&quot;} 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We scraped only the Prometheus metrics of pod <code>my-rabbit-server-1</code>.
Since these counters are &quot;node-global&quot;, it means above list shows only the metrics as observed by node <code>my-rabbit-server-1</code> (but global
across all queues on that node).</p>
<p>The very 1st message we sent went to pod <code>my-rabbit-server-0</code> before we stopped that node.
Thereafter the quorum queue leader changed in our example from <code>my-rabbit-server-0</code> to <code>my-rabbit-server-1</code>.
We then sent the 2nd message using the <code>at-most-once</code> dead letter strategy and the 3rd message using the <code>at-least-once</code> dead letter strategy.
The 3rd message that got dead lettered was eventually acknowledged by the dead letter consumer (or in other words, confirmed by the target queues).
This is why the following counters have the value <code>1</code>:</p>
<div class="language-zsh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-zsh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_confirmed_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_least_once&quot;} 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_expired_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_least_once&quot;} 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_expired_total{queue_type=&quot;rabbit_quorum_queue&quot;,dead_letter_strategy=&quot;at_most_once&quot;} 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you are curious you can scrape the Prometheus metrics for pod <code>my-rabbit-server-0</code>.
What would you expect to see? Does the output match your expectations?
Hint: &quot;A Prometheus counter is a cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart.&quot;</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="caveats">Caveats<a href="#caveats" class="hash-link" aria-label="Direct link to Caveats" title="Direct link to Caveats">​</a></h2>
<p>We saw how messages being dead lettered make it from the dead letter source queue to the dead letter target queue eventually even when the target queue is temporarily unavailable.
So why is at-least-once dead lettering not the new default dead letter strategy?</p>
<p>There are some caveats to be aware of when enabling at-least-once dead lettering:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="caveat-1---message-buildup-in-the-source-quorum-queue">Caveat 1 - Message buildup in the source quorum queue<a href="#caveat-1---message-buildup-in-the-source-quorum-queue" class="hash-link" aria-label="Direct link to Caveat 1 - Message buildup in the source quorum queue" title="Direct link to Caveat 1 - Message buildup in the source quorum queue">​</a></h3>
<p>At-least-once dead lettering does a great job ensuring messages are not lost when target queues are temporarily unavailable or when the routing topology is not configured correctly.
However, if the dead letter consumer process does not obtain publisher confirmations from <strong>all</strong> target queues for a long time while more and more messages keep getting dead lettered
in the source queue, it can cause excessive message buildup in the source queue.
In the worst case, the source quorum queue will contain only of dead lettered messages.
To prevent excessive message buildup, set a <a href="/rabbitmq-website/docs/maxlength">queue length limit</a> for the source queue (<code>max-length</code> or <code>max-length-bytes</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="caveat-2---dead-letter-throughput">Caveat 2 - Dead letter throughput<a href="#caveat-2---dead-letter-throughput" class="hash-link" aria-label="Direct link to Caveat 2 - Dead letter throughput" title="Direct link to Caveat 2 - Dead letter throughput">​</a></h3>
<p>The dead letter consumer has a configurable setting called <code>dead_letter_worker_consumer_prefetch</code> whose current default value is set to <code>32</code>.
This means that the dead letter consumer process will prefetch and buffer at most 32 messages while waiting for publisher confirmations from target queues.</p>
<p>Since RabbitMQ 3.10 quorum queues store all message bodies / payloads always on disk.
There is still a very small per message memory overhead for each message in the quorum queue because the quorum queue holds some metadata for each message in memory (for example the Raft index and
the message payload size).</p>
<p>The dead letter consumer process on the other hand keeps message bodies in memory.
To protect against the worst case where hundreds of quorum queues have at-least-once dead lettering enabled and publisher confirmations are not received, this prefetch value is set
to a moderate default value of <code>32</code> to not cause high memory usage by the dead letter consumers.</p>
<p>A low prefetch value however will cause lower throughput.
If you have a scenario where sustained dead lettering throughput of thousands of messages per second is required (for example thousands of messages expire or are getting rejected every second)
you can increase the prefetch setting in the advanced config file.</p>
<p>Here is an example how to increase the prefetch in Kubernetes:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rabbitmq.com/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RabbitmqCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rabbit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rabbitmq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">advancedConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      [</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          {rabbit, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              {dead_letter_worker_consumer_prefetch, 512}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          ]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ].</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="caveat-3---increased-resource-usage">Caveat 3 - Increased resource usage<a href="#caveat-3---increased-resource-usage" class="hash-link" aria-label="Direct link to Caveat 3 - Increased resource usage" title="Direct link to Caveat 3 - Increased resource usage">​</a></h3>
<p>Enabling at-least-once dead lettering for every quorum queue will increase resource usage.
More memory and more CPU will be consumed.
Comparing figure 1 (at-most-once dead lettering) with figure 2 (at-least-once dead lettering), we observe that at-least-once dead lettering will require
sending more messages (including acknowledgements).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="caveat-4---overflow-drop-head">Caveat 4 - Overflow drop-head<a href="#caveat-4---overflow-drop-head" class="hash-link" aria-label="Direct link to Caveat 4 - Overflow drop-head" title="Direct link to Caveat 4 - Overflow drop-head">​</a></h3>
<p>As explained in the <a href="#usage">Usage</a> section, enabling <code>at-least-once</code> dead lettering requires setting <code>overflow</code> to <code>reject-publish</code>.
Setting <code>overflow</code> to <code>drop-head</code> will make dead letter strategy fall back to <code>at-most-once</code>.
<code>drop-head</code> is not supported because dropping dead lettered messages from the source quorum queue would violate <code>at-least-once</code> semantics.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="caveat-5---switching-dead-letter-strategy">Caveat 5 - Switching dead letter strategy<a href="#caveat-5---switching-dead-letter-strategy" class="hash-link" aria-label="Direct link to Caveat 5 - Switching dead letter strategy" title="Direct link to Caveat 5 - Switching dead letter strategy">​</a></h3>
<p>For a quorum queue, it is possible to switch the dead-letter strategy via a policy from <code>at-most-once</code>
to <code>at-least-once</code> and vice versa. If the dead-letter strategy is changed either directly
from <code>at-least-once</code> to <code>at-most-once</code> or indirectly, for example by changing overflow from <code>reject-publish</code>
to <code>drop-head</code> or by unsetting <code>dead-letter-exchange</code>, any dead-lettered messages that have not yet been confirmed by all target queues will be permanently deleted
in the source quorum queue.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices">​</a></h2>
<p>Based on what we have learnt above, at-least-once dead lettering best practices include:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="best-practice-1">Best Practice 1<a href="#best-practice-1" class="hash-link" aria-label="Direct link to Best Practice 1" title="Direct link to Best Practice 1">​</a></h3>
<p>Set <code>max-length</code> or <code>max-length-bytes</code> in the source quorum queue to guard against excessive message buildup.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="best-practice-2">Best Practice 2<a href="#best-practice-2" class="hash-link" aria-label="Direct link to Best Practice 2" title="Direct link to Best Practice 2">​</a></h3>
<p>Bind a target quorum queue or stream to the dead letter exchange.
This provides higher availability than a target classic queue.
Redelivery of dead letter messages will also be faster for target quorum queues or target streams than for target classic queues.
This is because quorum queues and streams have their own clients, delivery protocols and retry mechanisms.
Remember that classic mirrored queues are deprecated.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="best-practice-3">Best Practice 3<a href="#best-practice-3" class="hash-link" aria-label="Direct link to Best Practice 3" title="Direct link to Best Practice 3">​</a></h3>
<p>Set the persistence flag on all messages published to the source quorum queue.
If the persistence flag is not set, dead lettered messages will not have it set either.
This becomes relevant when dead lettered messages are routed to a target classic queue.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrapping-up">Wrapping Up<a href="#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping Up" title="Direct link to Wrapping Up">​</a></h2>
<p>Prior to RabbitMQ 3.10 dead lettering in RabbitMQ has not been safe.
Messages being dead lettered could get lost for a variety of reasons - especially in multi-node RabbitMQ clusters.</p>
<p>At-least-once dead lettering ensures dead lettered messages arrive at the target queue eventually even in the presence of rolling upgrades and
temporary failures such as network partitions or routing topology misconfigurations.</p>
<p>Besides at-least-once dead lettering for quorum queues, we also learnt about two other new features in RabbitMQ 3.10:
Message TTL in quorum queues and Prometheus metrics for dead letter messages.</p>
<p>Since at-least-once dead lettering comes with increased resource usage, it should only be enabled if dead lettered messages are not &quot;dead&quot; in the
original sense but rather &quot;alive&quot; and crucial for your business logic.
If in your use case dead lettered messages are only of informational nature, at-most-once dead lettering should be used.</p>
<p>The at-least-once dead lettering feature for quorum queues paves the way for new use cases where you know that you
have messages that might be negatively acknowledged but still needs to be processed or where you cannot lose messages with an expiring TTL.
Such scenarios were previously unsafe or hard to achieve with RabbitMQ.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/resiliency">Resiliency</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/new-features">New Features</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2022-03-29-at-least-once-dead-lettering/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2022/04/26/centos-7-support-discontinued"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">CentOS 7 Support is Discontinued from May, 2022</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2022/03/24/rabbitmq-3.10.0-release-calendar"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">RabbitMQ 3.10.0 release calendar</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a><ul><li><a href="#prometheus-metrics" class="table-of-contents__link toc-highlight">Prometheus metrics</a></li></ul></li><li><a href="#caveats" class="table-of-contents__link toc-highlight">Caveats</a><ul><li><a href="#caveat-1---message-buildup-in-the-source-quorum-queue" class="table-of-contents__link toc-highlight">Caveat 1 - Message buildup in the source quorum queue</a></li><li><a href="#caveat-2---dead-letter-throughput" class="table-of-contents__link toc-highlight">Caveat 2 - Dead letter throughput</a></li><li><a href="#caveat-3---increased-resource-usage" class="table-of-contents__link toc-highlight">Caveat 3 - Increased resource usage</a></li><li><a href="#caveat-4---overflow-drop-head" class="table-of-contents__link toc-highlight">Caveat 4 - Overflow drop-head</a></li><li><a href="#caveat-5---switching-dead-letter-strategy" class="table-of-contents__link toc-highlight">Caveat 5 - Switching dead letter strategy</a></li></ul></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a><ul><li><a href="#best-practice-1" class="table-of-contents__link toc-highlight">Best Practice 1</a></li><li><a href="#best-practice-2" class="table-of-contents__link toc-highlight">Best Practice 2</a></li><li><a href="#best-practice-3" class="table-of-contents__link toc-highlight">Best Practice 3</a></li></ul></li><li><a href="#wrapping-up" class="table-of-contents__link toc-highlight">Wrapping Up</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
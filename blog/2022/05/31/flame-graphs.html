<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Improving RabbitMQ Performance with Flame Graphs | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2022/05/31/flame-graphs"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Improving RabbitMQ Performance with Flame Graphs | RabbitMQ"><meta data-rh="true" name="description" content="Recent Erlang/OTP versions ship with Linux perf support."><meta data-rh="true" property="og:description" content="Recent Erlang/OTP versions ship with Linux perf support."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-05-31T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ansd"><meta data-rh="true" property="article:tag" content="Performance"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2022/05/31/flame-graphs"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2022/05/31/flame-graphs" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2022/05/31/flame-graphs" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2022/05/31/flame-graphs","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2022/05/31/flame-graphs","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2022/05/31/flame-graphs","headline":"Improving RabbitMQ Performance with Flame Graphs","name":"Improving RabbitMQ Performance with Flame Graphs","description":"Recent Erlang/OTP versions ship with Linux perf support.","datePublished":"2022-05-31T00:00:00.000Z","author":{"@type":"Person","name":"David Ansari","url":"https://github.com/ansd","image":"https://github.com/ansd.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">Improving RabbitMQ Performance with Flame Graphs</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-05-31T00:00:00.000Z">May 31, 2022</time> · <!-- -->16 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/ansd.png" alt="David Ansari"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">David Ansari</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/ansd/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://m.ansd.xyz/@ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Mastodon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 61 65" width="1em" height="1em" class="authorSocialLink_owbf"><path fill="url(#:Rfndbeh:)" d="M60.754 14.39C59.814 7.406 53.727 1.903 46.512.836 45.294.656 40.682 0 29.997 0h-.08C19.23 0 16.938.656 15.72.836 8.705 1.873 2.299 6.82.745 13.886c-.748 3.48-.828 7.338-.689 10.877.198 5.075.237 10.142.697 15.197a71.482 71.482 0 0 0 1.664 9.968c1.477 6.056 7.458 11.096 13.317 13.152a35.718 35.718 0 0 0 19.484 1.028 28.365 28.365 0 0 0 2.107-.576c1.572-.5 3.413-1.057 4.766-2.038a.154.154 0 0 0 .062-.118v-4.899a.146.146 0 0 0-.055-.111.145.145 0 0 0-.122-.028 54 54 0 0 1-12.644 1.478c-7.328 0-9.298-3.478-9.863-4.925a15.258 15.258 0 0 1-.857-3.882.142.142 0 0 1 .178-.145 52.976 52.976 0 0 0 12.437 1.477c1.007 0 2.012 0 3.02-.026 4.213-.119 8.654-.334 12.8-1.144.103-.02.206-.038.295-.065 6.539-1.255 12.762-5.196 13.394-15.176.024-.393.083-4.115.083-4.523.003-1.386.446-9.829-.065-15.017Z"></path><path fill="#fff" d="M50.394 22.237v17.35H43.52V22.749c0-3.545-1.478-5.353-4.483-5.353-3.303 0-4.958 2.139-4.958 6.364v9.217h-6.835V23.76c0-4.225-1.657-6.364-4.96-6.364-2.988 0-4.48 1.808-4.48 5.353v16.84H10.93V22.237c0-3.545.905-6.362 2.715-8.45 1.868-2.082 4.317-3.152 7.358-3.152 3.519 0 6.178 1.354 7.951 4.057l1.711 2.871 1.714-2.871c1.773-2.704 4.432-4.056 7.945-4.056 3.038 0 5.487 1.069 7.36 3.152 1.81 2.085 2.712 4.902 2.71 8.449Z"></path><defs><linearGradient id=":Rfndbeh:" x1="30.5" x2="30.5" y1="0" y2="65" gradientUnits="userSpaceOnUse"><stop stop-color="#6364FF"></stop><stop offset="1" stop-color="#563ACC"></stop></linearGradient></defs></svg></a><a href="https://bsky.app/profile/ansd.xyz" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Recent Erlang/OTP versions ship with <a href="https://perf.wiki.kernel.org/index.php/Main_Page" target="_blank" rel="noopener noreferrer">Linux perf</a> support.
This blog post provides step by step instructions on how you can create CPU and memory <a href="https://www.brendangregg.com/flamegraphs.html" target="_blank" rel="noopener noreferrer">flame graphs</a> in RabbitMQ to quickly and accurately detect performance bottlenecks.
We also provide examples of how flame graphs have helped us to increase message throughput in RabbitMQ.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Prior to Erlang/OTP 24, many tools including
<a href="https://www.erlang.org/doc/man/fprof.html" target="_blank" rel="noopener noreferrer">fprof</a>,
<a href="https://www.erlang.org/doc/man/eprof.html" target="_blank" rel="noopener noreferrer">eprof</a>, and
<a href="https://www.erlang.org/doc/man/cprof.html" target="_blank" rel="noopener noreferrer">cprof</a>
have been available to <a href="https://www.erlang.org/doc/efficiency_guide/profiling.html" target="_blank" rel="noopener noreferrer">profile Erlang code</a>.
However, none of these tools can generate call graphs with minimal overhead.</p>
<p>Erlang/OTP 24 introduces the <a href="https://www.erlang.org/blog/my-otp-24-highlights/#beamasm---the-jit-compiler-for-erlang" target="_blank" rel="noopener noreferrer">just-in-time (JIT) compiler</a>.
Instead of interpreting code, the JIT compiler produces machine code.
That machine code can be instrumented by native tooling.
Specifically, Erlang/OTP 24 ships with Linux perf support.
Perf can profile machine code and generate call graphs with low overhead since profiling takes place within the Linux kernel.</p>
<p>This is a big feature in Erlang/OTP 24 because it allows any Erlang program to efficiently and precisely detect bottlenecks in its source code.</p>
<p>Once a program was profiled and its call graphs generated, these stack traces can then be visualized and analysed by a variety of tools.
The most popular tool is flame graphs.
Flame graphs were invented by <a href="https://www.brendangregg.com" target="_blank" rel="noopener noreferrer">Brendan Gregg</a> in 2011.</p>
<p>While it was possible to create flame graphs for profiled Erlang code many years ago, what is new is that these flame graphs can now be
created with accurate call stack reporting without a noticeable slowdown of the Erlang program.</p>
<p>In this blog post, we demonstrate how to create CPU and memory flame graphs, explain how to interpret them, and show how they have helped us improving RabbitMQ performance.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cpu-flame-graphs">CPU Flame Graphs<a href="#cpu-flame-graphs" class="hash-link" aria-label="Direct link to CPU Flame Graphs" title="Direct link to CPU Flame Graphs">​</a></h2>
<p>In order to profile RabbitMQ with Linux perf, we need to run RabbitMQ on a Linux operating system.
(The commands in this blog post were run on Ubuntu 22.04 LTS.)</p>
<p>A physical Linux box is best because more hardware counters will be present.
However, a Linux virtual machine (VM) is good enough to start with.
Keep in mind that a VM can come with some limitations.
For example, the <a href="https://man7.org/linux/man-pages/man2/fdatasync.2.html" target="_blank" rel="noopener noreferrer">fsync</a> system call which is heavily used
in RabbitMQ might be a no-op in certain virtualised environments.</p>
<p>Execute the following steps to create our first flame graph:</p>
<ol>
<li>Install Erlang/OTP 25.0 (which includes <a href="https://github.com/erlang/otp/pull/4676" target="_blank" rel="noopener noreferrer">supports frame pointers in JIT</a>).
Here, we use <a href="https://github.com/kerl/kerl" target="_blank" rel="noopener noreferrer">kerl</a>:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kerl build </span><span class="token number" style="color:#36acaa">25.0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kerl </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25.0</span><span class="token plain"> ~/kerl/25.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> ~/kerl/25.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Install Elixir. Here, we use <a href="https://github.com/taylor/kiex" target="_blank" rel="noopener noreferrer">kiex</a>:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kiex </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.12</span><span class="token plain">.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kiex use </span><span class="token number" style="color:#36acaa">1.12</span><span class="token plain">.3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>Clone RabbitMQ server:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:rabbitmq/rabbitmq-server.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> rabbitmq-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> checkout v3.10.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> fetch-deps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">/deps/seshat checkout 68f2b9d4ae7ea730cef613fd5dc4456e462da492</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>Since we are going to stress test RabbitMQ and we do not want RabbitMQ to artificially slow down our performance tests
by protecting itself against overload, we increase the memory threshold to not hit <a href="/rabbitmq-website/docs/memory">memory alarms</a>,
and increase credit <a href="/rabbitmq-website/docs/flow-control">flow control</a> settings by a factor of 4 compared to their default settings.
You can also try out setting <code>credit_flow_default_credit</code> to <code>{0, 0}</code> which disables credit based flow control altogether.
Create the following <a href="/rabbitmq-website/docs/configure#advanced-config-file">advanced.config</a> file:</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {rabbit,[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {vm_memory_high_watermark, {absolute, 15_000_000_000}},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {credit_flow_default_credit, {1600, 800}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">].</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="5">
<li>Start RabbitMQ server. We do not enable any RabbitMQ plugins (since plugins can have a negative impact on performance, especially
some plugins that query statistics in scenarios with many thousand objects such as queues, exchanges, channels, etc).
We set Erlang emulator flags <code>+JPperf true</code> to enable support for Linux perf and
<code>+S 4</code> to create 4 scheduler threads.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> run-broker </span><span class="token assign-left variable" style="color:#36acaa">PLUGINS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;+JPperf true +S 4&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_CONFIG_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;advanced.config&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">TEST_TMPDIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;test-rabbit&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="6">
<li>In a 2nd shell window, start <a href="https://rabbitmq.github.io/rabbitmq-perf-test/stable/htmlsingle/" target="_blank" rel="noopener noreferrer">RabbitMQ PerfTest</a>.
In our example PerfTest creates one producer publishing with at most 2,000 unconfirmed messages in flight to a stream called <code>my-stream</code> for 60 seconds.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Install PerfTest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-O</span><span class="token plain"> perf-test https://github.com/rabbitmq/rabbitmq-perf-test/releases/download/v2.17.0/perf-test_linux_x86_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x perf-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Start PerfTest client generating load against RabbitMQ server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./perf-test </span><span class="token parameter variable" style="color:#36acaa">--queue</span><span class="token plain"> my-stream --queue-args x-queue-type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">stream --auto-delete </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--flag</span><span class="token plain"> persistent </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token parameter variable" style="color:#36acaa">--producers</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--confirm</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--consumers</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--time</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="7">
<li>While PerfTest is running, in a 3rd shell window, record a profile which samples CPU stack traces of the RabbitMQ server process (<code>--pid</code>)
at 999 hertz (<code>--freq</code>) recording call-graph for both kernel space and user space (<code>-g</code>) for 30 seconds.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Install perf, e.g. on Ubuntu:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># sudo apt-get install linux-tools-common linux-tools-generic linux-tools-`uname -r`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> perf record </span><span class="token parameter variable" style="color:#36acaa">--pid</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">cat</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;test-rabbit/rabbit@</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">hostname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable parameter variable" style="color:#36acaa">--short</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">/rabbit@</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">hostname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable parameter variable" style="color:#36acaa">--short</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">.pid&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--freq</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">999</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-g</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="8">
<li>Once the 60 seconds PerfTest run finishes in the 2nd shell window, check the results.
On this machine, we get a sending rate average of ~103,000 messages per second.
This result can be slower or faster on your machine.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">test</span><span class="token plain"> stopped </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Reached </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-114336-500, sending rate avg: </span><span class="token number" style="color:#36acaa">103132</span><span class="token plain"> msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-114336-500, receiving rate avg: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> msg/s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="9">
<li>The previous perf command outputs a file <code>perf.data</code>.
Create a CPU flame graph from this data as described in the Erlang <a href="https://www.erlang.org/doc/apps/erts/beamasm#flame-graph" target="_blank" rel="noopener noreferrer">documentation</a>:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:brendangregg/FlameGraph.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Convert perf.data (created by perf record) to trace output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> perf script </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> out.perf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Collapse multiline stacks into single lines</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./FlameGraph/stackcollapse-perf.pl out.perf </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> out.folded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Merge scheduler profile data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s/^[0-9]\+_//&#x27;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s/^erts_\([^_]\+\)_[0-9]\+/erts_\1/&#x27;</span><span class="token plain"> out.folded </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> out.folded_sched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create the SVG file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./FlameGraph/flamegraph.pl </span><span class="token parameter variable" style="color:#36acaa">--title</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CPU Flame Graph&quot;</span><span class="token plain"> out.folded_sched </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cpu.svg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Opening the resulting <code>cpu.svg</code> file in your browser should show you a CPU flame graph similar to the following:</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 1: CPU Flame Graph - RabbitMQ v3.10.1 - 1 producer publishing to a stream" src="/rabbitmq-website/assets/images/flame-graph-cpu-3-10-1-7081734c39c08e0b917624dcb99cc8de.png" width="2090" height="1032" class="img_ev3q"><figcaption>Figure 1: CPU Flame Graph - RabbitMQ v3.10.1 - 1 producer publishing to a stream</figcaption></figure><p></p>
<p>If you did not run above steps, click <a href="/rabbitmq-website/assets/files/flame-graph-cpu-3-10-1-3474d23063731ef758c9e90248b6f0de.svg" target="_blank">here</a> to open Figure 1 as SVG file in your browser.</p>
<p>A CPU flame graph is interpreted as follow:</p>
<ul>
<li>Each box is a stack frame.</li>
<li>The SVG is interactive. Try to click on a stack frame to zoom into a particular call graph.
On the top left of the SVG click on <code>Reset Zoom</code> to go back.</li>
<li>Colours (yellow, orange, red) have no meaning.</li>
<li>The height represents how deep the call stacks are. High &quot;towers&quot; can represent recursive function calls.
Most of the time it is perfectly okay to have a certain level of recursion.
In above SVG click on a stack frame in the highest tower (on the left half of the graph) and you will see that
a function called <code>lists:foldr_1/3</code> causes this recursion.</li>
<li>The horizontal order of stack frames on the same level is alphabetically ordered.
Hence, the horizontal order does not represent time.</li>
<li>The most important characteristic to watch out for is the width of the boxes.
The width determines how often a function was on CPU.
In particular, look for wide stack frames at the top of the graph because they consume
directly a lot of CPU cycles!</li>
<li>All Erlang functions are prefixed by the dollar sign (<code>$</code>).</li>
<li>At the top right of the flame graph, you can click on the grey <code>Search</code> icon.
If you enter the regular expression <code>^\$</code> into the search box (meaning &quot;match everything starting with the dollar sign&quot;), all Erlang functions will be highlighted in purple.</li>
</ul>
<p>Unsurprisingly, the hardest part is to optimize performance based on the insights a flame graph provides.
In general, two strategies have proven to be successful:</p>
<ol>
<li>Run a workload which you know is problematic for RabbitMQ.
For example, if RabbitMQ runs slow, or eats a lot of memory for a particular client workload, run that client workload (e.g. with PerfTest),
record RabbitMQ server&#x27;s profile with Linux perf, and create a flame graph. Chances are high that the flame graph will present the bottleneck.</li>
<li>Try to optimize performance exploratively. This is what we are going to do in this blog post.</li>
</ol>
<p>We started PerfTest where one publisher sends messages to a stream without being aware of any performance issues.
Clicking on some stack frames and examining what functions consume CPU time, it is astonishing that function <code>rabbit_exchange:route/2</code> spends 9.5% on the CPU.
Search for that function in above SVG to highlight it purple, then click on the purple box to zoom in (or click <a href="/rabbitmq-website/assets/files/flame-graph-cpu-3-10-1-3474d23063731ef758c9e90248b6f0de.svg" target="_blank">here</a>).
It will show you the following image:</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 2: CPU Flame Graph - RabbitMQ v3.10.1 - zoomed into function rabbit_exchange/2" src="/rabbitmq-website/assets/images/flame-graph-cpu-3-10-1-rabbit-exchange-route-eaeb01067751811d958a8319153a486b.png" width="1791" height="599" class="img_ev3q"><figcaption>Figure 2: CPU Flame Graph - RabbitMQ v3.10.1 - zoomed into function rabbit_exchange/2</figcaption></figure><p></p>
<p>Execute the following command in a shell to list RabbitMQ bindings:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./sbin/rabbitmqctl list_bindings </span><span class="token parameter variable" style="color:#36acaa">--formatter</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pretty_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listing bindings </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> vhost /</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────┬─────────────┬──────────────────┬──────────────────┬──────────────────────────────────────┬───────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ source_name │ source_kind │ destination_name │ destination_kind │ routing_key                          │ arguments │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────┼─────────────┼──────────────────┼──────────────────┼──────────────────────────────────────┼───────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│             │ exchange    │ my-stream        │ queue            │ my-stream                            │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────┼─────────────┼──────────────────┼──────────────────┼ ──────────────────────────────────────┼───────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ direct      │ exchange    │ my-stream        │ queue            │ f809d879-b5ad-4159-819b-b39d6b50656a │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────┴─────────────┴──────────────────┴──────────────────┴──────────────────────────────────────┴───────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>PerfTest client created a stream (queue) <code>my-stream</code>.
The first binding shows that every queue is automatically bound to the default exchange (the exchange with the empty string <code>&quot;&quot;</code>).
PerfTest also created a direct exchange called <code>direct</code> and bound the stream to this exchange with some random routing key.</p>
<p>Although there are merely 2 bindings (routes), RabbitMQ spends a lot of CPU time (9.5%) in function <code>rabbit_exchange:route/2</code> - a function routing messages -
and it spends 6.69% of CPU time in function <a href="https://www.erlang.org/doc/man/ets.html#select-2" target="_blank" rel="noopener noreferrer">ets<!-- -->:select<!-- -->/2</a>.</p>
<p>We also see in the function stack trace a wide box <code>db_match_compile</code> meaning the same <a href="https://www.erlang.org/doc/apps/erts/match_spec.html" target="_blank" rel="noopener noreferrer">match specification</a>
gets compiled for every message being routed.</p>
<p>Pull Request (PR) <a href="https://github.com/rabbitmq/rabbitmq-server/pull/4606" target="_blank" rel="noopener noreferrer">#4606</a> follows
the <a href="https://www.erlang.org/doc/efficiency_guide/tablesdatabases" target="_blank" rel="noopener noreferrer">Tables and Databases efficiency guide</a>:</p>
<blockquote>
<p>An Ets table is a single-key table (either a hash table or a tree ordered by the key) and is to be used as one. In other words, use the key to look up things whenever possible.</p>
</blockquote>
<p>This PR adds an Mnesia index table whose table key is the Erlang tuple <code>{SourceExchange, RoutingKey}</code> so that routing destinations will be looked up by that key.</p>
<p>In our example, this means instead of calling <code>ets:select/2</code> which uses an expensive match specification, the routing destination <code>my-stream</code> is looked up
using <a href="https://www.erlang.org/doc/man/ets.html#lookup_element-3" target="_blank" rel="noopener noreferrer">ets<!-- -->:loookup_element<!-- -->/3</a> by providing the table key <code>{direct, f809d879-b5ad-4159-819b-b39d6b50656a}</code>.</p>
<p>Stop RabbitMQ server with <code>Ctrl+g q</code> and delete its data directory:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-rf</span><span class="token plain"> test-rabbit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let us check out a commit from the <code>master</code> branch (in May 2022 at the time of writing) which includes PR #4606:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> checkout c22e1cb20e656d211e025c417d1fc75a9067b717</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Re-run the same scenario by repeating steps 5 - 9 above.</p>
<p>Open the new CPU flame graph and search for stack frame <code>rabbit_exchange:route/2</code> (or click <a href="/rabbitmq-website/assets/files/flame-graph-cpu-c22e1cb-bd2aec9a1c47e1cf4297ba45e7ba2c8c.svg" target="_blank">here</a>):</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 3: reduced CPU usage in rabbit_exchange/2 on RabbitMQ master branch (May 2022)" src="/rabbitmq-website/assets/images/flame-graph-cpu-c22e1cb-5ceca3dd313768deea2775bfd5e6d539.png" width="2086" height="1043" class="img_ev3q"><figcaption>Figure 3: reduced CPU usage in rabbit_exchange/2 on RabbitMQ master branch (May 2022)</figcaption></figure><p></p>
<p>With the new optimisation CPU usage for that function dropped from 9.5% down to only 2.5%.</p>
<p>As a result of this optimisation PerfTest outputs a sending rate average of ~129,000 messages per second.
Compared to ~103,000 messages before this change this is a sending throughput improvement of 26,000 messages per second or 25% for a single publisher.
This speed-up applies to publishers sending via AMQP 0.9.1, AMQP 1.0, STOMP, and MQTT via a direct exchange.</p>
<p>As described in the PR, the end-to-end (from client to RabbitMQ server) sending throughput improvement is lower (20,000 messages per second or 15%) when sending to a classic or quorum queue (since they store messages slower than a stream)
and the throughput improvement is higher (90,000 messages per second or 35%) when there are many bindings because after this change routing table lookup happens via a table key in constant time.</p>
<p>To sum up, in this section we created a CPU flame graph for a usual RabbitMQ workload.
A CPU flame graph shows precisely what functions require CPU usage: the wider the boxes the more CPU time is required.
Just by exploring the stack frames we were able to detect routing to be a bottleneck.
Being aware of this bottleneck we could subsequently speed up routing via the direct exchange type and therefore sending throughput by 15% - 35%.</p>
<p>Further examples of reducing CPU usage in RabbitMQ by analysing CPU flame graphs can be found in PRs
<a href="https://github.com/rabbitmq/rabbitmq-server/pull/4787" target="_blank" rel="noopener noreferrer">#4787</a>,
<a href="https://github.com/rabbitmq/rabbitmq-server/pull/3934" target="_blank" rel="noopener noreferrer">#3934</a>, and
<a href="https://github.com/rabbitmq/ra/pull/272" target="_blank" rel="noopener noreferrer">rabbitmq/ra #272</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-flame-graphs">Memory Flame Graphs<a href="#memory-flame-graphs" class="hash-link" aria-label="Direct link to Memory Flame Graphs" title="Direct link to Memory Flame Graphs">​</a></h2>
<p>Flame graphs visualize hierarchical data.
In the previous section this data represented code paths consuming CPU time.
This section is about data representing code paths causing memory usage.</p>
<p>Brendan Gregg suggests different tracing approaches to analyze memory usage:</p>
<ol>
<li>Allocators such as the <a href="https://man7.org/linux/man-pages/man3/malloc.3.html" target="_blank" rel="noopener noreferrer">malloc()</a> library function.
The glibc&#x27;s <code>malloc()</code> implementation requests memory using system calls <a href="https://man7.org/linux/man-pages/man2/brk.2.html" target="_blank" rel="noopener noreferrer">brk()</a> and <a href="https://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="noopener noreferrer">mmap()</a>.</li>
<li><code>brk()</code> system call typically indicating memory growth.</li>
<li><code>mmap()</code> system call used by glibc for larger allocations. <code>mmap()</code> creates a new mapping in the virtual address space.
Unless subsequently freed using <code>munmap()</code>, a <code>mmap()</code> flame graph may detect functions that grow or leak memory.</li>
<li>Page faults indicating physical memory usage.</li>
</ol>
<p>Not all Erlang memory allocations can be traced by one of these approaches.
For example, memory that is already preallocated by the Erlang VM (at boot time) cannot be traced.
Also, to reduce the number of system calls, some memory segments allocated via <code>mmap()</code> are <a href="https://www.erlang.org/doc/man/erts_alloc.html#allocators" target="_blank" rel="noopener noreferrer">cached</a> before being destroyed.
Newly allocated segments are served from that cache and can therefore not be traced with Linux perf.</p>
<p>In this section we create a <code>mmap()</code> flame graph (approach 3).</p>
<p>Stop RabbitMQ server, delete its data directory, checkout tag <code>v3.10.1</code>, and start RabbitMQ server as done
in step 5 in the previous section.</p>
<p>In the 2nd shell window, start PerfTest with 1 publisher sending messages to a stream for 4 minutes:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./perf-test </span><span class="token parameter variable" style="color:#36acaa">--queue</span><span class="token plain"> my-stream --queue-args x-queue-type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">stream --auto-delete </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--flag</span><span class="token plain"> persistent </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token parameter variable" style="color:#36acaa">--producers</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--consumers</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--time</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">240</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the 4 minutes we see that PerfTest client published more than 32 million messages.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./sbin/rabbitmqctl list_queues name </span><span class="token builtin class-name">type</span><span class="token plain"> messages </span><span class="token parameter variable" style="color:#36acaa">--formatter</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pretty_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Timeout: </span><span class="token number" style="color:#36acaa">60.0</span><span class="token plain"> seconds </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listing queues </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> vhost / </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────┬────────┬──────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name      │ </span><span class="token builtin class-name">type</span><span class="token plain">   │ messages │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────┼────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ my-stream │ stream │ </span><span class="token number" style="color:#36acaa">32748214</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────┴────────┴──────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Start 4 consumers each consuming these messages for 90 seconds.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./perf-test </span><span class="token parameter variable" style="color:#36acaa">--queue</span><span class="token plain"> my-stream --queue-args x-queue-type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">stream --auto-delete </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--flag</span><span class="token plain"> persistent </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token parameter variable" style="color:#36acaa">--producers</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--consumers</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--qos</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"> --multi-ack-every </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> -consumer-args x-stream-offset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">first </span><span class="token parameter variable" style="color:#36acaa">--time</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">90</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>While PerfTest is running, in the 3rd shell window, record a profile which traces <code>mmap()</code> system calls:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> perf record </span><span class="token parameter variable" style="color:#36acaa">--pid</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">cat</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;test-rabbit/rabbit@</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">hostname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable parameter variable" style="color:#36acaa">--short</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">/rabbit@</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">hostname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable parameter variable" style="color:#36acaa">--short</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">.pid&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token parameter variable" style="color:#36acaa">--event</span><span class="token plain"> syscalls:sys_enter_mmap </span><span class="token parameter variable" style="color:#36acaa">-g</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After 90 seconds PerfTest outputs a receiving rate average of ~287,000 messages per second.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">test</span><span class="token plain"> stopped </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Reached </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-102129-000, sending rate avg: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-102129-000, receiving rate avg: </span><span class="token number" style="color:#36acaa">287086</span><span class="token plain"> msg/s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The previous Linux perf command writes file <code>perf.data</code>.
Create a <code>mmap()</code> flame graph:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> perf script </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> out.perf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Collapse multiline stacks into single lines</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./FlameGraph/stackcollapse-perf.pl out.perf </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> out.folded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Merge scheduler profile data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s/^[0-9]\+_//&#x27;</span><span class="token plain"> out.folded </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> out.folded_sched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create the SVG file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./FlameGraph/flamegraph.pl </span><span class="token parameter variable" style="color:#36acaa">--title</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;mmap() Flame Graph&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--color</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mem </span><span class="token parameter variable" style="color:#36acaa">--countname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;calls&quot;</span><span class="token plain"> out.folded_sched </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mmap.svg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Opening the resulting <code>mmap.svg</code> file in your browser and searching for <code>amqp10_binary_parser</code> should show you a <code>mmap()</code> flame graph similar to the following:</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 4: mmap() Flame Graph - RabbitMQ v3.10.1 - 4 consumers reading from a stream" src="/rabbitmq-website/assets/images/flame-graph-mmap-3-10-1-47cd120c3ccb3d0785b0448ad1a30006.png" width="1792" height="1137" class="img_ev3q"><figcaption>Figure 4: mmap() Flame Graph - RabbitMQ v3.10.1 - 4 consumers reading from a stream</figcaption></figure><p></p>
<p>If you did not run above steps, click <a href="/rabbitmq-website/assets/files/flame-graph-mmap-3-10-1-62f7cbbb9fb85a6089b30777e8c24645.svg" target="_blank">here</a> to open Figure 4 as SVG file in your browser.</p>
<p>As in CPU flame graphs, except for the purple color highlighting search matches, colors (green, blue) have no meaning in memory flame graphs.</p>
<p>The flame graph reveals that 10.1% of all <code>mmap()</code> system calls happen in module <code>amqp10_binary_parser</code>.
PR <a href="https://github.com/rabbitmq/rabbitmq-server/pull/4811" target="_blank" rel="noopener noreferrer">#4811</a> optimises the code in that module by following the
<a href="https://www.erlang.org/doc/efficiency_guide/binaryhandling.html" target="_blank" rel="noopener noreferrer">Matching Binaries efficiency guide</a>, that is by reusing match contexts instead of creating new sub-binaries.</p>
<p>Stop RabbitMQ server. Without deleting its data directory, checkout tag <code>v3.10.2</code> which includes PR #4811.
Repeat the previous steps by starting RabbitMQ server and consuming from the stream with 4 consumers while recording <code>mmap()</code> system calls with Linux perf.</p>
<p>When PerfTest finishes after 90 seconds, this time it outputs a receiving rate average of ~407,000 messages per second.
Compared to the 287,000 messages in v3.10.1 this is a receiving throughput improvement of ~120,000 messages per second or ~42%.</p>
<p>Create again a <code>mmap()</code> flame graph as done before and search for <code>amqp10_binary_parser</code>.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 5: mmap() Flame Graph - RabbitMQ v3.10.2 - 4 consumers reading from a stream" src="/rabbitmq-website/assets/images/flame-graph-mmap-3-10-2-67eb83beefab9b0742de8871a2b136a7.png" width="1791" height="1147" class="img_ev3q"><figcaption>Figure 5: mmap() Flame Graph - RabbitMQ v3.10.2 - 4 consumers reading from a stream</figcaption></figure><p></p>
<p>If you did not run above steps, click <a href="/rabbitmq-website/assets/files/flame-graph-mmap-3-10-2-dbb0035a959ef7ae53e80c91fabfef18.svg" target="_blank">here</a> to open Figure 5 as SVG file in your browser.</p>
<p>The binary matching optimisations decreased <code>mmap()</code> system calls of module <code>amqp10_binary_parser</code> from 10.1% in v3.10.1 to 1.3% in v3.10.2.</p>
<p>To sum up, in this section we created a <code>mmap()</code> memory flame graph for a usual RabbitMQ workload.
A <code>mmap()</code> flame graph shows precisely what functions cause <code>mmap()</code> system calls: the wider the boxes the more <code>mmap()</code> system calls they trigger.
Just by exploring the stack frames, we were able to detect AMQP 1.0 binary parsing to be a bottleneck.
Being aware of this bottleneck we could subsequently speed up AMQP 1.0 binary parsing and therefore receiving throughput from a stream via AMQP 0.9.1 by ~42%.</p>
<p>Another example of reducing <code>mmap()</code> system calls in RabbitMQ by exploring <code>mmap()</code> flame graphs can be found in PR <a href="https://github.com/rabbitmq/rabbitmq-server/pull/4801" target="_blank" rel="noopener noreferrer">#4801</a>.</p>
<p>Creating a page fault flame graph (approach 4) works the same way as creating a <code>mmap()</code> flame graph (approach 3).
The only difference is to replace Linux perf flag <code>--event syscalls:sys_enter_mmap</code> with <code>--event page-faults</code>.
An example of how a page fault flame graph helped improve RabbitMQ performance can be found in PR <a href="https://github.com/rabbitmq/rabbitmq-server/pull/4110" target="_blank" rel="noopener noreferrer">#4110</a> where less physical
memory is consumed by a new queue implementation maintaining its own queue length.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrapping-up">Wrapping Up<a href="#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping Up" title="Direct link to Wrapping Up">​</a></h2>
<p>Since Erlang/OTP 25 we can efficiently and precisely detect stack traces in RabbitMQ that consume a lot of CPU or memory by using Linux perf and creating flame graphs.
Once the bottlenecks are identified, we can optimise code paths and therefore improve RabbitMQ performance.</p>
<p>Different client workload will cause different CPU and memory usage patterns of RabbitMQ server.
Whether you experience RabbitMQ to run slow, suspect RabbitMQ to leak memory, or just want to speed up RabbitMQ, we encourage you to create flame graphs
to pin down performance bottlenecks.</p>
<p>As opposed to one-off profiling a single RabbitMQ node as done in this blog post, we are also experimenting with continuous profiling across multiple nodes in a RabbitMQ cluster.
In the future, a potential way to continuously profile RabbitMQ in production is deploying RabbitMQ on Kubernetes using the <a href="https://github.com/rabbitmq/cluster-operator" target="_blank" rel="noopener noreferrer">rabbitmq/cluster-operator</a>
while profiling with <a href="https://github.com/parca-dev/parca-agent" target="_blank" rel="noopener noreferrer">Parca Agent</a>.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/performance">Performance</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2022-05-31-flame-graphs/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2022/07/05/rabbitmq-3-11-feature-preview-single-active-consumer-for-streams"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">RabbitMQ 3.11 Feature Preview: Single Active Consumer for Streams</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2022/05/16/rabbitmq-3.10-performance-improvements"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">RabbitMQ 3.10 Performance Improvements</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#cpu-flame-graphs" class="table-of-contents__link toc-highlight">CPU Flame Graphs</a></li><li><a href="#memory-flame-graphs" class="table-of-contents__link toc-highlight">Memory Flame Graphs</a></li><li><a href="#wrapping-up" class="table-of-contents__link toc-highlight">Wrapping Up</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Deploying RabbitMQ to Kubernetes: What&#x27;s Involved? | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Deploying RabbitMQ to Kubernetes: What&#x27;s Involved? | RabbitMQ"><meta data-rh="true" name="description" content="Over time, we have seen the number of Kubernetes-related queries on our community"><meta data-rh="true" property="og:description" content="Over time, we have seen the number of Kubernetes-related queries on our community"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-08-10T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/michaelklishin"><meta data-rh="true" property="article:tag" content="Introductory,Kubernetes,Cloud,DIY"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved","headline":"Deploying RabbitMQ to Kubernetes: What's Involved?","name":"Deploying RabbitMQ to Kubernetes: What's Involved?","description":"Over time, we have seen the number of Kubernetes-related queries on our community","datePublished":"2020-08-10T00:00:00.000Z","author":{"@type":"Person","name":"Michael Klishin","url":"https://github.com/michaelklishin","image":"https://github.com/michaelklishin.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">Deploying RabbitMQ to Kubernetes: What&#x27;s Involved?</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-08-10T00:00:00.000Z">August 10, 2020</time> · <!-- -->22 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/michaelklishin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/michaelklishin.png" alt="Michael Klishin"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/michaelklishin" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Michael Klishin</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/michaelklishin" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/michaelklishin/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://bsky.app/profile/michaelklishin.bsky.social" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Over time, we have seen the number of Kubernetes-related queries on our community
<a href="https://groups.google.com/forum/#!forum/rabbitmq-users" target="_blank" rel="noopener noreferrer">mailing list</a>
and <a href="https://rabbitmq-slack.herokuapp.com/" target="_blank" rel="noopener noreferrer">Slack</a> channels soar.</p>
<p>In 2024, the answer to most Kubernetes-related question is: <a href="/rabbitmq-website/kubernetes/operator/operator-overview">use the Kubernetes Operator</a> built by the RabbitMQ Core Team.
It incorporates all the best practices and is the strongly recommended option.</p>
<p>This post explains the basics
of a DIY deployment of RabbitMQ on Kubernetes: what Kubernetes resources will be necessary, how to make sure
RabbitMQ nodes use durable storage, how to approach configuration of sensitive values, and so on.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="an-update-from-2024">An Update from 2024<a href="#an-update-from-2024" class="hash-link" aria-label="Direct link to An Update from 2024" title="Direct link to An Update from 2024">​</a></h2>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Instead of rolling your own deployment of RabbitMQ to Kubernetes, consider <a href="/rabbitmq-website/kubernetes/operator/operator-overview">using the Kubernetes Operator</a>
built by the RabbitMQ Core Team. It incorporates all the best practices and is the strongly recommended option.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Deploying a stateful data service such as RabbitMQ to Kubernetes without <a href="/rabbitmq-website/kubernetes/operator/operator-overview">using the Kubernetes Operator</a>
is a bit like assembling a jigsaw puzzle.</p>
<p>There are multiple pieces involved:</p>
<ul>
<li>A <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer">Kubernetes namespace</a></li>
<li>A <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener noreferrer">stateful set</a> for RabbitMQ cluter nodes</li>
<li>Ensuring durable storage is used by <a href="/rabbitmq-website/docs/relocate">node data directories</a></li>
<li>A Kubernetes Secret for <a href="/rabbitmq-website/docs/access-control#default-state">initial RabbitMQ user credentials</a></li>
<li>A Kubernetes Secret for <a href="/rabbitmq-website/docs/clustering#erlang-cookie">inter-node and CLI tool authentication</a></li>
<li>A <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" target="_blank" rel="noopener noreferrer">headless service</a> for inter-node communication</li>
<li>Permissions for RabbitMQ node data directory and configuration file(s)</li>
<li>Node <a href="/rabbitmq-website/docs/configure#configuration-files">configuration files</a></li>
<li><a href="/rabbitmq-website/docs/plugins#enabled-plugins-file">Pre-enabled plugin file</a></li>
<li><a href="/rabbitmq-website/docs/cluster-formation">Peer discovery</a> settings</li>
<li>Kubernetes <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener noreferrer">access control (RBAC)</a> rules</li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes" target="_blank" rel="noopener noreferrer">Liveness and readiness</a> probes</li>
<li>A <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" target="_blank" rel="noopener noreferrer">load balancer service</a> for external client connections</li>
<li>Resource limits (CPU, memory, disk, network bandwidth)</li>
</ul>
<p>In this post, we will try to cover the key parts as well as mention a couple
more steps that are not technically required to run RabbitMQ on Kubernetes, but every
production system operator will have to worry about sooner rather than later:</p>
<ul>
<li>How to set up cluster monitoring with Prometheus and Grafana</li>
<li>How to deploy a PerfTest instance to do basic functional and load testing of the cluster</li>
</ul>
<p>This post by no means covers every aspect that may be relevant when deploying
RabbitMQ to Kubernetes; our goal is to highlight the most important parts.
Deployment- and workload-specific decisions such as what <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/" target="_blank" rel="noopener noreferrer">resource limits</a> to apply
to RabbitMQ node pod (containers), <a href="/rabbitmq-website/blog/2020/06/21/cluster-sizing-case-study-quorum-queues-part-1">what kind of durable storage</a> to use,
how to approach TLS certificate/key pair rotation, log aggregation, and upgrades are great topics
for separate blog posts. Let us know what you&#x27;d like to see in a follow-up!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="executable-examples">Executable Examples<a href="#executable-examples" class="hash-link" aria-label="Direct link to Executable Examples" title="Direct link to Executable Examples">​</a></h2>
<p>The files that accompany this post can be found in the <a href="https://github.com/rabbitmq/diy-kubernetes-examples" target="_blank" rel="noopener noreferrer">DIY RabbitMQ on Kubernetes example repository</a>.
This post uses a Google Kubernetes Engine (GKE) cluster but Kubernetes concepts are universal.</p>
<p>To follow along the examples,</p>
<ul>
<li>Access to a Kubernetes Cluster</li>
<li>The <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer"><code>kubectl</code> CLI tool</a></li>
</ul>
<p>This post assumes that the reader is familiar with <a href="https://kubernetes.io/docs/reference/kubectl/overview/" target="_blank" rel="noopener noreferrer"><code>kubectl</code> usage basics</a>
and the tool is <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl" target="_blank" rel="noopener noreferrer">set up to work with a GKE cluster</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-docker-image">RabbitMQ Docker Image<a href="#rabbitmq-docker-image" class="hash-link" aria-label="Direct link to RabbitMQ Docker Image" title="Direct link to RabbitMQ Docker Image">​</a></h2>
<p>We recommend using the <a href="https://hub.docker.com/_/rabbitmq" target="_blank" rel="noopener noreferrer">community RabbitMQ Docker image</a>.
The image is maintained by the <a href="https://github.com/docker-library/rabbitmq" target="_blank" rel="noopener noreferrer">Docker Community</a> and is built with the latest versions of RabbitMQ,
Erlang and OpenSSL. The image has a variant built with RabbitMQ release candidates for early testing and adoption.</p>
<p>Now let&#x27;s begin with the first building block of a RabbitMQ cluster running on Kubernetes:
picking a namespace to deploy to.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-namespace-and-permissions-rbac">Kubernetes Namespace and Permissions (RBAC)<a href="#kubernetes-namespace-and-permissions-rbac" class="hash-link" aria-label="Direct link to Kubernetes Namespace and Permissions (RBAC)" title="Direct link to Kubernetes Namespace and Permissions (RBAC)">​</a></h2>
<p>Every set of Kubernetes objects belongs to a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer">Kubernetes Namespace</a>.
RabbitMQ cluster resources are no exception.</p>
<p>We recommend using a dedicated Namespace to keep the RabbitMQ cluster separate from other services that may be deployed
in the Kubernetes cluster.
Having a dedicated namespace makes logical sense and makes it easy to <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener noreferrer">grant just enough permissions</a> to the cluster nodes. This is a good
security practice.</p>
<p>RabbitMQ&#x27;s Kubernetes peer discovery plugin relies on the Kubernetes API as a data source.
On first boot, every node
will try to discover their peers using the Kubernetes API and attempt to join them.
Nodes that finish booting emit a <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-application-introspection/" target="_blank" rel="noopener noreferrer">Kubernetes event</a> to make it easier to discover such events in cluster activity (event) logs.</p>
<p>The plugin requires the following access to Kubernetes resources:</p>
<ul>
<li><code>get</code> access to the <code>endpoints</code> resource</li>
<li><code>create</code> access to the <code>events</code> resource</li>
</ul>
<p>Specify a <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener noreferrer">Role, Role Binding and a Service Account</a>
to configure this access.</p>
<p>An example namespace, along with RBAC rules can be seen in the <a href="https://github.com/rabbitmq/diy-kubernetes-examples/blob/master/gke/rbac.yaml" target="_blank" rel="noopener noreferrer">rbac.yaml example file</a>.</p>
<p>If following from the example, use the following command to create a namespace and the required RBAC rules.
Note that this creates a namespace called <code>test-rabbitmq</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> namespace.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> rbac.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>kubectl</code>  examples below will use the <code>test-rabbitmq</code> namespace. This namespace can be set to be the default
one for convenience:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># set the namespace to be the current (default) one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-context </span><span class="token parameter variable" style="color:#36acaa">--current</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">test-rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># verify</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config view </span><span class="token parameter variable" style="color:#36acaa">--minify</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> namespace:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Alternatively, <code>--namespace=&quot;test-rabbitmq&quot;</code> can be appended to all <code>kubectl</code> commands
demonstrated below.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-a-stateful-set">Use a Stateful Set<a href="#use-a-stateful-set" class="hash-link" aria-label="Direct link to Use a Stateful Set" title="Direct link to Use a Stateful Set">​</a></h2>
<p>RabbitMQ <strong>requires</strong> using a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener noreferrer">Stateful Set</a> to deploy a RabbitMQ cluster to Kubernetes.
The Stateful Set ensures that the RabbitMQ nodes are deployed in order, one at a time. This avoids running
into a potential <a href="/rabbitmq-website/docs/cluster-formation#initial-formation-race-condition">peer discovery race condition</a> when deploying a multi-node RabbitMQ cluster.</p>
<p>There are other, equally important reasons for using a Stateful Set instead of a Deployment:
sticky identity, simple network identifiers, stable persistent storage and the ability to perform
ordered rolling upgrades.</p>
<p>The Stateful Set definition file is packed with detail such as mounting configuration, mounting credentials, opening ports, etc,
which is explained topic-wise in the following sections.</p>
<p>The final Stateful Set file can be found in the <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yaml" target="_blank" rel="noopener noreferrer">under <code>gke</code> directory</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-service-for-clustering-and-cli-tools">Create a Service For Clustering and CLI Tools<a href="#create-a-service-for-clustering-and-cli-tools" class="hash-link" aria-label="Direct link to Create a Service For Clustering and CLI Tools" title="Direct link to Create a Service For Clustering and CLI Tools">​</a></h2>
<p>The Stateful Set definition can reference a Service which gives the Pods of the Stateful Set their network identity.
Here, we are referring to the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#statefulsetspec-v1-apps" target="_blank" rel="noopener noreferrer"><code>v1.StatefulSet.Spec.serviceName</code> property</a>.</p>
<p>This is required by RabbitMQ for clustering, and as mentioned in the Kubernetes documentation, has to be created before the Stateful Set.</p>
<p>RabbitMQ uses port 4369 for port 4369 for node discovery and port 25672 for inter-node communication.
Since this Service is used internally and does not need to be exposed,
we create a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" target="_blank" rel="noopener noreferrer">Headless Service</a>.
It can be found in the <a href="https://github.com/rabbitmq/diy-kubernetes-examples/blob/master/gke/headless-service.yaml" target="_blank" rel="noopener noreferrer">example headless-service.yaml file</a>.</p>
<p>If following from the example, run the following to create a Headless Service for inter-node
and CLI tool traffic:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> rabbitmq-headless.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The service now can be observed in the <code>test-rabbitmq</code> namespace:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; NAME                        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; service/rabbitmq-headless   ClusterIP   None         &lt;none&gt;        4369/TCP   7s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-a-persistent-volume-for-node-data">Use a Persistent Volume for Node Data<a href="#use-a-persistent-volume-for-node-data" class="hash-link" aria-label="Direct link to Use a Persistent Volume for Node Data" title="Direct link to Use a Persistent Volume for Node Data">​</a></h2>
<p>In order for RabbitMQ nodes to retain data between Pod restarts, node&#x27;s data directory must use durable storage.
A <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener noreferrer">Persistent Volume</a> must be attached to each RabbitMQ Pod.</p>
<p>If a transient volume is used to back a RabbitMQ node, the node will lose its identity and all of its
local data in case of a restart.
This includes both <a href="/rabbitmq-website/docs/clustering#cluster-membership">schema</a> and <a href="/rabbitmq-website/docs/queues#durability">durable queue data</a>.
Syncing all of this data on every node restart would be highly inefficient. In case
of a loss of <a href="/rabbitmq-website/docs/quorum-queues#what-is-quorum">quorum</a> during
a rolling restart, this will also lead to data loss.</p>
<p>In our <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yaml#L12-L22" target="_blank" rel="noopener noreferrer">statefulset.yaml example</a>,
we create a Persistent Volume Claim to provision a Persistent Volume.</p>
<p>The Persistent Volume is mounted at <code>/var/lib/rabbitmq/mnesia</code>. This path is used for a <a href="/rabbitmq-website/docs/relocate"><code>RABBITMQ_MNESIA_BASE</code> location</a>: the base directory
for all persistent data of a node.</p>
<p>A description of <a href="/rabbitmq-website/docs/relocate">default file paths for RabbitMQ</a> can be found in the RabbitMQ documentation.</p>
<p>Node&#x27;s data directory base can be changed using the <code>RABBITMQ_MNESIA_BASE</code> variable if needed. Make sure
to mount a Persistent Volume at the updated path.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="node-authentication-secret-the-erlang-cookie">Node Authentication Secret: the Erlang Cookie<a href="#node-authentication-secret-the-erlang-cookie" class="hash-link" aria-label="Direct link to Node Authentication Secret: the Erlang Cookie" title="Direct link to Node Authentication Secret: the Erlang Cookie">​</a></h2>
<p>RabbitMQ nodes and CLI tools use a shared secret known as <a href="/rabbitmq-website/docs/clustering#erlang-cookie">the Erlang Cookie</a>, to authenticate to each other.
The cookie value is a string of alphanumeric characters up to 255 characters in size. The value must be generated before creating
a RabbitMQ cluster since it is needed by the nodes to <a href="https://github.com/rabbitmq/diy-kubernetes-examples/blob/gke-examples/examples/gke/statefulset.yaml#L72-L75" target="_blank" rel="noopener noreferrer">form a cluster</a>.</p>
<p>With the community Docker image, RabbitMQ nodes will expect the cookie to be at <code>/var/lib/rabbitmq/.erlang.cookie</code>.
We recommend creating a Secret and mounting it as a Volume on the Pods at this path.</p>
<p>This is demonstrated in the <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yaml#L101-L105" target="_blank" rel="noopener noreferrer">statefulset.yaml example</a> file.</p>
<p>The secret is expected to have the following key/value pair:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">cookie</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To create a cookie Secret, run</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;this secret value is JUST AN EXAMPLE. Replace it!&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cookie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret generic erlang-cookie --from-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">./cookie</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will create a Secret with a single key, <code>cookie</code>, taken from the file name,
and the file contents as its value.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="administrator-credentials">Administrator Credentials<a href="#administrator-credentials" class="hash-link" aria-label="Direct link to Administrator Credentials" title="Direct link to Administrator Credentials">​</a></h2>
<p>RabbitMQ will seed a <a href="/rabbitmq-website/docs/access-control#default-state">default user</a> with well-known credentials on first boot.
The username and password of this user are both <code>guest</code>.</p>
<p>This default user can <a href="/rabbitmq-website/docs/access-control#loopback-users">only connect from localhost</a> by default.
It is possible to lift this restriction by opting in. This may be useful for testing but <strong>very insecure</strong>.
Instead, an administrative user must be created using generated credentials.</p>
<p>The administrative user credentials should be stored in a <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer">Kubernetes Secret</a>,
and mounting them onto the RabbitMQ Pods.
The <code>RABBITMQ_DEFAULT_USER</code> and <code>RABBITMQ_DEFAULT_PASS</code> environment variables then can be set to the Secret values.
The community Docker image will use them to <a href="/rabbitmq-website/docs/access-control#seeding">override default user credentials</a>.</p>
<p><a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yaml#L91-L100" target="_blank" rel="noopener noreferrer">Example for reference</a>.</p>
<p>The secret is expected to have the following key/value pair:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">username</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To create an administrative user Secret, use</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># this is merely an example, you are welcome to use a different username</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;administrator&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># this is merely an example, you MUST use a different, generated password value!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;g3N3rAtED-Pa</span><span class="token string variable" style="color:#36acaa">$$</span><span class="token string" style="color:#e3116c">w0rd&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret generic rabbitmq-admin --from-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">./user --from-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">./pass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will create a Secret with two keys, <code>user</code> and <code>pass</code>, taken from the file names,
and file contents as their respective values.</p>
<p>Users can be create explicitly using CLI tools as well.
See <a href="/rabbitmq-website/docs/access-control#seeding">RabbitMQ doc section on user management</a> to learn more.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="node-configuration">Node Configuration<a href="#node-configuration" class="hash-link" aria-label="Direct link to Node Configuration" title="Direct link to Node Configuration">​</a></h2>
<p>There are <a href="/rabbitmq-website/docs/configure">several ways</a> to configure a RabbitMQ node. The recommended way is to use configuration files.</p>
<p>Configuration files can be expressed as <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">Config Maps</a>,
and mounted as a Volume onto the RabbitMQ pods.</p>
<p>To create a Config Map with RabbitMQ configuration, apply our <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/configmap.yaml" target="_blank" rel="noopener noreferrer">minimal configmap.yaml example</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> configmap.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-an-init-container">Use an Init Container<a href="#use-an-init-container" class="hash-link" aria-label="Direct link to Use an Init Container" title="Direct link to Use an Init Container">​</a></h3>
<p>Since Kubernetes 1.9.4, Config Maps are mounted as read-only volumes onto Pods. This is problematic for the RabbitMQ community Docker image:
the image can try to update the config file at the time of container startup.</p>
<p>Thus, the path at which the RabbitMQ config is mounted must be read-write. If a read-only file is detected by the Docker image,
you&#x27;ll see the following warning:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">touch: cannot touch &#x27;/etc/rabbitmq/rabbitmq.conf&#x27;: Permission denied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: &#x27;/etc/rabbitmq/rabbitmq.conf&#x27; is not writable, but environment variables have been provided which request that we write to it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  We have copied it to &#x27;/tmp/rabbitmq.conf&#x27; so it can be amended to work around the problem, but it is recommended that the read-only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source file should be modified and the environment variables removed instead.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>While the Docker image does work around the issue, it is not ideal to store the configuration file in <code>/tmp</code> and we recommend instead
making the mount path read-write.</p>
<p>As a few other projects in the Kubernetes community, we use an <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener noreferrer">init container</a> to overcome this.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/rabbitmq/diy-kubernetes-examples/blob/master/examples/minikube/configmap.yaml" target="_blank" rel="noopener noreferrer">The Config Map</a></li>
<li><a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yml#L30-L64" target="_blank" rel="noopener noreferrer">Using an Init Container to mount the Config Map</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="run-the-pod-as-the-rabbitmq-user">Run The Pod As the <code>rabbitmq</code> User<a href="#run-the-pod-as-the-rabbitmq-user" class="hash-link" aria-label="Direct link to run-the-pod-as-the-rabbitmq-user" title="Direct link to run-the-pod-as-the-rabbitmq-user">​</a></h3>
<p>The Docker image <a href="https://github.com/docker-library/rabbitmq/blob/38bc089c287d05d22b03a4d619f7ad9d9a4501bc/3.8/ubuntu/Dockerfile#L186-L187%5D(https://github.com/docker-library/rabbitmq/blob/38bc089c287d05d22b03a4d619f7ad9d9a4501bc/3.8/ubuntu/Dockerfile#L186-L187)" target="_blank" rel="noopener noreferrer">runs as the <code>rabbitmq</code> user with uid 999</a> and writes to the <code>rabbitmq.conf</code> file.
Thus, the file permissions on <code>rabbitmq.conf</code> must allow this. A <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/" target="_blank" rel="noopener noreferrer">Pod Security Context</a> can be
added to the Stateful Set definition to achieve this.
Set the <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yaml#L66-L75" target="_blank" rel="noopener noreferrer"><code>runAsUser</code>, <code>runAsGroup</code> and the <code>fsGroup</code></a> to 999 in the Security Context.</p>
<p>See <a href="https://github.com/rabbitmq/diy-kubernetes-examples/blob/gke-examples/examples/gke/statefulset.yaml#L72-L75" target="_blank" rel="noopener noreferrer">Security Context</a>
in the Stateful Set definition file.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="importing-definitions">Importing Definitions<a href="#importing-definitions" class="hash-link" aria-label="Direct link to Importing Definitions" title="Direct link to Importing Definitions">​</a></h3>
<p>RabbitMQ nodes can <a href="/rabbitmq-website/docs/definitions">importi definitions</a> exported from another RabbitMQ cluster.
This may also be done at <a href="/rabbitmq-website/docs/definitions#import-on-boot">node boot time</a>.</p>
<p>Following from the RabbitMQ documentation, this can be done using the following steps:</p>
<ol>
<li>Export definitions from the RabbitMQ cluster you wish to replicate and save the file</li>
<li>Create a Config Map with the key being the file name, and the value being the contents of the file (See the <code>rabbitmq.conf</code> Config Map example)</li>
<li>Mount the Config Map as a Volume on the RabbitMQ Pod in the Stateful Set definition</li>
<li>Update the <code>rabbitmq.conf</code> Config Map with <code>load_definitions = /path/to/definitions/file</code></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="readiness-probe">Readiness Probe<a href="#readiness-probe" class="hash-link" aria-label="Direct link to Readiness Probe" title="Direct link to Readiness Probe">​</a></h2>
<p>Kubernetes uses a check known as the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener noreferrer">readiness probe</a> to determine if a pod is ready to serve client traffic.
This is effectively a specialized <a href="/rabbitmq-website/docs/monitoring#health-checks">health check</a> defined
by the system operator.</p>
<p>When an <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#pod-management-policies" target="_blank" rel="noopener noreferrer">ordered pod deployment policy</a> is used — and this is the commended option for RabbitMQ clusters —
the probe controls when the Kubernetes controller will consider the currently deployed pod to be ready
and proceed to deploy the next one. This check, if not chosen appropriately, can deadlock a rolling
cluster node restart.</p>
<p>RabbitMQ nodes that belong to a clsuter will <a href="/rabbitmq-website/docs/clustering#restarting-schema-sync">attempt to sync schema from their peers on startup</a>. If no peer comes online within a configurable time window (five minutes by default),
the node will give up and voluntarily stop. Before the sync is complete, the node won&#x27;t mark itself as fully booted.</p>
<p>Therefore, if a readiness probe assumes that a node is fully booted and running,
<strong>a rolling restart of RabbitMQ node pods using such probe will deadlock</strong>: the probe will never succeed,
and will never proceed to deploy the next pod, which must come online for the original pod to be considered
ready by the deployment.</p>
<p>It is therefore recommended to use a very basic RabbitMQ health check for readiness probe:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics </span><span class="token function" style="color:#d73a49">ping</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>While this check is not thorough, it allows all pods to be started and re-join the cluster within a certain time period,
even when pods are restarted one by one, in order.</p>
<p>This is covered in a dedicated section of the RabbitMQ clustering guide: <a href="/rabbitmq-website/docs/clustering#restarting-readiness-probes">Restarts and Health Checks (Readiness Probes)</a>.</p>
<p>The <a href="https://github.com/rabbitmq/diy-kubernetes-examples/blob/master/examples/gke/statefulset.yaml#L132-L143" target="_blank" rel="noopener noreferrer">readiness probe section</a>
in the Stateful Set definition file demonstrates how to configure a readiness probe.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="liveness-probe">Liveness Probe<a href="#liveness-probe" class="hash-link" aria-label="Direct link to Liveness Probe" title="Direct link to Liveness Probe">​</a></h2>
<p>Similarly to the readiness probe described above, Kubernetes allows for pod health checks using a different health check
called the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener noreferrer">liveness probe</a>.
The check determines if a pod must be restarted.</p>
<p>As with all <a href="/rabbitmq-website/docs/monitoring#health-checks">health checks</a>, there is no single solution that can be
recommended for all deployments. Health checks can produce false positives, which means reasonably healthy, operational nodes
will be restarted or even destroyed and re-created for no reason, reducing system availability.</p>
<p>Moreover, a RabbitMQ node restart won&#x27;t necessarily address the issue. For example, restarting a node
that is in an <a href="/rabbitmq-website/docs/alarms">alarmed state</a> because it is low on available disk space won&#x27;t help.</p>
<p>All this is to say that <strong>liveness probes must be chosen wisely</strong> and with false positives and &quot;recoverability by a restart&quot;
taken into account. Liveness probes also must <a href="/rabbitmq-website/docs/monitoring#health-checks">use node-local health checks instead of cluster-wide ones</a>.</p>
<p>RabbitMQ CLI tools provide a number of <a href="/rabbitmq-website/docs/monitoring#health-checks">pre-defined health checks</a> that
vary in how thorough they are, how intrusive they are and how likely they are to produce false positives in different
scenarios, e.g. when the system is under load. The checks are composable and can be combined.
The right liveness probe choice is a system-specific decision. When in doubt, start with a simpler, less intrusive
and less thorough option such as</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics </span><span class="token parameter variable" style="color:#36acaa">-q</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ping</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The following checks can be reasonable liveness probe candidates:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics </span><span class="token parameter variable" style="color:#36acaa">-q</span><span class="token plain"> check_port_connectivity</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics </span><span class="token parameter variable" style="color:#36acaa">-q</span><span class="token plain"> check_local_alarms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note, however, that they will fail for the nodes <a href="/rabbitmq-website/docs/partitions">paused by the &quot;pause minority&quot; partition handliner strategy</a>.</p>
<p>The <a href="https://github.com/rabbitmq/diy-kubernetes-examples/blob/master/examples/gke/statefulset.yaml#L119-L131" target="_blank" rel="noopener noreferrer">liveness probe section</a>
in the Stateful Set definition file demonstrates how to configure a liveness probe.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="plugins">Plugins<a href="#plugins" class="hash-link" aria-label="Direct link to Plugins" title="Direct link to Plugins">​</a></h2>
<p>RabbitMQ <a href="/rabbitmq-website/docs/plugins">supports plugins</a>. Some plugins are essential when running RabbitMQ on Kubernetes,
e.g. the Kubernetes-specific peer discovery implementation.</p>
<p>The <a href="https://github.com/rabbitmq/diy-kubernetes-examples" target="_blank" rel="noopener noreferrer"><code>rabbitmq_peer_discovery_k8s</code> plugin</a> is required
to deploy RabbitMQ on Kubernetes.
It is quite common to also enable <a href="/rabbitmq-website/docs/management"><code>rabbitmq_management</code> plugin</a> in order to get a browser-based management UI
and an HTTP API, and <a href="/rabbitmq-website/docs/prometheus"><code>rabbitmq_prometheus</code></a> for monitoring.</p>
<p>Plugins can be enabled in <a href="/rabbitmq-website/docs/plugins#ways-to-enable-plugins">different ways</a>.
We recommend mounting the plugins file, <code>enabled_plugins</code>, to the node configuration directory, <code>/etc/rabbitmq</code>.
A Config Map can be used to express the value of the <code>enabled_plugins</code> file. It can then be mounted
as a Volume onto each RabbitMQ container in the Stateful Set definition.</p>
<p>In our <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/configmap.yaml" target="_blank" rel="noopener noreferrer">configmap.yaml example</a> file,
we demonstrate how to popular the the <code>enabled_plugins</code> file and mount it under the <code>/etc/rabbitmq</code> directory.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ports">Ports<a href="#ports" class="hash-link" aria-label="Direct link to Ports" title="Direct link to Ports">​</a></h2>
<p>The final consideration for the Stateful Set is the ports to open on the RabbitMQ Pods.
Protocols supported by RabbitMQ are all TCP-based and require the <a href="/rabbitmq-website/docs/networking#ports">protocol ports</a> to be opened on the RabbitMQ nodes.
Depending on the plugins that are enabled on a node, the list of required ports can vary.</p>
<p>The example <code>enabled_plugins</code> file mentioned above enables a few plugins: <code>rabbitmq_peer_discovery_k8s</code> (mandatory), <code>rabbitmq_management</code>
and <code>rabbitmq_prometheus</code>.
Therefore, the service must <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yaml#L106-L118" target="_blank" rel="noopener noreferrer">open several ports</a> relevant for the core server and the enabled plugins:</p>
<ul>
<li><code>5672</code>: used by AMQP 0-9-1 and AMQP 1.0 clients</li>
<li><code>15672</code>: management UI and  HTTP API)</li>
<li><code>15692</code>: Prometheus scraping endpoint)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-the-stateful-set">Deploy the Stateful Set<a href="#deploy-the-stateful-set" class="hash-link" aria-label="Direct link to Deploy the Stateful Set" title="Direct link to Deploy the Stateful Set">​</a></h2>
<p>These are the key components in the Stateful Set file. Please have a look <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/statefulset.yaml" target="_blank" rel="noopener noreferrer">at the file</a>,
and if following from the example, deploy the Stateful Set:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will start spinning up a RabbitMQ cluster. To watch the progress:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">watch</span><span class="token plain"> kubectl get all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; NAME             READY   STATUS    RESTARTS   AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; pod/rabbitmq-0   0/1     Pending   0          8s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; NAME                        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; service/rabbitmq-headless   ClusterIP   None         &lt;none&gt;        4369/TCP   61m</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; NAME                        READY   AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; statefulset.apps/rabbitmq   0/1     8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-service-for-client-connections">Create a Service for Client Connections<a href="#create-a-service-for-client-connections" class="hash-link" aria-label="Direct link to Create a Service for Client Connections" title="Direct link to Create a Service for Client Connections">​</a></h2>
<p>If all the steps above succeeded, you should have functioning RabbitMQ cluster deployed on Kubernetes! ?
However, having a RabbitMQ cluster on Kubernetes is only useful clients can <a href="/rabbitmq-website/docs/connections">connect</a> to it.</p>
<p>Time to create a Service to make the cluster accessible to <a href="/rabbitmq-website/docs/connections">client connections</a>.</p>
<p>The type of the Service depends on your use case. The <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#servicespec-v1-core" target="_blank" rel="noopener noreferrer">Kubernetes API reference</a>
gives a good overview of the types of Services available.</p>
<p>In the <a href="https://github.com/rabbitmq/diy-kubernetes-examples/tree/master/gke/client-service.yaml" target="_blank" rel="noopener noreferrer">client-service.yaml example file</a>,
we have gone with a <code>LoadBalancer</code> Service.
This gives us an external IP that can be used to access the RabbitMQ cluter.</p>
<p>For example, this should make it possible to visit the RabbitMQ management UI by visiting <code>{external-ip}:15672</code>, and signing in.
Client applications can connect to endpoints such as <code>{external-ip}:5672</code> (AMQP 0-9-1, AMQP 1.0) or <code>{external-ip}:1883</code> (MQTT).
Please refer to the <a href="/rabbitmq-website/tutorials">get started guide</a> to learn how to use RabbitMQ.</p>
<p>If following from the example, run</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> client-service.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>to create a Service of type LoadBalancer with an external IP address. To find out what the external IP address is,
use <code>kubectl get svc</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; NAME                        TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                                          AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; service/rabbitmq-client     LoadBalancer   10.59.244.70   34.105.135.216   15672:30902/TCP,15692:30605/TCP,5672:31210/TCP   2m19s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resource-usage-and-limits">Resource Usage and Limits<a href="#resource-usage-and-limits" class="hash-link" aria-label="Direct link to Resource Usage and Limits" title="Direct link to Resource Usage and Limits">​</a></h2>
<p><a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/" target="_blank" rel="noopener noreferrer">Container resource management</a> is a topic that deserves
its own post. <a href="/rabbitmq-website/blog/tags/capacity-planning">Capacity planning</a> recommendations are entirely workload-,
environment- and system-specific. Optimal values are usually found via extensive <a href="/rabbitmq-website/docs/monitoring">monitoring</a> of the system, trial, and error.
However, when picking the limits and resource allocation settings, consider a few RabbitMQ-specific things.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-the-latest-major-erlang-release">Use the Latest Major Erlang Release<a href="#use-the-latest-major-erlang-release" class="hash-link" aria-label="Direct link to Use the Latest Major Erlang Release" title="Direct link to Use the Latest Major Erlang Release">​</a></h3>
<p>RabbitMQ runs on the Erlang runtime. Recent Erlang/OTP releases have introduced a number of improvements highly relevant to
the users who run RabbitMQ on Kubernetes:</p>
<ul>
<li>In Erlang 22, inter-node communication [latency and head-of-line blocking(<a href="http://blog.erlang.org/OTP-22-Highlights/" target="_blank" rel="noopener noreferrer">http://blog.erlang.org/OTP-22-Highlights/</a>)<!-- --> have been
significantly reduced. In earlier versions, link congestion was known to make <a href="/rabbitmq-website/docs/nettick">cluster node heartbeat</a> false
positives likely.</li>
<li>In Erlang 23, the runtime will <a href="http://blog.erlang.org/OTP-23-Highlights/" target="_blank" rel="noopener noreferrer">respect the container CPU quotas</a> when computing the default number of schedulers to start. This means that nodes will respect the Kubernetes-managed CPU resource limits.</li>
</ul>
<p>Docker community image for RabbitMQ ships with Erlang 23 at the time of writing. Users of custom Docker images are highly recommended
to provision Erlang 23 as well.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cpu-resource-usage">CPU Resource Usage<a href="#cpu-resource-usage" class="hash-link" aria-label="Direct link to CPU Resource Usage" title="Direct link to CPU Resource Usage">​</a></h3>
<p>RabbitMQ was designed for workloads that involve <a href="/rabbitmq-website/docs/queues#runtime-characteristics">multiple queues</a> and where
a node serves multiple clients at the same time. Nodes will generally use all the <a href="/rabbitmq-website/docs/runtime">CPU cores allowed</a>
without any explicit configuration. As the number of cores grows, some tuning may be necessary to reduce <a href="/rabbitmq-website/docs/runtime#scheduling">CPU context switching</a>.</p>
<p>How CPU time is spent can be monitored via the <a href="/rabbitmq-website/docs/runtime#thread-stats">runtime thread activity metrics</a> which
are also exposed via the <a href="/rabbitmq-website/docs/prometheus">RabbitMQ Prometheus plugin</a>.</p>
<p>If RabbitMQ pods hover around their CPU resource allowance and experience throttling in environments with a large number of
relatively idle clients, the load likely can be <a href="/rabbitmq-website/docs/runtime#cpu-reduce-idle-usage">reduced with a modest amount of configuration</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-limits">Memory Limits<a href="#memory-limits" class="hash-link" aria-label="Direct link to Memory Limits" title="Direct link to Memory Limits">​</a></h3>
<p>RabbitMQ uses the concept of a <a href="/rabbitmq-website/docs/memory">runtime memory high watermark</a>. By default a node will use 40% of detected
(available) memory as the watermark. When the watermark is crossed, publishers across the entire cluster will be blocked
and more aggressive paging out to disk initiated. The watermark value may seem like a memory quota on Kubernetes at first
but there is an important difference: RabbitMQ resource alarms assume a node can typically recover from this state. For example,
a large backlog of messages will eventually be consumed.</p>
<p>Kubernetes memory limits are <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits" target="_blank" rel="noopener noreferrer">enforced by the OOM killer</a>:
no recovery is expected. This means that a RabbitMQ node&#x27;s high memory watermark <strong>must be lower</strong> than the memory limit
imposed on the node container. Kubernetes deployments should use the relative watermark values in the <a href="/rabbitmq-website/docs/production-checklist#resource-limits-ram">recommended range</a>.</p>
<p><a href="/rabbitmq-website/docs/memory-use">Memory usage breakdown data</a> should be used to determine what consumes most memory on the node.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="disk-usage">Disk Usage<a href="#disk-usage" class="hash-link" aria-label="Direct link to Disk Usage" title="Direct link to Disk Usage">​</a></h3>
<p>We highly recommend overprovisioning the <a href="/rabbitmq-website/docs/production-checklist#resource-limits-disk-space">disk space available to RabbitMQ containers</a>.
A node that has run out of disk space won&#x27;t always be able to recover from such an event. Such nodes must be
decomissioned and replaced.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consider-available-network-link-bandwidth">Consider Available Network Link Bandwidth<a href="#consider-available-network-link-bandwidth" class="hash-link" aria-label="Direct link to Consider Available Network Link Bandwidth" title="Direct link to Consider Available Network Link Bandwidth">​</a></h3>
<p>Finally, consider what kind of links and Kubernetes networking options are used for inter-node communication. Network link congestion
can be a significant limiting factor to system throughput and affect its availability.</p>
<p>Below is a very simplistic formula to calculate the amount of bandwidth needed by a workload, in bits:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># peak message rate * bits per message * 110% to account for metadata and protocol framing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PeakMessageRate * AverageMessagePayloadSizeInBytes * 8 * 1.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Therefore a workload with average message size of 3 kiB and expected peak message rate
of 20K messages a second can consume up to</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">3 kiB * 20000/second * 8 * 1.1 = 528 megabits/second</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>of bandwidth.</p>
<p>Team RabbitMQ maintains a <a href="/rabbitmq-website/docs/prometheus#other-dashboards">Grafana dashboard</a> for inter-node communication
link metrics.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-rabbitmq-perf-test-to-run-a-functional-and-load-test-of-the-cluster">Using <code>rabbitmq-perf-test</code> to Run a Functional and Load Test of the Cluster<a href="#using-rabbitmq-perf-test-to-run-a-functional-and-load-test-of-the-cluster" class="hash-link" aria-label="Direct link to using-rabbitmq-perf-test-to-run-a-functional-and-load-test-of-the-cluster" title="Direct link to using-rabbitmq-perf-test-to-run-a-functional-and-load-test-of-the-cluster">​</a></h2>
<p>RabbitMQ comes with a load simulation tool, <a href="https://rabbitmq.github.io/rabbitmq-perf-test/stable/htmlsingle/" target="_blank" rel="noopener noreferrer">PerfTest</a>,
which can be executed from outside of a cluster or deployed to Kubernetes using the <code>perf-test</code> public <a href="https://hub.docker.com/r/pivotalrabbitmq/perf-test/" target="_blank" rel="noopener noreferrer">docker image</a>.
Here&#x27;s an example of how the image can be deployed to a Kubernetes cluster</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run perf-test </span><span class="token parameter variable" style="color:#36acaa">--image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pivotalrabbitmq/perf-test -- </span><span class="token parameter variable" style="color:#36acaa">--uri</span><span class="token plain"> amqp://</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">username</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">@</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here the <code>{username}</code> and <code>{password}</code> are the user credentials, e.g. those set up in the <code>rabbitmq-admin</code> Secret.
The <code>{serivce}</code> is the hostname to connect to. We use the name of the client service that will resolve as a hostname when deployed.</p>
<p>The above <code>kubectl run</code> command will start a PerfTest pod which can be observed in</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For a functioning RabbitMQ cluster, running <code>kubectl logs -f {perf-test-pod-name}</code> where <code>{perf-test-pod-name}</code>
is the name of the pod as reported by <code>kubectl get pods</code>,  will produce output similar to this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">id: test-110102-976, time: 263.100s, sent: 21098 msg/s, received: 21425 msg/s, min/median/75th/95th/99th consumer latency: 1481452/1600817/1636996/1674410/1682972 ?s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-110102-976, time: 264.100s, sent: 17314 msg/s, received: 17856 msg/s, min/median/75th/95th/99th consumer latency: 1509657/1600942/1636253/1695525/1718537 ?s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-110102-976, time: 265.100s, sent: 18597 msg/s, received: 17707 msg/s, min/median/75th/95th/99th consumer latency: 1573151/1716519/1756060/1813985/1846490 ?s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To learn more about PerfTest, its settings, capabilities and output, see the <a href="https://rabbitmq.github.io/rabbitmq-perf-test/stable/htmlsingle/" target="_blank" rel="noopener noreferrer">PerfTest doc guide</a>.</p>
<p>PerfTest is not meant to be running permanently. To tear down the <code>perf-test</code> pod, use</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod perf-test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring-the-cluster">Monitoring the Cluster<a href="#monitoring-the-cluster" class="hash-link" aria-label="Direct link to Monitoring the Cluster" title="Direct link to Monitoring the Cluster">​</a></h2>
<p><a href="/rabbitmq-website/docs/monitoring">Monitoring</a> is a critically important part of any production deployment.</p>
<p>RabbitMQ comes with <a href="/rabbitmq-website/docs/prometheus">in-built support for Prometheus</a>. To enable it, enable the <code>rabbitmq_prometheus</code> plugin.
This in turn can be done by adding <code>rabbitmq_promethus</code> to the <code>enabled_plugins</code> Config Map as explained above.</p>
<p>The Prometheus scraping port, 15972, must be open on both the Pod and the client Service.</p>
<p>Node and cluster metrics can be <a href="/rabbitmq-website/docs/prometheus">visualised with Grafana</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="alternative-option-the-kubernetes-cluster-operator-for-rabbitmq">Alternative Option: the Kubernetes Cluster Operator for RabbitMQ<a href="#alternative-option-the-kubernetes-cluster-operator-for-rabbitmq" class="hash-link" aria-label="Direct link to Alternative Option: the Kubernetes Cluster Operator for RabbitMQ" title="Direct link to Alternative Option: the Kubernetes Cluster Operator for RabbitMQ">​</a></h2>
<p>As this post demonstrates, there are quite a few parts involved in hosting a stateful data services
such as RabbitMQ on Kubernetes. It may seem like a daunting task.
There are several alternatives to this kind of DIY deployment demonstrated in this post.</p>
<p>Team RabbitMQ at VMware has open sourced a <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" target="_blank" rel="noopener noreferrer">Kubernetes Operator pattern</a>
implementation for RabbitMQ. As of August 2020, this is a young project under active development.
While it currently has limitations, it is our recommended option over the manual DIY setup
demonstrated in this post.</p>
<p>See <a href="/rabbitmq-website/kubernetes/operator/operator-overview">RabbitMQ Cluster Operator for Kubernetes </a> to learn more.
The project is developed in the open at <a href="https://github.com/rabbitmq/cluster-operator" target="_blank" rel="noopener noreferrer">rabbitmq/cluster-operator on GitHub</a>. Give it a try and let us know how it goes.
Besides GitHub, two great venues for providing feedback to the team behind the Operator are the <a href="https://groups.google.com/forum/#!forum/rabbitmq-users" target="_blank" rel="noopener noreferrer">RabbitMQ mailing list</a>
and the <a href="https://rabbitmq-slack.herokuapp.com/" target="_blank" rel="noopener noreferrer"><code>#kubernetes channel in RabbitMQ community Slack</code></a>.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/introductory">Introductory</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/cloud">Cloud</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/diy">DIY</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2020-08-10-deploying-rabbitmq-to-kubernetes-whats-involved/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2020/08/31/this-month-in-rabbitmq-july-2020-recap"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">This Month in RabbitMQ, July 2020 Recap</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2020/07/30/this-month-in-rabbitmq-june-2020-recap"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">This Month in Rabbitmq June 2020 Recap</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#an-update-from-2024" class="table-of-contents__link toc-highlight">An Update from 2024</a></li><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#executable-examples" class="table-of-contents__link toc-highlight">Executable Examples</a></li><li><a href="#rabbitmq-docker-image" class="table-of-contents__link toc-highlight">RabbitMQ Docker Image</a></li><li><a href="#kubernetes-namespace-and-permissions-rbac" class="table-of-contents__link toc-highlight">Kubernetes Namespace and Permissions (RBAC)</a></li><li><a href="#use-a-stateful-set" class="table-of-contents__link toc-highlight">Use a Stateful Set</a></li><li><a href="#create-a-service-for-clustering-and-cli-tools" class="table-of-contents__link toc-highlight">Create a Service For Clustering and CLI Tools</a></li><li><a href="#use-a-persistent-volume-for-node-data" class="table-of-contents__link toc-highlight">Use a Persistent Volume for Node Data</a></li><li><a href="#node-authentication-secret-the-erlang-cookie" class="table-of-contents__link toc-highlight">Node Authentication Secret: the Erlang Cookie</a></li><li><a href="#administrator-credentials" class="table-of-contents__link toc-highlight">Administrator Credentials</a></li><li><a href="#node-configuration" class="table-of-contents__link toc-highlight">Node Configuration</a><ul><li><a href="#use-an-init-container" class="table-of-contents__link toc-highlight">Use an Init Container</a></li><li><a href="#run-the-pod-as-the-rabbitmq-user" class="table-of-contents__link toc-highlight">Run The Pod As the <code>rabbitmq</code> User</a></li><li><a href="#importing-definitions" class="table-of-contents__link toc-highlight">Importing Definitions</a></li></ul></li><li><a href="#readiness-probe" class="table-of-contents__link toc-highlight">Readiness Probe</a></li><li><a href="#liveness-probe" class="table-of-contents__link toc-highlight">Liveness Probe</a></li><li><a href="#plugins" class="table-of-contents__link toc-highlight">Plugins</a></li><li><a href="#ports" class="table-of-contents__link toc-highlight">Ports</a></li><li><a href="#deploy-the-stateful-set" class="table-of-contents__link toc-highlight">Deploy the Stateful Set</a></li><li><a href="#create-a-service-for-client-connections" class="table-of-contents__link toc-highlight">Create a Service for Client Connections</a></li><li><a href="#resource-usage-and-limits" class="table-of-contents__link toc-highlight">Resource Usage and Limits</a><ul><li><a href="#use-the-latest-major-erlang-release" class="table-of-contents__link toc-highlight">Use the Latest Major Erlang Release</a></li><li><a href="#cpu-resource-usage" class="table-of-contents__link toc-highlight">CPU Resource Usage</a></li><li><a href="#memory-limits" class="table-of-contents__link toc-highlight">Memory Limits</a></li><li><a href="#disk-usage" class="table-of-contents__link toc-highlight">Disk Usage</a></li><li><a href="#consider-available-network-link-bandwidth" class="table-of-contents__link toc-highlight">Consider Available Network Link Bandwidth</a></li></ul></li><li><a href="#using-rabbitmq-perf-test-to-run-a-functional-and-load-test-of-the-cluster" class="table-of-contents__link toc-highlight">Using <code>rabbitmq-perf-test</code> to Run a Functional and Load Test of the Cluster</a></li><li><a href="#monitoring-the-cluster" class="table-of-contents__link toc-highlight">Monitoring the Cluster</a></li><li><a href="#alternative-option-the-kubernetes-cluster-operator-for-rabbitmq" class="table-of-contents__link toc-highlight">Alternative Option: the Kubernetes Cluster Operator for RabbitMQ</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
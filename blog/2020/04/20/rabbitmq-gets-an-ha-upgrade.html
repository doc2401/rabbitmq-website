<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">RabbitMQ Gets an HA Upgrade | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2020/04/20/rabbitmq-gets-an-ha-upgrade"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="RabbitMQ Gets an HA Upgrade | RabbitMQ"><meta data-rh="true" name="description" content="This is the first part of a series on quorum queues, our new replicated queue type. We&#x27;ll be covering everything from what quorum queues are, to hardware requirements, migration from mirrored queues and best practices."><meta data-rh="true" property="og:description" content="This is the first part of a series on quorum queues, our new replicated queue type. We&#x27;ll be covering everything from what quorum queues are, to hardware requirements, migration from mirrored queues and best practices."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-04-20T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="New Features"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2020/04/20/rabbitmq-gets-an-ha-upgrade"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2020/04/20/rabbitmq-gets-an-ha-upgrade" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2020/04/20/rabbitmq-gets-an-ha-upgrade" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2020/04/20/rabbitmq-gets-an-ha-upgrade","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2020/04/20/rabbitmq-gets-an-ha-upgrade","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2020/04/20/rabbitmq-gets-an-ha-upgrade","headline":"RabbitMQ Gets an HA Upgrade","name":"RabbitMQ Gets an HA Upgrade","description":"This is the first part of a series on quorum queues, our new replicated queue type. We'll be covering everything from what quorum queues are, to hardware requirements, migration from mirrored queues and best practices.","datePublished":"2020-04-20T00:00:00.000Z","author":{"@type":"Person","name":"Jack Vanlightly"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">RabbitMQ Gets an HA Upgrade</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-04-20T00:00:00.000Z">April 20, 2020</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Jack Vanlightly</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>This is the first part of a series on quorum queues, our new replicated queue type. We&#x27;ll be covering everything from what quorum queues are, to hardware requirements, migration from mirrored queues and best practices.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-quorum-queues">Introducing Quorum Queues<a href="#introducing-quorum-queues" class="hash-link" aria-label="Direct link to Introducing Quorum Queues" title="Direct link to Introducing Quorum Queues">​</a></h2>
<p>Mirrored queues, also known as HA queues have been the de facto option for years when requiring extra data safety guarantees for your messages. Quorum queues are the next generation of replicated queue that aim to replace most use cases for mirrored queues and are available from the 3.8 release and onward.</p>
<p>In this blog series we’re going to cover the following:</p>
<ul>
<li>Part 1 - Understand the need for a new replicated queue type and how it works (this post)</li>
<li><a href="/rabbitmq-website/blog/2020/04/21/quorum-queues-and-why-disks-matter">Part 2 - Why your choice of storage drive matters with quorum queues</a></li>
<li><a href="/rabbitmq-website/blog/2020/05/04/quorum-queues-and-flow-control-the-concepts">Part 3 - Quorum queues and flow control. Concepts.</a></li>
<li><a href="/rabbitmq-website/blog/2020/05/14/quorum-queues-and-flow-control-single-queue-benchmarks">Part 4 - Quorum queues and flow control. Single Queue Benchmarks.</a></li>
<li><a href="/rabbitmq-website/blog/2020/05/15/quorum-queues-and-flow-control-stress-tests">Part 5 - Quorum queues and flow control. Stress Tests.</a></li>
<li>Part 6 - Quorum queues and cluster/VM Sizing (coming soon)</li>
<li>Part 7 - When and how to migrate from mirrored to quorum queues (coming soon)</li>
<li>Part 8 - Best practices and gotchas (coming soon)</li>
<li>Part 9 - Monitoring and admin operations (coming soon)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-offer-a-new-type-of-replicated-queue">Why Offer a New Type of Replicated Queue?<a href="#why-offer-a-new-type-of-replicated-queue" class="hash-link" aria-label="Direct link to Why Offer a New Type of Replicated Queue?" title="Direct link to Why Offer a New Type of Replicated Queue?">​</a></h2>
<p>Mirrored queues are based on a replication algorithm called Chained Replication. In the context of queues, chained replication forms a ring of queues where there is one leader (the master) and one or more secondaries (mirrors). All messages are published to and consumed from the leader, the leader then replicates those operations to its adjacent mirror which in turn replicates to its adjacent mirror. This continues until reaching the last mirror who then notifies the master that the operation if fully replicated.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 1. Chain replication" src="/rabbitmq-website/assets/images/ChainReplication3Nodes-0ef787fbe6093016c8cdddb7041b2b66.png" width="641" height="335" class="img_ev3q"><figcaption>Fig 1. Chain replication</figcaption></figure><p></p>
<p>Due to some edge cases that produced message loss, this algorithm was modified so that the channel process would additionally send the message directly to each mirror. This unfortunately means that the broker receiving messages from a publisher has to send out each message twice, which doubles the network load.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 2. channel sends each message twice to master and mirrors" src="/rabbitmq-website/assets/images/ChainReplication3NodesDoubleSend-a15c30acbdc2fc91350b6a5cab21ccfa.png" width="923" height="477" class="img_ev3q"><figcaption>Fig 2. channel sends each message twice to master and mirrors</figcaption></figure><p></p>
<p>There are also some pain points regarding this replication algorithm which centre on how it handles mirrors that leave the ring either because of a server restart, a node failure or a network partition.</p>
<p>When a mirror has been out of communication with its peers beyond a certain time limit, it is removed from the ring and the queue continues to be available. The problems occur upon the mirror rejoining the ring again. First the mirror discards all its data and then, optionally, a process called synchronisation begins. </p>
<p>Synchronisation is where the master replicates its current messages to a mirror. This is a <em>stop the world</em> process where the queue becomes frozen until synchronisation is complete. This becomes a problem if the queue is very big as the period of unavailability can be long.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 3. Stop the world synchronisation" src="/rabbitmq-website/assets/images/ChainReplication5NodesRejoin-c8a5c0690bfdfc348766af97e6fa9ba0.png" width="853" height="360" class="img_ev3q"><figcaption>Fig 3. Stop the world synchronisation</figcaption></figure><p></p>
<p>Another option is to not synchronise a rejoining mirror with the master. In this case we end up with lower redundancy but avoid potentially painful synchronisation. Of course, if the queue is empty or has few messages then synchronisation doesn’t pose a big problem.</p>
<p>Another important topic is how it handles network partitions. When a partition occurs that splits a cluster into two halves, we’ll end up with one or more mirrors that lose communications with the master. As an administrator we can choose availability or consistency at this point. The <em>cluster_partition_handling</em> configuration determines how RabbitMQ handles the partition.</p>
<p>If we don’t want to lose messages, then we’ll configure the cluster to use <em>pause-minority</em> mode. This basically stops all brokers on the minority side of a partition. On the majority side (if there is one) the queue continues to operate, just with reduced redundancy. Once the partition is resolved, the cluster returns to normality. This strategy chooses consistency (albeit with less redundancy) over availability.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 4. Pause minority mode causes unavailability for clients connected to minority side." src="/rabbitmq-website/assets/images/PauseMinority-9ddda5c6c3f251b02e3f0a817400fa3c.png" width="691" height="491" class="img_ev3q"><figcaption>Fig 4. Pause minority mode causes unavailability for clients connected to minority side.</figcaption></figure><p></p>
<p>If we want continued availability on both sides of the partition then we can choose <em>ignore</em> or <em>auto-heal</em> mode. This will allow a mirror to be promoted to master, meaning we have a master on both sides. This allows the queue to continue to receive and deliver messages no matter which side of the partition a client is connected to. Unfortunately, on resolving the partition one side of the partition is chosen as the victim and restarted, <em>losing</em> any messages in the queue on that side. This is not an ideal option, but in some scenarios it can still better suit your needs than becoming unavailable.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 5. Auto-heal provides continued availability at the cost of potential data loss." src="/rabbitmq-website/assets/images/NonPauseMinority-8d2e2b215bf4885ce342b2a48c1ec6c1.png" width="689" height="499" class="img_ev3q"><figcaption>Fig 5. Auto-heal provides continued availability at the cost of potential data loss.</figcaption></figure><p></p>
<p>We needed a better replication algorithm and that is how quorum queues were born.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quorum-queues">Quorum Queues<a href="#quorum-queues" class="hash-link" aria-label="Direct link to Quorum Queues" title="Direct link to Quorum Queues">​</a></h2>
<p><a href="/rabbitmq-website/docs/quorum-queues">Quorum queues</a> do not use chained replication but are based on the well established and mathematically proven <strong>Raft</strong> protocol. Raft is a consensus algorithm for replicating a log of operations across a cluster of nodes. It requires a quorum (a majority) of participating nodes to be available and to agree on each new operation appended to the distributed log. This is where quorum queues get their name. </p>
<p>What operations does a queue have? We have <em>enqueue</em> operations and <em>consumer acknowledgemen</em>t operations. Just like with mirrored queues, all clients interact with a leader, whose job it is to then replicate the enqueues and acks to its followers.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 6. A quorum queue with one leader and two followers" src="/rabbitmq-website/assets/images/QQ-9ae1d2dd18389c354841e96198476f87.png" width="534" height="314" class="img_ev3q"><figcaption>Fig 6. A quorum queue with one leader and two followers</figcaption></figure><p></p>
<p>The algorithm is more efficient and can achieve higher throughput than mirrored queues. It does have higher end-to-end latencies and those latencies closely correspond to the throughput/latency of your disks. Quorum queues only confirm messages once written to disk on a majority and so disk performance plays a large role in quorum queue performance.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-difficult-decisions">No Difficult Decisions<a href="#no-difficult-decisions" class="hash-link" aria-label="Direct link to No Difficult Decisions" title="Direct link to No Difficult Decisions">​</a></h3>
<p>There is no <em>stop the world</em> synchronisation, no throwing away data on rejoining, no difficult decisions to make about automatic vs manual synchronisation at all. There is no availability vs consistency choice to make; a quorum queue will only confirm a message once it has been replicated to a majority of nodes. If a majority is down then you lose availability.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="network-partitions">Network Partitions<a href="#network-partitions" class="hash-link" aria-label="Direct link to Network Partitions" title="Direct link to Network Partitions">​</a></h3>
<p>When it comes to network partitions quorum queues are much simpler. Firstly they use a separate and much faster failure detector that can detect partitions rapidly and trigger fast leader elections meaning that availability is either not impacted or is quickly restored. The <em>cluster_partition_handling</em> configuration does not apply to quorum queues though the <em>pause_minority</em> mode can still affect a quorum queue as when a minority side is paused, any quorum queue leaders hosted on that node will become unavailable. However due to the speed of the failure detector, in the event of a partition, a leader election should have selected a new leader well before this pause is triggered.</p>
<p>Quorum queues are for those scenarios where data safety trumps all. Just remember though that data safety starts with applications doing the right thing, using publisher confirms and consumer acks correctly. Quorum queues do have some limitations and gotchas and we’ll be taking a look at those later in the series.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="x-queue-type-classic-and-quorum">x-queue-type: classic and quorum<a href="#x-queue-type-classic-and-quorum" class="hash-link" aria-label="Direct link to x-queue-type: classic and quorum" title="Direct link to x-queue-type: classic and quorum">​</a></h2>
<p>Now that we have a new type of queue, we refer to a queue as either a <em>classic</em> or a <em>quorum</em> queue. A classic queue is the same old queue as before. Declaring a classic queue with the ha-mode, ha-params, ha-sync-mode properties will make it a classic mirrored queue, as will defining a policy with those arguments that matches the queue.</p>
<p>You cannot turn a classic queue into a quorum queue via policies though. The x-queue-type property set to <em>quorum</em> must be included in the queue declaration. It is a quorum queue from birth.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quorum-queues-in-the-management-ui">Quorum Queues in the Management UI<a href="#quorum-queues-in-the-management-ui" class="hash-link" aria-label="Direct link to Quorum Queues in the Management UI" title="Direct link to Quorum Queues in the Management UI">​</a></h2>
<p>In the screenshot below, firstly you’ll notice the <em>x-queue-type: quorum</em> argument and the <em>x-quorum-initial-group-size: 3</em> argument that tells that this queue is a quorum queue with a replication factor of 3 (one leader and two followers).</p>
<p><img decoding="async" loading="lazy" src="/rabbitmq-website/assets/images/QQinManagementUI-f0a5870392cd979efa7aec3792c6cf03.png" width="1407" height="661" class="img_ev3q"></p>
<p>Fig 7. A quorum queue as seen in the management UIWe also can see the members of the queue, which members are online and who the current leader is.</p>
<p>Declaring a quorum queue is as simple as declaring any other queue, simply using the <em>x-queue-type</em> argument. By default the quorum size (replicator factor) is 5, though with a smaller cluster, the size will be the size of the cluster itself.</p>
<p>From the management UI you will see the option to add either a classic or quorum queue.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 8. Quorum queue appears in the new queue type drop-down" src="/rabbitmq-website/assets/images/ChooseQuorumQueue-d343e661ca17f5a84fcc5d3e8bde3ae4.png" width="379" height="248" class="img_ev3q"><figcaption>Fig 8. Quorum queue appears in the new queue type drop-down</figcaption></figure><p></p>
<p>You will see the available arguments change when you select Quorum.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fig 9. Quorum queue arguments" src="/rabbitmq-website/assets/images/QuorumQueueArguments-3af7da122dea1f4df37a575ec8b75715.png" width="686" height="389" class="img_ev3q"><figcaption>Fig 9. Quorum queue arguments</figcaption></figure><p></p>
<p>There are three new arguments available for quorum queues. Two are related to how many messages are kept in memory. By default all messages are maintained in memory and so if a quorum queue grows in length it can put memory pressure on a cluster. We can limit how much memory is used by messages by setting one or both of the following arguments:</p>
<ul>
<li>x-max-in-memory-length </li>
<li>x-max-in-memory-bytes</li>
</ul>
<p>The queue index is still stored in memory however, so a queue that continues to grow in size can still place memory pressure on a cluster. We’ll look more closely at this later in the series.</p>
<p>The new poison message feature is only available for quorum queues and is set using the <em>x-delivery-limit</em> argument. Each time a message is redelivered to a consumer, a counter is incremented. Once the redelivery count exceeds the x-delivery-limit, the message gets dropped or dead-lettered (if a DLX exchange has been configured).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="takeaways">Takeaways<a href="#takeaways" class="hash-link" aria-label="Direct link to Takeaways" title="Direct link to Takeaways">​</a></h2>
<p>Quorum queues offer bullet proof safety guarantees and less headaches when it comes to restarting servers. They also place different stresses on your hardware than mirrored queues so before you make the jump, check out our next posts which contain guidance about migrations and required hardware.</p>
<p>In the <a href="/rabbitmq-website/blog/2020/04/21/quorum-queues-and-why-disks-matter">next post</a> we’ll cover why we recommend SSDs over HDDs and the different performance characteristics we get with each storage drive type.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/new-features">New Features</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2020-04-20-rabbitmq-gets-an-ha-upgrade/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2020/04/21/quorum-queues-and-why-disks-matter"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Quorum queues and why disks matter</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2020/04/13/this-month-in-rabbitmq-march-2020-recap"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">This Month in RabbitMQ: March 2020 Recap</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introducing-quorum-queues" class="table-of-contents__link toc-highlight">Introducing Quorum Queues</a></li><li><a href="#why-offer-a-new-type-of-replicated-queue" class="table-of-contents__link toc-highlight">Why Offer a New Type of Replicated Queue?</a></li><li><a href="#quorum-queues" class="table-of-contents__link toc-highlight">Quorum Queues</a><ul><li><a href="#no-difficult-decisions" class="table-of-contents__link toc-highlight">No Difficult Decisions</a></li><li><a href="#network-partitions" class="table-of-contents__link toc-highlight">Network Partitions</a></li></ul></li><li><a href="#x-queue-type-classic-and-quorum" class="table-of-contents__link toc-highlight">x-queue-type: classic and quorum</a></li><li><a href="#quorum-queues-in-the-management-ui" class="table-of-contents__link toc-highlight">Quorum Queues in the Management UI</a></li><li><a href="#takeaways" class="table-of-contents__link toc-highlight">Takeaways</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
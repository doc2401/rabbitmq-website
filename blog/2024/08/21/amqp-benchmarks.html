<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">AMQP 1.0 Benchmarks | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2024/08/21/amqp-benchmarks"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="AMQP 1.0 Benchmarks | RabbitMQ"><meta data-rh="true" name="description" content="This blog post demonstrates that native AMQP 1.0 in RabbitMQ 4.0 provides significant performance and scalability improvements compared to AMQP 1.0 in RabbitMQ 3.13."><meta data-rh="true" property="og:description" content="This blog post demonstrates that native AMQP 1.0 in RabbitMQ 4.0 provides significant performance and scalability improvements compared to AMQP 1.0 in RabbitMQ 3.13."><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/assets/images/throughput-classic-queue-215d3f10d1e0213152fab2f26ca3921e.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/assets/images/throughput-classic-queue-215d3f10d1e0213152fab2f26ca3921e.svg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-08-21T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ansd"><meta data-rh="true" property="article:tag" content="AMQP 1.0,RabbitMQ 4.0,Performance"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2024/08/21/amqp-benchmarks"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2024/08/21/amqp-benchmarks" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2024/08/21/amqp-benchmarks" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2024/08/21/amqp-benchmarks","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2024/08/21/amqp-benchmarks","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2024/08/21/amqp-benchmarks","headline":"AMQP 1.0 Benchmarks","name":"AMQP 1.0 Benchmarks","description":"This blog post demonstrates that native AMQP 1.0 in RabbitMQ 4.0 provides significant performance and scalability improvements compared to AMQP 1.0 in RabbitMQ 3.13.","datePublished":"2024-08-21T00:00:00.000Z","author":{"@type":"Person","name":"David Ansari","url":"https://github.com/ansd","image":"https://github.com/ansd.png"},"image":{"@type":"ImageObject","@id":"https://www.rabbitmq.com/rabbitmq-website/assets/images/throughput-classic-queue-215d3f10d1e0213152fab2f26ca3921e.svg","url":"https://www.rabbitmq.com/rabbitmq-website/assets/images/throughput-classic-queue-215d3f10d1e0213152fab2f26ca3921e.svg","contentUrl":"https://www.rabbitmq.com/rabbitmq-website/assets/images/throughput-classic-queue-215d3f10d1e0213152fab2f26ca3921e.svg","caption":"title image for the blog post: AMQP 1.0 Benchmarks"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">AMQP 1.0 Benchmarks</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-08-21T00:00:00.000Z">August 21, 2024</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/ansd.png" alt="David Ansari"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">David Ansari</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/ansd/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://m.ansd.xyz/@ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Mastodon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 61 65" width="1em" height="1em" class="authorSocialLink_owbf"><path fill="url(#:Rfndbeh:)" d="M60.754 14.39C59.814 7.406 53.727 1.903 46.512.836 45.294.656 40.682 0 29.997 0h-.08C19.23 0 16.938.656 15.72.836 8.705 1.873 2.299 6.82.745 13.886c-.748 3.48-.828 7.338-.689 10.877.198 5.075.237 10.142.697 15.197a71.482 71.482 0 0 0 1.664 9.968c1.477 6.056 7.458 11.096 13.317 13.152a35.718 35.718 0 0 0 19.484 1.028 28.365 28.365 0 0 0 2.107-.576c1.572-.5 3.413-1.057 4.766-2.038a.154.154 0 0 0 .062-.118v-4.899a.146.146 0 0 0-.055-.111.145.145 0 0 0-.122-.028 54 54 0 0 1-12.644 1.478c-7.328 0-9.298-3.478-9.863-4.925a15.258 15.258 0 0 1-.857-3.882.142.142 0 0 1 .178-.145 52.976 52.976 0 0 0 12.437 1.477c1.007 0 2.012 0 3.02-.026 4.213-.119 8.654-.334 12.8-1.144.103-.02.206-.038.295-.065 6.539-1.255 12.762-5.196 13.394-15.176.024-.393.083-4.115.083-4.523.003-1.386.446-9.829-.065-15.017Z"></path><path fill="#fff" d="M50.394 22.237v17.35H43.52V22.749c0-3.545-1.478-5.353-4.483-5.353-3.303 0-4.958 2.139-4.958 6.364v9.217h-6.835V23.76c0-4.225-1.657-6.364-4.96-6.364-2.988 0-4.48 1.808-4.48 5.353v16.84H10.93V22.237c0-3.545.905-6.362 2.715-8.45 1.868-2.082 4.317-3.152 7.358-3.152 3.519 0 6.178 1.354 7.951 4.057l1.711 2.871 1.714-2.871c1.773-2.704 4.432-4.056 7.945-4.056 3.038 0 5.487 1.069 7.36 3.152 1.81 2.085 2.712 4.902 2.71 8.449Z"></path><defs><linearGradient id=":Rfndbeh:" x1="30.5" x2="30.5" y1="0" y2="65" gradientUnits="userSpaceOnUse"><stop stop-color="#6364FF"></stop><stop offset="1" stop-color="#563ACC"></stop></linearGradient></defs></svg></a><a href="https://bsky.app/profile/ansd.xyz" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>This blog post demonstrates that <a href="/rabbitmq-website/blog/2024/08/05/native-amqp">native AMQP 1.0</a> in RabbitMQ 4.0 provides significant performance and scalability improvements compared to AMQP 1.0 in RabbitMQ 3.13.</p>
<p>Additionally, this blog post suggests that AMQP 1.0 can perform slightly better than AMQP 0.9.1 in RabbitMQ 4.0.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Setup</summary><div><div class="collapsibleContent_i85q"><p>The following setup applies to all benchmarks in this blog post:</p><ul>
<li>Intel NUC 11</li>
<li>8 CPU cores</li>
<li>32 GB RAM</li>
<li>Ubuntu 22.04</li>
<li>Single node RabbitMQ server</li>
<li>Server runs with (only) 3 scheduler threads (set via <a href="https://www.erlang.org/doc/apps/erts/erl_cmd.html#emulator-flags" target="_blank" rel="noopener noreferrer">runtime flags</a> as <code>+S 3</code>)</li>
<li>Erlang/OTP 27.0.1</li>
<li>Clients and server run on the same box</li>
</ul><p>We use the latest RabbitMQ versions at the time of writing:</p><ul>
<li><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.0.0-beta.5" target="_blank" rel="noopener noreferrer">v4.0.0-beta.5</a></li>
<li><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.13.6" target="_blank" rel="noopener noreferrer">v3.13.6</a></li>
</ul><p>The following <a href="/rabbitmq-website/docs/configure#advanced-config-file">advanced.config</a> is applied:</p><div class="language-erl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-erl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {rabbit, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {loopback_users, []}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {rabbitmq_management_agent, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {disable_metrics_collector, true}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">].</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Metrics collection is disabled in the <code>rabbitmq_management_agent</code> plugin.
For <a href="https://www.rabbitmq.com/docs/production-checklist" target="_blank" rel="noopener noreferrer">production environments</a>, <a href="https://www.rabbitmq.com/docs/prometheus" target="_blank" rel="noopener noreferrer">Prometheus</a> is the recommended option.</p><p>RabbitMQ server is started as follows:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> run-broker </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">TEST_TMPDIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string environment constant" style="color:#36acaa">$HOME</span><span class="token string" style="color:#e3116c">/scratch/rabbit/test&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_CONFIG_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string environment constant" style="color:#36acaa">$HOME</span><span class="token string" style="color:#e3116c">/scratch/rabbit/advanced.config&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">PLUGINS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;rabbitmq_prometheus rabbitmq_management rabbitmq_amqp1_0&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;+S 3&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>rabbitmq_amqp1_0</code> plugin is a <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.5/deps/rabbitmq_amqp1_0/README.md" target="_blank" rel="noopener noreferrer">no-op plugin</a> in RabbitMQ 4.0.</p><p>The AMQP 1.0 benchmarks run <a href="https://github.com/ssorj/quiver" target="_blank" rel="noopener noreferrer">quiver</a> in a Docker container:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -it --rm --add-host host.docker.internal:host-gateway ssorj/quiver:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bash-5.1# quiver --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quiver 0.4.0-SNAPSHOT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="classic-queues">Classic Queues<a href="#classic-queues" class="hash-link" aria-label="Direct link to Classic Queues" title="Direct link to Classic Queues">​</a></h2>
<p>This section benchmarks <a href="/rabbitmq-website/docs/classic-queues">classic queues</a>.</p>
<p>We declare a classic queue called <code>my-classic-queue</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deps/rabbitmq_management/bin/rabbitmqadmin </span><span class="token builtin class-name">declare</span><span class="token plain"> queue </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">my-classic-queue </span><span class="token assign-left variable" style="color:#36acaa">queue_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">classic </span><span class="token assign-left variable" style="color:#36acaa">durable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-40">AMQP 1.0 in 4.0<a href="#amqp-10-in-40" class="hash-link" aria-label="Direct link to AMQP 1.0 in 4.0" title="Direct link to AMQP 1.0 in 4.0">​</a></h3>
<p>The client sends and receives 1 million messages.
Each message contains a payload of 12 bytes.
The receiver repeatedly tops up 200 <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-flow-control" target="_blank" rel="noopener noreferrer">link credits</a> at a time.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//queues/my-classic-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESULTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Count ............................................. 1,000,000 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration ............................................... 10.1 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sender rate .......................................... 99,413 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiver rate ........................................ 99,423 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End-to-end rate ...................................... 99,413 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Latencies by percentile:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          0% ........ 0 ms       90.00% ........ 1 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         25% ........ 1 ms       99.00% ........ 2 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         50% ........ 1 ms       99.90% ........ 2 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        100% ........ 9 ms       99.99% ........ 9 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-313">AMQP 1.0 in 3.13<a href="#amqp-10-in-313" class="hash-link" aria-label="Direct link to AMQP 1.0 in 3.13" title="Direct link to AMQP 1.0 in 3.13">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//amq/queue/my-classic-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESULTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Count ............................................. 1,000,000 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration ............................................... 45.9 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sender rate .......................................... 43,264 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiver rate ........................................ 21,822 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End-to-end rate ...................................... 21,790 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Latencies by percentile:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          0% ....... 67 ms       90.00% .... 24445 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         25% .... 23056 ms       99.00% .... 24780 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         50% .... 23433 ms       99.90% .... 24869 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        100% .... 24873 ms       99.99% .... 24873 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The same benchmark against RabbitMQ 3.13 results in 4.5 times lower throughput.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Detailed test execution</summary><div><div class="collapsibleContent_i85q"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">---------------------- Sender -----------------------  --------------------- Receiver ----------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Lat [ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------------------  -----------------------------------------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     2.1        130,814      65,342        8     79.1       2.1          3,509       1,753        1      7.5       777</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     4.1        206,588      37,849        6     79.1       4.1          5,995       1,242        0      7.5     2,458</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     6.1        294,650      43,987        6     79.1       6.1          9,505       1,753        1      7.5     5,066</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     8.1        360,184      32,734        5     79.4       8.1         13,893       2,194        0      7.5     6,190</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.1        458,486      49,102        6     79.4      10.1         15,793         950        1      7.5     9,259</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12.1        524,020      32,734        5     79.4      12.1         21,644       2,923        1      7.5    11,163</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    14.1        622,322      49,102        5     79.4      14.1         25,154       1,753        1      7.5    13,451</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    16.1        687,856      32,734        4     79.4      16.1         27,639       1,241        1      7.5    15,246</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    18.1        786,158      49,102        6     81.0      18.1         30,124       1,241        1      7.5    17,649</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    20.1        884,460      49,102        6     81.0      20.1         32,610       1,242        1      7.5    19,408</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    22.1        949,994      32,734        4     81.0      22.1         35,535       1,462        0      7.5    21,293</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    24.1        999,912      24,934        4     81.8      24.1         38,167       1,315        1      7.5    23,321</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    26.1        999,974          31        2      0.0      26.1        117,745      39,749       11      7.5    24,475</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      28.1        202,589      42,380       11      7.5    24,364</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      30.1        292,554      44,938       13      7.5    24,244</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      32.1        377,691      42,526       15      7.5    23,955</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      34.1        469,704      45,961       14      7.5    23,660</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      36.1        555,719      42,965       12      7.5    23,463</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      38.1        649,048      46,618       12      7.5    23,264</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      40.1        737,696      44,280       15      7.5    23,140</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      42.1        826,491      44,353       15      7.5    23,100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      44.1        917,187      45,303       16      7.5    23,066</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      46.1        999,974      41,394       14      0.0    22,781</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-091-in-40">AMQP 0.9.1 in 4.0<a href="#amqp-091-in-40" class="hash-link" aria-label="Direct link to AMQP 0.9.1 in 4.0" title="Direct link to AMQP 0.9.1 in 4.0">​</a></h3>
<p>For our AMQP 0.9.1 benchmarks we use <a href="https://perftest.rabbitmq.com/" target="_blank" rel="noopener noreferrer">PerfTest</a>.
We try to run a somewhat fair comparison of our previous AMQP 1.0 benchmark.</p>
<p>Since an AMQP 1.0 <a href="/rabbitmq-website/docs/amqp#target-address-v2">/queues/<!-- -->:queue</a> target address sends to the default exchange, we also send to the default exchange via AMQP 0.9.1.
Since we used <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-header" target="_blank" rel="noopener noreferrer">durable</a> messages with AMQP 1.0, we set the <code>persistent</code> flag in AMQP 0.9.1.
Since RabbitMQ settles with the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-released" target="_blank" rel="noopener noreferrer">released</a> outcome when a message cannot be routed, we set the <code>mandatory</code> flag in AMQP 0.9.1.
Since RabbitMQ <code>v4.0.0-beta.5</code> uses a default <code>rabbit.max_link_credit</code> of 128 granting 128 more credits to the sending client when remaining credit falls below 0.5 * 128, we configure the AMQP 0.9.1 publisher to have at most 1.5 * 128 = 192 messages unconfirmed at a time.
Since we used 200 link credits in the previous run, we configure the AMQP 0.9.1 consumer with a <a href="/rabbitmq-website/docs/consumer-prefetch">prefetch</a> of 200.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ java -jar target/perf-test.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --predeclared --exchange amq.default \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --routing-key my-classic-queue --queue my-classic-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --flag persistent --flag mandatory \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --pmessages 1000000 --size 12 --confirm 192 --qos 200 --multi-ack-every 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-151706-485, sending rate avg: 88534 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-151706-485, receiving rate avg: 88534 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-151706-485, consumer latency min/median/75th/95th/99th 99/975/1320/1900/2799 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-151706-485, confirm latency min/median/75th/95th/99th 193/1691/2113/2887/3358 µs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-classic-queues">Summary<a href="#summary-classic-queues" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 1: Classic queue end-to-end message rate" src="/rabbitmq-website/assets/images/throughput-classic-queue-215d3f10d1e0213152fab2f26ca3921e.svg" width="600" height="371" class="img_ev3q"><figcaption>Figure 1: Classic queue end-to-end message rate</figcaption></figure><p></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quorum-queues">Quorum Queues<a href="#quorum-queues" class="hash-link" aria-label="Direct link to Quorum Queues" title="Direct link to Quorum Queues">​</a></h2>
<p>This section benchmarks <a href="/rabbitmq-website/docs/quorum-queues">quorum queues</a>.</p>
<p>We declare a quorum queue called <code>my-quorum-queue</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deps/rabbitmq_management/bin/rabbitmqadmin </span><span class="token builtin class-name">declare</span><span class="token plain"> queue </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">my-quorum-queue </span><span class="token assign-left variable" style="color:#36acaa">queue_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">quorum </span><span class="token assign-left variable" style="color:#36acaa">durable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="flow-control-configuration">Flow Control Configuration<a href="#flow-control-configuration" class="hash-link" aria-label="Direct link to Flow Control Configuration" title="Direct link to Flow Control Configuration">​</a></h4>
<p>For highest data safety, quorum queues <a href="https://man7.org/linux/man-pages/man2/fsync.2.html" target="_blank" rel="noopener noreferrer">fsync</a> all <a href="https://github.com/rabbitmq/ra" target="_blank" rel="noopener noreferrer">Ra</a> commands including:</p>
<ul>
<li><a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.5/deps/rabbit/src/rabbit_fifo.erl#L144" target="_blank" rel="noopener noreferrer">enqueue</a>: sender enqueues a message</li>
<li><a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.5/deps/rabbit/src/rabbit_fifo.erl#L149" target="_blank" rel="noopener noreferrer">settle</a>: receiver accepts a message</li>
<li><a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.5/deps/rabbit/src/rabbit_fifo.erl#L152" target="_blank" rel="noopener noreferrer">credit</a>: receiver tops up link credit</li>
</ul>
<p>Before a quorum queue confirms receipt of a message to the publisher, it ensures that any file modifications are flushed to disk, making the data safe even if the RabbitMQ node crashes shortly after.</p>
<p>The SSD of my Linux box is slow, taking 5-15 ms per fsync.
Since we want to compare AMQP protocol implementations without being bottlenecked by a cheap disk, the tests in this section increase flow control settings:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><code>advanced.config</code></summary><div><div class="collapsibleContent_i85q"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {rabbit, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {loopback_users, []},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% RabbitMQ internal flow control for AMQP 0.9.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Default: {400, 200}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {credit_flow_default_credit, {5000, 2500}},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Maximum incoming-window of AMQP 1.0 session.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Default: 400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {max_incoming_window, 5000},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Maximum link-credit RabbitMQ grants to AMQP 1.0 sender.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Default: 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {max_link_credit, 2000},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Maximum link-credit RabbitMQ AMQP 1.0 session grants to sending queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Default: 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {max_queue_credit, 5000}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {rabbitmq_management_agent, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {disable_metrics_collector, true}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">].</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<p>This configuration allows more Ra commands to be batched before RabbitMQ calls fsync.
<strong>For production use cases, we recommend enterprise-grade high performance disks that fsync faster</strong>, in which case there is likely no need to increase flow control settings.</p>
<p>RabbitMQ flow control settings present a trade-off:</p>
<ul>
<li>Low values ensure stability in production.</li>
<li>High values can result in higher performance for individual connections but may lead to higher memory spikes when many connections publish large messages concurrently.</li>
</ul>
<p>RabbitMQ uses conservative flow control default settings to favour stability in production over winning performance benchmarks.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-40-1">AMQP 1.0 in 4.0<a href="#amqp-10-in-40-1" class="hash-link" aria-label="Direct link to AMQP 1.0 in 4.0" title="Direct link to AMQP 1.0 in 4.0">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//queues/my-quorum-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESULTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Count ............................................. 1,000,000 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration ............................................... 12.0 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sender rate .......................................... 83,459 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiver rate ........................................ 83,396 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End-to-end rate ...................................... 83,181 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Latencies by percentile:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          0% ........ 9 ms       90.00% ....... 47 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         25% ....... 27 ms       99.00% ....... 61 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         50% ....... 35 ms       99.90% ....... 76 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        100% ....... 81 ms       99.99% ....... 81 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Default Flow Control Settings</summary><div><div class="collapsibleContent_i85q"><p>The previous benchmark calls fsync 1,244 times in the <a href="https://github.com/rabbitmq/ra/blob/e95ab7b9df1f8f4ffec8535d60185b3bc33a09bc/src/ra_log_wal.erl#L770" target="_blank" rel="noopener noreferrer">ra_log_wal</a> module (that implements the Raft write-ahead log).</p><p>The same benchmark with default flow control settings calls fsync 15,493 times resulting in significantly lower throughput:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//queues/my-quorum-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESULTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Count ............................................. 1,000,000 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration .............................................. 100.2 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sender rate ........................................... 9,986 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiver rate ......................................... 9,987 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End-to-end rate ....................................... 9,983 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Latencies by percentile:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          0% ....... 10 ms       90.00% ....... 24 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         25% ....... 14 ms       99.00% ....... 30 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         50% ....... 18 ms       99.90% ....... 38 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        100% ....... 55 ms       99.99% ....... 47 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Each fsync took 5.9 ms on average.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(15,493 - 1,244) * 5.9 ms = 84 seconds</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Therefore, this benchmark with default flow control settings is blocked for 84 seconds longer executing <code>fsync</code> than the previous benchmark with increased flow control settings.
This shows how critical enterprise-grade high performance disks are to get the best results out of quorum queues.
For your production workloads, we recommend using disks with lower <code>fsync</code> latency rather than tweaking
RabbitMQ flow control settings.</p><p>It&#x27;s worth noting that the Raft WAL log is shared by all quorum queue replicas on a given RabbitMQ node.
This means that <code>ra_log_wal</code> will automatically batch multiple Raft commands (operations) into a single <code>fsync</code>
call when there are dozens of quorum queues with hundreds of connections.
Consequently, flushing an individual Ra command to disk becomes cheaper on average when there is more traffic on the node.
Our benchmark ran somewhat artificially with a single connection as fast as possible.</p></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-313-1">AMQP 1.0 in 3.13<a href="#amqp-10-in-313-1" class="hash-link" aria-label="Direct link to AMQP 1.0 in 3.13" title="Direct link to AMQP 1.0 in 3.13">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//amq/queue/my-quorum-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------- Sender -----------------------  --------------------- Receiver ----------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Lat [ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------------------  -----------------------------------------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     2.1        163,582      81,709       11     84.2       2.1         29,548      14,759        3      7.5       840</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     4.1        336,380      86,356       12    185.3       4.1         29,840         146        0      7.5     2,331</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     6.1        524,026      93,729       14    328.0       6.1         29,840           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     8.1        687,864      81,837       11    462.3       8.1         31,302         730        1      7.5     6,780</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.1        884,470      98,303       14    605.4      10.1         31,447          72        0      7.5     7,897</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12.1        999,924      57,669        7    687.5      12.1         31,447           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    14.1        999,924           0        0    687.5      14.1         31,447           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    16.1        999,924           0        0    687.5      16.1         31,447           0        1      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    18.1        999,924           0        1    688.3      18.1         31,447           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">receiver timed out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    20.1        999,924           0        0    688.3      20.1         31,447           0        0      7.5         0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>RabbitMQ 3.13 cannot handle this workload and the benchmark fails.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Default Flow Control Settings</summary><div><div class="collapsibleContent_i85q"><p>The benchmark also fails with default flow control settings:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//amq/queue/my-quorum-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------- Sender -----------------------  --------------------- Receiver ----------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Lat [ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------------------  -----------------------------------------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     2.1        130,814      65,342        9     70.0       2.1         26,915      13,437        6      7.5     1,213</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     4.1        196,348      32,718        5     70.2       4.1         28,084         584        0      7.5     3,093</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     6.1        261,882      32,734        7     70.2       6.1         30,131       1,022        1      7.5     4,952</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     8.1        360,184      49,126        6     70.2       8.1         32,325       1,096        0      7.5     6,637</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.1        425,718      32,734        6     70.2      10.1         34,225         949        1      7.5     8,089</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12.1        491,252      32,734        5     70.2      12.1         34,225           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    14.1        589,554      49,102        7     70.2      14.1         34,225           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    16.1        655,088      32,734        5     70.2      16.1         34,225           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    18.1        720,622      32,734        6     70.2      18.1         34,225           0        0      7.5         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">receiver timed out</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-091-in-40-1">AMQP 0.9.1 in 4.0<a href="#amqp-091-in-40-1" class="hash-link" aria-label="Direct link to AMQP 0.9.1 in 4.0" title="Direct link to AMQP 0.9.1 in 4.0">​</a></h3>
<p>Since we set <code>max_link_credit</code> to 2,000, we allow for a maximum of 2,000 * 1.5 = 3,000 unconfirmed messages in the publisher.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ java -jar target/perf-test.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --predeclared --exchange amq.default \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --routing-key my-quorum-queue --queue my-quorum-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --flag persistent --flag mandatory \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --pmessages 1000000 --size 12 --confirm 3000 --qos 5000 --multi-ack-every 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-085526-136, sending rate avg: 70067 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-085526-136, receiving rate avg: 70067 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-085526-136, consumer latency min/median/75th/95th/99th 8803/33127/40424/53407/62883 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-085526-136, confirm latency min/median/75th/95th/99th 8551/30323/38317/52103/63131 µs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Default Flow Control Settings</summary><div><div class="collapsibleContent_i85q"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ java -jar target/perf-test.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --predeclared --exchange amq.default \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --routing-key my-quorum-queue --queue my-quorum-queue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --flag persistent --flag mandatory \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --pmessages 1000000 --size 12 --confirm 192 --qos 5000 --multi-ack-every 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-084359-441, sending rate avg: 9931 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-084359-441, receiving rate avg: 9931 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-084359-441, consumer latency min/median/75th/95th/99th 7512/17054/26256/34249/38641 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-084359-441, confirm latency min/median/75th/95th/99th 9432/16586/23918/32636/36858 µs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These results are similar to the results of the default flow control settings in AMQP 1.0 in 4.0 because both benchmarks are bottlenecked by my slow disk.</p></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-quorum-queues">Summary<a href="#summary-quorum-queues" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 2: Quorum queue end-to-end message rate" src="/rabbitmq-website/assets/images/throughput-quorum-queue-7f61bcd561f964e3e5318aefb455dec1.svg" width="600" height="371" class="img_ev3q"><figcaption>Figure 2: Quorum queue end-to-end message rate</figcaption></figure><p></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="streams">Streams<a href="#streams" class="hash-link" aria-label="Direct link to Streams" title="Direct link to Streams">​</a></h2>
<p>This sections benchmarks <a href="/rabbitmq-website/docs/streams">streams</a>.</p>
<p>We declare a stream called <code>my-stream</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deps/rabbitmq_management/bin/rabbitmqadmin </span><span class="token builtin class-name">declare</span><span class="token plain"> queue </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">my-stream </span><span class="token assign-left variable" style="color:#36acaa">queue_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">stream </span><span class="token assign-left variable" style="color:#36acaa">durable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>(We run with default RabbitMQ flow control settings.)</p>
<p>We want the receiver to start consuming from the very beginning of the stream.
Quiver doesn&#x27;t support passing a <code>filter</code> field to the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-source" target="_blank" rel="noopener noreferrer">source</a> where we could specify a <code>rabbitmq:stream-offset-spec</code> value <code>first</code>.
Therefore, for this benchmark it&#x27;s easier to patch RabbitMQ to use stream offset spec <code>first</code> by default instead of <code>next</code>:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>git diff</summary><div><div class="collapsibleContent_i85q"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">diff --git a/deps/rabbit/src/rabbit_stream_queue.erl b/deps/rabbit/src/rabbit_stream_queue.erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index e36ad708eb..acd193d76f 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- a/deps/rabbit/src/rabbit_stream_queue.erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ b/deps/rabbit/src/rabbit_stream_queue.erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -344,7 +344,7 @@ consume(Q, Spec, #stream_client{} = QState0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        {term(), non_neg_integer()}) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     {ok, osiris:offset_spec()} | {error, term()}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> parse_offset_arg(undefined) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-    {ok, next};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    {ok, first};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> parse_offset_arg({_, &lt;&lt;&quot;first&quot;&gt;&gt;}) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     {ok, first};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> parse_offset_arg({_, &lt;&lt;&quot;last&quot;&gt;&gt;}) -&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-40-2">AMQP 1.0 in 4.0<a href="#amqp-10-in-40-2" class="hash-link" aria-label="Direct link to AMQP 1.0 in 4.0" title="Direct link to AMQP 1.0 in 4.0">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//queues/my-stream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------- Sender -----------------------  --------------------- Receiver ----------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Lat [ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------------------  -----------------------------------------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     2.1        278,782     139,321       25      8.0       2.1        215,185     107,539       22      7.6       224</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     4.1        554,492     137,717       25      8.0       4.1        434,027     109,312       24      7.6       651</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     6.1        825,082     135,160       25      8.0       6.1        650,236     107,997       26      7.6     1,079</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     8.1        999,992      87,368       17      0.0       8.1        888,973     119,249       29      7.6     1,469</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       -              -           -        -        -      10.1        999,993      55,455       13      0.0     1,583</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESULTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Count ............................................. 1,000,000 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration ................................................ 8.9 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sender rate ......................................... 136,705 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiver rate ....................................... 112,587 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End-to-end rate ..................................... 112,196 messages/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Latencies by percentile:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          0% ........ 7 ms       90.00% ..... 1553 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         25% ...... 519 ms       99.00% ..... 1612 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         50% ..... 1011 ms       99.90% ..... 1615 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        100% ..... 1616 ms       99.99% ..... 1616 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is easy to observe a substantially higher throughput.</p>
<p>Note that end-to-end latencies are very high just because the sender can write into the stream at a higher rate than RabbitMQ being able
to dispatch messages to the consumer (&quot;receiver&quot; in <code>quiver</code> terms).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-313-2">AMQP 1.0 in 3.13<a href="#amqp-10-in-313-2" class="hash-link" aria-label="Direct link to AMQP 1.0 in 3.13" title="Direct link to AMQP 1.0 in 3.13">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># quiver //host.docker.internal//amq/queue/my-stream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --durable --count 1m --duration 10m --body-size 12 --credit 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------- Sender -----------------------  --------------------- Receiver ----------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Time [s]      Count [m]  Rate [m/s]  CPU [%]  RSS [M]  Lat [ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------------------  -----------------------------------------------------  --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     2.1        196,350      98,077       12     70.1       2.1          4,094       2,045        0      7.7       195</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     4.1        392,956      98,205       13    138.5       4.1          4,094           0        0      7.7         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     6.1        524,026      65,470       10    196.5       6.1          4,094           0        0      7.7         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     8.1        655,096      65,470       11    259.4       8.1          4,094           0        0      7.7         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10.1        786,166      65,470       10    307.5      10.1          4,094           0        0      7.7         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">receiver timed out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12.1        917,236      65,470        9    355.5      12.1          4,094           0        0      7.7         0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>RabbitMQ 3.13 cannot handle this workload and the benchmark fails.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-091-in-40-2">AMQP 0.9.1 in 4.0<a href="#amqp-091-in-40-2" class="hash-link" aria-label="Direct link to AMQP 0.9.1 in 4.0" title="Direct link to AMQP 0.9.1 in 4.0">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ java -jar target/perf-test.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --predeclared --exchange amq.default \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --routing-key my-stream --queue my-stream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --flag persistent --flag mandatory \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --pmessages 1000000 --size 12 --confirm 192 --qos 5000 --multi-ack-every 5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-104223-225, sending rate avg: 88912 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-104223-225, receiving rate avg: 88912 msg/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-104223-225, consumer latency min/median/75th/95th/99th 701/1340/1523/2500/4524 µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: test-104223-225, confirm latency min/median/75th/95th/99th 788/1983/2130/2437/2970 µs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since streams store messages in AMQP 1.0 format, this workload requires RabbitMQ to translate each message between AMQP 0.9.1 and AMQP 1.0.
This explains why stream throughput is lower when using AMQP 0.9.1 clients compared to AMQP 1.0 clients.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-streams">Summary<a href="#summary-streams" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 3: Stream end-to-end message rate" src="/rabbitmq-website/assets/images/throughput-stream-a6526579118b787eb9d281abc8b4ef9a.svg" width="600" height="371" class="img_ev3q"><figcaption>Figure 3: Stream end-to-end message rate</figcaption></figure><p></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="many-connections">Many Connections<a href="#many-connections" class="hash-link" aria-label="Direct link to Many Connections" title="Direct link to Many Connections">​</a></h2>
<p>This section compares memory usage of connecting 40,000 clients with two AMQP 1.0 sessions / AMQP 0.9.1 channels per connection.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Setup</summary><div><div class="collapsibleContent_i85q"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> run-broker </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">TEST_TMPDIR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string environment constant" style="color:#36acaa">$HOME</span><span class="token string" style="color:#e3116c">/scratch/rabbit/test&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_CONFIG_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string environment constant" style="color:#36acaa">$HOME</span><span class="token string" style="color:#e3116c">/scratch/rabbit/rabbitmq.conf&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">PLUGINS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;rabbitmq_amqp1_0&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;+P 3000000 +S 6&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">ERL_MAX_PORTS</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3000000</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the following <code>rabbitmq.conf</code>, we use small buffer sizes to better compare the memory usage of the protocol implementations.</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tcp_listen_options.sndbuf = 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcp_listen_options.recbuf = 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_memory_high_watermark.relative = 0.95</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_memory_high_watermark_paging_ratio = 0.95</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loopback_users = none</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>AMQP 1.0</summary><div><div class="collapsibleContent_i85q"><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;github.com/Azure/go-amqp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40_000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">%</span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;opened %d connections&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> amqp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TODO</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token string" style="color:#e3116c">&quot;amqp://localhost&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">amqp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConnOptions</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">SASLType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amqp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SASLTypeAnonymous</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;open connection:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TODO</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;begin session:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TODO</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;begin session:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;opened all connections&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Hour</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>AMQP 0.9.1</summary><div><div class="collapsibleContent_i85q"><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	amqp </span><span class="token string" style="color:#e3116c">&quot;github.com/rabbitmq/amqp091-go&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40_000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">%</span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;opened %d connections&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> amqp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;amqp://guest:guest@localhost&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;open connection:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;open channel:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;open channel:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;opened all connections&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Hour</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details></div></div></details>
<p>The examples below directly invoke <a href="https://www.erlang.org/doc/apps/erts/erlang.html#memory/0" target="_blank" rel="noopener noreferrer"><code>erlang:memory/0</code></a> on the node,
a function that returns the memory size in bytes for each memory type.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><code>rabbitmq-diagnostics</code></summary><div><div class="collapsibleContent_i85q"><p>To retrieve the same information from a running node, use <a href="/rabbitmq-website/docs/cli">CLI</a> command <a href="/rabbitmq-website/docs/man/rabbitmq-diagnostics.8">rabbitmq-diagnostics</a> like so:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics memory_breakdown</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This command can format the numbers using different information units (e.g. MiB, GiB) and supports JSON
output with <code>--formatter=json</code>:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># pipes the output to `jq` for more readable formatting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics memory_breakdown </span><span class="token parameter variable" style="color:#36acaa">--formatter</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-40-3">AMQP 1.0 in 4.0<a href="#amqp-10-in-40-3" class="hash-link" aria-label="Direct link to AMQP 1.0 in 4.0" title="Direct link to AMQP 1.0 in 4.0">​</a></h3>
<p>Here are the runtime-reported memory footprint numbers:</p>
<div class="language-erlang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-erlang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token atom">erlang</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">memory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">total</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">5330809208</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">processes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4788022888</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">processes_used</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4787945960</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">system</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">542786320</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">atom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">999681</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">atom_used</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">974364</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">binary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">194810368</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">19328950</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">ets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">94161808</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token atom">erlang</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">system_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token atom">process_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">360312</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-10-in-313-3">AMQP 1.0 in 3.13<a href="#amqp-10-in-313-3" class="hash-link" aria-label="Direct link to AMQP 1.0 in 3.13" title="Direct link to AMQP 1.0 in 3.13">​</a></h3>
<p>To compare, the runtime-reported memory footprint numbers in this test are:</p>
<div class="language-erlang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-erlang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token atom">erlang</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">memory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">total</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">12066294144</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">processes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">11156497904</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">processes_used</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">11156461208</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">system</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">909796240</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">atom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1089809</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">atom_used</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1062780</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">binary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">192784464</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">22068126</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">ets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">318872128</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token atom">erlang</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">system_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token atom">process_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1480318</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We observe that the memory usage of <code>processes</code> in RabbitMQ 3.13 is 11.1 GB compared to only 4.8 GB in RabbitMQ 4.0 (a reduction of about 56%).
As explained in the <a href="/rabbitmq-website/blog/2024/08/05/native-amqp#amqp-10-in-rabbitmq-313">previous</a> blog post, the RabbitMQ 3.13 implementation of AMQP 1.0 is resource heavy because each AMQP 1.0 session in the plugin includes an AMQP 0.9.1 client and maintains AMQP 0.9.1 state.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp-091-in-40-3">AMQP 0.9.1 in 4.0<a href="#amqp-091-in-40-3" class="hash-link" aria-label="Direct link to AMQP 0.9.1 in 4.0" title="Direct link to AMQP 0.9.1 in 4.0">​</a></h3>
<div class="language-erlang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-erlang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token atom">erlang</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">memory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">total</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">5409763512</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">processes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4716150248</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">processes_used</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4715945080</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">system</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">693613264</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">atom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">991489</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">atom_used</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">962578</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">binary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">187229040</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">19118766</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">ets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">235605424</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token atom">erlang</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">system_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token atom">process_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">600314</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-many-connections">Summary<a href="#summary-many-connections" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 4: Memory usage of 40,000 connections and 80,000 sessions / channels" src="/rabbitmq-website/assets/images/memory-many-connections-af340c0a7efe58d8b521dd3abb1117ba.svg" width="600" height="371" class="img_ev3q"><figcaption>Figure 4: Memory usage of 40,000 connections and 80,000 sessions / channels</figcaption></figure><p></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>This blog post demonstrated that the new native AMQP 1.0 implementation in RabbitMQ 4.0 performs multiple times better than AMQP 1.0 in RabbitMQ 3.13.</p>
<p>We also observed that AMQP 1.0 can perform better than AMQP 0.9.1.
However, it’s challenging to provide a fair comparison.
This blog post used an AMQP 1.0 client written in C and an AMQP 0.9.1 client written in Java.
Therefore, we do not claim or promise that you will observe better throughput with your AMQP 1.0 workloads.
The AMQP 0.9.1 implementation in RabbitMQ performs well since it has been stable and optimized for over 15 years.</p>
<p>Use cases where AMQP 1.0 will likely outperform AMQP 0.9.1 include:</p>
<ul>
<li>Sending to or receiving from a stream because a stream encodes messages in AMQP 1.0 format (as covered in this blog post).</li>
<li>Leveraging queue locality using the <a href="https://github.com/rabbitmq/rabbitmq-amqp-java-client" target="_blank" rel="noopener noreferrer">RabbitMQ AMQP 1.0 Java client</a>. (This feature will be covered separately.)</li>
<li>Publishing to or consuming from other queues when one target queue reaches its limits on the same connection (as covered in the <a href="/rabbitmq-website/blog/2024/09/02/amqp-flow-control">AMQP 1.0 flow control</a> blog post).</li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/amqp-1-0">AMQP 1.0</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/rabbit-mq-4-0">RabbitMQ 4.0</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/performance">Performance</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2024-08-21-amqp-benchmarks/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2024/08/28/quorum-queues-in-4.0"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">RabbitMQ 4.0: New Quorum Queue Features</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2024/08/11/package-repository-updates"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Package Repository Updates</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#classic-queues" class="table-of-contents__link toc-highlight">Classic Queues</a><ul><li><a href="#amqp-10-in-40" class="table-of-contents__link toc-highlight">AMQP 1.0 in 4.0</a></li><li><a href="#amqp-10-in-313" class="table-of-contents__link toc-highlight">AMQP 1.0 in 3.13</a></li><li><a href="#amqp-091-in-40" class="table-of-contents__link toc-highlight">AMQP 0.9.1 in 4.0</a></li><li><a href="#summary-classic-queues" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li><li><a href="#quorum-queues" class="table-of-contents__link toc-highlight">Quorum Queues</a><ul><li><a href="#amqp-10-in-40-1" class="table-of-contents__link toc-highlight">AMQP 1.0 in 4.0</a></li><li><a href="#amqp-10-in-313-1" class="table-of-contents__link toc-highlight">AMQP 1.0 in 3.13</a></li><li><a href="#amqp-091-in-40-1" class="table-of-contents__link toc-highlight">AMQP 0.9.1 in 4.0</a></li><li><a href="#summary-quorum-queues" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li><li><a href="#streams" class="table-of-contents__link toc-highlight">Streams</a><ul><li><a href="#amqp-10-in-40-2" class="table-of-contents__link toc-highlight">AMQP 1.0 in 4.0</a></li><li><a href="#amqp-10-in-313-2" class="table-of-contents__link toc-highlight">AMQP 1.0 in 3.13</a></li><li><a href="#amqp-091-in-40-2" class="table-of-contents__link toc-highlight">AMQP 0.9.1 in 4.0</a></li><li><a href="#summary-streams" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li><li><a href="#many-connections" class="table-of-contents__link toc-highlight">Many Connections</a><ul><li><a href="#amqp-10-in-40-3" class="table-of-contents__link toc-highlight">AMQP 1.0 in 4.0</a></li><li><a href="#amqp-10-in-313-3" class="table-of-contents__link toc-highlight">AMQP 1.0 in 3.13</a></li><li><a href="#amqp-091-in-40-3" class="table-of-contents__link toc-highlight">AMQP 0.9.1 in 4.0</a></li><li><a href="#summary-many-connections" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
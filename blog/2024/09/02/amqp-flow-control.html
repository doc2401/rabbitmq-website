<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Ten Benefits of AMQP 1.0 Flow Control | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2024/09/02/amqp-flow-control"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Ten Benefits of AMQP 1.0 Flow Control | RabbitMQ"><meta data-rh="true" name="description" content="This blog post outlines ten advantages of AMQP 1.0 flow control over AMQP 0.9.1, supported by two benchmarks demonstrating significant performance gains."><meta data-rh="true" property="og:description" content="This blog post outlines ten advantages of AMQP 1.0 flow control over AMQP 0.9.1, supported by two benchmarks demonstrating significant performance gains."><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/assets/images/figure-2-45-465ed496160578f3f8516c4a6e762756.png"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/assets/images/figure-2-45-465ed496160578f3f8516c4a6e762756.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-09-02T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ansd"><meta data-rh="true" property="article:tag" content="AMQP 1.0,RabbitMQ 4.0,Performance,Technical Deep Dive"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2024/09/02/amqp-flow-control"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2024/09/02/amqp-flow-control" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2024/09/02/amqp-flow-control" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2024/09/02/amqp-flow-control","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2024/09/02/amqp-flow-control","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2024/09/02/amqp-flow-control","headline":"Ten Benefits of AMQP 1.0 Flow Control","name":"Ten Benefits of AMQP 1.0 Flow Control","description":"This blog post outlines ten advantages of AMQP 1.0 flow control over AMQP 0.9.1, supported by two benchmarks demonstrating significant performance gains.","datePublished":"2024-09-02T00:00:00.000Z","author":{"@type":"Person","name":"David Ansari","url":"https://github.com/ansd","image":"https://github.com/ansd.png"},"image":{"@type":"ImageObject","@id":"https://www.rabbitmq.com/rabbitmq-website/assets/images/figure-2-45-465ed496160578f3f8516c4a6e762756.png","url":"https://www.rabbitmq.com/rabbitmq-website/assets/images/figure-2-45-465ed496160578f3f8516c4a6e762756.png","contentUrl":"https://www.rabbitmq.com/rabbitmq-website/assets/images/figure-2-45-465ed496160578f3f8516c4a6e762756.png","caption":"title image for the blog post: Ten Benefits of AMQP 1.0 Flow Control"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">Ten Benefits of AMQP 1.0 Flow Control</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-09-02T00:00:00.000Z">September 2, 2024</time> · <!-- -->32 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/ansd.png" alt="David Ansari"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">David Ansari</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/ansd/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://m.ansd.xyz/@ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Mastodon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 61 65" width="1em" height="1em" class="authorSocialLink_owbf"><path fill="url(#:Rfndbeh:)" d="M60.754 14.39C59.814 7.406 53.727 1.903 46.512.836 45.294.656 40.682 0 29.997 0h-.08C19.23 0 16.938.656 15.72.836 8.705 1.873 2.299 6.82.745 13.886c-.748 3.48-.828 7.338-.689 10.877.198 5.075.237 10.142.697 15.197a71.482 71.482 0 0 0 1.664 9.968c1.477 6.056 7.458 11.096 13.317 13.152a35.718 35.718 0 0 0 19.484 1.028 28.365 28.365 0 0 0 2.107-.576c1.572-.5 3.413-1.057 4.766-2.038a.154.154 0 0 0 .062-.118v-4.899a.146.146 0 0 0-.055-.111.145.145 0 0 0-.122-.028 54 54 0 0 1-12.644 1.478c-7.328 0-9.298-3.478-9.863-4.925a15.258 15.258 0 0 1-.857-3.882.142.142 0 0 1 .178-.145 52.976 52.976 0 0 0 12.437 1.477c1.007 0 2.012 0 3.02-.026 4.213-.119 8.654-.334 12.8-1.144.103-.02.206-.038.295-.065 6.539-1.255 12.762-5.196 13.394-15.176.024-.393.083-4.115.083-4.523.003-1.386.446-9.829-.065-15.017Z"></path><path fill="#fff" d="M50.394 22.237v17.35H43.52V22.749c0-3.545-1.478-5.353-4.483-5.353-3.303 0-4.958 2.139-4.958 6.364v9.217h-6.835V23.76c0-4.225-1.657-6.364-4.96-6.364-2.988 0-4.48 1.808-4.48 5.353v16.84H10.93V22.237c0-3.545.905-6.362 2.715-8.45 1.868-2.082 4.317-3.152 7.358-3.152 3.519 0 6.178 1.354 7.951 4.057l1.711 2.871 1.714-2.871c1.773-2.704 4.432-4.056 7.945-4.056 3.038 0 5.487 1.069 7.36 3.152 1.81 2.085 2.712 4.902 2.71 8.449Z"></path><defs><linearGradient id=":Rfndbeh:" x1="30.5" x2="30.5" y1="0" y2="65" gradientUnits="userSpaceOnUse"><stop stop-color="#6364FF"></stop><stop offset="1" stop-color="#563ACC"></stop></linearGradient></defs></svg></a><a href="https://bsky.app/profile/ansd.xyz" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>This blog post outlines ten advantages of AMQP 1.0 flow control over AMQP 0.9.1, supported by two benchmarks demonstrating significant performance gains.
Additionally, we delve into the powerful AMQP 1.0 flow control primitives and how they are used in RabbitMQ.</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Flow_control_(data)" target="_blank" rel="noopener noreferrer">Flow control</a> is the process of managing the rate of data transmission between two nodes to prevent a fast sender from overwhelming a slow receiver.</p>
</blockquote>
<p>The AMQP 1.0 protocol defines flow control at two different levels:</p>
<ol>
<li><a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-flow-control" target="_blank" rel="noopener noreferrer">Link Flow Control</a></li>
<li><a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-session-flow-control" target="_blank" rel="noopener noreferrer">Session Flow Control</a></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="link-flow-control">Link Flow Control<a href="#link-flow-control" class="hash-link" aria-label="Direct link to Link Flow Control" title="Direct link to Link Flow Control">​</a></h2>
<p>In AMQP 1.0, messages are sent over a <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#section-links" target="_blank" rel="noopener noreferrer">link</a>.
A link connects either a sending client application to an <a href="/rabbitmq-website/tutorials/amqp-concepts#exchanges">exchange</a> in RabbitMQ or a <a href="/rabbitmq-website/tutorials/amqp-concepts#queues">queue</a> in RabbitMQ to a consuming client application.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>While the AMQP 1.0 specification uses the terms &quot;senders&quot; and &quot;receivers&quot;, the RabbitMQ documentation refers to <a href="/rabbitmq-website/docs/publishers">&quot;publishers&quot;</a> (or &quot;producers&quot;) and <a href="/rabbitmq-website/docs/consumers">&quot;consumers&quot;</a>.
When discussing client applications, these terms can be used interchangeably. Therefore, a client application instance that:</p><ul>
<li>Sends messages to RabbitMQ is a <strong>sender</strong> / <strong>publisher</strong> / <strong>producer</strong> (with RabbitMQ acting as the <strong>receiver</strong>).</li>
<li>Receives messages from RabbitMQ is a <strong>receiver</strong> / <strong>consumer</strong> (with RabbitMQ acting as the <strong>sender</strong>).</li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="link-credit">Link-Credit<a href="#link-credit" class="hash-link" aria-label="Direct link to Link-Credit" title="Direct link to Link-Credit">​</a></h3>
<p>The central idea behind AMQP 1.0 link flow control is simple:
<strong>To receive messages, a consumer must grant credits to the sending queue.</strong></p>
<p>One credit corresponds to one message.
For example, when the consumer grants 10 credits, RabbitMQ is allowed to send 10 messages.
This straightforward principle, where the receiver provides <strong>feedback</strong> to the sender, ensures that the sender never overwhelms the receiver.</p>
<p>Both the receiver and sender maintain their own &quot;link state&quot;.
Part of this state is the current link credit.
Link credit decreases by 1 each time a message is transferred.
Specifically, the sender reduces link credit by 1 when it sends a message, and the receiver reduces link credit by 1 when it receives a message.
When the sender&#x27;s link credit reaches 0, it must stop sending messages.</p>
<p>Messages are sent in <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer" target="_blank" rel="noopener noreferrer">transfer</a> frames.</p>
<p>Credits are granted in <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frames:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">link-credit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">uint</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you might have guessed, they are called &quot;flow&quot; frames because these frames carry flow control information.
The type <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-types-v1.0-os.html#type-uint" target="_blank" rel="noopener noreferrer">uint</a> stands for unsigned integer, a value between 0 and a large number (2^32 - 1).</p>
<p>Even after the link is successfully set up (&quot;<a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-idp315568" target="_blank" rel="noopener noreferrer">attached</a>&quot; in AMQP 1.0 terms), RabbitMQ is not allowed to start sending messages to the consumer until the consumer sends its first <code>flow</code> frame, granting link credit to the sending queue.</p>
<p>In its simplest form, when a client (receiver) grants a single credit to the queue (sender), the queue will send a single message, as illustrated in <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-idp416352" target="_blank" rel="noopener noreferrer">Figure 2.43: Synchronous Get</a> of the AMQP 1.0 specification:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Receiver                                      Sender</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow(link-credit=1)               ----------&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        +---- transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*block until transfer arrives*         /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &lt;---+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------------------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Synchronously getting a single message at a time will result in low throughput. Therefore, a client typically grants multiple credits to a queue, as shown in <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-idp424576" target="_blank" rel="noopener noreferrer">Figure 2.45: Asynchronous Notification</a> of the AMQP 1.0 specification:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Receiver                                          Sender</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=====================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &lt;----------     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &lt;----------     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow(link-credit=delta)           ---+   +---     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      \ /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      / \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &lt;--+   +--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &lt;----------     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &lt;----------     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow(link-credit=delta)           ---+   +---     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      \ /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      / \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &lt;--+   +--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------------------------------------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the receiver grants N credits and waits for <strong>all</strong> N messages to arrive before granting the next N credits, throughput will be higher compared to figure 2.43 where <code>N=1</code>.
However, if you look closely at figure 2.45, you will observe that the receiver grants more credits before receiving all previous messages.
This approach results in the highest throughput.
For example, in figure 2.45, the receiver might have granted 6 credits initially, and then sends another <code>flow</code> frame with <code>link-credit = 6</code> to RabbitMQ whenever it has received 3 messages.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Granting link credit is not cumulative.</p><p>When the receiver sends a <code>flow</code> frame with <code>link-credit = N</code>, the receiver <strong>sets</strong> the current credit to N instead of adding N more credits.
For example, if a receiver sends two <code>flow</code> frames with <code>link-credit = 50</code> without any messages being transferred in between, the receiver will have 50 credits, not 100.</p></div></div>
<p>The receiver knows its current processing capacity and therefore it is always the receiver (and never the sender) that determines the current link credit.
The sender only &quot;consumes&quot; link credit granted by the receiver by sending more messages.</p>
<p>The receiver is allowed to dynamically increase or decrease the amount of link credit depending on its current processing capacity.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #1</div><div class="admonitionContent_BuS1"><p><strong>A consuming client application can dynamically adjust how many messages it wants to receive from a specific queue.</strong></p><p>This is a great advantage of link flow control in AMQP 1.0 over <a href="/rabbitmq-website/docs/consumer-prefetch">consumer prefetch</a> in AMQP 0.9.1.
In AMQP 0.9.1, the <a href="https://github.com/rabbitmq/amqp-0.9.1-spec/blob/main/pdf/amqp-xml-doc0-9-1.pdf" target="_blank" rel="noopener noreferrer">basic.qos</a> method applies to <strong>all</strong> consumers on the given <a href="/rabbitmq-website/docs/channels">AMQP 0.9.1 channel</a>.
Furthermore, dynamically updating the consumer prefetch is not possible or convenient, as discussed in <a href="https://github.com/rabbitmq/rabbitmq-server/discussions/10174" target="_blank" rel="noopener noreferrer">#10174</a> and <a href="https://github.com/rabbitmq/rabbitmq-server/discussions/11955" target="_blank" rel="noopener noreferrer">#11955</a>.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #2</div><div class="admonitionContent_BuS1"><p><strong>A consuming client application can dynamically prioritize which queue(s), out of multiple queues on the same session, it wants to receive messages from.</strong></p><p>This is another advantage of link flow control in AMQP 1.0 over <a href="/rabbitmq-website/docs/consumer-prefetch">consumer prefetch</a> in AMQP 0.9.1.
Once an AMQP 0.9.1 client calls <code>basic.consume</code> on multiple queues, it will continuously receive messages from all these queues until it calls <code>basic.cancel</code>.</p></div></div>
<p>You might wonder: What are good values for link-credit and how often should the client top up link credit?
As is often the case, the answer is that you will need to benchmark your specific workload with different values to find out.</p>
<p>Instead of implementing fancy algorithms, I would recommend starting simple:
for example, the client could initially grant 200 link credits and send a flow with <code>link-credit = 200</code> whenever the remaining link credit falls below 100.</p>
<p>In fact, this is what RabbitMQ does the other way around:
The RabbitMQ AMQP 1.0 <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.x/deps/rabbit/src/rabbit_amqp_session.erl" target="_blank" rel="noopener noreferrer">session process</a> grants initially <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.x/deps/rabbit/src/rabbit_amqp_session.erl#L52" target="_blank" rel="noopener noreferrer">170 link credits</a> to the publisher, and grants again 170 link credits when the remaining link credit falls below half (i.e. 85) <strong>and</strong> the number of unconfirmed messages is less than 170.
(Internally on the broker, publisher confirms are always enabled between AMQP 1.0 session process and target queues, even when no confirms are sent to the publishing client.
This means that if the target queue does not confirm fast enough, RabbitMQ stops granting link credit to the sending application.)
Please note that these RabbitMQ implementation details can change at any time.</p>
<p>The value of <code>170</code> is configurable via <a href="/rabbitmq-website/docs/configure#advanced-config-file">advanced.config</a> setting <code>rabbit.max_link_credit</code>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #3</div><div class="admonitionContent_BuS1"><p><strong>When one target queue is overloaded, the publisher can continue publishing at high speed to all other target queues.</strong></p><p>Applications can send to multiple queues on the same AMQP 1.0 connection or session (by attaching multiple links).
Let&#x27;s assume a simple scenario where a client opens two links:</p><ul>
<li>Link 1 sends to a classic queue.</li>
<li>Link 2 sends to a 5-replica quorum queue.</li>
</ul><p>Before confirming a message, the quorum queue must have replicated the message to a majority of replicas, with each replica <a href="https://man7.org/linux/man-pages/man2/fsync.2.html" target="_blank" rel="noopener noreferrer">fsync</a>ing the message to its local disk.</p><p>In contrast, classic queues do not replicate messages.
Furthermore, when a message is consumed and acknowledged quickly enough, classic queues can (thereafter) confirm the message back to the publisher without ever writing it to disk.
Hence, in this scenario, throughput for the classic queue will be far higher than for the quorum queue.</p><p>The beauty of AMQP 1.0 link flow control is that RabbitMQ can slow down granting credits on Link 2 while continuing to grant credits on Link 1 at a high frequency.
Therefore, even when the 5-replica quorum queue does not process messages as quickly as the (single replica) classic queue, the client can continue to send at full speed to the classic queue.</p><p>The following picture is copied from a <a href="/rabbitmq-website/blog/2020/05/04/quorum-queues-and-flow-control-the-concepts#quorum-queues">previous</a> AMQP 0.9.1 blog post:</p><p></p><figure><img decoding="async" loading="lazy" alt="Flow control in AMQP 0.9.1" src="/rabbitmq-website/assets/images/credit-flow-quorum-queue-da23589562b76b48019f48ba8e1e2753.png" width="625" height="538" class="img_ev3q"><figcaption>Flow control in AMQP 0.9.1</figcaption></figure><p></p><p>The word &quot;credit&quot; in this picture refers to RabbitMQ&#x27;s internal flow control for AMQP 0.9.1 connections and is unrelated to link credit in AMQP 1.0.</p><p>The <code>reader</code> in the above picture is the Erlang process that reads AMQP 0.9.1 frames from the socket.
The picture shows that for AMQP 0.9.1 connections, RabbitMQ will block the <code>reader</code>, causing TCP backpressure to be applied to the client.
Therefore, when a single target queue becomes overloaded, RabbitMQ throttles the AMQP 0.9.1 connection, affecting the publishing to all other target queues.</p><p>The following benchmark shows how AMQP 1.0 can provide multiple times higher throughput compared to AMQP 0.9.1 when a connection sends to more than one target queue.</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Benchmark: Two senders</summary><div><div class="collapsibleContent_i85q"><p>To put the theory we just discussed into practice, the <a href="https://github.com/ansd/rabbitmq-amqp/blob/v0.1.0/two_senders/main.go" target="_blank" rel="noopener noreferrer">two_senders</a> program simulates a similar scenario.</p><p>This program opens a single AMQP 0.9.1 connection and channel, as well as a single AMQP 1.0 connection and session.</p><p>On both the AMQP 0.9.1 channel and the AMQP 1.0 session, there are two goroutines that publish as quickly as possible into a classic queue and a quorum queue.
This results in four target queues in total:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    main.go                                                      RabbitMQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+                                     +----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |        AMQP 0.9.1 connection        |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |#####################################|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+    |-------------------------------------|    +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | P |                                               | classic-queue-amqp-091 |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                        AMQP 0.9.1 channel                                            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | P |                                               | quorum-queue-amqp-091  |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+    |-------------------------------------|    +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |#####################################|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |                                     |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |                                     |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |                                     |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |#####################################|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+    |-------------------------------------|    +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | P |O============================================&gt;O| classic-queue-amqp-10 |     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                        AMQP 1.0 session                                              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | P |O======================================+=====&gt;O| quorum-queue-amqp-10  |     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +-+-+    |----------------------------------|--|    +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      |      |##################################|##|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      |      |        AMQP 1.0 connection       |  |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------|------+                                  |  +----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |                                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |                                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Publisher                               AMQP 1.0 link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   goroutine</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run the benchmark as follows:</p><ol>
<li>Start RabbitMQ server <a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.0.0-beta.6" target="_blank" rel="noopener noreferrer">v4.0.0-beta.6</a> using <code>make run-broker</code> on an Ubuntu box. (On macOS, <code>fsync</code> does not write physically to the platters).</li>
<li>Execute the Go program with <code>go run two_senders/main.go</code>. After 10 seconds, the Go program will complete.</li>
<li>List the number of messages in each queue:</li>
</ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./sbin/rabbitmqctl --silent list_queues name type messages --formatter=pretty_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────┬─────────┬──────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name                   │ type    │ messages │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ classic-queue-amqp-091 │ classic │ 159077   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ quorum-queue-amqp-091  │ quorum  │ 155782   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ classic-queue-amqp-10  │ classic │ 1089075  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ quorum-queue-amqp-10   │ quorum  │ 148580   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────┴─────────┴──────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As explained in the <a href="/rabbitmq-website/blog/2024/08/21/amqp-benchmarks#quorum-queues">AMQP 1.0 Benchmarks</a> blog post, quorum queues <a href="https://man7.org/linux/man-pages/man2/fsync.2.html" target="_blank" rel="noopener noreferrer">fsync</a> (<code>fdatasync</code> to be precise), whereas classic queues do not.
Therefore, even without replication, a quorum queue is significantly slower than a classic queue because I use a consumer-grade disk where each <code>fsync</code> takes at least 5 milliseconds.
For production clusters, it is recommended to use high-end, enterprise-grade disks that <code>fsync</code> faster.</p><p>The results show that the single AMQP 0.9.1 connection sends roughly the same number of messages to both the target classic queue and the target quorum queue.
This is because <code>quorum-queue-amqp-091</code> causes the entire AMQP 0.9.1 connection to be blocked (and unblocked) around 80 times per second in my benchmark.
As a result, the publishing rate to multiple target queues (<code>classic-queue-amqp-091</code> and <code>quorum-queue-amqp-091</code>) on a single AMQP 0.9.1 connection is constrained by the slowest target queue (<code>quorum-queue-amqp-091</code>).
In total, the AMQP 0.9.1 connection sends <code>159,077 + 155,782 = 314,859</code> messages.</p><p>In contrast, thanks to link flow control, RabbitMQ throttles only the link to the <code>quorum-queue-amqp-10</code> <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-target" target="_blank" rel="noopener noreferrer">target</a>, allowing the AMQP 1.0 client to continue publishing at full speed to the <code>classic-queue-amqp-10</code> target.
In total, the AMQP 1.0 connection sends <code>1,089,075 + 148,580 = 1,237,655</code> messages.</p><p>Therefore, in our simple benchmark, the total send throughput of AMQP 1.0 is four times (!) higher than that of AMQP 0.9.1.</p></div></div></details></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #4</div><div class="admonitionContent_BuS1"><p><strong>When one target queue is overloaded, the client can continue consuming at high speed from all source queues.
Therefore, AMQP 1.0 clients can use a single connection for both publishing and consuming at high throughput.</strong></p><p>Benefit #3 described how a single overloaded target queue causes RabbitMQ to block the reader process from reading any AMQP 0.9.1 frames.
This means that not only can the client no longer publish messages, but it also <strong>cannot consume</strong> messages.
This is because the client&#x27;s message <a href="/rabbitmq-website/docs/confirms#acknowledgement-modes">acknowledgements</a> are no longer processed by RabbitMQ, preventing the delivery of new messages to the consumer once its <a href="/rabbitmq-website/docs/confirms#channel-qos-prefetch">prefetch</a> limit is reached.</p><p>Although this throttling in consumption is temporary (with the AMQP 0.9.1 <code>reader</code> process being blocked and unblocked many times per second), it can significantly reduce the consumption rate.</p><p>The RabbitMQ AMQP 0.9.1 <a href="/rabbitmq-website/docs/connections#flow-control">documentation</a> advises:</p><blockquote>
<p>It is therefore recommended that, when possible, publishers and consumers use separate connections so that consumers are isolated from potential flow control that may be applied to publishing connections, affecting manual consumer acknowledgements.</p>
</blockquote><p>This has led to an entire ecosystem of AMQP 0.9.1 client libraries adopting this &quot;best practice&quot; of using separate connections for publishing and consuming.
For example the RabbitMQ AMQP 0.9.1 C++ library <a href="https://github.com/bloomberg/rmqcpp/blob/1.0.0/README.md#features" target="_blank" rel="noopener noreferrer">states</a>:</p><blockquote>
<p>Publishing and Consuming happens on different connections:</p>
<p>A common application pitfall is to consume &amp; produce on the same connection.
This can cause slow-downs in consumption rate, as RabbitMQ applies backpressure to fast publishers - depending on the exact queues being consumed/published from this can cause a vicious cycle.</p>
</blockquote><p>In contrast, AMQP 1.0 link flow control allows to slow down only the link sender in the client application.
All other links (whether sending or consuming) can continue to operate at full speed.</p><p>Therefore, in AMQP 1.0, clients can use a single connection for both publishing and consuming.</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Benchmark: One sender, one receiver</summary><div><div class="collapsibleContent_i85q"><p>Program <a href="https://github.com/ansd/rabbitmq-amqp/blob/v0.1.0/one_sender_one_receiver/main.go" target="_blank" rel="noopener noreferrer">one_sender_one_receiver</a> simulates a scenario where a client opens two links:</p><ul>
<li>Link 1 receives from a classic queue.</li>
<li>Link 2 sends to a quorum queue.</li>
</ul><p>This program opens a single AMQP 0.9.1 connection and channel, as well as a single AMQP 1.0 connection and session.</p><p>To prepare for the benchmark, the program writes one million messages into each classic queue.</p><p>On both the AMQP 0.9.1 channel and the AMQP 1.0 session, there are two goroutines:</p><ul>
<li>One goroutine (Link 1) that receives messages with a prefetch of 200 from the classic queue and acknowledges each one.</li>
<li>One goroutine (Link 2) that publishes in batches of 10,000 messages to the quorum queue.
(After all 10,000 confirmations are received, the next batch is published.)</li>
</ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    main.go                                                      RabbitMQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+                                     +----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |        AMQP 0.9.1 connection        |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |#####################################|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+    |-------------------------------------|    +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | C |                                               | classic-queue-amqp-091 |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                        AMQP 0.9.1 channel                                            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | P |                                               | quorum-queue-amqp-091  |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+    |-------------------------------------|    +------------------------+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |#####################################|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |                                     |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |                                     |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |                                     |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |#####################################|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+    |-------------------------------------|    +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | C |O&lt;============================================O| classic-queue-amqp-10 |     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                        AMQP 1.0 session                                              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +---+                                               +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    | P |O======================================+=====&gt;O| quorum-queue-amqp-10  |     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    +-+-+    |----------------------------------|--|    +-----------------------+     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      |      |##################################|##|                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      |      |        AMQP 1.0 connection       |  |                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------|------+                                  |  +----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |                                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |                                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Publisher or Consumer                      AMQP 1.0 link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   goroutine</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run the benchmark as follows:</p><ol>
<li>Start RabbitMQ server <a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.0.0-beta.6" target="_blank" rel="noopener noreferrer">v4.0.0-beta.6</a> using <code>make run-broker</code> on an Ubuntu box.</li>
<li>Execute the Go program with <code>go run one_sender_one_receiver/main.go</code></li>
<li>Once the program completes, list the number of messages in each queue:</li>
</ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./sbin/rabbitmqctl --silent list_queues name type messages --formatter=pretty_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────┬─────────┬──────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ name                   │ type    │ messages │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ classic-queue-amqp-091 │ classic │ 990932   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ quorum-queue-amqp-091  │ quorum  │ 172800   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │ classic-queue-amqp-10  │ classic │ 336229   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────┼─────────┼──────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ quorum-queue-amqp-10   │ quorum  │ 130000   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────┴─────────┴──────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>While the AMQP 0.9.1 client consumes only <code>1,000,000 - 990,932 = 9,068</code> messages, the AMQP 1.0 client consumes <code>1,000,000 - 336,229 = 663,771</code> messages.</p><p>Therefore, in this benchmark, the AMQP 1.0 client receives 73 times (!) more messages than the AMQP 0.9.1 client.</p></div></div></details></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>In AMQP 0.9.1, <a href="/rabbitmq-website/docs/consumer-prefetch">consumer prefetch</a> limits the number of unacknowledged messages.
When a consumer acknowledges messages by sending <code>basic.ack</code> frames, RabbitMQ delivers additional messages.</p><p>In AMQP 1.0, message acknowledgment is independent of link flow control.
A consumer acknowledging messages by sending <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-disposition" target="_blank" rel="noopener noreferrer">disposition</a> frames will not prompt RabbitMQ to deliver more messages.
Instead, the client must replenish link credit by sending <code>flow</code> frames for RabbitMQ to continue sending messages.
For convenience, some AMQP 1.0 client libraries automatically send both <code>disposition</code> and <code>flow</code> frames when your application acknowledges messages.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="delivery-count">Delivery-Count<a href="#delivery-count" class="hash-link" aria-label="Direct link to Delivery-Count" title="Direct link to Delivery-Count">​</a></h3>
<p>So far, we understand only one field of the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frame: <code>link-credit</code>.</p>
<p>What happens in the following scenario?</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Receiver                                  Sender</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=======================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link state:                               link state:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> link-credit = 3                           link-credit = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow(link-credit = 6)     ---+   +---     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              \ /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              / \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &lt;--+   +--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link state:                               link state:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> link-credit = 5                           link-credit = 6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Initially, <code>link-credit</code> is 3.
The receiver decides to send a <code>flow</code> frame, setting the new <code>link-credit</code> to 6.
In parallel, the sender sends a <code>transfer</code> frame.</p>
<p>Since the receiver received the <code>transfer</code> frame after it sent the <code>flow</code> frame, it will compute its new link-credit as <code>6 - 1 = 5</code>.
However, because the sender received the <code>flow</code> frame after it sent the <code>transfer</code> frame, it will set the credit to 6.
As a result, the state - and therefore the view of how many credits the link has left - becomes misaligned.
This is problematic because the sender could potentially overflow the receiver.</p>
<p>To prevent such misalignments, a second field is needed in both the link state and the <code>flow</code> frame:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">delivery-count</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">sequence-no</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The delivery-count is increased by 1 each time a message is transferred.
Specifically, the sender increments the delivery-count whenever it sends a message, and the receiver increments the delivery-count whenever it receives a message.</p>
<p>When the sender receives a <code>flow</code> frame (which contains both link-credit and delivery-count), the sender sets its link-credit according to this <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-flow-control" target="_blank" rel="noopener noreferrer">formula</a>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">link-credit(snd) := delivery-count(rcv) + link-credit(rcv) - delivery-count(snd).</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>(snd)</code> refers to the link state at the sender, while the link state at the receiver <code>(rcv)</code> is sent within the <code>flow</code> frame to the sender.</p>
<p>At the sender, this formula means:
&quot;Set the new link-credit to the link-credit I just received in the flow frame minus any in-flight deliveries.&quot;</p>
<p>The purpose of the delivery-count is to establish an order in the sequence of events, which are:</p>
<ul>
<li>Sender sends message</li>
<li>Receiver receives message</li>
<li>Receivers grants link-credit</li>
<li>Sender computes receiver&#x27;s link-credit</li>
</ul>
<p>Using the delivery-count resolves the misalignment issue we discussed earlier.</p>
<p>Let’s assume the delivery-count is initially set to 20:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Receiver                                      Sender</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">========================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link state:                                   link state:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> delivery-count = 20                           delivery-count = 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> link-credit = 3                               link-credit = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow(delivery-count = 20,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     link-credit = 6)         ---+   +---     transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  \ /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  / \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              &lt;--+   +--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link state:                                   link state:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> delivery-count = 21                           delivery-count = 21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> link-credit = 5                               link-credit = 20+6-21 = 5 (above formula)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Some AMQP 1.0 fields, including the delivery-count are of type <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-sequence-no" target="_blank" rel="noopener noreferrer">sequence-no</a>.
These are 32-bit <a href="https://www.ietf.org/rfc/rfc1982.txt" target="_blank" rel="noopener noreferrer">RFC-1982</a> serial numbers that range from <code>[0 .. 4,294,967,295]</code> and wrap around: Adding 1 to 4,294,967,295 results in 0.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The delivery-count is initialized by the sender, which sends its chosen value in the <code>initial-delivery-count</code> field of the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-attach" target="_blank" rel="noopener noreferrer">attach</a> frame.</p><p>The sender can initialize the delivery-count to any value it chooses, such as 0, 10, or 4,294,967,295.
This value has no intrinsic meaning beyond the purpose we discussed earlier: comparing the delivery-count of the receiver with that of the sender to determine how many messages are in-flight.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>From what I can tell, the AMQP 1.0 link flow control seems to be based on the paper <a href="https://www.eecs.harvard.edu/~htk/publication/1995-ieee-network-kung-morris.pdf" target="_blank" rel="noopener noreferrer">Credit-Based Flow Control for ATM Networks</a> from 1995.</p><p>The formula</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">link-credit(snd) := delivery-count(rcv) + link-credit(rcv) - delivery-count(snd).</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>from the AMQP 1.0 specification in section <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-flow-control" target="_blank" rel="noopener noreferrer">2.6.7</a> matches the formula</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Crd_Bal = Buf_Alloc - (Tx_Cnt - Fwd_Cnt)(1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>in the paper.</p><p>The AMQP 1.0 specification even adopts similar terminology from the paper, such as &quot;link&quot; and &quot;node.&quot;
Furthermore, the specification likely refers to &quot;delivery-count&quot; because it is called &quot;count&quot; in the paper as well (even though the specification clarifies that in AMQP it&#x27;s not actually a count, but rather a sequence number).</p><p>Figure 2 in the paper illustrates the concept nicely:</p><p></p><figure><img decoding="async" loading="lazy" alt="Credit-Based Flow Control for ATM Networks, Figure 2: Credit Update Protocol" src="/rabbitmq-website/assets/images/figure-2-credit-update-protocol-a457495495711e1e2a6015597b64714e.png" width="1546" height="966" class="img_ev3q"><figcaption>Credit-Based Flow Control for ATM Networks, Figure 2: Credit Update Protocol</figcaption></figure><p></p><p>In this figure:</p><ul>
<li><code>Tx_Cnt</code> corresponds to <code>delivery-count(snd)</code></li>
<li><code>Fwd_Cnt</code> corresponds to <code>delivery-count(rcv)</code></li>
<li><code>Crd_Bal</code> corresponds to <code>link-credit(snd)</code></li>
<li><code>Buf_Alloc</code> corresponds to <code>link-credit(rcv)</code></li>
</ul><p>The paper explains in detail how frequently and by how much a receiver should top up link credit.
If you want to become an expert in AMQP 1.0 flow control, I recommend reading both the AMQP 1.0 specification and the paper.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="drain">Drain<a href="#drain" class="hash-link" aria-label="Direct link to Drain" title="Direct link to Drain">​</a></h3>
<p>Having understood the two most important link control fields of the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frame (<code>link-credit</code> and <code>delivery-count</code>), let&#x27;s move on to the <code>drain</code> field:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">drain</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">boolean</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">default</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">false</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By default, the <code>drain</code> field is set to <code>false</code>.
The receiver decides whether drain mode is enabled, and the sender sets <code>drain</code> to the last known value from the receiver.</p>
<p>Draining means that the sender should use all link credit from the receiver by sending available messages.
If there are not enough messages to send, the sender must still exhaust all link credit as follows:</p>
<ol>
<li>Advance the delivery-count by the remaining link-credit.</li>
<li>Set link-credit to 0.</li>
<li>Send a <code>flow</code> frame to the receiver.</li>
</ol>
<p>By setting the <code>drain</code> field to <code>true</code>, the consumer requests RabbitMQ to &quot;Either send a <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer" target="_blank" rel="noopener noreferrer">transfer</a> or a <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frame.&quot;
If the source queue is empty, RabbitMQ will promptly reply with only a <code>flow</code> frame.</p>
<p>Therefore, the <code>drain</code> field allows a consumer to set a timeout when synchronously getting messages, as shown in <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-idp416352" target="_blank" rel="noopener noreferrer">Figure 2.44: Synchronous Get with a Timeout</a> of the AMQP 1.0 specification:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Receiver                                      Sender</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    =================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow(link-credit=1)               ----------&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *wait for link-credit &lt;= 0*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow(drain=True)                  ---+   +--- transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          \ /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          / \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1)                                   &lt;--+   +--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2)                                   &lt;---------- flow(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -----------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (1) If a message is available within the timeout, it will</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          arrive at this point.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (2) If a message is not available within the timeout, the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          drain flag will ensure that the sender promptly advances the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          delivery-count until link-credit is consumed.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Because the link-credit is consumed quickly, the consumer can unambiguously determine whether a message was received or if the operation timed out.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="echo">Echo<a href="#echo" class="hash-link" aria-label="Direct link to Echo" title="Direct link to Echo">​</a></h3>
<p>Similar to the <code>drain</code> field, the <code>echo</code> field is:</p>
<ul>
<li>set to <code>false</code> by default</li>
<li>determined by the consumer, as RabbitMQ does not set this field in its current implementation</li>
</ul>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">echo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">boolean</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">default</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">false</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The consumer can set the <code>echo</code> field to request RabbitMQ to reply with a <code>flow</code> frame.
One use case is depicted in <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-idp429232" target="_blank" rel="noopener noreferrer">Figure 2.46: Stopping Incoming Messages</a> of the AMQP 1.0 specification:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Receiver                                       Sender</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       &lt;---------- transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow(...,                          ---+   +--- transfer(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         link-credit=0,                    \ /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         echo=True)                         x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           / \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1)                                    &lt;--+   +--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2)                                    &lt;---------- flow(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ----------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (1) In-flight transfers can still arrive until the flow state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          is updated at the sender.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (2) At this point no further transfers will arrive.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #5</div><div class="admonitionContent_BuS1"><p><strong>In AMQP 1.0, a consumer can be stopped/paused and later resumed.</strong></p><p>In AMQP 0.9.1, a consumer cannot be paused and resumed. Instead, the consumer must be cancelled using the <code>basic.cancel</code> method before registering a new consumer with <code>basic.consume</code>.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #6</div><div class="admonitionContent_BuS1"><p><strong>AMQP 1.0 allows a graceful handoff from one <a href="/rabbitmq-website/docs/consumers#single-active-consumer">single active consumer</a> to the next, while maintaining message order.</strong></p><p>In AMQP 1.0, the consumer can either stop the link first and acknowledge messages before <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-detach" target="_blank" rel="noopener noreferrer">detach</a>ing the link (preferred), or detach the link directly.
Detaching the link directly will requeue any unacknowledged messages.
Either way, detaching the link causes the next consumer to be activated and to receive the messages in the original order.</p><p>In contrast, a single active consumer in AMQP 0.9.1 cannot gracefully and safely hand over to the next one.
When an AMQP 0.9.1 consumer cancels consumption via <code>basic.cancel</code> but still has unacknowledged messages, the queue will activate the next consumer.
If the AMQP 0.9.1 client crashes shortly after, messages checked out to the old consumer will be requeued, potentially violating message order.
To maintain message order, an AMQP 0.9.1 client must close the entire channel (without calling <code>basic.cancel</code> first) so that messages are requeued before the next consumer is activated.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="available">Available<a href="#available" class="hash-link" aria-label="Direct link to Available" title="Direct link to Available">​</a></h3>
<p>RabbitMQ sets the <code>available</code> field in the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frame to inform the consumer how many messages are available:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">available</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">uint</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>available</code> value is only an approximation because, from the time the queue emits this information until the <code>flow</code> frame arrives at the consumer, this information can already be outdated, for instance when other clients publish messages to or consume messages from this queue.</p>
<p>For <a href="/rabbitmq-website/docs/classic-queues">classic queues</a> and <a href="/rabbitmq-website/docs/quorum-queues">quorum queues</a>, <code>available</code> indicates the number of messages ready for delivery (i.e. the queue length excluding messages that are checked out to consumers).</p>
<p>For <a href="/rabbitmq-website/docs/streams">streams</a>, <code>available</code> represents the difference between the committed offset and the last consumed <a href="/rabbitmq-website/docs/streams#consuming">offset</a>.
Roughly, the committed offset is what the different stream <a href="/rabbitmq-website/docs/streams#replication-factor">replicas</a> in the RabbitMQ cluster agree is the end of the stream.
The last consumed offset might be the same as the committed offset or lag behind it.
The <code>available</code> value is merely an estimate because <a href="/rabbitmq-website/docs/streams#limitations-ui-metrics">a stream offset does not necessarily represent a message</a>.</p>
<p>If the <a href="/rabbitmq-website/docs/consumers#single-active-consumer">Single Active Consumer</a> feature is enabled, quorum queues will return <code>available = 0</code> for all inactive (waiting) consumers.
This makes sense since no messages are available for inactive consumers, regardless of how much credit they have topped up.</p>
<p>In the <a href="#echo">previous</a> section, we learned that one use case for the consumer setting the <code>echo</code> field is to stop a link.
Another use case is when a consumer wants to learn about the number of messages available in the queue it consumes from.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #7</div><div class="admonitionContent_BuS1"><p><strong>AMQP 1.0 informs the consumer about the number of messages available in the queue.</strong></p><p>Including this information in every <code>flow</code> frame sent from RabbitMQ to the consumer is an advantage over AMQP 0.9.1.
In AMQP 0.9.1, methods to query available messages are more cumbersome and less efficient:</p><ul>
<li><code>queue.declare</code> with <code>passive=true</code>: The <code>queue.declare_ok</code> reply will contain a <code>message_count</code> field.</li>
<li><code>basic.get</code>: The <code>basic.get_ok</code> reply will contain a <code>message_count</code> field.</li>
</ul></div></div>
<p>The <code>available</code> field could also be set by a publisher to tell RabbitMQ how many messages the publisher has available to send.
Currently, RabbitMQ ignores this information.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="properties">Properties<a href="#properties" class="hash-link" aria-label="Direct link to Properties" title="Direct link to Properties">​</a></h3>
<p>The <code>properties</code> field of the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frame can carry application specific link state properties:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">properties</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">fields</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Currently, RabbitMQ does not make use of this field.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #8</div><div class="admonitionContent_BuS1"><p><strong>AMQP 1.0 link flow control is extensible.</strong></p><p>Imagine that RabbitMQ wants to enable publishers to send messages directly to the quorum queue leader.
Since all <a href="https://github.com/rabbitmq/ra" target="_blank" rel="noopener noreferrer">Ra</a> commands, including enqueuing a message, must go through the leader first, it would make sense for the client to connect directly to the RabbitMQ node that hosts the quorum queue leader.
This &quot;queue locality&quot; would reduce RabbitMQ intra-cluster traffic, thereby improving latency and throughput.
When the leader changes, instead of causing RabbitMQ to <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-detach" target="_blank" rel="noopener noreferrer">detach</a> the link - which could be disruptive to the publishing application - RabbitMQ could push a leader change notification, including the new RabbitMQ node hosting the quorum queue leader, to the publisher via the <code>properties</code> field.
The application could then decide when it is convenient to detach the link and attach a new link on a different connection to continue publishing &quot;locally&quot;.</p><p>Alternatively, RabbitMQ could send a boolean value for a key <code>local</code> in every <code>flow</code> frame&#x27;s <code>properties</code> field to indicate whether the link is currently publishing or consuming locally.
If the <code>local</code> field flips from <code>true</code> to <code>false</code>, the client could query the new queue topology and leader via <a href="https://github.com/oasis-tcs/amqp-specs/blob/master/http-over-amqp-v1.0-wd06a.docx" target="_blank" rel="noopener noreferrer">HTTP over AMQP 1.0</a>.</p><p>These are just hypothetical examples showing how RabbitMQ could make use of link flow control extensibility in the future, which is an advantage over AMQP 0.9.1.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3>
<p>We learned that AMQP 1.0 link flow control protects individual consumers or queues from being overwhelmed with messages.
The receiver periodically provides feedback to the sender on how many messages it can currently handle.</p>
<p>Each link endpoint (sender and receiver) maintains full link flow control state and exchanges this state via <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frames with the other side.</p>
<p>The following link flow control fields are independently determined by the <strong>receiver</strong>:</p>
<ul>
<li><code>link-credit</code></li>
<li><code>drain</code></li>
</ul>
<p>The following link flow control fields are independently determined by the <strong>sender</strong>:</p>
<ul>
<li><code>delivery-count</code></li>
<li><code>available</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="session-flow-control">Session Flow Control<a href="#session-flow-control" class="hash-link" aria-label="Direct link to Session Flow Control" title="Direct link to Session Flow Control">​</a></h2>
<p>Before diving into <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-session-flow-control" target="_blank" rel="noopener noreferrer">session flow control</a>, let&#x27;s recap what a <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#section-sessions" target="_blank" rel="noopener noreferrer">session</a> actually is.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="session">Session<a href="#session" class="hash-link" aria-label="Direct link to Session" title="Direct link to Session">​</a></h3>
<p>A client library creates a single TCP connection per <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#section-connections" target="_blank" rel="noopener noreferrer">AMQP connection</a>.
An AMQP 1.0 connection is established using the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-open" target="_blank" rel="noopener noreferrer">open</a> frame.</p>
<p>Within an AMQP 1.0 connection, the client can then start multiple AMQP 1.0 sessions.
This is <a href="/rabbitmq-website/docs/connections#protocol-differences">analogous</a> to how an AMQP 0.9.1 client can open multiple <a href="/rabbitmq-website/docs/channels">AMQP 0.9.1 channels</a> within an AMQP 0.9.1 connection.
An AMQP 1.0 session is started using the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-begin" target="_blank" rel="noopener noreferrer">begin</a> frame.</p>
<p>Within a session, a client can then create <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#section-links" target="_blank" rel="noopener noreferrer">links</a> by sending the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-attach" target="_blank" rel="noopener noreferrer">attach</a> frame.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  Client App                                       RabbitMQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+                                +-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             |################################|             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   +---+     |--------------------------------|    +---+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   | C |O&lt;===============================+========O| Q |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   +-+-+ \   |-------------------+-------|----|   |+-+-+    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|     |    \  |#######+###########|#######|####|   |  |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----|-----\-+       |           |       |    +---|--|------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |      \        |           |       |        |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |     Target    |           |       |    Source |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |               |           |       |           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Consumer           |           |     Link        Queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      |       Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 Connection</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A client application could create, for example:</p>
<ul>
<li>A single connection with a single session, or</li>
<li>A single connection with multiple sessions, or</li>
<li>Multiple connections with one or more sessions each</li>
</ul>
<p>Usually, a single connection with a single session is sufficient.</p>
<p>Opening an AMQP connection comes with some overhead:
A TCP connection must be established, allocating operating system resources such as sockets and TCP buffers in both the client and server, and incurring latency for the TCP or TLS handshake.
Additionally, on the RabbitMQ node, a <a href="https://www.erlang.org/doc/apps/stdlib/supervisor.html" target="_blank" rel="noopener noreferrer">supervision tree</a> is created for each incoming AMQP connection.</p>
<p>A session can be thought of as a &quot;lightweight&quot; connection.
Each AMQP 1.0 session is currently implemented as its own <a href="https://www.erlang.org/doc/system/ref_man_processes.html" target="_blank" rel="noopener noreferrer">Erlang process</a>.
Hence, creating a session is inexpensive if the connection is already established.</p>
<p>Creating a second session within an AMQP connection might be useful in the following scenarios:</p>
<ul>
<li>Quickly and cheaply creating another &quot;virtual connection&quot; without incurring the aforementioned AMQP connection setup overhead.</li>
<li>Ensuring high-priority <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer" target="_blank" rel="noopener noreferrer">transfer</a> frames (requiring low latency) are not blocked by other transfer frames.</li>
<li>Increasing parallelism when the RabbitMQ <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.6/deps/rabbit/src/rabbit_amqp_session.erl" target="_blank" rel="noopener noreferrer">session process</a> becomes very busy (for example, routing messages to <a href="/rabbitmq-website/tutorials/amqp-concepts#queues">queues</a>).</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flow-fields">Flow Fields<a href="#flow-fields" class="hash-link" aria-label="Direct link to Flow Fields" title="Direct link to Flow Fields">​</a></h3>
<blockquote>
<p>Sessions provide a flow control scheme based on the number of transfer frames transmitted.
Since frames have a maximum size for a given connection, this provides flow control based on the number of bytes transmitted.</p>
</blockquote>
<p>Remember that a <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-idp484080" target="_blank" rel="noopener noreferrer">large message</a> is split into multiple transfer frames.</p>
<p><a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#doc-session-flow-control" target="_blank" rel="noopener noreferrer">Session flow control</a> in AMQP 1.0 operates at a higher layer than link flow control.
While link flow control protects individual consumers and queues, session flow control is designed to protect the entire client application and RabbitMQ as a whole.</p>
<p>Just as each link endpoint maintains link flow control state and exchanges this state via <code>flow</code> frames, each session endpoint maintains session flow control state and exchanges this state within the same <code>flow</code> frames.
The remaining fields in the <a href="https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow" target="_blank" rel="noopener noreferrer">flow</a> frame are therefore used for session flow control:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">next-incoming-id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">transfer-number</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">incoming-window</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">uint</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">mandatory</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">true</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">next-outgoing-id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">transfer-number</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">mandatory</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">true</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">field</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">outgoing-window</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">uint</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">mandatory</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">true</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>incoming-window</code> is similar to the <a href="#link-credit">link-credit</a> field in that the receiving side informs the sending side how many &quot;units&quot; it can tolerate receiving.
The difference is that for <code>link-credit</code>, the unit is a potentially large application message, while for <code>incoming-window</code>, the unit is a <code>transfer</code> frame.</p>
<p>To provide an extreme example for better understanding: if the negotiated <code>max-frame-size</code> on the connection is very low and a single message is very large, if the receiver grants one link credit to the sender, the sender might still be blocked by session flow control sending this message in its entirety.</p>
<p><code>next-incoming-id</code> and <code>next-outgoing-id</code> are sequence numbers and serve the same purpose as the <a href="#delivery-count">delivery-count</a> in link flow control:
they ensure that the windows are computed correctly on the other side when <code>transfer</code> frames are sent in parallel with <code>flow</code> frames.
Two sequence numbers are needed for session flow control as opposed to one for link flow control because a session is bidirectional, while a link is unidirectional.</p>
<p>Initially, RabbitMQ allows the publisher to send <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.6/deps/rabbit/src/rabbit_amqp_session.erl#L60" target="_blank" rel="noopener noreferrer">400</a> transfer frames.
Whenever the RabbitMQ session process has processed half of that number (200 transfer frames), RabbitMQ expands this window by sending a <code>flow</code> frame to the publisher containing <code>incoming_window = 400</code>.</p>
<p>The value of <code>400</code> is configurable via <a href="/rabbitmq-website/docs/configure#advanced-config-file">advanced.config</a> setting <code>rabbit.max_incoming_window</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-alarms">RabbitMQ Alarms<a href="#rabbitmq-alarms" class="hash-link" aria-label="Direct link to RabbitMQ Alarms" title="Direct link to RabbitMQ Alarms">​</a></h3>
<p>The only exception to this rule is when a <a href="/rabbitmq-website/docs/alarms">memory or disk alarm</a> is triggered.
To protect RabbitMQ from running out of memory or disk space, each session will close its incoming window by sending a <code>flow</code> frame with <code>incoming_window = 0</code> to publishers, effectively preventing them from sending any further <code>transfer</code> frames.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #9</div><div class="admonitionContent_BuS1"><p><strong>In the event of a cluster wide memory or disk alarm, RabbitMQ will block AMQP 1.0 clients only from publishing <code>transfer</code> frames.
Other operations, such as AMQP 1.0 clients consuming on the same session or creating new connections that only consume in order to empty queues in RabbitMQ (thereby reducing memory and disk usage), will still be allowed.</strong></p><p>In AMQP 0.9.1, RabbitMQ will block reading from the connection socket entirely and prevent opening new connections until the alarm clears.
AMQP 0.9.1 clients must use separate connections for publishing and consuming to continue consuming during an alarm.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Benefit #10</div><div class="admonitionContent_BuS1"><p>As described in Benefits #4 and #9, <strong>because clients can safely and efficiently use a single AMQP 1.0 connection for both publishing and consuming, memory usage is reduced in RabbitMQ</strong>.</p><p>AMQP 0.9.1 practically requires twice the number of connections compared to AMQP 1.0.
The <a href="/rabbitmq-website/blog/2024/08/21/amqp-benchmarks#many-connections">AMQP 1.0 Benchmarks</a> provide insights into how much memory could be saved.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="incoming-window">Incoming-Window<a href="#incoming-window" class="hash-link" aria-label="Direct link to Incoming-Window" title="Direct link to Incoming-Window">​</a></h3>
<p>The disadvantage of AMQP 1.0 flow control is its complexity.
While the ideas and motivations behind link flow control and session flow control are sound, implementing one layer (session flow control) on top of another layer (link flow control) can be challenging to get right and efficient in every scenario.
Consider that clients can:</p>
<ul>
<li>Modify session flow control and link flow control independently (either in the same <code>flow</code> frame or in separate <code>flow</code> frames).</li>
<li>Send a <code>flow</code> frame at any time and at different frequencies.</li>
<li>Dynamically increase or decrease either the session window or the link credit.</li>
<li>Grant a link-credit of 0 (causing the queue to stop sending) or a huge number of link credits (up to 4 billion).</li>
<li>Close its session <code>incoming-window</code> (causing the server session to stop sending) or open it widely (up to 4 billion).</li>
<li>Stop reading from its socket, applying TCP backpressure to the server.</li>
<li>Add other special logic, such as <code>drain=true</code>, into the mix.</li>
</ul>
<p>In AMQP 1.0 programs, concurrency is desirable.
Depending on the programming language, different parts of the client or broker are implemented by different threads or processes.</p>
<p>RabbitMQ achieves concurrency by running the <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.6/deps/rabbit/src/rabbit_amqp_reader.erl" target="_blank" rel="noopener noreferrer">connection reader process</a> (parsing frames), <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.6/deps/rabbit/src/rabbit_amqp_writer.erl" target="_blank" rel="noopener noreferrer">connection writer process</a> (serializing frames), <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.6/deps/rabbit/src/rabbit_amqp_session.erl" target="_blank" rel="noopener noreferrer">session process</a> (e.g. routing messages), and <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v4.0.0-beta.6/deps/rabbit/src/rabbit_amqqueue_process.erl" target="_blank" rel="noopener noreferrer">queue process</a> (storing and forwarding messages) in different <a href="https://www.erlang.org/doc/system/ref_man_processes.html" target="_blank" rel="noopener noreferrer">Erlang processes</a>.</p>
<p>In a scenario where the client grants a huge number of <code>link-credit</code> to the sending queue but maintains a very small session <code>incoming-window</code>, queue processes are allowed to deliver messages, while the session process is not allowed to forward them to the client.
In this case, messages are buffered in the session process until the client&#x27;s <code>incoming-window</code> allows them to be forwarded.</p>
<p>To guard against this scenario - where a large number of messages could be buffered in the session process - RabbitMQ, in its current implementation, internally grants link credits from the session process to the queue process in batches of at most 256 link credits.
Even if the client grants a large number of link credits, the queue will only ever see up to 256 credits for a given consumer.
Once these 256 messages have been sent out by the server session process, the server session process will grant the next batch of 256 credits to the queue.</p>
<p>The value of <code>256</code> is configurable via <a href="/rabbitmq-website/docs/configure#advanced-config-file">advanced.config</a> setting <code>rabbit.max_queue_credit</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrapping-up">Wrapping Up<a href="#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping Up" title="Direct link to Wrapping Up">​</a></h2>
<p>This blog post explained how AMQP 1.0 link flow control and session flow control work.</p>
<p>We learned how individual processes within RabbitMQ protect themselves from overload:</p>
<ul>
<li>Queue processes are protected by link flow control.</li>
<li>Session processes and RabbitMQ as a whole are protected by session flow control.</li>
<li>Connection reader processes are protected by applying TCP backpressure when they cannot read frames quickly enough (which should be rare).</li>
</ul>
<p>This blog post also highlighted ten benefits of flow control in AMQP 1.0 over flow control in AMQP 0.9.1.
The main advantages include:</p>
<ul>
<li>Fine-grained control for consumers, allowing them to determine at any point in time the exact number of messages they want to consume from specific queue(s).</li>
<li>Higher throughput for publishing and consuming on a single AMQP connection when a target queue reaches its limits. We ran two benchmarks:<!-- -->
<ol>
<li>Total send throughput of AMQP 1.0 was four times higher than AMQP 0.9.1 when sending to two different target queues.</li>
<li>In an extreme case, consumption rate of AMQP 1.0 was 73 times higher than AMQP 0.9.1 when receiving from one queue while sending too fast to another queue.</li>
</ol>
</li>
<li>Safe and efficient usage of a single connection for both publishing and consuming.</li>
<li>The ability for consumers to stop and resume at any time.</li>
<li>Extensibility for future use cases.</li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/amqp-1-0">AMQP 1.0</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/rabbit-mq-4-0">RabbitMQ 4.0</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/performance">Performance</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/technical-deep-dive">Technical Deep Dive</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2024-09-02-amqp-flow-control/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2024/10/11/modified-outcome"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">AMQP 1.0 Modified Outcome</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2024/08/28/quorum-queues-in-4.0"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">RabbitMQ 4.0: New Quorum Queue Features</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#link-flow-control" class="table-of-contents__link toc-highlight">Link Flow Control</a><ul><li><a href="#link-credit" class="table-of-contents__link toc-highlight">Link-Credit</a></li><li><a href="#delivery-count" class="table-of-contents__link toc-highlight">Delivery-Count</a></li><li><a href="#drain" class="table-of-contents__link toc-highlight">Drain</a></li><li><a href="#echo" class="table-of-contents__link toc-highlight">Echo</a></li><li><a href="#available" class="table-of-contents__link toc-highlight">Available</a></li><li><a href="#properties" class="table-of-contents__link toc-highlight">Properties</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li><li><a href="#session-flow-control" class="table-of-contents__link toc-highlight">Session Flow Control</a><ul><li><a href="#session" class="table-of-contents__link toc-highlight">Session</a></li><li><a href="#flow-fields" class="table-of-contents__link toc-highlight">Flow Fields</a></li><li><a href="#rabbitmq-alarms" class="table-of-contents__link toc-highlight">RabbitMQ Alarms</a></li><li><a href="#incoming-window" class="table-of-contents__link toc-highlight">Incoming-Window</a></li></ul></li><li><a href="#wrapping-up" class="table-of-contents__link toc-highlight">Wrapping Up</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">RabbitMQ 3.12 Performance Improvements | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2023/05/17/rabbitmq-3.12-performance-improvements"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="RabbitMQ 3.12 Performance Improvements | RabbitMQ"><meta data-rh="true" name="description" content="RabbitMQ 3.12 will be released soon with many new features and improvements."><meta data-rh="true" property="og:description" content="RabbitMQ 3.12 will be released soon with many new features and improvements."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-05-17T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/mkuratczyk"><meta data-rh="true" property="article:tag" content="Performance"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2023/05/17/rabbitmq-3.12-performance-improvements"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2023/05/17/rabbitmq-3.12-performance-improvements" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2023/05/17/rabbitmq-3.12-performance-improvements" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2023/05/17/rabbitmq-3.12-performance-improvements","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2023/05/17/rabbitmq-3.12-performance-improvements","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2023/05/17/rabbitmq-3.12-performance-improvements","headline":"RabbitMQ 3.12 Performance Improvements","name":"RabbitMQ 3.12 Performance Improvements","description":"RabbitMQ 3.12 will be released soon with many new features and improvements.","datePublished":"2023-05-17T00:00:00.000Z","author":{"@type":"Person","name":"Michał Kuratczyk","url":"https://github.com/mkuratczyk","image":"https://github.com/mkuratczyk.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">RabbitMQ 3.12 Performance Improvements</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-05-17T00:00:00.000Z">May 17, 2023</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/mkuratczyk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/mkuratczyk.png" alt="Michał Kuratczyk"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/mkuratczyk" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Michał Kuratczyk</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/mkuratczyk" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/mkuratczyk/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://fosstodon.org/@kura" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Mastodon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 61 65" width="1em" height="1em" class="authorSocialLink_owbf"><path fill="url(#:Rfndbeh:)" d="M60.754 14.39C59.814 7.406 53.727 1.903 46.512.836 45.294.656 40.682 0 29.997 0h-.08C19.23 0 16.938.656 15.72.836 8.705 1.873 2.299 6.82.745 13.886c-.748 3.48-.828 7.338-.689 10.877.198 5.075.237 10.142.697 15.197a71.482 71.482 0 0 0 1.664 9.968c1.477 6.056 7.458 11.096 13.317 13.152a35.718 35.718 0 0 0 19.484 1.028 28.365 28.365 0 0 0 2.107-.576c1.572-.5 3.413-1.057 4.766-2.038a.154.154 0 0 0 .062-.118v-4.899a.146.146 0 0 0-.055-.111.145.145 0 0 0-.122-.028 54 54 0 0 1-12.644 1.478c-7.328 0-9.298-3.478-9.863-4.925a15.258 15.258 0 0 1-.857-3.882.142.142 0 0 1 .178-.145 52.976 52.976 0 0 0 12.437 1.477c1.007 0 2.012 0 3.02-.026 4.213-.119 8.654-.334 12.8-1.144.103-.02.206-.038.295-.065 6.539-1.255 12.762-5.196 13.394-15.176.024-.393.083-4.115.083-4.523.003-1.386.446-9.829-.065-15.017Z"></path><path fill="#fff" d="M50.394 22.237v17.35H43.52V22.749c0-3.545-1.478-5.353-4.483-5.353-3.303 0-4.958 2.139-4.958 6.364v9.217h-6.835V23.76c0-4.225-1.657-6.364-4.96-6.364-2.988 0-4.48 1.808-4.48 5.353v16.84H10.93V22.237c0-3.545.905-6.362 2.715-8.45 1.868-2.082 4.317-3.152 7.358-3.152 3.519 0 6.178 1.354 7.951 4.057l1.711 2.871 1.714-2.871c1.773-2.704 4.432-4.056 7.945-4.056 3.038 0 5.487 1.069 7.36 3.152 1.81 2.085 2.712 4.902 2.71 8.449Z"></path><defs><linearGradient id=":Rfndbeh:" x1="30.5" x2="30.5" y1="0" y2="65" gradientUnits="userSpaceOnUse"><stop stop-color="#6364FF"></stop><stop offset="1" stop-color="#563ACC"></stop></linearGradient></defs></svg></a><a href="https://bsky.app/profile/mkuratczyk.bsky.social" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>RabbitMQ 3.12 will be released soon with many new features and improvements.
This blog post focuses on the the performance-related differences.
The most important change is that the <code>lazy</code> mode for classic queues is now the standard behavior (more on this below).
The new implementation should be even more memory efficient
while proving higher throughput and lower latency than both <code>lazy</code> or <code>non-lazy</code> implementations did in earlier versions.</p>
<p>For even better performance, we highly recommend switching to classic queues version 2 (CQv2).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Let&#x27;s quickly go through the most important performance-related improvements in RabbitMQ 3.12.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="classic-queues-changes-to-the-lazy-mode">Classic Queues: Changes to the Lazy Mode<a href="#classic-queues-changes-to-the-lazy-mode" class="hash-link" aria-label="Direct link to Classic Queues: Changes to the Lazy Mode" title="Direct link to Classic Queues: Changes to the Lazy Mode">​</a></h3>
<p>Starting with 3.12, the <code>x-queue-mode=lazy</code> argument is ignored. All classic queues will now behave similarly to the way lazy queues behaved previously.
That is, messages tend to be written to disk and only a small subset is kept in memory. The number of messages in memory depends on the consumption rate.
This change affects all users of classic queues. Based on our testing, for the vast majority of them,
the new implementation should bring significant improvements in performance and should lower the memory usage. Keep reading for some benchmark results,
but also make sure to test your system <a href="https://rabbitmq.github.io/rabbitmq-perf-test/stable/htmlsingle/" target="_blank" rel="noopener noreferrer">using PerfTest</a> before upgrading.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="classic-queues-massively-improved-classic-queues-v2-cqv2">Classic Queues: Massively Improved Classic Queues v2 (CQv2)<a href="#classic-queues-massively-improved-classic-queues-v2-cqv2" class="hash-link" aria-label="Direct link to Classic Queues: Massively Improved Classic Queues v2 (CQv2)" title="Direct link to Classic Queues: Massively Improved Classic Queues v2 (CQv2)">​</a></h3>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This paragraph was updated to reflect the changes to the roadmap. Classic queues version 2 will become the
default and only option in RabbitMQ 4.0 (perviously we planned to make it the default in 3.13).</p></div></div>
<p>Since RabbitMQ 3.10, we have had <a href="/rabbitmq-website/docs/persistence-conf#queue-version">two implementation of classic queues</a>: the original
one (CQv1) and a new one (CQv2). The difference between them is mostly around on-disk storage.</p>
<p>Most users still use CQv1, but starting with 3.12 we highly recommend switching to,
or at least evaluating, CQv2. Version 2 will become the the only implementation available in RabbitMQ 4.0.</p>
<p>The migration process is easy: add a new policy key or an optional queue argument, <code>x-queue-version=2</code>, when declaring the queue.
To switch to CQv2 globally, set <code>classic_queue.default_version</code> to <code>2</code> in the config file:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">classic_queue.default_version = 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is possible to go back by setting the version back to 1. Every time the value changes, RabbitMQ will convert the on-disk representation of the queue.
For mostly empty queues, the process is instantaneous. For reasonable backlogs, it can take a few seconds.</p>
<p>In many use cases, switching to CQv2 will result in a 20-40% throughput improvement
and lower memory usage at the same time. Those who still use classic queue mirroring (<a href="/rabbitmq-website/blog/2023/03/02/quorum-queues-migration">you shouldn&#x27;t, it&#x27;ll be removed soon!</a>),
need to test your system more thoroughly as there are a few cases where version 1 works better with mirrored classic queues,
but there are also many scenarios where version 2 is much better, despite not having any mirroring-specific code optimizations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-mqtt-implementation-significant-memory-savings-per-connection-supports-millions-of-connections-per-node">New MQTT implementation: Significant Memory Savings Per Connection, Supports Millions of Connections per Node<a href="#new-mqtt-implementation-significant-memory-savings-per-connection-supports-millions-of-connections-per-node" class="hash-link" aria-label="Direct link to New MQTT implementation: Significant Memory Savings Per Connection, Supports Millions of Connections per Node" title="Direct link to New MQTT implementation: Significant Memory Savings Per Connection, Supports Millions of Connections per Node">​</a></h3>
<p>The <a href="/rabbitmq-website/docs/mqtt">MQTT plugin</a> has been completely reworked and provides much lower memory usage,
lower latency and can handle many more connections than before.</p>
<p>We&#x27;ve published <a href="/rabbitmq-website/blog/2023/03/21/native-mqtt">a separate blog post about the MQTT-related improvements</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="significant-improvements-to-quorum-queues">Significant improvements to quorum queues<a href="#significant-improvements-to-quorum-queues" class="hash-link" aria-label="Direct link to Significant improvements to quorum queues" title="Direct link to Significant improvements to quorum queues">​</a></h3>
<p>The work on making quorum queues more efficient continues. RabbitMQ 3.12 brings a number of improvements so all quorum queue users should see better performance.
The biggest change will be observed in the environments with long quorum queues.
Previously, as the queue got longer, its throughput decreased. This should no longer be a problem.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nodes-should-stop-and-start-faster">Nodes Should Stop and Start Faster<a href="#nodes-should-stop-and-start-faster" class="hash-link" aria-label="Direct link to Nodes Should Stop and Start Faster" title="Direct link to Nodes Should Stop and Start Faster">​</a></h3>
<p>RabbitMQ nodes with many classic queues (tens of thousands or more) should stop and start faster. That means shorter node unavailability during an upgrade
and other maintenance operations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarking-setup">Benchmarking Setup<a href="#benchmarking-setup" class="hash-link" aria-label="Direct link to Benchmarking Setup" title="Direct link to Benchmarking Setup">​</a></h2>
<p>All the data present below compares 3.11.7 and 3.12-rc.2. Some, mostly smaller, optimizations have been backported to more recent 3.11 patch releases,
which is why this comparison does not use the latest 3.11 patch release.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="benchmark-tests">Benchmark Tests<a href="#benchmark-tests" class="hash-link" aria-label="Direct link to Benchmark Tests" title="Direct link to Benchmark Tests">​</a></h2>
<p>At the moment of writing, Team RabbitMQ&#x27;s standard performance test suite contains 14 tests. Each test runs for 5 minutes.
Separate environments go through the same tests at the same time with different message sizes,
so that it is easy to see the impact of the message size and/or to compare different queue types or versions under the same workload.</p>
<p>Here is a list of the tests, in the order they appear in the Grafana dashboard:</p>
<ol>
<li>One publisher publishes as fast as it can, while one consumer consumes as fast as it can</li>
<li>Two publishers and no consumers (performance as the queue gets longer)</li>
<li>One consumer consumes a long queue from the previous test (performance of consumers unaffected by publishers)</li>
<li>Five queues, each has 1 publisher publishing at 10k messages/s and 1 consumer (the total expected throughput is 50k/s, we look at the latency)</li>
<li>Fanout to 10 queues - 1 publishers and 10 consumers, a fanout exchange</li>
<li>One publisher, one consumer, but only 1 unconfirmed message (the publisher waits for the confirmation of the previous message before sending the next one)</li>
<li>Fan-in: 7000 publishers publishing 1 message per second, to a single queue</li>
<li>1000 publishers publish 10 messages/s, each to a different queue; each queue has a consumer as well (total expected throughput: 10k/s)</li>
<li>One publisher without consumers creates a backlog of messages, then 10 consumers join to drain the queue</li>
<li>Similar to the previous one, but 50 consumers join, but a single-active-consumer is set (so only one starts draining the queue)</li>
<li>Similar to the first test, but multi-ack of 1000 is used on the consumer-side</li>
<li>Messages with TTL are published and expire quickly (they never get consumed)</li>
<li>Messages get published to be negatively acknowledged later (this is just a setup for the next test)</li>
<li>Messages from the previous test are negatively acknowledged</li>
</ol>
<p>The last few tests are less interesting. They were introduced to look for issues in some specific areas.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-environment">The Environment<a href="#the-environment" class="hash-link" aria-label="Direct link to The Environment" title="Direct link to The Environment">​</a></h3>
<p>These tests were conducted using the following environment:</p>
<ul>
<li>A GKE cluster with e2-standard-16 nodes</li>
<li>RabbitMQ clusters deployed using <a href="/rabbitmq-website/kubernetes/operator/operator-overview">our Kubernetes Operator</a> with the following resources and configuration</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rabbitmq.com/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RabbitmqCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># or 3 for mirrored and quorum queues</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rabbitmq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3.11.7</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">management </span><span class="token comment" style="color:#999988;font-style:italic"># or rabbitmq:3.12.0-rc.2-management</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 12Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 12Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">persistence</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">storageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> premium</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rwo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;150Gi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rabbitmq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">advancedConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      [</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      {rabbit, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          {credit_flow_default_credit,{0,0}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ].</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Some notes on the environment:</p>
<ol>
<li>For many tests (or even production workloads), these resource settings are excessive. This is simply a configuration we happen to use for performance testing, it is not a recommendation</li>
<li>You should be able to reach higher values with better hardware. <code>e2-standard-16</code> is far from the best hardware money can buy/rent</li>
<li>The credit flow was disabled because otherwise a single fast publisher will be throttled (to prevent overload and to give a fair chance to other publishers);
flow control is important in systems with many users/connections, but usually not something we want when benchmarking</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-results">Test Results<a href="#test-results" class="hash-link" aria-label="Direct link to Test Results" title="Direct link to Test Results">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-lazy-like-default-behavior-of-classic-queues-and-classic-queues-v2">New Lazy-like Default Behavior of Classic Queues and Classic Queues v2<a href="#new-lazy-like-default-behavior-of-classic-queues-and-classic-queues-v2" class="hash-link" aria-label="Direct link to New Lazy-like Default Behavior of Classic Queues and Classic Queues v2" title="Direct link to New Lazy-like Default Behavior of Classic Queues and Classic Queues v2">​</a></h3>
<p>Initial version of RabbitMQ was released in 2007. Back then, disk access was very slow compared to any other operation.
However, as the storage technology evolved over the years, there was less and less need to avoid writing data to disk. In version 3.6.0, back in 2015,
<a href="/rabbitmq-website/docs/lazy-queues">lazy queues</a> were added as an option. Lazy queues store all messages on disk to save memory, which is particularly important for queues that can become long.
These days, writing messages to disk is a pretty cheap operation (unless you perform <code>fsync</code> to guarantee high data safety, as quorum queues do).
By storing messages on disk, we can use much less memory. That means lower costs, fewer memory alarms and fewer headaches caused by sudden memory spikes in your cluster.
We&#x27;ve therefore made this the only option for classic queues going forward.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="311-non-lazy-vs-312">3.11 non-lazy vs 3.12<a href="#311-non-lazy-vs-312" class="hash-link" aria-label="Direct link to 3.11 non-lazy vs 3.12" title="Direct link to 3.11 non-lazy vs 3.12">​</a></h4>
<p>Let&#x27;s start by looking at what we expect to happen for users that currently use non-lazy classic queues version 1 (CQv1), after the upgrade.
The screenshot was taken from 12 bytes message sizes test.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Classic queues: non-lazy classic queues in 3.11 vs 3.12" src="/rabbitmq-website/assets/images/lazy-3.11-vs-3.12-ab2560a083634ee8816e7e5632e8d420.png" width="1958" height="1800" class="img_ev3q"><figcaption>Classic queues: non-lazy classic queues in 3.11 vs 3.12</figcaption></figure><p></p>
<p>As you can see, 3.12 performs better in every single test: higher throughput, lower latency, less variability (fewer spikes in rates).
At the same time, 3.12 has a much lower memory usage (similar to lazy queues). On the last panel you can see 3.11 memory spikes whenever the queues get longer,
while 3.12 only exceeds 1GB memory usage in the tests that involve many connections (it&#x27;s the connections that use the memory, not the queues).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="312-cqv1-vs-cqv2">3.12 CQv1 vs CQv2<a href="#312-cqv1-vs-cqv2" class="hash-link" aria-label="Direct link to 3.12 CQv1 vs CQv2" title="Direct link to 3.12 CQv1 vs CQv2">​</a></h4>
<p>Above, we saw some of the benefits that most users should get after upgrading to RabbitMQ 3.12, but we are just getting started! Let&#x27;s add classic queues version 2
to the comparison:</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Classic queues: non-lazy classic queues in 3.11 vs 3.12 v1 and v2" src="/rabbitmq-website/assets/images/lazy-3.11-vs-3.12-v1-and-v2-2aac60d554f8b218f064b6c38ea6d4b5.png" width="1974" height="1794" class="img_ev3q"><figcaption>Classic queues: non-lazy classic queues in 3.11 vs 3.12 v1 and v2</figcaption></figure><p></p>
<p>With CQv2, we observe even higher throughput and even lower latency. Especially in the second test when the queue gets long, version 2 doesn&#x27;t exceed 50ms latency,
while 3.11 can spike into multiple seconds.</p>
<p>Please do not hesitate to give classic queues version 2 a try. All you need to do is set the <code>x-queue-version=2</code> policy key.
To switch to CQv2 globally, set <code>classic_queue.default_version</code> to <code>2</code> in the config file:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">classic_queue.default_version = 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Version 2 will become the default version starting with RabbitMQ 3.13.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="classic-mirrored-queues">Classic Mirrored Queues<a href="#classic-mirrored-queues" class="hash-link" aria-label="Direct link to Classic Mirrored Queues" title="Direct link to Classic Mirrored Queues">​</a></h3>
<p>As mentioned above, classic queues version 1 contain a few optimizations specifically implemented to improve the behaviour when a queue is mirrored.
As we prepare to <a href="https://blog.rabbitmq.com/blog/2023/03/21/quorum-queues-migration" target="_blank" rel="noopener noreferrer">remove the mirroring feature</a>, version 2 no longer performs any special mirroring tricks.
Therefore, the results are mixed, but version 2 is so efficient that even without special considerations, it can outperform version 1 in most scenarios, even with mirroring.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Mirrored queues: 3.11 lazy and non-lazy vs 3.12 v2; 1kb messages" src="/rabbitmq-website/assets/images/mirrored-3.11-vs-3.12-91abd7246f7a44fb779a09efcdd45bf9.png" width="1936" height="1796" class="img_ev3q"><figcaption>Mirrored queues: 3.11 lazy and non-lazy vs 3.12 v2; 1kb messages</figcaption></figure><p></p>
<p>You can see whether version 2 works better for you but more importantly, please <a href="https://blog.rabbitmq.com/blog/2023/03/21/quorum-queues-migration" target="_blank" rel="noopener noreferrer">start migrating to quorum queues</a>
and <a href="/rabbitmq-website/docs/streams">streams</a> ASAP.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="quorum-queues">Quorum Queues<a href="#quorum-queues" class="hash-link" aria-label="Direct link to Quorum Queues" title="Direct link to Quorum Queues">​</a></h3>
<p><a href="/rabbitmq-website/docs/quorum-queues">Quorum queues</a> have offered much better performance and data safety than queue mirroring for several years now,
and they only get better.</p>
<p>The biggest improvement in 3.12 is in how quorum queues handle long backlogs.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Quorum queues: 3.11 vs 3.12; 5kb messages" src="/rabbitmq-website/assets/images/qq-3.11-vs-3.12-5kb-4460bd73d32064069d18c73397c21711.png" width="1974" height="1794" class="img_ev3q"><figcaption>Quorum queues: 3.11 vs 3.12; 5kb messages</figcaption></figure><p></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="publishing-to-a-long-quorum-queue">Publishing to a Long Quorum Queue<a href="#publishing-to-a-long-quorum-queue" class="hash-link" aria-label="Direct link to Publishing to a Long Quorum Queue" title="Direct link to Publishing to a Long Quorum Queue">​</a></h4>
<p>Prior to RabbitMQ 3.12, if a quorum queue had a long backlog, publishing latency could increase significantly, lowering throughput.
Starting with 3.12, the length of the queue should no longer matter much for latency and throughput.</p>
<p>You can see this in the second test: while both versions start at about 25k messages/s,
3.11 quickly degrades to 10k/s or so. Meanwhile, 3.12 remains above 20k/s.</p>
<p>The 3.12 performance is not as smooth as we wish it was, but it&#x27;s
much better already and could be improved further. It&#x27;s also important to remember that in these tests, we are effectively overloading
the queues: the messages keep flowing in as fast as possible and therefore any garbage collection or periodic operation (eg. Raft write-ahead log
roll-over) will be observable as a latency spike.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="consumption-throughput">Consumption Throughput<a href="#consumption-throughput" class="hash-link" aria-label="Direct link to Consumption Throughput" title="Direct link to Consumption Throughput">​</a></h4>
<p>Consuming messages from quorum queues is also much faster than it used to be. In particular, consuming messages from a very long queue can up to 10 times faster in our tests.
Queues are still meant to be kept relatively short (you can use <a href="/rabbitmq-website/docs/streams">streams</a> if you need to store a lot of messages),
but with these improvements, quorum queues should cope well with all kinds of message backlogs.</p>
<p>Take a look at the third test on the last panel (Messages consumed / s). 3.12 starts at over 15k messages/s and gets even faster as the queue
gets shorter. Meanwhile, 3.11 can hardly exceed 1000 messages per second. In this test, we are consuming a queue with a backlog of 5 million messages,
so you have hopefully never seen quorum queues struggle like this, but the good news is: even in these situations,
quorum queues should now perform better and more predictably.</p>
<p>A more likely scenario is a situation where the consumers were unavailable for some time and need to catch up. Let&#x27;s focus on these tests:</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Quorum queues: 3.11 vs 3.12" src="/rabbitmq-website/assets/images/qq-3.11-vs-3.12-consumption-53940cfd6c2b2c34a4acfa8de1b55a74.png" width="1946" height="1188" class="img_ev3q"><figcaption>Quorum queues: 3.11 vs 3.12</figcaption></figure><p></p>
<p>In the first phase of each test, consumers are off and a backlog of messages is created. Then the consumers start. In the first test 10 of them,
in the second test 50, but only one is active (as a <a href="/rabbitmq-website/docs/consumers#single-active-consumer">Single Active Consumer</a>).
In both cases, 3.12 offers a significantly higher consumption
rate and the queue is drained much more quickly. In the case of 3.11, we can see that it gets progressively faster as the queue backlog gets shorter.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="faster-node-restarts">Faster Node Restarts<a href="#faster-node-restarts" class="hash-link" aria-label="Direct link to Faster Node Restarts" title="Direct link to Faster Node Restarts">​</a></h3>
<p>This one shouldn&#x27;t affect most users, but should be very good news for users with many classic queues (eg. MQTT users with many subscriptions).
In our test, we started a node, imported 100,000 classic queues version 2 and then restarted the node. 3.12 was up and running within 3 minutes,
while 3.11 needed 15 minutes to start serving clients again. 3.11 hit a memory alarm on startup, which made the boot
process particularly slow. There was a client running just to see when it loses the connection and can establish it again.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Node restart with 100k classic queues v2: 3.11 vs 3.12" src="/rabbitmq-website/assets/images/100k-queues-restart-d746048c4c9757add94aa9698ab19f4e.png" width="1936" height="578" class="img_ev3q"><figcaption>Node restart with 100k classic queues v2: 3.11 vs 3.12</figcaption></figure><p></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-more-periodic-resource-usage-spikes-with-many-idle-queues">No More Periodic Resource Usage Spikes With Many Idle Queues<a href="#no-more-periodic-resource-usage-spikes-with-many-idle-queues" class="hash-link" aria-label="Direct link to No More Periodic Resource Usage Spikes With Many Idle Queues" title="Direct link to No More Periodic Resource Usage Spikes With Many Idle Queues">​</a></h3>
<p>You may have noticed on the screenshot above, that 3.11 not only took much longer to restart, but also that the publishing rate was spiky, even
though it was a very light workload (just 100 messages a second). The spikes are caused by an internal process which checks the health of the queues
to prevent stale queue metrics being emitted. Before 3.12, it&#x27;d query each queue for its status to decide if the queue is healthy. However,
idle classic queues hibernate (their Erlang process is stopped and its memory compacted) and need to be awaken just to reply that they are healthy.
Starting with 3.12, hibernated queues are considered healthy without waking them up, so CPU and memory usage should be lower and more consistent,
even on nodes with many queues.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>RabbitMQ 3.12 should improve the performance for virtually all users, often significantly. As always, we wholeheartedly recommend
testing release candidates and new versions before you upgrade. We are also always interested in learning how people use RabbitMQ
in <a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer">GitHub Discussions</a> and our <a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer">community Discord server</a>.</p>
<p>If you can share information about your workload, <a href="https://perftest.rabbitmq.com/" target="_blank" rel="noopener noreferrer">ideally as a perf-test command</a>, it will help
us make RabbitMQ better for you.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/performance">Performance</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2023-05-17-rabbitmq-3.12-performance-improvements/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2023/07/21/mqtt5"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">MQTT 5.0 support is coming in RabbitMQ 3.13</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2023/04/04/announcing-rabbitmq-community-discord-server"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Announcing RabbitMQ Community Discord Server</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#classic-queues-changes-to-the-lazy-mode" class="table-of-contents__link toc-highlight">Classic Queues: Changes to the Lazy Mode</a></li><li><a href="#classic-queues-massively-improved-classic-queues-v2-cqv2" class="table-of-contents__link toc-highlight">Classic Queues: Massively Improved Classic Queues v2 (CQv2)</a></li><li><a href="#new-mqtt-implementation-significant-memory-savings-per-connection-supports-millions-of-connections-per-node" class="table-of-contents__link toc-highlight">New MQTT implementation: Significant Memory Savings Per Connection, Supports Millions of Connections per Node</a></li><li><a href="#significant-improvements-to-quorum-queues" class="table-of-contents__link toc-highlight">Significant improvements to quorum queues</a></li><li><a href="#nodes-should-stop-and-start-faster" class="table-of-contents__link toc-highlight">Nodes Should Stop and Start Faster</a></li></ul></li><li><a href="#benchmarking-setup" class="table-of-contents__link toc-highlight">Benchmarking Setup</a></li><li><a href="#benchmark-tests" class="table-of-contents__link toc-highlight">Benchmark Tests</a><ul><li><a href="#the-environment" class="table-of-contents__link toc-highlight">The Environment</a></li></ul></li><li><a href="#test-results" class="table-of-contents__link toc-highlight">Test Results</a><ul><li><a href="#new-lazy-like-default-behavior-of-classic-queues-and-classic-queues-v2" class="table-of-contents__link toc-highlight">New Lazy-like Default Behavior of Classic Queues and Classic Queues v2</a></li><li><a href="#classic-mirrored-queues" class="table-of-contents__link toc-highlight">Classic Mirrored Queues</a></li><li><a href="#quorum-queues" class="table-of-contents__link toc-highlight">Quorum Queues</a></li><li><a href="#faster-node-restarts" class="table-of-contents__link toc-highlight">Faster Node Restarts</a></li><li><a href="#no-more-periodic-resource-usage-spikes-with-many-idle-queues" class="table-of-contents__link toc-highlight">No More Periodic Resource Usage Spikes With Many Idle Queues</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
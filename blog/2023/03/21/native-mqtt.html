<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Serving Millions of Clients with Native MQTT | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/blog/2023/03/21/native-mqtt"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Serving Millions of Clients with Native MQTT | RabbitMQ"><meta data-rh="true" name="description" content="RabbitMQ&#x27;s core protocol has been AMQP 0.9.1."><meta data-rh="true" property="og:description" content="RabbitMQ&#x27;s core protocol has been AMQP 0.9.1."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-03-21T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ansd"><meta data-rh="true" property="article:tag" content="Technical Deep Dive,Performance,MQTT"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/blog/2023/03/21/native-mqtt"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2023/03/21/native-mqtt" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/blog/2023/03/21/native-mqtt" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.rabbitmq.com/rabbitmq-website/blog/2023/03/21/native-mqtt","mainEntityOfPage":"https://www.rabbitmq.com/rabbitmq-website/blog/2023/03/21/native-mqtt","url":"https://www.rabbitmq.com/rabbitmq-website/blog/2023/03/21/native-mqtt","headline":"Serving Millions of Clients with Native MQTT","name":"Serving Millions of Clients with Native MQTT","description":"RabbitMQ's core protocol has been AMQP 0.9.1.","datePublished":"2023-03-21T00:00:00.000Z","author":{"@type":"Person","name":"David Ansari","url":"https://github.com/ansd","image":"https://github.com/ansd.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.rabbitmq.com/rabbitmq-website/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a class="navbar__item navbar__link" href="/rabbitmq-website/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">Serving Millions of Clients with Native MQTT</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-03-21T00:00:00.000Z">March 21, 2023</time> Â· <!-- -->24 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/ansd.png" alt="David Ansari"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">David Ansari</span></a></div><div class="authorSocials_rSDt"><a href="https://github.com/ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/ansd/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a><a href="https://m.ansd.xyz/@ansd" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Mastodon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 61 65" width="1em" height="1em" class="authorSocialLink_owbf"><path fill="url(#:Rfndbeh:)" d="M60.754 14.39C59.814 7.406 53.727 1.903 46.512.836 45.294.656 40.682 0 29.997 0h-.08C19.23 0 16.938.656 15.72.836 8.705 1.873 2.299 6.82.745 13.886c-.748 3.48-.828 7.338-.689 10.877.198 5.075.237 10.142.697 15.197a71.482 71.482 0 0 0 1.664 9.968c1.477 6.056 7.458 11.096 13.317 13.152a35.718 35.718 0 0 0 19.484 1.028 28.365 28.365 0 0 0 2.107-.576c1.572-.5 3.413-1.057 4.766-2.038a.154.154 0 0 0 .062-.118v-4.899a.146.146 0 0 0-.055-.111.145.145 0 0 0-.122-.028 54 54 0 0 1-12.644 1.478c-7.328 0-9.298-3.478-9.863-4.925a15.258 15.258 0 0 1-.857-3.882.142.142 0 0 1 .178-.145 52.976 52.976 0 0 0 12.437 1.477c1.007 0 2.012 0 3.02-.026 4.213-.119 8.654-.334 12.8-1.144.103-.02.206-.038.295-.065 6.539-1.255 12.762-5.196 13.394-15.176.024-.393.083-4.115.083-4.523.003-1.386.446-9.829-.065-15.017Z"></path><path fill="#fff" d="M50.394 22.237v17.35H43.52V22.749c0-3.545-1.478-5.353-4.483-5.353-3.303 0-4.958 2.139-4.958 6.364v9.217h-6.835V23.76c0-4.225-1.657-6.364-4.96-6.364-2.988 0-4.48 1.808-4.48 5.353v16.84H10.93V22.237c0-3.545.905-6.362 2.715-8.45 1.868-2.082 4.317-3.152 7.358-3.152 3.519 0 6.178 1.354 7.951 4.057l1.711 2.871 1.714-2.871c1.773-2.704 4.432-4.056 7.945-4.056 3.038 0 5.487 1.069 7.36 3.152 1.81 2.085 2.712 4.902 2.71 8.449Z"></path><defs><linearGradient id=":Rfndbeh:" x1="30.5" x2="30.5" y1="0" y2="65" gradientUnits="userSpaceOnUse"><stop stop-color="#6364FF"></stop><stop offset="1" stop-color="#563ACC"></stop></linearGradient></defs></svg></a><a href="https://bsky.app/profile/ansd.xyz" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="Bluesky"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 226" class="authorSocialLink_owbf"><path fill="#1185FE" d="M55.491 15.172c29.35 22.035 60.917 66.712 72.509 90.686 11.592-23.974 43.159-68.651 72.509-90.686C221.686-.727 256-13.028 256 26.116c0 7.818-4.482 65.674-7.111 75.068-9.138 32.654-42.436 40.983-72.057 35.942 51.775 8.812 64.946 38 36.501 67.187-54.021 55.433-77.644-13.908-83.696-31.676-1.11-3.257-1.63-4.78-1.637-3.485-.008-1.296-.527.228-1.637 3.485-6.052 17.768-29.675 87.11-83.696 31.676-28.445-29.187-15.274-58.375 36.5-67.187-29.62 5.041-62.918-3.288-72.056-35.942C4.482 91.79 0 33.934 0 26.116 0-13.028 34.314-.727 55.491 15.172Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>RabbitMQ&#x27;s core protocol has been AMQP 0.9.1.
To support MQTT, STOMP, and AMQP 1.0, the broker transparently proxies via its core protocol.
While this is a simple way to extend RabbitMQ with support for more messaging protocols,
it degrades scalability and performance.</p>
<p>In the last 9 months, we re-wrote the <a href="/rabbitmq-website/docs/mqtt">MQTT plugin</a> to not proxy via AMQP 0.9.1 anymore.
Instead, the MQTT plugin parses MQTT messages and sends them directly to queues.
This is what we call <strong>Native MQTT</strong>.</p>
<p>The results are spectacular:</p>
<ol>
<li>Memory usage drops by up to 95% and hundreds of GBs with many connections.</li>
<li>For the first time ever, RabbitMQ is able to handle millions of connections.</li>
<li>End-to-end latency drops by 50% - 70%.</li>
<li>Throughput increases by 30% - 40%.</li>
</ol>
<p>Native MQTT turns RabbitMQ into an MQTT broker opening the door for a broader set of IoT use cases.</p>
<p>Native MQTT ships in RabbitMQ 3.12.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">â€‹</a></h2>
<p>As depicted in Figure 1, up to RabbitMQ 3.11 the MQTT plugin worked by parsing MQTT messages and forwarding them via the AMQP 0.9.1 protocol to the <a href="/rabbitmq-website/docs/channels">channel</a> which in turn routes messages to <a href="/rabbitmq-website/docs/queues">queues</a>.
Each blue dot in Figure 1 represents an <a href="https://www.erlang.org/doc/reference_manual/processes.html#processes" target="_blank" rel="noopener noreferrer">Erlang process</a>.
A total of 22 Erlang processes are created for each incoming MQTT connection.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 1: RabbitMQ 3.11 - MQTT proxied via AMQP 0.9.1 - 22 Erlang processes per MQTT connection" src="/rabbitmq-website/assets/images/mqtt-proxy-amqp-091-c438ca5ff9c0da910c88c404eef29689.svg" width="1248" height="192" class="img_ev3q"><figcaption>Figure 1: RabbitMQ 3.11 - MQTT proxied via AMQP 0.9.1 - 22 Erlang processes per MQTT connection</figcaption></figure><p></p>
<p>16 Erlang processes per MQTT connection are created in the MQTT plugin (that is Erlang application <a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_mqtt" target="_blank" rel="noopener noreferrer"><code>rabbitmq_mqtt</code></a>) including one process that is responsible for <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Keep_Alive" target="_blank" rel="noopener noreferrer">MQTT Keep Alive</a> and a bunch of processes that act as an AMQP 0.9.1 client.</p>
<p>6 Erlang processes per MQTT connection are created in the Erlang application <a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbit" target="_blank" rel="noopener noreferrer"><code>rabbit</code></a>.
They implement the per-client part of the core AMQP 0.9.1 server.</p>
<p>Figure 2 shows that Native MQTT requires a single Erlang process per incoming MQTT connection.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 2: RabbitMQ 3.12 - Native MQTT - 1 Erlang process per MQTT connection" src="/rabbitmq-website/assets/images/native-mqtt-f7c59adb7e8e57c5eeb4ea43807cf94c.svg" width="1248" height="192" class="img_ev3q"><figcaption>Figure 2: RabbitMQ 3.12 - Native MQTT - 1 Erlang process per MQTT connection</figcaption></figure><p></p>
<p>That single Erlang process is responsible for parsing MQTT messages, respecting MQTT Keep Alive, performing <a href="/rabbitmq-website/docs/access-control">authentication and authorization</a>, and routing messages to queues.</p>
<p>A usual MQTT workload consists of many Internet of Things (IoT) devices sending data periodically to an MQTT broker.
For example, there could be hundreds of thousands or even millions of devices that each send a status update every few seconds or minutes.</p>
<p>We learnt in last year&#x27;s RabbitMQ Summit talk <a href="https://youtu.be/CRDmKZhYmxw" target="_blank" rel="noopener noreferrer">RabbitMQ Performance Improvements</a> that creating Erlang processes is cheap.
(An Erlang process is much more lightweight than a Java thread. An Erlang process might be compared with a <a href="https://go.dev/tour/concurrency/1" target="_blank" rel="noopener noreferrer">Goroutine</a> in Golang.)
However, for 1 million incoming MQTT client connections, it makes a big scalability difference whether RabbitMQ creates 22 million Erlang processes (up to RabbitMQ 3.11) or just 1 million Erlang processes (RabbitMQ 3.12).
This difference is analysed in sections <a href="#memory-usage">Memory Usage</a> and <a href="#latency-and-throughput">Latency and Throughput</a>.</p>
<p>Not only was the <code>rabbitmq_mqtt</code> plugin re-written, but also the <a href="/rabbitmq-website/docs/web-mqtt">rabbitmq_web_mqtt</a> plugin.
This means, starting in 3.12, there will also be a single Erlang process per incoming <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718127" target="_blank" rel="noopener noreferrer">MQTT over WebSocket</a> connection.
Therefore, all performance improvements outlined in this blog post also apply to MQTT over WebSockets.</p>
<p>The term &quot;Native MQTT&quot; is not an official term of the MQTT specification.
&quot;Native MQTT&quot; refers to the new RabbitMQ 3.12 implementation where RabbitMQ supports MQTT &quot;natively&quot;, i.e. where MQTT traffic is not proxied via AMQP 0.9.1 anymore.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-mqtt-qos-0-queue-type">New MQTT QoS 0 Queue Type<a href="#new-mqtt-qos-0-queue-type" class="hash-link" aria-label="Direct link to New MQTT QoS 0 Queue Type" title="Direct link to New MQTT QoS 0 Queue Type">â€‹</a></h2>
<p>Native MQTT ships with a new RabbitMQ queue type called <code>rabbit_mqtt_qos0_queue</code>.
To have the MQTT plugin create queues of that new queue type, the 3.12 <a href="/rabbitmq-website/docs/feature-flags">feature flag</a> with the same name <code>rabbit_mqtt_qos0_queue</code> must be enabled.
(Remember that feature flags are not meant to be used as a form of cluster configuration.
After a successful rolling upgrade, you should enable all feature flags.
Each feature flag will become mandatory in a future RabbitMQ version.)</p>
<p>Before explaining the new queue type, we should first understand how queues relate to MQTT subscribers.</p>
<p>In all RabbitMQ versions, the MQTT plugin creates a dedicated queue per MQTT subscriber.
To be more precise, there could be 0, 1, or 2 queues per MQTT connection:</p>
<ul>
<li>There are 0 queues for an MQTT connection if the MQTT client never sends a <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718063" target="_blank" rel="noopener noreferrer">SUBSCRIBE</a> packet. The MQTT client is only publishing messages.</li>
<li>There is 1 queue for an MQTT connection if the MQTT client creates one or multiple subscriptions with the same <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718099" target="_blank" rel="noopener noreferrer">Quality of Service (QoS) level</a>.</li>
<li>There are 2 queues for an MQTT connection if the MQTT client creates one or multiple subscriptions with both <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718100" target="_blank" rel="noopener noreferrer">QoS 0 (at most once)</a> and <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718101" target="_blank" rel="noopener noreferrer">QoS 1 (at least once)</a>.</li>
</ul>
<p>When listing queues you will observe the queue naming pattern <code>mqtt-subscription-&lt;MQTT client ID&gt;qos[0|1]</code>
where <code>&lt;MQTT client ID&gt;</code> is the <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc385349242" target="_blank" rel="noopener noreferrer">MQTT client identifier</a> and <code>[0|1]</code> is either <code>0</code> for a QoS 0 subscription or <code>1</code> for a QoS 1 subscription.
Having a separate queue per MQTT subscriber makes sense because every MQTT subscriber receives its own copy of the application message.</p>
<p>By default, the MQTT plugin creates classic queues.</p>
<p>The MQTT plugin creates queues transparently for MQTT subscribing clients.
The MQTT specification does not define the concept of queues, and MQTT clients are not aware that these queues exist.
A queue is an implementation detail of how RabbitMQ implements the MQTT protocol.</p>
<p>Figure 3 shows an MQTT subscriber that connects with <code>CleanSession=1</code> and subscribes with QoS 0.
<a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Ref362965194" target="_blank" rel="noopener noreferrer">Clean session</a> means that the MQTT session lasts only as long as the network connection between client and server.
When the session ends, all session state in the server is deleted, which implies the queue gets auto deleted.</p>
<p>As seen in Figure 3, each classic queue results in two additional Erlang processes: one <a href="https://www.erlang.org/doc/design_principles/des_princ.html#supervision-trees" target="_blank" rel="noopener noreferrer">supervisor</a> process, and one worker process.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 3: Native MQTT - Feature flag rabbit_mqtt_qos0_queue disabled" src="/rabbitmq-website/assets/images/mqtt-qos0-queue-disabled-fa8f9b88f2d124e37433682b6793a495.svg" width="1248" height="192" class="img_ev3q"><figcaption>Figure 3: Native MQTT - Feature flag rabbit_mqtt_qos0_queue disabled</figcaption></figure><p></p>
<p>The new queue type optimisation works as follows: If</p>
<ol>
<li>feature flag <code>rabbit_mqtt_qos0_queue</code> is enabled, and</li>
<li>an MQTT client connects with <code>CleanSession=1</code>, and</li>
<li>the MQTT client subscribes with QoS 0</li>
</ol>
<p>then, the MQTT plugin will create a queue of type <code>rabbit_mqtt_qos0_queue</code> instead of a classic queue.</p>
<p>Figure 4 shows that the new queue type is a &quot;pseudo&quot; queue or &quot;virtual&quot; queue:
It is very different from the queue types you know (classic queues, <a href="/rabbitmq-website/docs/quorum-queues">quorum queues</a>, and <a href="/rabbitmq-website/docs/streams">streams</a>) in the sense that this new queue type is neither a separate Erlang process nor does it store messages on disk.
Instead, this queue type is a subset of the Erlang process mailbox.
MQTT messages are directly sent to the MQTT connection process of the subscribing client.
In other words, MQTT messages are sent to any &quot;online&quot; MQTT subscribers.</p>
<p>It is more accurate to think of the queue being skipped (as indicated in the last line <code>no queue at all? ðŸ¤”</code> in <a href="https://youtu.be/CRDmKZhYmxw?t=596" target="_blank" rel="noopener noreferrer">this slide from the RabbitMQ summit 2022 talk</a>).
The fact that sending messages directly to the MQTT connection process is implemented as a queue type is to simplify routing of messages and protocol interoperability, such that messages
can not only be sent from the MQTT publishing connection process, but also from the channel process.
The latter enables sending messages from an AMQP 0.9.1, AMQP 1.0 or STOMP client directly to the MQTT subscriber connection process skipping a dedicated queue process.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 4: Native MQTT - Feature flag rabbit_mqtt_qos0_queue enabled" src="/rabbitmq-website/assets/images/mqtt-qos0-queue-enabled-c8c55758ae99532ae11140a7de34f612.svg" width="1248" height="192" class="img_ev3q"><figcaption>Figure 4: Native MQTT - Feature flag rabbit_mqtt_qos0_queue enabled</figcaption></figure><p></p>
<p>We now understand that this new queue type skips the queue process.
However, what are the advantages of doing so in the context of MQTT?
MQTT workloads are characterised by many devices sending data to and receiving data from the broker.
Here are four reasons in decreasing importance how the new queue type provides optimisations:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benefit-1-large-fan-outs">Benefit 1: large fan-outs<a href="#benefit-1-large-fan-outs" class="hash-link" aria-label="Direct link to Benefit 1: large fan-outs" title="Direct link to Benefit 1: large fan-outs">â€‹</a></h3>
<p>Enable large fan-outs sending a message from the &quot;cloud&quot; (MQTT broker) to all devices.</p>
<p>For classic queues and quorum queues, each queue client (i.e. the channel process or MQTT connection process) keeps state for all destination queues for the purpose of flow control.
For example, the channel process holds the number of credits from each destination queue in its <a href="https://www.erlang.org/doc/reference_manual/processes.html#process-dictionary" target="_blank" rel="noopener noreferrer">process dictionary</a>.
(Read <a href="//blog.rabbitmq.com/blog/2020/05/04/quorum-queues-and-flow-control-the-concepts#credit-based-flow-control" target="_blank" rel="noopener noreferrer">our blog post about credit-based flow control</a> to learn more.)</p>
<ul>
<li>If there is 1 channel process that sends to 3 million MQTT devices, 3 million entries (hundreds of MBs of memory) are kept in the channel process dictionary.</li>
<li>If there are 100 channel processes each sending to 3 million devices, there are in total 300 million entries in the process dictionaries (better not try this).</li>
<li>If there are a few thousand channels or MQTT connection processes each sending a message to 3 million devices, RabbitMQ will run out of memory and crash.</li>
</ul>
<p>Even if these huge fan-outs happen extremely rarely, e.g. once a day, the state from the sending Erlang process to all destination queues is always kept in memory (until the destination queue gets deleted).</p>
<p>The most important characteristic of the new queue type is that its queue type client is stateless.
This means that the MQTT connection or channel process can send a message (&quot;fire &amp; forget&quot;) to 3 million MQTT connection processes (which still temporarily requires significant amount of memory) without
keeping any state to the destination queues. Once garbage collection kicked in, the queue client process memory usage drops to 0 MB.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benefit-2-lower-memory-usage">Benefit 2: lower memory usage<a href="#benefit-2-lower-memory-usage" class="hash-link" aria-label="Direct link to Benefit 2: lower memory usage" title="Direct link to Benefit 2: lower memory usage">â€‹</a></h3>
<p>Not only for large fan-outs, but also in 1:1 topologies (where each publisher sends to exactly one subscriber), the new queue type <code>rabbit_mqtt_qos0_queue</code> saves substantial amount of memory by skipping queue processes.</p>
<p>Even with Native MQTT in 3.12, with feature flag <code>rabbit_mqtt_qos0_queue</code> disabled, 3 million MQTT devices subscribing with QoS 0 results in 9 million Erlang processes.
With feature flag <code>rabbit_mqtt_qos0_queue</code> enabled, the same workload results in only 3 million Erlang processes because the additional queue supervisor and queue worker processes per MQTT subscriber are skipped saving several GBs of process memory.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benefit-3-lower-publisher-confirm-latency">Benefit 3: lower publisher confirm latency<a href="#benefit-3-lower-publisher-confirm-latency" class="hash-link" aria-label="Direct link to Benefit 3: lower publisher confirm latency" title="Direct link to Benefit 3: lower publisher confirm latency">â€‹</a></h3>
<p>Despite an MQTT client subscribing with QoS 0, another MQTT client can still send messages with QoS 1 (or equivalently the channel from an AMQP 0.9.1 sending client can be put in confirm mode).
In that case, the publishing client requires a publisher confirmation from the broker.</p>
<p>The new queue type&#x27;s client (part of the MQTT publisher connection process or channel process) auto-confirms directly on behalf of the &quot;queue server process&quot; because the at-most-once QoS 0 message might be lost anyway on the way from broker to MQTT subscriber.
This results in lower publisher confirm latency.</p>
<p>In RabbitMQ a message is only confirmed back to the publishing client once <strong>all</strong> destination queues confirmed they received the message.
Therefore, even more importantly, the publishing process only awaits confirmation from queues that potentially have at-least-once consumers.
With the new queue type the publishing process is not blocked on sending the confirmation back to the publishing client in a scenario where one message is routed to an important quorum queue as well as to one million MQTT QoS 0 subscribers while a single out of the million MQTT connection processes is overloaded (and would therefore reply very slowly).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benefit-4-lower-end-to-end-latency">Benefit 4: lower end-to-end latency<a href="#benefit-4-lower-end-to-end-latency" class="hash-link" aria-label="Direct link to Benefit 4: lower end-to-end latency" title="Direct link to Benefit 4: lower end-to-end latency">â€‹</a></h3>
<p>Because the queue process is skipped, there is one fewer message hop resulting in lower end-to-end latency.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overload-protection">Overload protection<a href="#overload-protection" class="hash-link" aria-label="Direct link to Overload protection" title="Direct link to Overload protection">â€‹</a></h3>
<p>Because the new queue type has no flow control, MQTT messages might arrive faster in the MQTT connection process mailbox than they can be delivered to the MQTT subscribing client from the MQTT connection process.
This can happen when the network connection between MQTT subscribing client and RabbitMQ is poor or in a large fan-in scenario where many publishers overload a single MQTT subscribing client.</p>
<p>To protect against high memory usage due to MQTT QoS 0 messages piling up in the MQTT connection process mailbox, RabbitMQ intentionally drops QoS 0 messages from the <code>rabbit_mqtt_qos0_queue</code> if both conditions are true:</p>
<ol>
<li>the number of messages in the MQTT connection process mailbox exceeds the setting <code>mqtt.mailbox_soft_limit</code> (defaults to 200), and</li>
<li>the socket sending to the MQTT client is busy (not sending fast enough).</li>
</ol>
<p>Note that there can be other messages in the process mailbox (e.g. applications messages sent from the MQTT subscribing client to RabbitMQ or confirmations from another queue type to the MQTT connection process) which are obviously not dropped.
However, these other messages also contribute to the <code>mqtt.mailbox_soft_limit</code>.</p>
<p>Setting <code>mqtt.mailbox_soft_limit</code> to 0 disables the overload protection mechanism meaning QoS 0 messages are never dropped intentionally by RabbitMQ.
Setting <code>mqtt.mailbox_soft_limit</code> to a very high value decreases the likelihood of intentionally dropping QoS 0 messages while increasing the risk of causing a cluster wide <a href="/rabbitmq-website/docs/memory">memory alarm</a> (especially if the message payloads are large or if there are many overloaded queues of type <code>rabbit_mqtt_qos0_queue</code>).</p>
<p>The <code>mqtt.mailbox_soft_limit</code> can be thought of a <a href="/rabbitmq-website/docs/maxlength">queue length limit</a> although not precisely because, as mentioned previously, the Erlang process mailbox can contain other messages than MQTT application messages.
This is why the configuration key <code>mqtt.mailbox_soft_limit</code> contains the word <code>soft</code>.
The described overload protection mechanism corresponds roughly to overflow behaviour <code>drop-head</code> that you already know from classic queues and quorum queues.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue-type-naming">Queue type naming<a href="#queue-type-naming" class="hash-link" aria-label="Direct link to Queue type naming" title="Direct link to Queue type naming">â€‹</a></h3>
<p>Do not rely on the name of this new queue type.
The name of the feature flag <code>rabbit_mqtt_qos0_queue</code> will not change.
However, we might change the name of queue type <code>rabbit_mqtt_qos0_queue</code> in the future in case we decide to reuse part of its design in other RabbitMQ use cases (such as <a href="/rabbitmq-website/docs/direct-reply-to">Direct Reply-to</a>).</p>
<p>In fact, neither MQTT client applications nor RabbitMQ core (the Erlang application <code>rabbit</code>) are aware of the new queue type.
End users will not be aware of the new queue type either except when listing queues in the Management UI or via <code>rabbitmqctl</code>.</p>
<p>Given that we now understand the architecture of Native MQTT and the intent of the MQTT QoS 0 queue type, we can move on with performance benchmarks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-usage">Memory Usage<a href="#memory-usage" class="hash-link" aria-label="Direct link to Memory Usage" title="Direct link to Memory Usage">â€‹</a></h2>
<p>This section compares memory usage of MQTT in RabbitMQ 3.11 and Native MQTT in RabbitMQ 3.12.
The complete test setup can be found in <a href="https://github.com/ansd/rabbitmq-mqtt/tree/blog-post-native-mqtt" target="_blank" rel="noopener noreferrer">ansd/rabbitmq-mqtt</a>.</p>
<p>The two tests in this section were done against a 3-node cluster with the following subset of RabbitMQ configuration:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.sndbuf = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.recbuf = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.buffer = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">management_agent.disable_metrics_collector = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>TCP buffer sizes are configured to be small such that they do not cause high binary memory usage.</p>
<p>Metrics collection is disabled in the <code>rabbitmq_management</code> plugin.
For production use cases, Prometheus should be used.
The <code>rabbitmq_management</code> plugin is not designed to handle a high number of stats emitting objects such as queues and connections.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-million-mqtt-connections">1 million MQTT connections<a href="#1-million-mqtt-connections" class="hash-link" aria-label="Direct link to 1 million MQTT connections" title="Direct link to 1 million MQTT connections">â€‹</a></h3>
<p>The first test uses 1,000,000 MQTT connections that send only MQTT Keep Alives after connection establishment.
No MQTT application messages are sent or received.</p>
<p>As shown in Figure 5, the 3-node cluster requires 108.0 + 100.7 + 92.4 = 301.1 GiB in 3.11 and only 6.1 + 6.3 + 6.3 = 18.7 GiB of memory in 3.12.
Therefore 3.11 requires 16 times (or 282 GiB) more memory than 3.12.
Native MQTT reduces memory usage by 94%.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 5: Memory usage connecting 1 million MQTT clients" src="/rabbitmq-website/assets/images/native-mqtt-memory-1mio-conn-83ff516dc32495df8565c5cad6ff5623.png" width="2335" height="1110" class="img_ev3q"><figcaption>Figure 5: Memory usage connecting 1 million MQTT clients</figcaption></figure><p></p>
<p>The biggest part contributing to memory usage in 3.11 is <strong>process</strong> memory.
As explained in the <a href="#overview">Overview</a> section, Native MQTT in 3.12 uses 1 Erlang process per MQTT connection while 3.11 uses 22 Erlang processes per MQTT connection.
Some of the 3.11 processes keep large states causing high memory usage.</p>
<p>Native MQTT&#x27;s low memory usage is not only achieved by using a single Erlang process, but also by reducing the state of that single Erlang process.
Numerous memory optimisations are implemented in PR <a href="https://github.com/rabbitmq/rabbitmq-server/pull/5895" target="_blank" rel="noopener noreferrer">#5895</a> such as removing long lists and unnecessary function references from the process state.</p>
<p>Further tests on development environments show that Native MQTT requires around 56 GB of memory per node in a 3-node cluster for a total of 9 million MQTT connections.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="100k-publishers-100k-subscribers">100k publishers, 100k subscribers<a href="#100k-publishers-100k-subscribers" class="hash-link" aria-label="Direct link to 100k publishers, 100k subscribers" title="Direct link to 100k publishers, 100k subscribers">â€‹</a></h3>
<p>The second test uses 100,000 publishers and 100,000 subscribers.
They send and receive in a 1:1 topology meaning each publisher sends a QoS 0 application message every 2 minutes to exactly one QoS 0 subscriber.</p>
<p>As shown in Figure 6, the 3-node cluster requires 21.6 + 21.5 + 21.7 = 64.8 GiB in 3.11 and only 2.6 + 2.6 + 2.6 = 7.8 GiB of memory in 3.12.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 6: Memory usage connecting 100,000 publishers and 100,000 subscribers" src="/rabbitmq-website/assets/images/native-mqtt-memory-100k-pub-100k-sub-30f77c2766cc6484fef6aebbc467b4bb.png" width="2333" height="1053" class="img_ev3q"><figcaption>Figure 6: Memory usage connecting 100,000 publishers and 100,000 subscribers</figcaption></figure><p></p>
<p>Further tests on development environments show that Native MQTT requires around 47 GB of memory per node in a 3-node cluster for the following scenario:</p>
<ul>
<li>3 million MQTT connections in total</li>
<li>1:1 topology</li>
<li>1.5 million publishers sending QoS 1 messages with 64 bytes of payload every 3 minutes</li>
<li>1.5 million QoS 1 subscribers (i.e. 1.5 million classic queues <a href="/rabbitmq-website/docs/persistence-conf#queue-version">version 2</a>)</li>
</ul>
<p>PR <a href="https://github.com/rabbitmq/rabbitmq-server/pull/6684" target="_blank" rel="noopener noreferrer">#6684</a> that shipped in RabbitMQ 3.11.6 substantially reduces memory usage of many classic queues benefitting the use case
of many MQTT QoS 1 or <code>CleanSession=0</code> subscribers.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="latency-and-throughput">Latency and Throughput<a href="#latency-and-throughput" class="hash-link" aria-label="Direct link to Latency and Throughput" title="Direct link to Latency and Throughput">â€‹</a></h2>
<p>To compare latency between MQTT in 3.11 and Native MQTT in 3.12 we use <a href="https://github.com/ansd/mqtt-bm-latency/tree/blog-post-native-mqtt" target="_blank" rel="noopener noreferrer">mqtt-bm-latency</a>.</p>
<p>The following latency benchmarks were executed on a physical Ubuntu 22.04 box with 8 CPUs and 32 GB of RAM.
Clients and single node RabbitMQ server run on the same machine.</p>
<p>In the root directory of <a href="https://github.com/rabbitmq/rabbitmq-server" target="_blank" rel="noopener noreferrer">rabbitmq-server</a> start the server with 4 scheduler threads:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> run-broker </span><span class="token assign-left variable" style="color:#36acaa">PLUGINS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;rabbitmq_mqtt&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_CONFIG_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;rabbitmq.conf&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;+S 4&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The server runs with the following <code>rabbitmq.conf</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.mailbox_soft_limit = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.nodelay = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.backlog = 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.sndbuf = 87380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.recbuf = 87380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.buffer = 87380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">classic_queue.default_version = 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first line is only used in RabbitMQ 3.12 and disables overload protection ensuring all QoS 0 messages are delivered to the subscribers.</p>
<p>The 3.11 benchmarks use Git tag <code>v3.11.10</code>.
The 3.12 benchmarks use Git tag <code>v3.12.0-beta.2</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="latency-and-throughput-qos-1">Latency and Throughput QoS 1<a href="#latency-and-throughput-qos-1" class="hash-link" aria-label="Direct link to Latency and Throughput QoS 1" title="Direct link to Latency and Throughput QoS 1">â€‹</a></h3>
<p>The first benchmark compares latency and throughput of QoS 1 messages sent to QoS 1 subscribers.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./mqtt-bm-latency </span><span class="token parameter variable" style="color:#36acaa">-clients</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-count</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-pubqos</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-subqos</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-size</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-keepalive</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">120</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-topic</span><span class="token plain"> t</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This benchmark uses 100 MQTT client &quot;pairs&quot; sending in a 1:1 topology.
In other words, there are a total of 200 MQTT clients: 100 publishers and 100 subscribers.
Each publisher sends 10,000 messages to a single subscriber.</p>
<p>All MQTT clients run concurrently.
However, application messages are sent synchronously from publishing client to RabbitMQ:
Each publisher sends a QoS 1 message and waits until it receives the <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718043" target="_blank" rel="noopener noreferrer">PUBACK</a> from RabbitMQ before sending the next one.</p>
<p>The subscribing client also replies with a PUBACK packet for each <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718037" target="_blank" rel="noopener noreferrer">PUBLISH</a> packet it receives.</p>
<p>The topic <code>t</code> in above command is just a topic prefix.
Each publishing client publishes to a different topic by appending its index to the given topic (e.g. the first publisher publishes to topic <code>t-0</code>, the second to <code>t-1</code>, etc.).</p>
<p>Results for 3.11:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">================= TOTAL PUBLISHER (100) =================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Publish Success Ratio:   100.000% (1000000/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Runtime (sec):           75.835</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Average Runtime (sec):         75.488</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time min (ms):             0.167</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time max (ms):             101.331</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time mean mean (ms):       7.532</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time mean std (ms):        0.037</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Average Bandwidth (msg/sec):   132.475</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Bandwidth (msg/sec):     13247.470</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">================= TOTAL SUBSCRIBER (100) =================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Forward Success Ratio:      100.000% (1000000/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency min (ms):         0.177</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency max (ms):         94.045</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency mean std (ms):    0.032</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Mean forward latency (ms):  6.737</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Results for 3.12:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">================= TOTAL PUBLISHER (100) =================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Publish Success Ratio:   100.000% (1000000/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Runtime (sec):           55.955</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Average Runtime (sec):         55.570</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time min (ms):             0.175</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time max (ms):             96.725</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time mean mean (ms):       5.550</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pub time mean std (ms):        0.031</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Average Bandwidth (msg/sec):   179.959</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Bandwidth (msg/sec):     17995.888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">================= TOTAL SUBSCRIBER (100) =================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Forward Success Ratio:      100.000% (1000000/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency min (ms):         0.108</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency max (ms):         51.421</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency mean std (ms):    0.028</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Mean forward latency (ms):  2.880</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>Total Publish Success Ratio</code> and <code>Total Forward Success Ratio</code> validate that a total of <code>100 publishers * 10,000 messages = 1,000,000 messages</code> were processed by RabbitMQ.</p>
<p><code>Total Runtime</code> and <code>Average Runtime</code> show the first huge performance difference:
With Native MQTT each publisher receives all 10,000 publisher confirmations (PUBACKs) from the server within 55 seconds.
MQTT in 3.11 requires 75 seconds.</p>
<p><code>Pub time mean mean</code> demonstrates that the average publisher confirm latency drops from 7.532 milliseconds in 3.11 by 1.982 milliseconds or 26% to 5.550 milliseconds in 3.12.</p>
<p>As depicted in Figure 7, the throughput of 100 concurrent clients each synchronously publishing MQTT QoS 1 messages to RabbitMQ increases from 13,247 messages per second in 3.11 by 4,748 messages per second or 36% to 17,995 messages per second in 3.12.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 7: Publish Throughput with QoS 1 (3.12 performs better because throughput is higher)" src="/rabbitmq-website/assets/images/native-mqtt-bandwidth-cc40c22dfa5b7dcebd0127b95ab9d3bb.svg" width="600" height="371" class="img_ev3q"><figcaption>Figure 7: Publish Throughput with QoS 1 (3.12 performs better because throughput is higher)</figcaption></figure><p></p>
<p>The <code>forward latency</code> statistics represent the end-to-end latency, i.e. how long it takes from publishing the message to receiving the message in the clients.
It is measured by having the publisher include a timestamp in each message payload.</p>
<p>Figure 8 illustrates that the <code>Total mean forward latency</code> drops from 6.737 milliseconds in 3.11 by 3.857 milliseconds or 57% to 2.880 milliseconds in 3.12.</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Figure 8: End-to-end latency with QoS 1 (3.12 performs better because latency is lower)" src="/rabbitmq-website/assets/images/native-mqtt-latency-1e0e206649b1e6ffd4e00f02302ebd6c.svg" width="600" height="371" class="img_ev3q"><figcaption>Figure 8: End-to-end latency with QoS 1 (3.12 performs better because latency is lower)</figcaption></figure><p></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="latency-qos-0">Latency QoS 0<a href="#latency-qos-0" class="hash-link" aria-label="Direct link to Latency QoS 0" title="Direct link to Latency QoS 0">â€‹</a></h3>
<p>The second latency benchmark looks very similar to the first but uses QoS 0 for messages being published and QoS 0 for subscriptions.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./mqtt-bm-latency </span><span class="token parameter variable" style="color:#36acaa">-clients</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-count</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-pubqos</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-subqos</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-size</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-keepalive</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">120</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-topic</span><span class="token plain"> t</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since clients connect with <code>CleanSession=1</code> RabbitMQ creates one <code>rabbit_mqtt_qos0_queue</code> per subscriber.
The queue process is therefore skipped.</p>
<p>Publisher results are omitted here for 3.11 and 3.12 because they are very low (<code>Pub time mean mean</code> is 5 microseconds).
Publishing clients send (&quot;fire &amp; forget&quot;) all 1 million messages to the server at once without waiting for a PUBACK response.</p>
<p>Results for 3.11:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">================= TOTAL SUBSCRIBER (100) =================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Forward Success Ratio:      100.000% (1000000/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency min (ms):         3.907</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency max (ms):         12855.600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency mean std (ms):    883.343</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Mean forward latency (ms):  7260.071</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Results for 3.12:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">================= TOTAL SUBSCRIBER (100) =================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Forward Success Ratio:      100.000% (1000000/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency min (ms):         0.461</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency max (ms):         5003.936</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forward latency mean std (ms):    596.133</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Mean forward latency (ms):  2426.867</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>Total mean forward latency</code> drops from 7,260.071 milliseconds in 3.11 by 4,833.204 milliseconds or 66% to 2,426.867 milliseconds in 3.12.</p>
<p>Compared to the QoS 1 benchmarks, the end-to-end latency of 7.2 seconds in 3.11 and 2.4 seconds in 3.12 is very high, because the broker is temporarily flooded with all 1 million MQTT messages at once.</p>
<p>Disabling credit flow (by setting <code>{credit_flow_default_credit, {0, 0}}</code> in <code>advanced.config</code>) does not improve latency in 3.11.</p>
<p>An exercise left for the interested reader is to run the same benchmark against 3.12 with feature flag <code>rabbit_mqtt_qos0_queue</code> disabled to see the latency difference of skipping the queue process.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-else-improves-with-native-mqtt-in-312">What else improves with Native MQTT in 3.12?<a href="#what-else-improves-with-native-mqtt-in-312" class="hash-link" aria-label="Direct link to What else improves with Native MQTT in 3.12?" title="Direct link to What else improves with Native MQTT in 3.12?">â€‹</a></h2>
<p>The following list contains miscellaneous items that change with Native MQTT in 3.12:</p>
<ul>
<li>The MQTT 3.1.1 feature of allowing the <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718068" target="_blank" rel="noopener noreferrer">SUBACK</a> packet to include a failure return code (0x80) is implemented.</li>
<li>The AMQP 0.9.1 header <code>x-mqtt-dup</code> is removed because its usage within the MQTT plugin was wrong up to 3.11. This is a breaking change if your AMQP 0.9.1 clients depend on this header.</li>
<li>All queues created by the MQTT plugin are durable. This is done to ease the transition to <a href="https://github.com/rabbitmq/khepri" target="_blank" rel="noopener noreferrer">Khepri</a> in a future RabbitMQ version.</li>
<li>The MQTT plugin creates <a href="/rabbitmq-website/docs/queues#exclusive-queues">exclusive</a> (instead of <a href="/rabbitmq-website/docs/queues#temporary-queues">auto-delete</a>) queues for clean sessions.</li>
<li>MQTT client ID tracking (to terminate an existing MQTT connection if a new client connects with the same client ID) is implemented in <a href="https://www.erlang.org/doc/man/pg.html" target="_blank" rel="noopener noreferrer">pg</a>. The previous <a href="https://github.com/rabbitmq/ra" target="_blank" rel="noopener noreferrer">Ra</a> cluster that used to track MQTT client IDs is deleted when feature flag <code>delete_ra_cluster_mqtt_node</code> gets enabled. The old Ra cluster required a lot of memory and became a bottleneck when disconnecting too many clients at once.</li>
<li>Prometheus metrics are implemented using <a href="https://github.com/rabbitmq/rabbitmq-server/blob/main/deps/rabbitmq_prometheus/metrics.md#global-counters" target="_blank" rel="noopener noreferrer">global counters</a>. The protocol label has the value <code>mqtt310</code> or <code>mqtt311</code>. An example of such a metric is: <code>rabbitmq_global_messages_routed_total{protocol=&quot;mqtt311&quot;} 10</code>.</li>
<li>The MQTT parser got optimised.</li>
<li>MQTT clients that have never published application messages are not blocked during <a href="/rabbitmq-website/docs/alarms">memory and disk alarms</a> such that subscribers can continue emptying queues.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="should-i-use-rabbitmq-as-an-mqtt-broker">Should I use RabbitMQ as an MQTT broker?<a href="#should-i-use-rabbitmq-as-an-mqtt-broker" class="hash-link" aria-label="Direct link to Should I use RabbitMQ as an MQTT broker?" title="Direct link to Should I use RabbitMQ as an MQTT broker?">â€‹</a></h2>
<p>Native MQTT enables many new use cases as it allows an order of magnitude more IoT devices to connect to RabbitMQ.
The set of use cases is broad.</p>
<p>RabbitMQ is only one MQTT broker on the market.
There are other good MQTT brokers out there and some will be able to handle even more MQTT client connections than RabbitMQ because other brokers are specialised in MQTT only.</p>
<p>The strength of RabbitMQ is that it is more than just an MQTT broker.
It is a general-purpose multi-protocol broker.
The real power of RabbitMQ is protocol interoperability in combination with flexible routing and choice of queue types.</p>
<p>To provide an example: As a payment processing company, you could connect hundreds of thousands or a few million cash terminals distributed all over the world to a central RabbitMQ cluster where each cash
terminal sends MQTT QoS 1 messages every few minutes to RabbitMQ (whenever a customer does a payment).</p>
<p>These MQTT messages containing payment data are of high importance to your business.
Under no circumstances (node failure, disk failure, network partitions) are the messages allowed to be lost.
They also need to be processed by one or more microservices.</p>
<p>One solution is to bind a few quorum queues to the topic exchange where each quorum queue binds with a different routing key such that load is spread across the queues.
Each quorum queue is replicated across 3 or 5 RabbitMQ nodes providing high data safety by using the Raft consensus algorithm underneath.
The messages within each quorum queue can be processed by different microservices using more specialised messaging protocols than MQTT, such as AMQP 0.9.1 or AMQP 1.0.</p>
<p>Alternatively, the MQTT plugin could forward the MQTT payment messages to a <a href="//blog.rabbitmq.com/blog/2022/07/13/rabbitmq-3-11-feature-preview-super-streams" target="_blank" rel="noopener noreferrer">super stream</a> that is replicated across multiple RabbitMQ nodes.
Other clients can then do different forms of data analytics by consuming the same messages from the streams multiple times using the <a href="https://github.com/rabbitmq/rabbitmq-server/blob/v3.12.0-beta.2/deps/rabbitmq_stream/docs/PROTOCOL.adoc" target="_blank" rel="noopener noreferrer">RabbitMQ Streams protocol</a>.</p>
<p>The flexibility that RabbitMQ offers is almost endless, and there is no other message broker on the market that provides such a wide range of protocol interoperability, data safety, fault tolerance, scalability, and performance.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="future-work">Future Work<a href="#future-work" class="hash-link" aria-label="Direct link to Future Work" title="Direct link to Future Work">â€‹</a></h2>
<p>Native MQTT shipping in 3.12 is a crucial step for RabbitMQ to be used as an MQTT broker.
However, the MQTT journey does not end here.
In the future, we plan (no promises!) to add the following MQTT improvements:</p>
<ul>
<li>Add support for <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html" target="_blank" rel="noopener noreferrer">MQTT 5.0 (v5)</a> - a feature that is highly asked for by the community. You can track the current progress in PR <a href="https://github.com/rabbitmq/rabbitmq-server/pull/7263" target="_blank" rel="noopener noreferrer">#7263</a>. As of 3.12, RabbitMQ supports only <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener noreferrer">MQTT 3.1.1 (v4)</a> and <a href="https://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html" target="_blank" rel="noopener noreferrer">MQTT 3.1.0 (v3)</a>. Native MQTT has been a prerequisite to develop support for MQTT 5.0.</li>
<li>Improve resiliency when upgrading RabbitMQ nodes that handle millions of MQTT connections and improve resiliency of mass client disconnections (e.g. due to a load balancer crash).</li>
<li>Support huge fan-outs for QoS 1 sending a message at-least-once to all devices. The new queue type <code>rabbit_mqtt_qos0_queue</code> improves large fan-outs by not keeping any state in sending and receiving Erlang processes. However, as of today, sending a message that requires queue confirmations (QoS 1 in MQTT or publisher confirms in AMQP 0.9.1) to millions of queues should be done with extreme care: always use the same publisher and do so very rarely (every few minutes). Note that 1:1 topologies and large fan-ins are not problematic for RabbitMQ.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrapping-up">Wrapping up<a href="#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping up" title="Direct link to Wrapping up">â€‹</a></h2>
<p>Although RabbitMQ has supported MQTT in 3.11, scalability with regards to the number of client connections has been poor and memory usage has been excessive.</p>
<p>Native MQTT shipping in 3.12 turns RabbitMQ into an MQTT broker.
It allows connecting millions of clients to RabbitMQ.
Even if you do not plan to connect that many clients, by upgrading your MQTT workload to 3.12, you will substantially save infrastructure costs because memory usage drops by up to 95%.</p>
<p>As next step, we plan to add support for MQTT 5.0.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/technical-deep-dive">Technical Deep Dive</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/performance">Performance</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/rabbitmq-website/blog/tags/mqtt">MQTT</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/blog/2023-03-21-native-mqtt/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/blog/2023/04/04/announcing-rabbitmq-community-discord-server"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Announcing RabbitMQ Community Discord Server</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/blog/2023/03/02/quorum-queues-migration"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Migrating from Mirrored Classic Queues to Quorum Queues</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#new-mqtt-qos-0-queue-type" class="table-of-contents__link toc-highlight">New MQTT QoS 0 Queue Type</a><ul><li><a href="#benefit-1-large-fan-outs" class="table-of-contents__link toc-highlight">Benefit 1: large fan-outs</a></li><li><a href="#benefit-2-lower-memory-usage" class="table-of-contents__link toc-highlight">Benefit 2: lower memory usage</a></li><li><a href="#benefit-3-lower-publisher-confirm-latency" class="table-of-contents__link toc-highlight">Benefit 3: lower publisher confirm latency</a></li><li><a href="#benefit-4-lower-end-to-end-latency" class="table-of-contents__link toc-highlight">Benefit 4: lower end-to-end latency</a></li><li><a href="#overload-protection" class="table-of-contents__link toc-highlight">Overload protection</a></li><li><a href="#queue-type-naming" class="table-of-contents__link toc-highlight">Queue type naming</a></li></ul></li><li><a href="#memory-usage" class="table-of-contents__link toc-highlight">Memory Usage</a><ul><li><a href="#1-million-mqtt-connections" class="table-of-contents__link toc-highlight">1 million MQTT connections</a></li><li><a href="#100k-publishers-100k-subscribers" class="table-of-contents__link toc-highlight">100k publishers, 100k subscribers</a></li></ul></li><li><a href="#latency-and-throughput" class="table-of-contents__link toc-highlight">Latency and Throughput</a><ul><li><a href="#latency-and-throughput-qos-1" class="table-of-contents__link toc-highlight">Latency and Throughput QoS 1</a></li><li><a href="#latency-qos-0" class="table-of-contents__link toc-highlight">Latency QoS 0</a></li></ul></li><li><a href="#what-else-improves-with-native-mqtt-in-312" class="table-of-contents__link toc-highlight">What else improves with Native MQTT in 3.12?</a></li><li><a href="#should-i-use-rabbitmq-as-an-mqtt-broker" class="table-of-contents__link toc-highlight">Should I use RabbitMQ as an MQTT broker?</a></li><li><a href="#future-work" class="table-of-contents__link toc-highlight">Future Work</a></li><li><a href="#wrapping-up" class="table-of-contents__link toc-highlight">Wrapping up</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
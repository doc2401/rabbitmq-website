<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-3.13 docs-doc-page docs-doc-id-ha/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Classic Queue Mirroring | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/ha"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="3.13"><meta data-rh="true" name="docusaurus_tag" content="docs-default-3.13"><meta data-rh="true" name="docsearch:version" content="3.13"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-3.13"><meta data-rh="true" property="og:title" content="Classic Queue Mirroring | RabbitMQ"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/ha"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/ha" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/ha" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/docs/3.13">Docs</a><a class="navbar__item navbar__link" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs/3.13/ha">3.13</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0">4.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/rabbitmq-website/docs/3.13/ha">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs/3.13">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs/3.13/whats-new">What&#x27;s New</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/3.13/download">Install and Upgrade</a><button aria-label="Expand sidebar category &#x27;Install and Upgrade&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rabbitmq-website/docs/3.13/use-rabbitmq">How to Use RabbitMQ</a><button aria-label="Collapse sidebar category &#x27;How to Use RabbitMQ&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/3.13/publishers">Publishing Messages</a><button aria-label="Expand sidebar category &#x27;Publishing Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/3.13/consumers">Consuming Messages</a><button aria-label="Expand sidebar category &#x27;Consuming Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rabbitmq-website/docs/3.13/queues">Queues</a><button aria-label="Collapse sidebar category &#x27;Queues&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum Queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/classic-queues">Classic Queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rabbitmq-website/docs/3.13/ha">Mirrored Classic Queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/migrate-mcq-to-qq">Migrate Mirrored Classic Queues to Quorum Queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/ttl">Time-to-Live and Expiration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/maxlength">Queue Length</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/lazy-queues">Lazy Queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/dlx">Dead Lettering</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/priority">Priority Queues</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/streams">Streams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/channels">Channels</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/reliability">Reliability and Data Safety</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/confirms">Consumer Acknowledgements and Publisher Confirms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/distributed">Network Distribution</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/3.13/plugins">Plugins</a><button aria-label="Expand sidebar category &#x27;Plugins&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/3.13/protocols">Protocols</a><button aria-label="Expand sidebar category &#x27;Protocols&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/client-libraries">Client Libraries</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/3.13/manage-rabbitmq">How to Manage RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Manage RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/3.13/monitoring">How to Monitor RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Monitor RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->RabbitMQ<!-- --> <b>3.13</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/rabbitmq-website/docs">latest version</a></b> (<!-- -->4.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rabbitmq-website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/3.13/use-rabbitmq"><span itemprop="name">How to Use RabbitMQ</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/3.13/queues"><span itemprop="name">Queues</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Mirrored Classic Queues</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 3.13</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Classic Queue Mirroring (Deprecated)</h1></header>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>This guide covers a feature that had been <a href="/rabbitmq-website/blog/2021/08/21/4.0-deprecation-announcements"><strong>deprecated since 2021</strong></a> and <a href="https://github.com/rabbitmq/rabbitmq-server/pull/9815" target="_blank" rel="noopener noreferrer"><strong>was removed completely</strong></a> from RabbitMQ 4.0.x.</p></div></div>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p><a href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum queues</a> and/or <a href="/rabbitmq-website/docs/3.13/streams">streams</a> should be used instead of mirrored classic queues.
<strong>Non-replicated</strong> classic queues continue being supported and developed.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="interstitial">Wait, There&#x27;s a Better Way: Modern Replicated Queue Type and Streams<a href="#interstitial" class="hash-link" aria-label="Direct link to Wait, There&#x27;s a Better Way: Modern Replicated Queue Type and Streams" title="Direct link to Wait, There&#x27;s a Better Way: Modern Replicated Queue Type and Streams">​</a></h2>
<p>This guide covers a <a href="/rabbitmq-website/blog/2021/08/21/4.0-deprecation-announcements"><strong>long time deprecated</strong></a> and <a href="https://github.com/rabbitmq/rabbitmq-server/pull/9815" target="_blank" rel="noopener noreferrer"><strong>in 4.x, removed</strong></a> legacy feature: mirroring (queue contents replication) of classic queues.
<a href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum queues</a> and/or <a href="/rabbitmq-website/docs/3.13/streams">streams</a> should be used instead of mirrored classic queues.</p>
<p>Quorum queues are a more advanced queue type, which offers high availability using  replication and focuses on data safety. Quorum queues <a href="/rabbitmq-website/blog/2022/05/05/rabbitmq-3.10-release-overview">support message TTL</a> and provide <a href="/rabbitmq-website/blog/2022/05/16/rabbitmq-3.10-performance-improvements">higher throughput and more stable latency</a> compared to mirrored classic queues. Please <a href="/rabbitmq-website/docs/3.13/migrate-mcq-to-qq">migrate from Mirrored Classic Queues to Quorum Queues</a> now.</p>
<p><a href="/rabbitmq-website/docs/3.13/streams">Streams</a> is an <a href="/rabbitmq-website/blog/2021/07/13/rabbitmq-streams-overview">alternative messaging data structure</a> supported by RabbitMQ.
Just like quorum queues, streams are replicated.</p>
<p>Quorum queues should be the <strong>default choice</strong> for a replicated queue type.
Classic queue mirroring will be <strong>removed in a future version</strong> of RabbitMQ:
classic queues will remain a supported non-replicated queue type.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Topics covered in this guide include,
for migrating away from classic mirrored queues:</p>
<ul>
<li><a href="#interstitial">Next generation replicated queues and streams</a>, and why they should be preferred over classic queue mirroring</li>
<li>How to <a href="#detect-usage">detect what policies enable classic queue mirroring</a></li>
</ul>
<p>For historical reference:</p>
<ul>
<li>What is <a href="#what-is-mirroring">classic queue mirroring</a> and how it works</li>
<li>How to <a href="#ways-to-configure">enable it</a></li>
<li>What <a href="#mirroring-arguments">mirroring settings are available</a></li>
<li>Why <a href="#cqv2">mixed CQv1 and CQv2 clusters are not recommended with mirroring</a></li>
<li>What <a href="#replication-factor">replication factor</a> is recommended</li>
<li><a href="#leader-migration-data-locality">Data locality</a></li>
<li><a href="#behaviour">Leader election</a> (mirror promotion) and <a href="#unsynchronised-mirrors">unsynchronised mirrors</a></li>
<li>Mirrored vs. <a href="#non-mirrored-queue-behavior-on-node-failure">non-mirrored queue behavior</a> in case of node failure</li>
<li><a href="#batch-sync">Batch synchronisation</a> of newly added and recovering mirrors</li>
</ul>
<p>and more.</p>
<p>This guide assumes general familiarity with <a href="/rabbitmq-website/docs/3.13/clustering">RabbitMQ clustering</a>, <a href="/rabbitmq-website/docs/3.13/quorum-queues">quorum queues</a>, and <a href="/rabbitmq-website/docs/3.13/streams">streams</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-mirroring">What is Queue Mirroring<a href="#what-is-mirroring" class="hash-link" aria-label="Direct link to What is Queue Mirroring" title="Direct link to What is Queue Mirroring">​</a></h2>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>This guide covers a feature that had been <a href="/rabbitmq-website/blog/2021/08/21/4.0-deprecation-announcements"><strong>deprecated since 2021</strong></a>
and <a href="https://github.com/rabbitmq/rabbitmq-server/pull/9815" target="_blank" rel="noopener noreferrer"><strong>was removed completely</strong></a> for the next major series, RabbitMQ 4.x.</p></div></div>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p><a href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum queues</a> and/or <a href="/rabbitmq-website/docs/3.13/streams">streams</a> should be used instead of mirrored classic queues.
<strong>Non-replicated</strong> classic queues continue being supported and developed.</p></div></div>
<p>By default, contents of a queue within a RabbitMQ cluster are located on
a single node (the node on which the queue was
declared). This is in contrast to exchanges and bindings,
which can always be considered to be on all nodes. Queues
can optionally run mirrors (additional replicas) on other cluster nodes.</p>
<p>Each mirrored queue consists of one <strong>leader replica</strong> and
one or more <strong>mirrors</strong> (replicas). The leader is hosted on one
node commonly referred as the leader node for that queue. Each queue has
its own leader node. All operations for a given queue are first applied
on the queue&#x27;s leader node and then propagated to mirrors. This
involves enqueueing publishes, delivering messages to consumers, tracking
<a href="/rabbitmq-website/docs/3.13/confirms">acknowledgements from consumers</a> and so on.</p>
<p>Queue mirroring implies <a href="/rabbitmq-website/docs/3.13/clustering">a cluster of nodes</a>.
It is therefore not recommended for use
across a WAN (though of course, clients can still connect
from as near and as far as needed).</p>
<p>Messages published to the queue are replicated to all
mirrors. Consumers are connected to the leader regardless of
which node they connect to, with mirrors dropping messages
that have been acknowledged at the leader. Queue mirroring
therefore enhances availability, but does not distribute
load across nodes (all participating nodes each do all the
work).</p>
<p>If the node that hosts queue leader fails, the oldest mirror will be
promoted to the new leader as long as it&#x27;s synchronised. <a href="#unsynchronised-mirrors">Unsynchronised mirrors</a>
can be promoted, too, depending on queue mirroring parameters.</p>
<p>There are multiple terms commonly used to identify primary
and secondary replicas in a distributed system. This guide
typically uses &quot;leader&quot; to refer to the primary replica of a
queue and &quot;mirror&quot; for secondary replicas.</p>
<p>Queue object fields in the HTTP API and CLI tools originally used the unfortunate term
&quot;slave&quot; to refer to secondaries. That term still appears
in column names in CLI tools for backwards compatibility but will be
replaced or removed in a future version.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ways-to-configure">How Mirroring is Configured<a href="#ways-to-configure" class="hash-link" aria-label="Direct link to How Mirroring is Configured" title="Direct link to How Mirroring is Configured">​</a></h2>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>This guide covers a feature that had been <a href="/rabbitmq-website/blog/2021/08/21/4.0-deprecation-announcements"><strong>deprecated since 2021</strong></a>
and <a href="https://github.com/rabbitmq/rabbitmq-server/pull/9815" target="_blank" rel="noopener noreferrer"><strong>was removed completely</strong></a> for the next major series, RabbitMQ 4.x.</p></div></div>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p><a href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum queues</a> and/or <a href="/rabbitmq-website/docs/3.13/streams">streams</a> should be used instead of mirrored classic queues.
<strong>Non-replicated</strong> classic queues continue being supported and developed.</p></div></div>
<p>Mirroring parameters are configured using <a href="/rabbitmq-website/docs/3.13/policies">policies</a>. A policy matches
one or more queues by name (using a regular expression pattern) and
contains a definition (a map of optional arguments) that are added to the total set of
properties of the matching queues.</p>
<p>Please see <a href="/rabbitmq-website/docs/3.13/policies">Runtime Parameters and Policies</a> for more information on policies.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mirroring-arguments">Queue Arguments that Control Mirroring<a href="#mirroring-arguments" class="hash-link" aria-label="Direct link to Queue Arguments that Control Mirroring" title="Direct link to Queue Arguments that Control Mirroring">​</a></h2>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>This guide covers a feature that had been <a href="/rabbitmq-website/blog/2021/08/21/4.0-deprecation-announcements"><strong>deprecated since 2021</strong></a>
and <a href="https://github.com/rabbitmq/rabbitmq-server/pull/9815" target="_blank" rel="noopener noreferrer"><strong>was removed completely</strong></a> for the next major series, RabbitMQ 4.x.</p></div></div>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p><a href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum queues</a> and/or <a href="/rabbitmq-website/docs/3.13/streams">streams</a> should be used instead of mirrored classic queues.
<strong>Non-replicated</strong> classic queues continue being supported and developed.</p></div></div>
<p>As we&#x27;ve covered above, queues have mirroring enabled
via <a href="/rabbitmq-website/docs/3.13/policies">policy</a>. Policies
can change at any time; it is valid to create a non-mirrored
queue, and then make it mirrored at some later point (and
vice versa). There is a difference between a non-mirrored
queue and a mirrored queue which does not have any mirrors -
the former lacks the extra mirroring infrastructure and will
likely provide higher throughput.</p>
<p>Adding mirrors to a queue increases cluster load but
helps lower the probability of <a href="#unsynchronised-mirrors">losing all up-to-date replicas</a>.</p>
<p>To make the classic queues mirrored, create a
policy which matches them and sets policy keys <code>ha-mode</code> and (optionally) <code>ha-params</code>.
The following table explains the options for these keys:</p>
<table><tr><th><code>ha-mode</code></th><th><code>ha-params</code></th><th>Result</th></tr><tr><td><code>exactly</code></td><td><i>count</i></td><td><p>Number of queue replicas (leader plus mirrors) in the cluster.</p><p>A <i>count</i> value of 1 means a single replica: just the queue leader.
If the node running the queue leader becomes
unavailable, <a href="#non-mirrored-queue-behavior-on-node-failure">the behaviour depends on queue durability</a>.</p><p>A <i>count</i> value of 2 means 2 replicas: 1 queue leader and 1 queue
mirror. In other words: <code>NumberOfQueueMirrors = NumberOfNodes - 1</code>.
If the node running the queue leader becomes unavailable,
the queue mirror will be automatically promoted to leader
according to the <a href="#unsynchronised-mirrors">mirror promotion strategy</a> configured.</p><p>If there are fewer than <i>count</i> nodes in the cluster, the
queue is mirrored to all nodes. If there are more than
<i>count</i> nodes in the cluster, and a node containing a mirror
goes down, then a new mirror will be created on another node. Use
of <code>exactly</code> mode with <a href="#cluster-shutdown">
<code>&quot;ha-promote-on-shutdown&quot;: &quot;always&quot;</code></a> can be
dangerous since queues can migrate across a cluster and become
unsynced as it is brought down.</p></td></tr><tr><td><code>all</code></td><td>(none)</td><td><p>Queue is mirrored across all nodes in the
cluster. When a new node is added to the cluster, the
queue will be mirrored to that node.</p><p>This setting is very
conservative. Mirroring to a quorum (N/2 + 1) of cluster nodes
is <a href="#replication-factor">recommended instead</a>.
Mirroring to all nodes will put additional
strain on all cluster nodes, including network I/O, disk I/O and
disk space usage.</p></td></tr><tr><td><code>nodes</code></td><td><i>node names</i></td><td><p>Queue is mirrored to the nodes listed in <i>node names</i>.
Node names are the Erlang node names as they
appear in <code>rabbitmqctl cluster_status</code>; they
usually have the form &quot;<tt>rabbit@hostname</tt>&quot;.</p><p>If any of those node names are not a part of the cluster,
this does not constitute an error. If none of the nodes
in the list are online at the time when the queue is
declared then the queue will be created on the node that
the declaring client is connected to.</p></td></tr></table>
<p>Whenever the HA policy for a queue changes it will endeavour
to keep its existing mirrors as far as this fits with the new
policy.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="replication-factor">Replication Factor: How Many Mirrors are Optimal?<a href="#replication-factor" class="hash-link" aria-label="Direct link to Replication Factor: How Many Mirrors are Optimal?" title="Direct link to Replication Factor: How Many Mirrors are Optimal?">​</a></h3>
<p>Mirroring to all nodes is the most conservative option.
It will put additional strain on all cluster nodes, including network I/O, disk I/O and
disk space usage. Having a replica on every node is unnecessary in most cases.</p>
<p>For clusters of 3 and more nodes
it is recommended to replicate to a quorum (the majority) of nodes,
e.g. 2 nodes in a 3 node cluster or 3 nodes in a 5 node cluster.</p>
<p>Since some data can be inherently transient or very time sensitive,
it can be perfectly reasonable to use a lower number of mirrors
for some queues (or even not use any mirroring).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-check-i-a-queue-is-mirrored">How to Check if a Queue is Mirrored?<a href="#how-to-check-i-a-queue-is-mirrored" class="hash-link" aria-label="Direct link to How to Check if a Queue is Mirrored?" title="Direct link to How to Check if a Queue is Mirrored?">​</a></h2>
<p>Mirrored queues will have a policy name and the number of additional replicas (mirrors)
next to it on the queue page in the <a href="/rabbitmq-website/docs/3.13/management">management UI</a>.</p>
<p>Below is an example of a queue named <code>two.replicas</code> which has a leader
and a mirror:</p>
<figure><p><img decoding="async" loading="lazy" alt="Mirrored queue indicators in management UI" src="/rabbitmq-website/assets/images/queue_mirroring_indicators_management_ui_row_only-ccaea71cc4235863bd01cc86e324ae21.png" width="944" height="200" class="img_ev3q"></p></figure>
<p>leader node for the queue and its online mirror(s), if any, will be listed on the queue page:</p>
<figure><p><img decoding="async" loading="lazy" alt="Mirrored queue details on individual queue page" src="/rabbitmq-website/assets/images/queue_mirroring_one_mirror_present-a2483a78f01e0813ddbf1c70ce840f67.png" width="710" height="492" class="img_ev3q"></p></figure>
<p>If the queue page does not list any mirrors, the queue is not mirrored (or has only one mirror which
is not online):</p>
<figure><p><img decoding="async" loading="lazy" alt="Non-mirrored queue details on individual queue page" src="/rabbitmq-website/assets/images/queue_mirroring_no_mirrors-69bfbd5bf9411faa6fa7e8fe27cb77a0.png" width="701" height="498" class="img_ev3q"></p></figure>
<p>When a new queue mirror is added, the event is logged:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2018-03-01 07:26:33.121 [info] &lt;0.1360.0&gt; Mirrored queue &#x27;two.replicas&#x27; in vhost &#x27;/&#x27;: Adding mirror on node hare@warp10: &lt;37324.1148.0&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is possible to list queue leader and mirrors using <code>rabbitmqctl list_queues</code>. In this
example we also display queue policy since it&#x27;s highly relevant:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">cmd</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># mirror_pids is a new field alias introduced in RabbitMQ 3.11.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl list_queues name policy pid mirror_pids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; Timeout: 60.0 seconds ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; Listing queues for vhost / ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; two.replicas ha-two &lt;hare@hostname-2.1.2223.0&gt; [&lt;rabbit@hostname-1.3.1360.0&gt;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat list_queues name policy pid mirror_pids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; Timeout: 60.0 seconds ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; Listing queues for vhost / ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; two.replicas ha-two &lt;hare@hostname-2.1.2223.0&gt; [&lt;rabbit@hostname-1.3.1360.0&gt;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-batch codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-batch codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">rem mirror_pids is a new field alias introduced in RabbitMQ 3.11.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token command keyword" style="color:#00009f">rabbitmqctl</span><span class="token command">.bat list_queues name policy pid mirror_pids</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">rem =&gt; Timeout: 60.0 seconds ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">rem =&gt; Listing queues for vhost / ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">rem =&gt; two.replicas ha-two &lt;hare@host-2.1.2223.0&gt; [&lt;rabbit@hostname-1.3.1360.0&gt;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>If a queue that&#x27;s expected to be mirroring is not, this usually means that its name
doesn&#x27;t match that specified in the policy that controls mirroring or that another
policy takes priority (and does not enable mirroring).
See <a href="/rabbitmq-website/docs/3.13/policies">Runtime Parameters and Policies</a> to learn more.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="detect-usage">How to Detect Policies that Enable Classic Queue Mirroring<a href="#detect-usage" class="hash-link" aria-label="Direct link to How to Detect Policies that Enable Classic Queue Mirroring" title="Direct link to How to Detect Policies that Enable Classic Queue Mirroring">​</a></h2>
<p>In order to prepare for migration away from classic mirrored queues, it may be necessary to first
understand whether there are any policies in the cluster that enable use this deprecated feature.</p>
<p>There are two <code>rabbitmq-diagnostics</code> commands that help with this:</p>
<ul>
<li><code>rabbitmq-diagnostics check_if_cluster_has_classic_queue_mirroring_policy</code>, a <a href="/rabbitmq-website/docs/3.13/monitoring#health-checks">health check</a></li>
<li><code>rabbitmq-diagnostics list_policies_with_classic_queue_mirroring</code> that lists the problematic policies</li>
</ul>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">cmd</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># exits with a non-zero code if any policies in the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># enable classic queue mirroring</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics check_if_cluster_has_classic_queue_mirroring_policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># lists policies that enable classic queue mirroring</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics list_policies_with_classic_queue_mirroring </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--formatter</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pretty_table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># exits with a non-zero code if any policies in the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># enabling classic queue mirroring</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat check_if_cluster_has_classic_queue_mirroring_policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># lists policies that enable classic queue mirroring</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat list_policies_with_classic_queue_mirroring </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">formatter=pretty_table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-batch codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-batch codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">rem exits with a non-zero code if any policies in the cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">rem enabling classic queue mirroring</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token command keyword" style="color:#00009f">rabbitmq</span><span class="token command">-diagnostics.bat check_if_cluster_has_classic_queue_mirroring_policy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">rem lists policies that enable classic queue mirroring</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token command keyword" style="color:#00009f">rabbitmq</span><span class="token command">-diagnostics.bat list_policies_with_classic_queue_mirroring </span><span class="token command parameter attr-name" style="color:#00a4db">-s</span><span class="token command"> </span><span class="token command parameter attr-name" style="color:#00a4db">--formatter</span><span class="token command">=pretty_table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cqv2">Mirroring and CQv2<a href="#cqv2" class="hash-link" aria-label="Direct link to Mirroring and CQv2" title="Direct link to Mirroring and CQv2">​</a></h2>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p><a href="/rabbitmq-website/docs/3.13/persistence-conf#queue-version">Classic queues version 2</a> can be used with mirroring.
However, combining v1 and v2 members is not recommended</p></div></div>
<p>It may happen if some nodes default to version 1 while other
nodes default to version 2 (a new mirror will use the local node&#x27;s default version if not explicitly set). Version 2
is significantly faster in many situations and can overload a v1 mirror. The easiest solution is to switch to version 2
using policies before changing the default version in the configuration.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="leader-migration-data-locality">Queue Leader Replicas, Leader Migration, Data Locality<a href="#leader-migration-data-locality" class="hash-link" aria-label="Direct link to Queue Leader Replicas, Leader Migration, Data Locality" title="Direct link to Queue Leader Replicas, Leader Migration, Data Locality">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue-leader-location">Queue Leader Location<a href="#queue-leader-location" class="hash-link" aria-label="Direct link to Queue Leader Location" title="Direct link to Queue Leader Location">​</a></h3>
<p>This section has been moved to the <a href="/rabbitmq-website/docs/3.13/clustering#replica-placement">Clustering guide</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixed-leader-promotion">&quot;nodes&quot; Policy and Migrating Leaders<a href="#fixed-leader-promotion" class="hash-link" aria-label="Direct link to &quot;nodes&quot; Policy and Migrating Leaders" title="Direct link to &quot;nodes&quot; Policy and Migrating Leaders">​</a></h3>
<p>Note that setting or modifying a &quot;nodes&quot; policy can cause
the existing leader to go away if it is not listed in the
new policy. In order to prevent message loss, RabbitMQ will
keep the existing leader around until at least one other
mirror has synchronised (even if this is a long
time). However, once synchronisation has occurred things will
proceed just as if the node had failed: consumers will be
disconnected from the leader and will need to reconnect.</p>
<p>For example, if a queue is on <code>[A B]</code>
(with <code>A</code> the leader), and you give it
a <code>nodes</code> policy telling it to be on
<code>[C D]</code>, it will initially end up on
<code>[A C D]</code>. As soon as the queue synchronises on its new
mirrors <code>[C D]</code>, the leader on <code>A</code>
will shut down.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exclusive-queues-are-not-mirrored">Mirroring of Exclusive Queues<a href="#exclusive-queues-are-not-mirrored" class="hash-link" aria-label="Direct link to Mirroring of Exclusive Queues" title="Direct link to Mirroring of Exclusive Queues">​</a></h3>
<p>Exclusive queues will be deleted when the connection that declared them is
closed. For this reason, it is not useful for an exclusive queue to be mirrored
(or a non-durable queue, for that matter) since when the node hosting it goes
down, the connection will close and the queue will need to be deleted anyway.</p>
<p>For this reason, exclusive queues are never mirrored (even if they match a
policy stating that they should be). They are also never durable (even if
declared as such).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="non-mirrored-queue-behavior-on-node-failure">Non-mirrored Queue Behavior in a Cluster<a href="#non-mirrored-queue-behavior-on-node-failure" class="hash-link" aria-label="Direct link to Non-mirrored Queue Behavior in a Cluster" title="Direct link to Non-mirrored Queue Behavior in a Cluster">​</a></h2>
<p>This guide focuses on mirrored queues, however, it is important
to briefly explain how non-mirrored queues behave in a cluster in contrast
with mirrored ones.</p>
<p>If leader node of a queue (the node running queue leader) is available,
all queue operations (e.g. declaration, binding and consumer management, message routing
to the queue) can be performed on any node. Cluster nodes will route
operations to the leader node transparently to the clients.</p>
<p>If leader node of a queue
becomes unavailable, the behaviour of a non-mirrored queue
depends on its durability. A durable queue will become
unavailable until the node comes back.
All operations on a durable queue with unavailable leader node
will fail with a message in server logs that looks like this:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">operation queue.declare caused a channel exception not_found: home node &#x27;rabbit@hostname&#x27; of durable queue &#x27;queue-name&#x27; in vhost &#x27;/&#x27; is down or inaccessible</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A non-durable one will be deleted.</p>
<p>In case it is desired that the queue remains available at all times,
mirrors can be configured to be <a href="#unsynchronised-mirrors">promoted to leader even when not in sync</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="examples">Examples<a href="#examples" class="hash-link" aria-label="Direct link to Examples" title="Direct link to Examples">​</a></h2>
<p>Below is a policy where queues whose names begin with
&quot;<code>two.</code>&quot; are mirrored to any two nodes in the
cluster, with <a href="#configuring-synchronisation">automatic synchronisation</a>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">HTTP API</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Management UI</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_policy ha-two </span><span class="token string" style="color:#e3116c">&quot;^two\.&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;{&quot;ha-mode&quot;:&quot;exactly&quot;,&quot;ha-params&quot;:2,&quot;ha-sync-mode&quot;:&quot;automatic&quot;}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat set_policy ha-two </span><span class="token string" style="color:#e3116c">&quot;^two\.&quot;</span><span class="token plain"> ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;{&quot;</span><span class="token string" style="color:#e3116c">&quot;ha-mode&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;exactly&quot;</span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token string" style="color:#e3116c">&quot;ha-params&quot;</span><span class="token string" style="color:#e3116c">&quot;:2,&quot;</span><span class="token string" style="color:#e3116c">&quot;ha-sync-mode&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;automatic&quot;</span><span class="token string" style="color:#e3116c">&quot;}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT /api/policies/%2f/ha-two</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;pattern&quot;:&quot;^two\.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;definition&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ha-mode&quot;:&quot;exactly&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ha-params&quot;:2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ha-sync-mode&quot;:&quot;automatic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul><li><p>Navigate to <code>Admin</code> &gt; <code>Policies</code> &gt; <code>Add / update a       policy</code>.</p></li><li><p>Enter &quot;ha-two&quot; next to Name and &quot;^two.&quot; next to
<code>Pattern</code>.</p></li><li><p>Enter &quot;ha-mode&quot; = &quot;exactly&quot; in the first line
next to Policy, then &quot;ha-params&quot; = 2 in the second
line, then &quot;ha-sync-mode&quot; = &quot;automatic&quot; in the third,
and set the type on the second line to &quot;Number&quot;.</p></li><li><p>Click <code>Add policy</code>.</p></li></ul></div></div></div>
<p>The following example uses the <code>&quot;all&quot;</code> mode, which is excessive
and usually unnecessary in clusters of five nodes or larger:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">HTTP API</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Management UI</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Mirroring to all nodes is unnecessary and will result
in unnecessary resource waste.</p><p>Consider mirroring to the majority (N/2+1) nodes with &quot;ha-mode&quot;:&quot;exactly&quot; instead.
See <a href="#replication-factor">Replication Factor</a> above.</p></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_policy ha-all </span><span class="token string" style="color:#e3116c">&quot;^ha\.&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{&quot;ha-mode&quot;:&quot;all&quot;}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Mirroring to all nodes is unnecessary and will result
in unnecessary resource waste.</p><p>Consider mirroring to the majority (N/2+1) nodes with &quot;ha-mode&quot;:&quot;exactly&quot; instead.
See <a href="#replication-factor">Replication Factor</a> above.</p></div></div><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat set_policy ha-all </span><span class="token string" style="color:#e3116c">&quot;^ha\.&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{&quot;</span><span class="token string" style="color:#e3116c">&quot;ha-mode&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;all&quot;</span><span class="token string" style="color:#e3116c">&quot;}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT /api/policies/%2f/ha-two</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;pattern&quot;:&quot;^two\.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;definition&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ha-mode&quot;:&quot;all&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ha-sync-mode&quot;:&quot;automatic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Mirroring to all nodes is unnecessary and will result
in unnecessary resource waste.</p><p>Consider mirroring to the majority (N/2+1) nodes with &quot;ha-mode&quot;:&quot;exactly&quot; instead.
See <a href="#replication-factor">Replication Factor</a> above.</p></div></div><ul><li><p>Navigate to <code>Admin</code> &gt; <code>Policies</code> &gt; <code>Add / update a policy</code>.</p></li><li><p>Enter &quot;ha-all&quot; next to Name, &quot;^ha.&quot; next to <code>Pattern</code>,
and &quot;ha-mode&quot; = &quot;all&quot; into Definition properties (or press Queues[Classic] -&gt; &quot;HA mode&quot; and enter word &quot;all&quot; into value)</p></li><li><p>Click <code>Add policy</code>.</p></li></ul></div></div></div>
<p>A policy where queues whose names begin with
&quot;<code>nodes.</code>&quot; are mirrored to specific nodes in the
cluster:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">HTTP API</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Management UI</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_policy ha-nodes </span><span class="token string" style="color:#e3116c">&quot;^nodes\.&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;{&quot;ha-mode&quot;:&quot;nodes&quot;,&quot;ha-params&quot;:[&quot;rabbit@nodeA&quot;, &quot;rabbit@nodeB&quot;]}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat set_policy ha-nodes </span><span class="token string" style="color:#e3116c">&quot;^nodes\.&quot;</span><span class="token plain"> ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;{&quot;</span><span class="token string" style="color:#e3116c">&quot;ha-mode&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;nodes&quot;</span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token string" style="color:#e3116c">&quot;ha-params&quot;</span><span class="token string" style="color:#e3116c">&quot;:[&quot;</span><span class="token string" style="color:#e3116c">&quot;rabbit@nodeA&quot;</span><span class="token string" style="color:#e3116c">&quot;, &quot;</span><span class="token string" style="color:#e3116c">&quot;rabbit@nodeB&quot;</span><span class="token string" style="color:#e3116c">&quot;]}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT /api/policies/%2f/ha-nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;pattern&quot;:&quot;^nodes\.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;definition&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;ha-mode&quot;:&quot;nodes&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;ha-params&quot;:[&quot;rabbit@nodeA&quot;, &quot;rabbit@nodeB&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ul><li><p>Navigate to <code>Admin</code> &gt; <code>Policies</code> &gt; <code>Add / update a       policy</code>.</p></li><li><p>Enter &quot;ha-nodes&quot; next to Name and &quot;^nodes.&quot; next to
<code>Pattern</code>.</p></li><li><p>Enter &quot;ha-mode&quot; = &quot;nodes&quot; in the first line next to
Policy, then &quot;ha-params&quot; in the second line, set the
second line&#x27;s type to &quot;List&quot;, and then enter
&quot;rabbit@nodeA&quot; and &quot;rabbit@nodeB&quot; in the sublist which
appears.</p></li><li><p>Click <code>Add policy</code>.</p></li></ul></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="behaviour">Mirrored Queue Implementation and Semantics<a href="#behaviour" class="hash-link" aria-label="Direct link to Mirrored Queue Implementation and Semantics" title="Direct link to Mirrored Queue Implementation and Semantics">​</a></h2>
<p>As discussed, for each mirrored queue there is one
<em>leader</em> replica and several <em>mirrors</em>, each on a
different node. The mirrors apply the operations that occur
to the leader in exactly the same order as the leader and
thus maintain the same state. All actions other than
publishes go only to the leader, and the leader then
broadcasts the effect of the actions to the mirrors. Thus
clients consuming from a mirrored queue are in fact
consuming from the leader.</p>
<p>Should a mirror fail, there is little to be done other than
some bookkeeping: the leader remains the leader and no
client need to take any action or be informed of the failure.
Note that mirror failures may not be detected immediately and
the interruption of the per-connection flow control mechanism
can delay message publication. The details are described
in the <a href="/rabbitmq-website/docs/3.13/nettick">Inter-node Communication Heartbeats</a> guide.</p>
<p>If the leader fails, then one of the mirrors will be promoted to
leader as follows:</p>
<ol>
<li>The longest running mirror is promoted to leader, the assumption
being that it is most likely to be fully synchronised with the
leader. If there is no mirror that is <a href="#unsynchronised-mirrors">synchronised</a> with the
leader, messages that only existed on leader will be lost.</li>
<li>The mirror considers all previous consumers to have been abruptly
disconnected. It requeues all messages that have been delivered
to clients but are pending acknowledgement. This can include
messages for which a client has issued acknowledgements, say, if
an acknowledgement was either lost on the wire before reaching the
node hosting queue leader, or it was lost when broadcast from the leader to the
mirrors. In either case, the new leader has no choice but to
requeue all messages that it has not seen acknowledgements for.</li>
<li>Consumers that have requested to be notified when a queue fails
over <a href="#cancellation">will be notified of cancellation</a>.</li>
<li>As a result of the requeuing, clients that re-consume from the
queue <b>must</b> be aware that they are likely to subsequently
receive messages that they have already received.</li>
<li>As the chosen mirror becomes the leader, no messages that are
published to the mirrored queue during this time will be lost
(barring subsequent failures on the promoted node).
Messages published to a node that hosts queue mirror are routed
to the queue leader and then replicated to all mirrors. Should the leader fail,
the messages continue to be sent to the mirrors and will be added
to the queue once the promotion of a mirror to the leader completes.</li>
<li>Messages published by clients using <a href="/rabbitmq-website/docs/3.13/confirms">publisher confirms</a> will still be
confirmed even if the leader (or any mirrors) fail
between the message being published and a confirmation received
by the publisher. From the point of view of the publisher,
publishing to a mirrored queue is no different from publishing to a non-mirrored one.</li>
</ol>
<p>If consumers use <a href="/rabbitmq-website/docs/3.13/confirms">automatic acknowledgement mode</a>, then messages can be lost. This is no different
from non-mirrored queues, of course: the broker considers a message
<em>acknowledged</em> as soon as it has been sent to a consumer in automatic acknowledgement mode.</p>
<p>Should the client disconnect abruptly, the message may never be received. In the case of a
mirrored queue, should the leader die, messages that are in-flight on
their way to consumers in automatic acknowledgement mode may never be received
by those clients, and will not be requeued by the new leader. Because
of the possibility that the consuming client is connected to a node
that survives, the <a href="#cancellation">consumer cancellation notification</a> is useful to identify when such events may have
occurred. Of course, in practise, if data safety is less important
than throughput, the automatic acknowledgement mode is the way to go.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="confirms-transactions">Publisher Confirms and Transactions<a href="#confirms-transactions" class="hash-link" aria-label="Direct link to Publisher Confirms and Transactions" title="Direct link to Publisher Confirms and Transactions">​</a></h3>
<p>Mirrored queues support both <a href="/rabbitmq-website/docs/3.13/confirms">publisher confirms</a> and
transactions. The semantics chosen are that in the case of both confirms and
transactions, the action spans all mirrors of the
queue. So in the case of a transaction, a
<code>tx.commit-ok</code> will only be returned to a
client when the transaction has been applied across all
mirrors of the queue. Equally, in the case of publisher
confirms, a message will only be confirmed to the
publisher when it has been accepted by all of the
mirrors. It is correct to think of the semantics as being
the same as a message being routed to multiple normal
queues, and of a transaction with publications within
that similarly are routed to multiple queues.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flow-control">Flow Control<a href="#flow-control" class="hash-link" aria-label="Direct link to Flow Control" title="Direct link to Flow Control">​</a></h3>
<p>RabbitMQ uses a credit-based algorithm to <a href="./memory#per-connection">limit the rate of
message publication</a>.  Publishers are permitted to
publish when they receive credit from all mirrors of a
queue.  Credit in this context means permission to
publish.  Mirrors that fail to issue credit can cause
publishers to stall. Publishers will remain blocked until
all mirrors issue credit or until the remaining nodes
consider the mirror to be disconnected from the cluster.
Erlang detects such disconnections by periodically sending
a tick to all nodes. The tick interval can be controlled
with the <a href="/rabbitmq-website/docs/3.13/nettick">net_ticktime</a>
configuration setting.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cancellation">Leader Failures and Consumer Cancellation<a href="#cancellation" class="hash-link" aria-label="Direct link to Leader Failures and Consumer Cancellation" title="Direct link to Leader Failures and Consumer Cancellation">​</a></h3>
<p>Clients that are consuming from a mirrored queue may wish
to know that the queue from which they have been consuming
has failed over. When a mirrored queue fails over,
knowledge of which messages have been sent to which
consumer is lost, and therefore all unacknowledged
messages are redelivered with the <code>redelivered</code>
flag set. Consumers may wish to know this is going to
happen.</p>
<p>If so, they can consume with the argument
<code>x-cancel-on-ha-failover</code> set to
<code>true</code>. Their consuming will then be cancelled
on failover and a <a href="/rabbitmq-website/docs/3.13/consumer-cancel">consumer
cancellation notification</a> sent. It is then the
consumer&#x27;s responsibility to reissue
<code>basic.consume</code> to start consuming again.</p>
<p>For example (in Java):</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Channel</span><span class="token plain"> channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Consumer</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-cancel-on-ha-failover&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-queue&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This creates a new consumer with the argument set.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unsynchronised-mirrors">Unsynchronised Mirrors<a href="#unsynchronised-mirrors" class="hash-link" aria-label="Direct link to Unsynchronised Mirrors" title="Direct link to Unsynchronised Mirrors">​</a></h2>
<p>A node may join a cluster at any time. Depending on the
configuration of a queue, when a node joins a cluster,
queues may add a mirror on the new node. At this point, the
new mirror will be empty: it will not contain any existing
contents of the queue. Such a mirror will receive new
messages published to the queue, and thus over time will
accurately represent the tail of the mirrored queue. As
messages are drained from the mirrored queue, the size of
the head of the queue for which the new mirror is missing
messages, will shrink until eventually the mirror&#x27;s contents
precisely match the leader&#x27;s contents. At this point, the
mirror can be considered fully synchronised, but it is
important to note that this has occurred because of actions
of clients in terms of draining the pre-existing head of the
queue.</p>
<p>A newly added mirror provides no additional form of
redundancy or availability of the queue&#x27;s contents that
existed before the mirror was added, unless the queue has
been explicitly synchronised. Since the queue becomes
unresponsive while explicit synchronisation is occurring, it
is preferable to allow active queues from which messages are
being drained to synchronise naturally, and only explicitly
synchronise inactive queues.</p>
<p>When enabling automatic queue mirroring, consider the expected on disk
data set of the queues involved. Queues with a sizeable data set
(say, tens of gigabytes or more) will have to replicate it to
the newly added mirror(s), which can put a significant load on
cluster resources such as network bandwidth and disk I/O. This is
a common scenario with lazy queues, for example.</p>
<p>To see mirror status (whether they are synchronised), use:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">cmd</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl list_queues name mirror_pids synchronised_mirror_pids</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat list_queues name mirror_pids synchronised_mirror_pids</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-batch codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-batch codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token command keyword" style="color:#00009f">rabbitmqctl</span><span class="token command">.bat list_queues name mirror_pids synchronised_mirror_pids</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>It is possible to manually synchronise a queue:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">cmd</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl sync_queue </span><span class="token string" style="color:#e3116c">&quot;{name}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat sync_queue </span><span class="token string" style="color:#e3116c">&#x27;{name}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-batch codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-batch codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token command keyword" style="color:#00009f">rabbitmqctl</span><span class="token command">.bat sync_queue </span><span class="token command string" style="color:#e3116c">&quot;{name}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>Or cancel an in-progress synchronisation:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">cmd</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl cancel_sync_queue </span><span class="token string" style="color:#e3116c">&quot;{name}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat cancel_sync_queue </span><span class="token string" style="color:#e3116c">&#x27;{name}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-batch codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-batch codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token command keyword" style="color:#00009f">rabbitmqctl</span><span class="token command">.bat cancel_sync_queue </span><span class="token command string" style="color:#e3116c">&quot;{name}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>These features are also available through the management plugin.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="promoting-unsynchronised-mirrors">Promotion of Unsynchronised Mirrors on Failure<a href="#promoting-unsynchronised-mirrors" class="hash-link" aria-label="Direct link to Promotion of Unsynchronised Mirrors on Failure" title="Direct link to Promotion of Unsynchronised Mirrors on Failure">​</a></h3>
<p>By default if a queue&#x27;s leader node fails, loses
connection to its peers or is removed from the cluster,
the oldest mirror will be promoted to be the new
leader. In some circumstances this mirror can be
<a href="#unsynchronised-mirrors">unsynchronised</a>, which will cause data loss.</p>
<p>Starting with RabbitMQ 3.7.5, the <code>ha-promote-on-failure</code>
policy key controls whether unsynchronised mirror promotion is allowed. When set to
<code>when-synced</code>, it will make sure that unsynchronised mirrors
are not promoted.</p>
<p>Default value is <code>always</code>.
The <code>when-synced</code> value should be used with care. It trades off
safety from unsynchronised mirror promotion for increased reliance on queue leader&#x27;s
availability. Sometimes queue availability can be more important than consistency.</p>
<p>The <code>when-synced</code> promotion strategy avoids data loss due to promotion of an unsynchronised mirror
but makes queue availability dependent on its leader&#x27;s availability.
In the event of queue leader node failure the queue will become unavailable until queue leader
recovers. In case of a permanent loss of queue leader the queue won&#x27;t be available
unless it is deleted and redeclared. Deleting a queue deletes all of its contents,
which means permanent loss of a leader with this promotion strategy equates to losing all
queue contents.</p>
<p>Systems that use the <code>when-synced</code> promotion strategy must use
<a href="/rabbitmq-website/docs/3.13/confirms">publisher confirms</a> in order to detect queue unavailability
and broker&#x27;s inability to enqueue messages.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="start-stop">Stopping Nodes and Synchronisation<a href="#start-stop" class="hash-link" aria-label="Direct link to Stopping Nodes and Synchronisation" title="Direct link to Stopping Nodes and Synchronisation">​</a></h3>
<p>If you stop a RabbitMQ node which contains the leader of a
mirrored queue, some mirror on some other node will be
promoted to the leader (assuming there is a synchronised mirror;
see <a href="#cluster-shutdown">below</a>). If you
continue to stop nodes then you will reach a point where a
mirrored queue has no more mirrors: it exists only on one
node, which is now its leader.  If the mirrored queue was
declared <i>durable</i> then, if its last remaining node is
shutdown, durable messages in the queue will survive the
restart of that node. In general, as you restart other
nodes, if they were previously part of a mirrored queue then
they will rejoin the mirrored queue.</p>
<p>However, there is currently no way for a mirror to know
whether or not its queue contents have diverged from the
leader to which it is rejoining (this could happen during a
network partition, for example). As such, when a mirror
rejoins a mirrored queue, it throws away any durable local
contents it already has and starts empty. Its behaviour is
at this point the same as if it were a <a href="#unsynchronised-mirrors">new node joining the cluster</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-shutdown">Stopping Nodes Hosting Queue Leader with Only Unsynchronised Mirrors<a href="#cluster-shutdown" class="hash-link" aria-label="Direct link to Stopping Nodes Hosting Queue Leader with Only Unsynchronised Mirrors" title="Direct link to Stopping Nodes Hosting Queue Leader with Only Unsynchronised Mirrors">​</a></h3>
<p>It&#x27;s possible that when you shut down a leader node that
all available mirrors are unsynchronised. A common
situation in which this can occur is rolling cluster
upgrades.</p>
<p>By default, RabbitMQ will refuse to promote
an unsynchronised mirror on controlled leader shutdown
(i.e. explicit stop of the RabbitMQ service or shutdown of
the OS) in order to avoid message loss; instead the entire
queue will shut down as if the unsynchronised mirrors were
not there.</p>
<p>An uncontrolled leader shutdown (i.e. server or
node crash, or network outage) will still trigger a
promotion of an unsynchronised mirror.</p>
<p>If you would prefer to have queue leader move to an
unsynchronised mirror in all circumstances (i.e. you would
choose availability of the queue over avoiding message
loss due to unsynchronised mirror promotion) then set the
<code>ha-promote-on-shutdown</code> policy key to
<code>always</code> rather than its default value of
<code>when-synced</code>.</p>
<p>If the <code>ha-promote-on-failure</code> policy key is set to
<code>when-synced</code>, unsynchronised mirrors will not be promoted
even if the <code>ha-promote-on-shutdown</code> key is set to
<code>always</code>. This means that in the event of queue leader node
failure the queue will become unavailable until leader recovers.
In case of a permanent loss of queue leader the queue won&#x27;t be available
unless it is deleted (that will also delete all of its contents) and redeclared.</p>
<p>Note that <code>ha-promote-on-shutdown</code> and
<code>ha-promote-on-failure</code> have different default behaviours.
<code>ha-promote-on-shutdown</code> is set to <code>when-synced</code>
by default, while <code>ha-promote-on-failure</code> is set to
<code>always</code> by default.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="promotion-while-down">Loss of a Leader While All Mirrors are Stopped<a href="#promotion-while-down" class="hash-link" aria-label="Direct link to Loss of a Leader While All Mirrors are Stopped" title="Direct link to Loss of a Leader While All Mirrors are Stopped">​</a></h3>
<p>It is possible to lose the leader for a queue while all
mirrors for the queue are shut down. In normal operation
the last node for a queue to shut down will become the
leader, and we want that node to still be the leader when
it starts again (since it may have received messages that
no other mirror saw).</p>
<p>However, when you invoke
<code>rabbitmqctl forget_cluster_node</code>, RabbitMQ will attempt to find
a currently stopped mirror for each queue which has its
leader on the node we are forgetting, and &quot;promote&quot; that
mirror to be the new leader when it starts up again. If
there is more than one candidate, the most recently
stopped mirror will be chosen.</p>
<p>It&#x27;s important to understand that RabbitMQ can only
promote <b>stopped</b> mirrors during
<code>forget_cluster_node</code>, since any mirrors that
are started again will clear out their contents as
described at &quot;<a href="#start-stop">stopping nodes and
synchronisation</a>&quot; above. Therefore when removing a lost
leader in a stopped cluster, you must invoke
<code>rabbitmqctl forget_cluster_node</code> <i>before</i>
starting mirrors again.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="batch-sync">Batch Synchronization<a href="#batch-sync" class="hash-link" aria-label="Direct link to Batch Synchronization" title="Direct link to Batch Synchronization">​</a></h2>
<p>Classic queue leaders perform synchronisation in
batches. Batch can be configured via the
<code>ha-sync-batch-size</code> queue argument. If no value is set <code>mirroring_sync_batch_size</code>
is used as the default value. Earlier
versions (prior to 3.6.0) will synchronise <code>1</code> message at a
time by default. By synchronising messages in batches,
the synchronisation process can be sped up considerably.</p>
<p>To choose the right value for
<code>ha-sync-batch-size</code> you need to consider:</p>
<ul>
<li>average message size</li>
<li>network throughput between RabbitMQ nodes</li>
<li><code>net_ticktime</code> value</li>
</ul>
<p>For example, if you set <code>ha-sync-batch-size</code> to
<code>50000</code> messages, and each message in the
queue is 1KB, then each synchronisation message between nodes
will be ~49MB. You need to make sure that your network
between queue mirrors can accommodate this kind of traffic. If the
network takes longer than <a href="/rabbitmq-website/docs/3.13/nettick">net_ticktime</a>
to send one batch of messages, then nodes in the cluster could
think they are in the presence of a network partition.</p>
<p>The amount of data sent over the network can also be controlled by setting
the parameter <code>mirroring_sync_max_throughput</code>. The parameter specifies the
number of bytes per second that is being transferred. The default is <code>0</code>, which disables
this feature.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-synchronisation">Configuring Synchronisation<a href="#configuring-synchronisation" class="hash-link" aria-label="Direct link to Configuring Synchronisation" title="Direct link to Configuring Synchronisation">​</a></h3>
<p>Let&#x27;s start with the most important aspect of queue
synchronisation: <em>while a queue is being synchronised, all other
queue operations will be blocked</em>. Depending on multiple
factors, a queue might be blocked by synchronisation for many
minutes or hours, and in extreme cases even days.</p>
<p>Queue synchronisation can be configured as follows:</p>
<ul>
<li><code>ha-sync-mode: manual</code>: this is the default mode.
A new queue mirror will not receive existing messages, it will
only receive new messages. The new queue mirror will become an
exact replica of the leader over time, once consumers have
drained messages that only exist on the leader. If the leader
queue fails before all unsynchronised messages are drained,
those messages will be lost. You can fully synchronise a queue
manually, refer to <a href="#unsynchronised-mirrors">unsynchronised mirrors</a>
section for details.</li>
<li><code>ha-sync-mode: automatic</code>: a queue will
automatically synchronise when a new mirror joins. It is worth
reiterating that queue synchronisation is a blocking operation.
If queues are small, or you have a fast network between
RabbitMQ nodes and the <code>ha-sync-batch-size</code> was
optimised, this is a good choice.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/versioned_docs/version-3.13/ha/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/docs/3.13/classic-queues"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Classic Queues</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/docs/3.13/migrate-mcq-to-qq"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Migrate Mirrored Classic Queues to Quorum Queues</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#interstitial" class="table-of-contents__link toc-highlight">Wait, There&#39;s a Better Way: Modern Replicated Queue Type and Streams</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#what-is-mirroring" class="table-of-contents__link toc-highlight">What is Queue Mirroring</a></li><li><a href="#ways-to-configure" class="table-of-contents__link toc-highlight">How Mirroring is Configured</a></li><li><a href="#mirroring-arguments" class="table-of-contents__link toc-highlight">Queue Arguments that Control Mirroring</a><ul><li><a href="#replication-factor" class="table-of-contents__link toc-highlight">Replication Factor: How Many Mirrors are Optimal?</a></li></ul></li><li><a href="#how-to-check-i-a-queue-is-mirrored" class="table-of-contents__link toc-highlight">How to Check if a Queue is Mirrored?</a></li><li><a href="#detect-usage" class="table-of-contents__link toc-highlight">How to Detect Policies that Enable Classic Queue Mirroring</a></li><li><a href="#cqv2" class="table-of-contents__link toc-highlight">Mirroring and CQv2</a></li><li><a href="#leader-migration-data-locality" class="table-of-contents__link toc-highlight">Queue Leader Replicas, Leader Migration, Data Locality</a><ul><li><a href="#queue-leader-location" class="table-of-contents__link toc-highlight">Queue Leader Location</a></li><li><a href="#fixed-leader-promotion" class="table-of-contents__link toc-highlight">&quot;nodes&quot; Policy and Migrating Leaders</a></li><li><a href="#exclusive-queues-are-not-mirrored" class="table-of-contents__link toc-highlight">Mirroring of Exclusive Queues</a></li></ul></li><li><a href="#non-mirrored-queue-behavior-on-node-failure" class="table-of-contents__link toc-highlight">Non-mirrored Queue Behavior in a Cluster</a></li><li><a href="#examples" class="table-of-contents__link toc-highlight">Examples</a></li><li><a href="#behaviour" class="table-of-contents__link toc-highlight">Mirrored Queue Implementation and Semantics</a><ul><li><a href="#confirms-transactions" class="table-of-contents__link toc-highlight">Publisher Confirms and Transactions</a></li><li><a href="#flow-control" class="table-of-contents__link toc-highlight">Flow Control</a></li><li><a href="#cancellation" class="table-of-contents__link toc-highlight">Leader Failures and Consumer Cancellation</a></li></ul></li><li><a href="#unsynchronised-mirrors" class="table-of-contents__link toc-highlight">Unsynchronised Mirrors</a><ul><li><a href="#promoting-unsynchronised-mirrors" class="table-of-contents__link toc-highlight">Promotion of Unsynchronised Mirrors on Failure</a></li><li><a href="#start-stop" class="table-of-contents__link toc-highlight">Stopping Nodes and Synchronisation</a></li><li><a href="#cluster-shutdown" class="table-of-contents__link toc-highlight">Stopping Nodes Hosting Queue Leader with Only Unsynchronised Mirrors</a></li><li><a href="#promotion-while-down" class="table-of-contents__link toc-highlight">Loss of a Leader While All Mirrors are Stopped</a></li></ul></li><li><a href="#batch-sync" class="table-of-contents__link toc-highlight">Batch Synchronization</a><ul><li><a href="#configuring-synchronisation" class="table-of-contents__link toc-highlight">Configuring Synchronisation</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
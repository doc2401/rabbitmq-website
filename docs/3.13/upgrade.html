<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-3.13 docs-doc-page docs-doc-id-upgrade" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Upgrading RabbitMQ | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/upgrade"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="3.13"><meta data-rh="true" name="docusaurus_tag" content="docs-default-3.13"><meta data-rh="true" name="docsearch:version" content="3.13"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-3.13"><meta data-rh="true" property="og:title" content="Upgrading RabbitMQ | RabbitMQ"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/upgrade"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/upgrade" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/3.13/upgrade" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/docs/3.13">Docs</a><a class="navbar__item navbar__link" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs/3.13/upgrade">3.13</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next/upgrade">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/upgrade">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0/upgrade">4.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/rabbitmq-website/docs/3.13/upgrade">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs/3.13">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs/3.13/whats-new">What&#x27;s New</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rabbitmq-website/docs/3.13/download">Install and Upgrade</a><button aria-label="Collapse sidebar category &#x27;Install and Upgrade&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/which-erlang">Erlang Version Requirements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/signatures">Package Signatures</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/3.13/platforms">Supported Operating Systems</a><button aria-label="Expand sidebar category &#x27;Supported Operating Systems&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/kubernetes/operator/install-operator">Kubernetes Operator</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible menu__list-item-collapsible--active"><a class="menu__link menu__link--sublist menu__link--active" aria-current="page" tabindex="0" href="/rabbitmq-website/docs/3.13/upgrade">Upgrade</a><button aria-label="Collapse sidebar category &#x27;Upgrade&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/feature-flags">Feature Flags</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/deprecated-features">Deprecated Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/blue-green-upgrade">Blue-Green Upgrade</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/3.13/snapshots">Snapshots</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/3.13/use-rabbitmq">How to Use RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Use RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/3.13/manage-rabbitmq">How to Manage RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Manage RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/3.13/monitoring">How to Monitor RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Monitor RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->RabbitMQ<!-- --> <b>3.13</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/rabbitmq-website/docs/upgrade">latest version</a></b> (<!-- -->4.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rabbitmq-website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/3.13/download"><span itemprop="name">Install and Upgrade</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Upgrade</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 3.13</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Upgrading RabbitMQ</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>This guide covers topics related to RabbitMQ installation upgrades.</p>
<ol>
<li><a href="#basics">An overview</a> of several common approaches to upgrading RabbitMQ</li>
<li><a href="#rabbitmq-version-upgradability">RabbitMQ version upgradability</a>: explains what versions or series can be upgraded to what later series</li>
<li><a href="#rabbitmq-erlang-version-requirement">Erlang version requirement</a></li>
<li><a href="#rabbitmq-plugins-compatibility">Plugin compatibility between versions</a></li>
<li>Features <a href="#unsupported-inplace-upgrade">that do not support in-place upgrade</a></li>
<li><a href="#system-resource-usage">Changes in system resource usage and reporting</a> in the new version</li>
<li>How upgrades of <a href="#clusters">multi-node clusters</a> is different from those with only a single node</li>
<li>Marking <a href="#maintenance-mode">nodes for maintenance</a></li>
<li><a href="#recommended-upgrade-steps">Recommended upgrade steps</a></li>
<li><a href="#caveats">Caveats</a></li>
<li><a href="#rabbitmq-restart-handling">Handling node restarts</a> in applications</li>
</ol>
<p>See <a href="/rabbitmq-website/release-information">Release Information</a> to find out what RabbitMQ release series are supported.
Release notes of individual releases are <a href="https://github.com/rabbitmq/rabbitmq-server/releases" target="_blank" rel="noopener noreferrer">published on GitHub</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="important-note-on-upgrading-to-312-and-313">Important Note on Upgrading to 3.12 and 3.13<a href="#important-note-on-upgrading-to-312-and-313" class="hash-link" aria-label="Direct link to Important Note on Upgrading to 3.12 and 3.13" title="Direct link to Important Note on Upgrading to 3.12 and 3.13">​</a></h2>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>RabbitMQ 3.12 requires all previously existing feature flags to be <a href="/rabbitmq-website/docs/3.13/feature-flags#how-to-enable-feature-flags">enabled</a> before the upgrade.</p><p>The upgrade will fail if you miss this step.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="basics">Basics<a href="#basics" class="hash-link" aria-label="Direct link to Basics" title="Direct link to Basics">​</a></h2>
<p>There are two major upgrade scenarios that are covered in this guide: a <a href="#single-node-upgrade">single node</a> and a <a href="#multiple-nodes-upgrade">cluster</a>,
as well as several most commonly used strategies:</p>
<ul>
<li>In-place upgrade where each node is upgraded with its existing on disk data</li>
<li><a href="/rabbitmq-website/docs/3.13/blue-green-upgrade">Blue-green deployment</a> where a new cluster is created and existing data is migrated to it</li>
<li>A grow-then-shrink approach where one or more new nodes are added to the cluster, then the old nodes are eventually removed</li>
</ul>
<p>Below is a brief overview of the common strategies. The rest of the guide covers each strategy in more detail.</p>
<p>The <a href="#rabbitmq-version-upgradability">RabbitMQ version upgradability</a> section explains what versions or series can be upgraded to what later series.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="in-place">In-place Upgrades<a href="#in-place" class="hash-link" aria-label="Direct link to In-place Upgrades" title="Direct link to In-place Upgrades">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>This upgrade strategy is recommended</p></div></div>
<p>An in-place upgrade usually involves the following steps performed by a deployment tool or manually
by an operator. Each step is covered in more detail later in this guide. An intentionally oversimplified
list of steps would include:</p>
<ul>
<li>Investigate if the current and target versions have an in-place upgrade path: check <a href="#rabbitmq-version-upgradability">version upgradability</a>, <a href="#rabbitmq-erlang-version-requirement">Erlang version requirements</a>, release notes, <a href="#unsupported-inplace-upgrade">features that do not support in-place upgrades</a>, and <a href="#caveats">known caveats</a></li>
<li>Check that the node or cluster is in a good state in order to be upgraded: no <a href="/rabbitmq-website/docs/3.13/alarms">alarms</a> are in effect, no ongoing queue or stream replica sync operations
and the system is otherwise under a reasonable load</li>
<li>Stop the node</li>
<li>Upgrade RabbitMQ and, if applicable, Erlang</li>
<li>Start the node</li>
<li>Watch <a href="/rabbitmq-website/docs/3.13/monitoring">monitoring and health check</a> data to assess the health and recovery of the upgraded node or cluster</li>
</ul>
<p><a href="#rolling-upgrades">Rolling upgrades</a> between certain versions are not supported. <a href="#full-stop-upgrades">Full Stop Upgrades</a>
and the <a href="/rabbitmq-website/docs/3.13/blue-green-upgrade">Blue/Green deployment</a> upgrade strategy cover the two options available for those cases.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blue-green-deployment-upgrades">Blue-Green Deployment Upgrades<a href="#blue-green-deployment-upgrades" class="hash-link" aria-label="Direct link to Blue-Green Deployment Upgrades" title="Direct link to Blue-Green Deployment Upgrades">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>This upgrade strategy is the safest option. It is recommended
for environments where a rolling in-place upgrade is not an option
for any reason, or extra safety is particularly important</p></div></div>
<p><a href="/rabbitmq-website/docs/3.13/blue-green-upgrade">The Blue/Green deployment</a> strategy offers the benefit of making the upgrade process safer at the cost of
temporary increasing infrastructure footprint. The safety aspect comes from the fact that the operator
can abort an upgrade by switching applications back to the existing cluster.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grow-then-shrink-upgrades">Grow-then-Shrink Upgrades<a href="#grow-then-shrink-upgrades" class="hash-link" aria-label="Direct link to Grow-then-Shrink Upgrades" title="Direct link to Grow-then-Shrink Upgrades">​</a></h3>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>This upgrade strategy changes replica identities, can result in massive unnecessary data transfers between
nodes, and is only safe with important precautions. Therefore, it is <a href="#grow-then-shrink">highly recommended against</a>.</p></div></div>
<p>A <a href="#grow-then-shrink">grow-and-shrink upgrade</a> usually involves the following steps. Consider a three node cluster with nodes
A, B, and C:</p>
<ul>
<li>Add a new node, node D, to the cluster</li>
<li>Place a new replica of every quorum queue and every stream to the new node using commands such as <code>rabbitmq-queues grow</code></li>
<li>Check that the cluster is in a good state: no <a href="/rabbitmq-website/docs/3.13/alarms">alarms</a> are in effect, no ongoing queue or stream replica sync operations
and the system is otherwise under a reasonable load</li>
<li>Remove node A from the cluster using <code>rabbitmqctl forget_cluster_node</code></li>
<li>Add a new node, node E, to the cluster</li>
<li>Place a new replica of every quorum queue and every stream to the new node using commands such as <code>rabbitmq-queues grow</code></li>
<li>Check that the cluster is in a good state</li>
<li>Remove node B from the cluster using <code>rabbitmqctl forget_cluster_node</code></li>
<li>and so on</li>
</ul>
<p>Multiple nodes can be added and removed at a time.</p>
<p>Similarly to <a href="#rolling-upgrades">rolling upgrades</a>, grow-and-shrink upgrades between certain versions are not supported.
<a href="#full-stop-upgrades">Full Stop Upgrades</a> and the <a href="/rabbitmq-website/docs/3.13/blue-green-upgrade">Blue/Green deployment</a> upgrade strategy cover the two options available for those cases.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-version-upgradability">RabbitMQ Version Upgradability<a href="#rabbitmq-version-upgradability" class="hash-link" aria-label="Direct link to RabbitMQ Version Upgradability" title="Direct link to RabbitMQ Version Upgradability">​</a></h2>
<p>All versions starting with <code>3.7.27</code> support <a href="#rolling-upgrades">rolling upgrades</a> to compatible
later versions using <a href="/rabbitmq-website/docs/3.13/feature-flags">feature flags</a>.</p>
<p>A <a href="#full-stop-upgrades">full cluster stop</a> may be required for feature version upgrades
but such cases are rare in modern release series thanks to feature flags.</p>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>As a rule of thumb, upgrade to the latest patch release in the target series,
and then <a href="/rabbitmq-website/docs/3.13/feature-flags#how-to-enable-feature-flags">enable all stable feature flags</a>
after all cluster nodes have been upgraded.</p></div></div>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>When an upgrade jumps multiple release series (e.g. goes from <code>3.9.x</code> to <code>3.13.x</code>), it may be necessary to perform
one or more intermediate upgrades first.</p><p>For each intermediary upgrade, upgrade to the latest patch release in the target series,
and then <a href="/rabbitmq-website/docs/3.13/feature-flags#how-to-enable-feature-flags">enable all stable feature flags</a>
after all cluster nodes have been upgraded.</p></div></div>
<p>When an upgrade jumps multiple release series (e.g. goes from <code>3.9.x</code> to <code>3.13.x</code>), it may be necessary to perform
one or more intermediate upgrades first. For each intermediary upgrade, upgrade to the latest patch release in the target series,
and then <a href="/rabbitmq-website/docs/3.13/feature-flags#how-to-enable-feature-flags">enable all stable feature flags</a>
after all cluster nodes have been upgraded.</p>
<p>For example, when upgrading from <code>3.9.x</code> to <code>3.13.x</code>, it would be necessary to</p>
<ol>
<li>First upgrade to the latest 3.10.x patch release</li>
<li>Then to the latest patch release of 3.11.x</li>
<li>Then to the latest patch release of 3.12.x</li>
<li>Finally, upgrade to the latest release in the 3.13.x</li>
</ol>
<p>Don&#x27;t forget to <a href="/rabbitmq-website/docs/3.13/feature-flags#how-to-enable-feature-flags">enable all stable feature flags</a> every step of
the process or the follow step may fail because some feature flags have <a href="/rabbitmq-website/docs/3.13/feature-flags#graduation">graduated</a> (became mandatory).</p>
<p>Or consider a <a href="/rabbitmq-website/docs/3.13/blue-green-upgrade">The Blue/Green deployment</a> upgrade in one go.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="release-series-upgradeability-with-rolling-upgrades">Release Series Upgradeability with Rolling Upgrades<a href="#release-series-upgradeability-with-rolling-upgrades" class="hash-link" aria-label="Direct link to Release Series Upgradeability with Rolling Upgrades" title="Direct link to Release Series Upgradeability with Rolling Upgrades">​</a></h3>
<p>Current release series upgrade compatibility with <strong>rolling</strong> upgrade:</p>
<table><thead><tr><th>From</th><th>To</th><th>Notes</th></tr></thead><tbody><tr><td>3.12.x</td><td>3.13.x</td><td></td></tr><tr><td>3.11.18</td><td>3.12.x</td><td>All feature flags <strong>must</strong> be enabled <strong>before</strong> the upgrade</td></tr><tr><td>3.10.x</td><td>3.11.x</td><td>Some feature flags <strong>must</strong> be enabled <strong>before</strong> the upgrade</td></tr><tr><td>3.9.x</td><td>3.10.x</td><td></td></tr><tr><td>3.8.x</td><td>3.9.x</td><td></td></tr><tr><td>3.7.18</td><td>3.8.x</td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="release-series-upgradeability-with-full-stop-upgrades">Release Series Upgradeability with Full Stop Upgrades<a href="#release-series-upgradeability-with-full-stop-upgrades" class="hash-link" aria-label="Direct link to Release Series Upgradeability with Full Stop Upgrades" title="Direct link to Release Series Upgradeability with Full Stop Upgrades">​</a></h3>
<p>Current release series upgrade compatibility with <strong>full stop</strong> upgrade:</p>
<table><thead><tr><th>From</th><th>To</th><th>Notes</th></tr></thead><tbody><tr><td>3.12.x</td><td>3.13.x</td><td></td></tr><tr><td>3.11.18</td><td>3.12.x</td><td>All feature flags should be enabled <strong>before</strong> this upgrade</td></tr><tr><td>3.10.x</td><td>3.11.x</td><td>Some feature flags should be enabled <strong>before</strong> this upgrade</td></tr><tr><td>3.9.x</td><td>3.10.x</td><td></td></tr><tr><td>3.8.x</td><td>3.9.x</td><td></td></tr><tr><td>3.7.27</td><td>3.9.x</td><td></td></tr><tr><td>3.6.x</td><td>3.8.x</td><td></td></tr><tr><td>3.6.x</td><td>3.7.x</td><td></td></tr><tr><td>3.5.x</td><td>3.7.x</td><td></td></tr><tr><td>=&lt; 3.4.x</td><td>3.6.16</td><td></td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-erlang-version-requirement">Erlang Version Requirements<a href="#rabbitmq-erlang-version-requirement" class="hash-link" aria-label="Direct link to Erlang Version Requirements" title="Direct link to Erlang Version Requirements">​</a></h2>
<p>We recommend that you upgrade Erlang together with RabbitMQ.
Please refer to the <a href="/rabbitmq-website/docs/3.13/which-erlang">Erlang Version Requirements</a> guide.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unsupported-inplace-upgrade">Features that Do Not Support In-place Upgrades<a href="#unsupported-inplace-upgrade" class="hash-link" aria-label="Direct link to Features that Do Not Support In-place Upgrades" title="Direct link to Features that Do Not Support In-place Upgrades">​</a></h2>
<p><a href="/rabbitmq-website/docs/3.13/priority">Priority queue</a> on disk data currently cannot be migrated in place between 3.6 and any later series.
If an upgrade is performed in place, such queues would start empty (without any messages) after node restart.</p>
<p>To migrate an environment with priority queues and preserve their content (messages),
a <a href="/rabbitmq-website/docs/3.13/blue-green-upgrade">blue-green upgrade</a> strategy should be used.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-plugins-compatibility">Plugin Compatibility Between Versions<a href="#rabbitmq-plugins-compatibility" class="hash-link" aria-label="Direct link to Plugin Compatibility Between Versions" title="Direct link to Plugin Compatibility Between Versions">​</a></h2>
<p>Unless otherwise specified in release notes, RabbitMQ plugin API
introduces no breaking changes within a release series (e.g. between
<code>3.12.5</code> and <code>3.12.13</code>). If upgrading to a new minor or major version
(e.g. <code>3.13.2</code>), plugin must be upgraded to their versions that support
the new RabbitMQ version series.</p>
<p>In rare cases patch versions of RabbitMQ can break some plugin APIs.
Such cases will be documented in the breaking changes section of the release notes document.</p>
<p><a href="/rabbitmq-website/community-plugins">Community plugins page</a> contains information on RabbitMQ
version support for plugins not included into the RabbitMQ distribution.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="management-ui">Management Plugin Upgrades<a href="#management-ui" class="hash-link" aria-label="Direct link to Management Plugin Upgrades" title="Direct link to Management Plugin Upgrades">​</a></h3>
<p>RabbitMQ management plugin comes with a Web application that runs in the browser.</p>
<p>After upgrading a cluster, it is highly recommended to clear browser cache,
local storage, session storage and cookies for the domain(s) used to access the management UI.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="discontinued-plugins">Discontinued Plugins<a href="#discontinued-plugins" class="hash-link" aria-label="Direct link to Discontinued Plugins" title="Direct link to Discontinued Plugins">​</a></h3>
<p>Sometimes a new feature release drops a plugin or multiple plugins from the distribution.
For example, <code>rabbitmq_management_visualiser</code> no longer ships with RabbitMQ as of
3.7.0. Such plugins <strong>must be disabled</strong> before the upgrade.
A node that has a missing plugin enabled will fail to start.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-resource-usage">Changes in System Resource Usage and Reporting<a href="#system-resource-usage" class="hash-link" aria-label="Direct link to Changes in System Resource Usage and Reporting" title="Direct link to Changes in System Resource Usage and Reporting">​</a></h2>
<p>Different versions of RabbitMQ can have different resource usage. That
should be taken into account before upgrading: make sure there&#x27;s enough
capacity to run the workload with the new version. Always consult with
the release notes of all versions between the one currently deployed and the
target one in order to find out about changes which could impact
your workload and resource usage.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="clusters">Single Node and Cluster Upgrades<a href="#clusters" class="hash-link" aria-label="Direct link to Single Node and Cluster Upgrades" title="Direct link to Single Node and Cluster Upgrades">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="single-node-upgrade">Upgrading a Single Node Installation<a href="#single-node-upgrade" class="hash-link" aria-label="Direct link to Upgrading a Single Node Installation" title="Direct link to Upgrading a Single Node Installation">​</a></h3>
<p>Upgrading single node installation is similar to upgrading clusters. <a href="/rabbitmq-website/docs/3.13/feature-flags">Feature flags</a> should be enabled after each
upgrade (it&#x27;s always a good idea to double-check by enabling them before the next upgrade as well - if they are already
enabled, it will just do nothing). You should also follow the <a href="#rabbitmq-version-upgradability">upgrade compatibility matrix</a>.</p>
<p>Client (application) connections will be dropped when the node stops. Applications need to be
prepared to handle this and reconnect.</p>
<p>With some distributions (e.g. the generic binary UNIX) you can install a newer version of
RabbitMQ without removing or replacing the old one, which can make upgrade faster.
You should make sure the new version <a href="/rabbitmq-website/docs/3.13/relocate">uses the same data directory</a>.</p>
<p>RabbitMQ does not support downgrades; it&#x27;s strongly advised to back node&#x27;s data directory up before
upgrading.</p>
<p>Single node deployments are often local development or test environments. In such cases, if
the upgrade involves jumping multiple release series (eg. from <code>3.8.15</code> to <code>3.13.2</code>),
it&#x27;s easier to simply delete everything in the data directory and go directly
to the desired version. Effectively, it&#x27;s no longer an upgrade but a fresh installation of the new version.
Please note that this process will <strong>delete all data</strong> in your RabbitMQ (definitions and messages), but this is usually
not a problem in a developement/test environment. The definitions can be preserved using <a href="/rabbitmq-website/docs/3.13/definitions">export/import</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiple-nodes-upgrade">Upgrading Multiple Nodes<a href="#multiple-nodes-upgrade" class="hash-link" aria-label="Direct link to Upgrading Multiple Nodes" title="Direct link to Upgrading Multiple Nodes">​</a></h3>
<p>Depending on what versions are involved in an upgrade, RabbitMQ cluster
<em>may</em> provide an opportunity to perform upgrades without cluster
downtime using a procedure known as rolling upgrade. A rolling upgrade
is when nodes are stopped, upgraded and restarted one-by-one, with the
rest of the cluster still running while each node is being upgraded.</p>
<p>If rolling upgrades are not possible, the entire cluster should be
stopped, then restarted. This is referred to as a full stop upgrade.</p>
<p>Client (application) connections will be dropped when each node stops. Applications need to be
prepared to handle this and reconnect.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rolling-upgrades">Rolling Upgrades<a href="#rolling-upgrades" class="hash-link" aria-label="Direct link to Rolling Upgrades" title="Direct link to Rolling Upgrades">​</a></h3>
<p>Rolling upgrades are possible only between compatible RabbitMQ and Erlang versions.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rolling-upgrade-starting-with-3.8">With RabbitMQ 3.8 or Later Versions<a href="#rolling-upgrade-starting-with-3.8" class="hash-link" aria-label="Direct link to With RabbitMQ 3.8 or Later Versions" title="Direct link to With RabbitMQ 3.8 or Later Versions">​</a></h4>
<p>RabbitMQ provides a <a href="/rabbitmq-website/docs/3.13/feature-flags">feature flag</a> subsystem which is
responsible for determining if two RabbitMQ nodes of different versions are compatible with respect
to a certain feature, important internal implementation detail or behavior.</p>
<p>If they are, then two nodes with different versions can run side-by-side in the
same cluster: this allows a rolling upgrade of cluster members without
shutting down the cluster entirely.</p>
<p>To learn more, please read the <a href="/rabbitmq-website/docs/3.13/feature-flags">feature flags documentation</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rolling-upgrades-restarting-nodes">When to Restart Nodes<a href="#rolling-upgrades-restarting-nodes" class="hash-link" aria-label="Direct link to When to Restart Nodes" title="Direct link to When to Restart Nodes">​</a></h3>
<p>It is important to let the node being upgraded to fully start and sync
all data from its peers before proceeding to upgrade the next one. You
can check for that via the management UI. Confirm that:</p>
<ul>
<li>the <code>rabbitmqctl await_startup</code> (or <code>rabbitmqctl wait &lt;pidfile&gt;</code>) command returns</li>
<li>the node starts and rejoins its cluster according to the management overview page or <code>rabbitmq-diagnostics cluster_status</code></li>
<li>the node is not quorum-critical for any <a href="#quorum-queues">quorum queues</a> and streams it hosts</li>
<li>all classic mirrored queues have <a href="#mirrored-queues-synchronisation">synchronised mirrors</a></li>
</ul>
<p>During a rolling upgrade, client connection recovery will make sure that connections
are rebalanced. Primary queue replicas will migrate to other nodes.
In practice this will put more load on the remaining cluster nodes.
This can impact performance and stability of the cluster.
It&#x27;s not recommended to perform rolling upgrades under high load.</p>
<p>Nodes can be put into maintenance mode to prepare them for
shutdown during rolling upgrades. This is covered below.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="after-restarting">After Restarting All Nodes<a href="#after-restarting" class="hash-link" aria-label="Direct link to After Restarting All Nodes" title="Direct link to After Restarting All Nodes">​</a></h3>
<p>After performing a rolling upgrade and putting the last node out of <a href="#maintenance-mode">maintenance mode</a>,
perform the following steps:</p>
<ul>
<li>Enable all <a href="/rabbitmq-website/docs/3.13/feature-flags">feature flags</a> in the cluster using <code>rabbitmqctl enable_feature_flag all</code></li>
<li>Rebalance all queue and stream leader replicas with <code>rabbitmq-queues rebalance all</code></li>
</ul>
<p>Enabling all feature flags is <strong>very important</strong> for future upgrade, which may require all
feature flags from certain earlier versions to be enabled.</p>
<p>Rebalancing of queue and stream leader replicas helps spread the load across
all cluster nodes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="grow-then-shrink">Grow-then-Shrink Upgrades<a href="#grow-then-shrink" class="hash-link" aria-label="Direct link to Grow-then-Shrink Upgrades" title="Direct link to Grow-then-Shrink Upgrades">​</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This strategy involves node identity changes and replica transfers to the newly added nodes.</p><p>With quorum queues and streams that have large data sets, this means that the cluster will
experience substantial network traffic volume and disk I/O spikes that a rolling in-place upgrade would not.</p><p>Consider using <a href="#in-place">in-place upgrades</a> or <a href="/rabbitmq-website/docs/3.13/blue-green-upgrade">Blue/Green deployment upgrades</a> instead.</p></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>In order to safely perform a grow-then-shrink upgrade, several precautions must be taken</p></div></div>
<p>A Grow-then-Shrink upgrade usually involves the following steps. Consider a three node cluster with nodes
A, B, and C:</p>
<ul>
<li>Add a new node, node D, to the cluster</li>
<li>Place a new replica of every quorum queue and every stream to the new node using commands such as <code>rabbitmq-queues grow</code></li>
<li>Check that the cluster is in a good state: no <a href="/rabbitmq-website/docs/3.13/alarms">alarms</a> are in effect, no ongoing queue or stream replica sync operations
and the system is otherwise under a reasonable load</li>
<li>Remove node A from the cluster using <code>rabbitmqctl forget_cluster_node</code></li>
<li>Add a new node, node E, to the cluster</li>
<li>Place a new replica of every quorum queue and every stream to the new node using commands such as <code>rabbitmq-queues grow</code></li>
<li>Check that the cluster is in a good state</li>
<li>Remove node B from the cluster using <code>rabbitmqctl forget_cluster_node</code></li>
<li>and so on</li>
</ul>
<p>This approach may seem like one that strikes a good balance between the relative simplicity of
in-place upgrades and the safety of Blue-Green deployment upgrades. However, in practice this
strategy has comparable characteristics to the in-place upgrade option:</p>
<ul>
<li>Newly added nodes may affect the existing cluster state</li>
<li>Replicas will migrate between nodes during the upgrade process</li>
</ul>
<p>In addition, this approach has its own unique potential risks:</p>
<ul>
<li>Node identities change during the upgrade process, which can affect <a href="/rabbitmq-website/docs/3.13/monitoring">historical monitoring data</a></li>
<li>Nodes must transfer their data sets to the newly added members, which can result in a <strong>very substantial increase
in network traffic and disk I/O</strong></li>
<li>Premature removal of nodes (see below) can lead to a quorum loss for a subset of quorum queues and streams</li>
</ul>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>In order to safely perform a grow-then-shrink upgrade, several precautions must be taken</p></div></div>
<p>In order to safely perform a grow-then-shrink upgrade, several precautions must be taken:</p>
<ul>
<li>After a new node is added and a replica extension process is initiated, the process must
be given enough time to complete</li>
<li>Before a node is removed, a health check must be run to ensure that it is not quorum critical for any queues (or streams):
that is, that the removal of the node will not leave any quorum queues or streams without an online majority</li>
<li>Nodes must be removed from the cluster explicitly using <code>rabbitmqctl forget_cluster_node</code></li>
</ul>
<p><a href="/rabbitmq-website/docs/3.13/streams">Streams</a> specifically were not designed for environments where replica (node) identity change is frequent,
and all replicas can be transferred away and replaced over duration of a single cluster upgrade.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-precautions">Key Precautions<a href="#key-precautions" class="hash-link" aria-label="Direct link to Key Precautions" title="Direct link to Key Precautions">​</a></h3>
<p>To determine if a node is quorum critical, use the following <a href="/rabbitmq-website/docs/3.13/monitoring#health-checks">health check</a>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># exits with a non-zero status if shutting down target node would leave some quorum queues</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># or streams without an online majority</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics check_if_node_is_quorum_critical</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># exits with a non-zero status if shutting down target node would leave some quorum queues</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># or streams without an online majority</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat check_if_node_is_quorum_critical</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>The following <a href="/rabbitmq-website/docs/3.13/monitoring#health-checks">health check</a> must be used to determine if there may be
any remaining initial quorum queue replica log transfers:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># exits with a non-zero status if there are any ongoing initial quorum queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># replica sync operations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics check_if_new_quorum_queue_replicas_have_finished_initial_sync</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># exits with a non-zero status if there are any ongoing initial quorum queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># replica sync operations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat check_if_new_quorum_queue_replicas_have_finished_initial_sync</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Consider adding and removing a single node at a time</p></div></div>
<p>If multiple nodes are added and removed at a time, the health checks must be performed on all of them.
Removing multiple nodes at a time is more likely to leave certain quorum queues or streams without
an online majority, therefore it is highly recommended to add and remove a single node at a time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="maintenance-mode">Maintenance Mode<a href="#maintenance-mode" class="hash-link" aria-label="Direct link to Maintenance Mode" title="Direct link to Maintenance Mode">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-maintenance-mode">What is Maintenance Mode?<a href="#what-is-maintenance-mode" class="hash-link" aria-label="Direct link to What is Maintenance Mode?" title="Direct link to What is Maintenance Mode?">​</a></h3>
<p>Maintenance mode is a special node operation mode that can be useful during upgrades.
The mode is explicitly turned on and off by the operator using a bunch of new CLI commands covered below.
For mixed-version cluster compatibility, this feature must be <a href="/rabbitmq-website/docs/3.13/feature-flags">enabled using a feature flag</a>
once all cluster members have been upgraded to a version that supports it:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl enable_feature_flag maintenance_mode_status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat enable_feature_flag maintenance_mode_status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="put-a-node-into-maintenance-mode">Put a Node into Maintenance Mode<a href="#put-a-node-into-maintenance-mode" class="hash-link" aria-label="Direct link to Put a Node into Maintenance Mode" title="Direct link to Put a Node into Maintenance Mode">​</a></h3>
<p>To put a node under maintenance, use <code>rabbitmq-upgrade drain</code>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade drain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat drain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>As all other CLI commands, this command can be invoked against an arbitrary node (including remote ones)
using the <code>-n</code> switch:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># puts node rabbit@node2.cluster.rabbitmq.svc into maintenance mode</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade drain </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> rabbit@node2.cluster.rabbitmq.svc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># puts node rabbit@node2.cluster.rabbitmq.svc into maintenance mode</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat drain </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n rabbit@node2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rabbitmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>When a node is in maintenance mode, it <strong>will not be available for serving client traffic</strong>
and will try to transfer as many of its responsibilities as practically possible and safe.</p>
<p>Currently this involves the following steps:</p>
<ul>
<li>Suspend all client connection listeners (no new client connections will be accepted)</li>
<li>Close all existing client connections: applications are expected to reconnect to other nodes and recover</li>
<li>Transfer primary replicas of all quorum queues hosted on the target node, and prevent them from participating
in the subsequently triggered Raft elections</li>
<li>Mark the node as down for maintenance</li>
<li>At this point, a node shutdown will be least disruptive as the node has already transferred most of its
responsibilities</li>
</ul>
<p>A node in maintenance mode will not be considered for new primary queue replica placement, regardless
of queue type and the <a href="/rabbitmq-website/docs/3.13/ha#leader-migration-data-locality">queue leader locator policy</a> used.</p>
<p>This feature is expected to evolve based on the feedback from RabbitMQ operators, users,
and RabbitMQ core team&#x27;s own experience with it.</p>
<p>A node in maintenance mode is expected to be shut down, upgraded or reconfigured, and restarted in a short
time window (say, 5-30 minutes). Nodes are not expected to be running in this mode permanently or
for long periods of time.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="revive-a-node-from-maintenance-mode">Revive a Node from Maintenance Mode<a href="#revive-a-node-from-maintenance-mode" class="hash-link" aria-label="Direct link to Revive a Node from Maintenance Mode" title="Direct link to Revive a Node from Maintenance Mode">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The command described below exists to roll back (to the extent possible) the effects of
the <code>drain</code> one mentioned above.</p><p>It is not necessary to run it after a node restart because a restarted node will reset its
maintenance mode state.</p></div></div>
<p>A node in maintenance mode can be <em>revived</em>, that is, <strong>brought back into its regular operational state</strong>,
using <code>rabbitmq-upgrade revive</code>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade revive</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat revive</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>The command exists to roll back (to the extent possible) the effects of the <code>drain</code> one.</p>
<p>It is not necessary to run it after a node restart because a restarted node will reset its
maintenance mode state.</p>
<p>As all other CLI commands, this command can be invoked against an arbitrary node (including remote ones)
using the <code>-n</code> switch:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># revives node rabbit@node2.cluster.rabbitmq.svc from maintenance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade revive </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> rabbit@node2.cluster.rabbitmq.svc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># revives node rabbit@node2.cluster.rabbitmq.svc from maintenance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-upgrade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat revive </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n rabbit@node2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rabbitmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>When a node is revived or restarted (e.g. after an upgrade), it will again accept client connections
and be considered for primary queue replica placements.</p>
<p>It will not recover previous client connections as RabbitMQ never initiates connections
to clients, but clients will be able to reconnect to it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-maintenance-status-of-a-node">Verify Maintenance Status of a Node<a href="#verify-maintenance-status-of-a-node" class="hash-link" aria-label="Direct link to Verify Maintenance Status of a Node" title="Direct link to Verify Maintenance Status of a Node">​</a></h3>
<p>If the maintenance mode status feature flag is enabled, node maintenance status will be reported
in <code>rabbitmq-diagnostics status</code> and <code>rabbitmq-diagnostics cluster_status</code>.</p>
<p>Here&#x27;s an example <code>rabbitmq-diagnostics status</code> output of a node under maintenance:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Status of node rabbit@hostname ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Runtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OS PID: 25531</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OS: macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Uptime (seconds): 48540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Is under maintenance?: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Compare this to this example output from a node in regular operating mode:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Status of node rabbit@hostname ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Runtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OS PID: 25531</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OS: macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Uptime (seconds): 48540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Is under maintenance?: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="full-stop-upgrades">Full-Stop Upgrades<a href="#full-stop-upgrades" class="hash-link" aria-label="Direct link to Full-Stop Upgrades" title="Direct link to Full-Stop Upgrades">​</a></h2>
<p>When an entire cluster is stopped for upgrade, the order in which nodes are
stopped and started is important.</p>
<p>RabbitMQ will automatically update its data directory
if necessary when upgrading between major or minor versions.
In a cluster, this task is performed by the first disc node to be started
(the &quot;upgrader&quot; node).</p>
<p>When upgrading a RabbitMQ cluster using the &quot;full stop&quot; method,
a node with stable durable storage must start first.</p>
<p>During an upgrade, the last disc node to go down must be the first node to
be brought online. Otherwise the started node will emit an error message and
fail to start up. Unlike an ordinary cluster restart, upgrading nodes will not wait
for the last disc node to come back online.</p>
<p>While not strictly necessary, it is a good idea to decide ahead of time
which disc node will be the upgrader, stop that node last, and start it first.
Otherwise changes to the cluster configuration that were made between the
upgrader node stopping and the last node stopping will be lost.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="recommended-upgrade-steps">Recommended Upgrade Steps<a href="#recommended-upgrade-steps" class="hash-link" aria-label="Direct link to Recommended Upgrade Steps" title="Direct link to Recommended Upgrade Steps">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="understand-what-the-most-recent-release-is">Understand What the Most Recent Release Is<a href="#understand-what-the-most-recent-release-is" class="hash-link" aria-label="Direct link to Understand What the Most Recent Release Is" title="Direct link to Understand What the Most Recent Release Is">​</a></h3>
<p>See <a href="/rabbitmq-website/release-information">Release Information</a> to find out what the most recent
available version is.</p>
<p>Upgrading to the oldest series is highly recommended.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="carefully-read-the-release-notes-up-to-the-selected-rabbitmq-version">Carefully Read the Release Notes Up to the Selected RabbitMQ Version<a href="#carefully-read-the-release-notes-up-to-the-selected-rabbitmq-version" class="hash-link" aria-label="Direct link to Carefully Read the Release Notes Up to the Selected RabbitMQ Version" title="Direct link to Carefully Read the Release Notes Up to the Selected RabbitMQ Version">​</a></h3>
<p>The release notes may indicate specific additional upgrade steps.
Always consult with the release notes of all versions between the
one currently deployed and the target one.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enable-required-feature-flags-before-attempting-the-upgrade">Enable Required Feature Flags Before Attempting the Upgrade<a href="#enable-required-feature-flags-before-attempting-the-upgrade" class="hash-link" aria-label="Direct link to Enable Required Feature Flags Before Attempting the Upgrade" title="Direct link to Enable Required Feature Flags Before Attempting the Upgrade">​</a></h3>
<p>Some versions, such as 3.11 and 3.12, <a href="/rabbitmq-website/docs/3.13/feature-flags#core-feature-flags">require some or all previously existing feature flags</a>
to be enabled <strong>before</strong> the upgrade. If all feature flags were enabled after the
previous upgrade, this should already be the case. However, it&#x27;s better to verify
the state of feature flags with</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl list_feature_flags </span><span class="token parameter variable" style="color:#36acaa">--formatter</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pretty_table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat list_feature_flags </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">formatter=pretty_table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>and enable all feature flags with</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl enable_feature_flag all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat enable_feature_flag all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>Repeat these steps <a href="#enable-ff-after-upgrade">at the end of the upgrade process</a>
to fully take advantage of the new features and be prepared for the next upgrade in the future.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="check-currently-used-rabbitmq-version">Check Currently Used RabbitMQ Version<a href="#check-currently-used-rabbitmq-version" class="hash-link" aria-label="Direct link to Check Currently Used RabbitMQ Version" title="Direct link to Check Currently Used RabbitMQ Version">​</a></h3>
<p>Some upgrade paths, e.g. from 3.10.x to 3.13.x, will require an intermediate upgrade
or even multiple intermediate upgrades.</p>
<p>See the <a href="#rabbitmq-version-upgradability">RabbitMQ Version Upgradability</a> section above.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="check-erlang-version-requirements">Check Erlang Version Requirements<a href="#check-erlang-version-requirements" class="hash-link" aria-label="Direct link to Check Erlang Version Requirements" title="Direct link to Check Erlang Version Requirements">​</a></h3>
<p>Check if the current Erlang version is supported by the new RabbitMQ version.
See the <a href="/rabbitmq-website/docs/3.13/which-erlang">Erlang Version Requirements</a> guide.
If not, Erlang should be upgraded together with RabbitMQ.</p>
<p>It&#x27;s generally recommended to upgrade to the latest Erlang version supported to
get all the latest bugfixes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="make-sure-all-package-dependencies-including-erlang-are-available">Make Sure All Package Dependencies (including Erlang) are Available.<a href="#make-sure-all-package-dependencies-including-erlang-are-available" class="hash-link" aria-label="Direct link to Make Sure All Package Dependencies (including Erlang) are Available." title="Direct link to Make Sure All Package Dependencies (including Erlang) are Available.">​</a></h3>
<p>If you are using Debian or RPM packages, you must ensure
that all dependencies are available. In particular, the
correct version of Erlang. You may have to setup additional
third-party package repositories to achieve that.</p>
<p>Please read recommendations for
<a href="/rabbitmq-website/docs/3.13/which-erlang#debian">Debian-based</a> and
<a href="/rabbitmq-website/docs/3.13/which-erlang#redhat">RPM-based</a> distributions to find the
appropriate repositories for Erlang.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="if-running-rabbitmq-in-a-cluster-select-the-cluster-upgrade-strategy">If running RabbitMQ in a cluster, select the cluster upgrade strategy.<a href="#if-running-rabbitmq-in-a-cluster-select-the-cluster-upgrade-strategy" class="hash-link" aria-label="Direct link to If running RabbitMQ in a cluster, select the cluster upgrade strategy." title="Direct link to If running RabbitMQ in a cluster, select the cluster upgrade strategy.">​</a></h3>
<p>It can be possible to do a rolling upgrade,
if Erlang version and RabbitMQ version changes support it.</p>
<p>See the <a href="#multiple-nodes-upgrade">Upgrading Multiple Nodes</a> section above.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="assess-cluster-health">Assess Cluster Health<a href="#assess-cluster-health" class="hash-link" aria-label="Direct link to Assess Cluster Health" title="Direct link to Assess Cluster Health">​</a></h3>
<p>Make sure nodes are healthy and there are no <a href="/rabbitmq-website/docs/3.13/partitions">network partition</a> or <a href="/rabbitmq-website/docs/3.13/alarms">disk or memory alarms</a> in effect.</p>
<p>RabbitMQ management UI, CLI tools or HTTP API can be used for
assessing the health of the system.</p>
<p>The overview page in the management UI displays effective RabbitMQ
and Erlang versions, multiple cluster-wide metrics and rates. From
this page ensure that all nodes are running and they are all &quot;green&quot;
(w.r.t. file descriptors, memory, disk space, and so on).</p>
<p>We recommend recording the number of durable queues, the number
of messages they hold and other pieces of information about the
topology that are relevant. This data will help verify that the
system operates within reasonable parameters after the upgrade.</p>
<p>Use <a href="/rabbitmq-website/docs/3.13/monitoring#health-checks">node health checks</a> to
vet individual nodes.</p>
<p>Queues in flow state or blocked/blocking connections might be ok,
depending on your workload. It&#x27;s up to you to determine if this is
a normal situation or if the cluster is under unexpected load and
thus, decide if it&#x27;s safe to continue with the upgrade.</p>
<p>However, if there are queues in an undefined state (a.k.a. <code>NaN</code> or
&quot;ghost&quot; queues), you should first start by understanding what is
wrong before starting an upgrade.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ensure-cluster-has-the-capacity-for-upgrading">Ensure Cluster Has the Capacity for Upgrading<a href="#ensure-cluster-has-the-capacity-for-upgrading" class="hash-link" aria-label="Direct link to Ensure Cluster Has the Capacity for Upgrading" title="Direct link to Ensure Cluster Has the Capacity for Upgrading">​</a></h3>
<p>The upgrade process can require additional resources.
Make sure there are enough resources available to proceed, in particular free
memory and free disk space.</p>
<p>It&#x27;s recommended to have at least half of the system memory free
before the upgrade. Default memory watermark is 0.4 so it should be
ok, but you should still double-check. Starting with RabbitMQ <code>3.6.11</code>
the way nodes <a href="/rabbitmq-website/docs/3.13/memory-use">calculate their total RAM consumption</a> has changed.</p>
<p>When upgrading from an earlier version,
it is required that the node has enough free disk space to fit at
least a full copy of the node data directory. Nodes create backups
before proceeding to upgrade their database. If disk space is
depleted, the node will abort upgrading and may fail to start
until the data directory is restored from the backup.</p>
<p>For example, if you have 10 GiB of free system memory and the Erlang
process (i.e. <code>beam.smp</code>) memory footprint is around 6 GiB, then it
can be unsafe to proceed. Likewise w.r.t. disk if you have 10 GiB of
free space and the data directory (e.g. <code>/var/lib/rabbitmq</code>) takes
10 GiB.</p>
<p>When upgrading a cluster using the rolling upgrade strategy,
be aware that queues and connections can migrate to other nodes
during the upgrade.</p>
<p>If queues are mirrored to a subset of the cluster only (as opposed
to all nodes), new mirrors will be created on running nodes when
the to-be-upgraded node shuts down. If clients support connections
recovery and can connect to different nodes, they will reconnect
to the nodes that are still running. If clients are configured to create
exclusive queues, these queues might be recreated on different nodes
after client reconnection.</p>
<p>To handle such migrations, make sure you have enough
spare resources on the remaining nodes so they can handle the extra load.
Depending on the load balancing strategy all the connections from
the stopped node can go to a single node, so it should be able to
handle up to twice as many.
It&#x27;s generally a good practice to run a cluster with N+1 redundancy
(resource-wise), so you always have a capacity to handle a single
node being down.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="take-a-backup">Take a Backup<a href="#take-a-backup" class="hash-link" aria-label="Direct link to Take a Backup" title="Direct link to Take a Backup">​</a></h3>
<p>It&#x27;s always good to have a backup before upgrading.
See <a href="/rabbitmq-website/docs/3.13/backup">backup</a> guide for instructions.</p>
<p>To make a proper backup, you may need to stop the entire cluster.
Depending on your use case, you may make the backup while the
cluster is stopped for the upgrade.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="perform-the-upgrade">Perform the Upgrade<a href="#perform-the-upgrade" class="hash-link" aria-label="Direct link to Perform the Upgrade" title="Direct link to Perform the Upgrade">​</a></h3>
<p>It&#x27;s recommended to upgrade Erlang version together with RabbitMQ, because both
actions require restart and recent RabbitMQ work better with recent Erlang.</p>
<p>Depending on cluster configuration, you can use either <a href="#single-node-upgrade">single node upgrade</a>,
<a href="#multiple-nodes-upgrade">rolling upgrade</a> or <a href="#full-stop-upgrades">full-stop upgrade</a> strategy.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-that-the-upgrade-has-succeeded">Verify that the Upgrade Has Succeeded<a href="#verify-that-the-upgrade-has-succeeded" class="hash-link" aria-label="Direct link to Verify that the Upgrade Has Succeeded" title="Direct link to Verify that the Upgrade Has Succeeded">​</a></h3>
<p>Like you did before the upgrade, verify the health and <a href="/rabbitmq-website/docs/3.13/monitoring">monitoring data</a> to
make sure all cluster nodes are in good shape and the service is
running again.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enable-ff-after-upgrade">Enable New Feature Flags<a href="#enable-ff-after-upgrade" class="hash-link" aria-label="Direct link to Enable New Feature Flags" title="Direct link to Enable New Feature Flags">​</a></h3>
<p>If the new version provides new feature flags, you should
now enable them if you upgraded all nodes and you are
sure you do not want to rollback. See the <a href="/rabbitmq-website/docs/3.13/feature-flags">feature flags guide</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="caveats">Caveats<a href="#caveats" class="hash-link" aria-label="Direct link to Caveats" title="Direct link to Caveats">​</a></h2>
<p>There are some minor things to consider during upgrade process when stopping and
restarting nodes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="otp-bugs">Known Erlang OTP Bugs that Can Affect Upgrades<a href="#otp-bugs" class="hash-link" aria-label="Direct link to Known Erlang OTP Bugs that Can Affect Upgrades" title="Direct link to Known Erlang OTP Bugs that Can Affect Upgrades">​</a></h3>
<p>There are currently no known bugs in the <a href="/rabbitmq-website/docs/3.13/which-erlang">supported Erlang series</a> that can affect upgrades.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="quorum-queues">Quorum Queues<a href="#quorum-queues" class="hash-link" aria-label="Direct link to Quorum Queues" title="Direct link to Quorum Queues">​</a></h3>
<p><a href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum queues</a> depend on a <a href="/rabbitmq-website/docs/3.13/quorum-queues#what-is-quorum">quorum</a> of nodes to
be online for any queue operations to succeed. This includes successful new leader election should
a cluster node that hosts some leaders shut down.</p>
<p>In the context of rolling upgrades, this means that a quorum of nodes must be present at all times
during an upgrade. If this is not the case, quorum queues will become unavailable and will be not
able to satisfy their data safety guarantees.</p>
<p>Latest RabbitMQ releases provide a <a href="/rabbitmq-website/docs/3.13/monitoring#health-checks">health check</a> command that would fail
should any quorum queues on the target node lose their quorum in case the node was to be shut down:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Exits with a non-zero code if one or more quorum queues will lose online quorum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># should target node be shut down</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics check_if_node_is_quorum_critical</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Exits with a non-zero code if one or more quorum queues will lose online quorum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># should target node be shut down</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat check_if_node_is_quorum_critical</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>For example, consider a three node cluster with nodes A, B, and C. If node B is currently down
and there are quorum queues having their leader replica on node A, this check will fail if executed
against node A. When node B comes back online, the same check would succeed because
the quorum queues with leader on node A would have a quorum of replicas online.</p>
<p>Quorum queue quorum state can be verified by listing queues in the management UI or using <code>rabbitmq-queues</code>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-queues </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> rabbit@to-be-stopped quorum_status </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">queue name</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-queues</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n rabbit@to-be-stopped quorum_status &lt;queue name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mirrored-queues-synchronisation">Mirrored Queues Replica Synchronisation<a href="#mirrored-queues-synchronisation" class="hash-link" aria-label="Direct link to Mirrored Queues Replica Synchronisation" title="Direct link to Mirrored Queues Replica Synchronisation">​</a></h3>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>This section covers a feature that had been <a href="https://blog.rabbitmq.com/posts/2021/08/4.0-deprecation-announcements/" target="_blank" rel="noopener noreferrer"><strong>deprecated since 2021</strong></a>
and <a href="https://github.com/rabbitmq/rabbitmq-server/pull/9815" target="_blank" rel="noopener noreferrer"><strong>was removed completely</strong></a> for the next major series, RabbitMQ 4.x.</p></div></div>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p><a href="/rabbitmq-website/docs/3.13/quorum-queues">Quorum queues</a> and/or <a href="/rabbitmq-website/docs/3.13/streams">streams</a> should be used instead of mirrored classic queues.
<strong>Non-replicated</strong> classic queues continue being supported and developed.</p></div></div>
<p>In environments that use <a href="/rabbitmq-website/docs/3.13/ha">classic mirrored queues</a> (a <strong>deprecated feature removal for RabbitMQ 4.0</strong>),
it is important to make sure that all mirrored queues on a node
have a synchronised follower replica (mirror) <strong>before stopping that node</strong>.</p>
<p>RabbitMQ will not promote unsynchronised queue mirrors on controlled queue leader shutdown when
<a href="/rabbitmq-website/docs/3.13/ha#promotion-while-down">default promotion settings</a> are used.
However if a queue leader encounters any errors during shutdown, an <a href="/rabbitmq-website/docs/3.13/ha#unsynchronised-mirrors">unsynchronised queue mirror</a>
might still be promoted. It is generally safer option to synchronise all classic mirrored queues
with replicas on a node before shutting the node down.</p>
<p>RabbitMQ 3.13.x series provides a <a href="/rabbitmq-website/docs/3.13/monitoring#health-checks">health check</a> command that would fail
should any classic mirrored queues on the target node have no synchronised mirrors:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## IMPORTANT: classic queue mirroring, together with this health checks, were REMOVED for RabbitMQ 4.0.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Exits with a non-zero code if target node hosts leader replica of at least one queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># that has out-of-sync mirror.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics check_if_node_is_mirror_sync_critical</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## IMPORTANT: classic queue mirroring, together with this health checks, were REMOVED for RabbitMQ 4.0.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Exits with a non-zero code if target node hosts leader replica of at least one queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># that has out-of-sync mirror.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat check_if_node_is_mirror_sync_critical</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>For example, consider a three node cluster with nodes A, B, and C. If there are classic mirrored queues
with the only synchronised replica on node A (the leader), this check will fail if executed
against node A. When one of other replicas is re-synchronised, the same check would succeed because
there would be at least one replica suitable for promotion.</p>
<p>Classic mirrored queue replica state can be verified by listing queues in the management UI or using <code>rabbitmqctl</code>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># For queues with non-empty `mirror_pids`, you must have at least one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># `synchronised_mirror_pids`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note that mirror_pids is a new field alias introduced in RabbitMQ 3.11.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> rabbit@to-be-stopped list_queues </span><span class="token parameter variable" style="color:#36acaa">--local</span><span class="token plain"> name mirror_pids synchronised_mirror_pids</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># For queues with non-empty `mirror_pids`, you must have at least one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># `synchronised_mirror_pids`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note that mirror_pids is a new field alias introduced in RabbitMQ 3.11.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n rabbit@to-be-stopped list_queues </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">local name mirror_pids synchronised_mirror_pids</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>If there are unsynchronised queues, either enable
automatic synchronisation or <a href="/rabbitmq-website/docs/3.13/ha#unsynchronised-mirrors">trigger it using <code>rabbitmqctl</code></a> manually.</p>
<p>RabbitMQ shutdown process will not wait for queues to be synchronised
if a synchronisation operation is in progress.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mirrored-queue-masters-rebalance">Mirrored queue leaders rebalancing<a href="#mirrored-queue-masters-rebalance" class="hash-link" aria-label="Direct link to Mirrored queue leaders rebalancing" title="Direct link to Mirrored queue leaders rebalancing">​</a></h3>
<p>Some upgrade scenarios can cause mirrored queue leaders to be unevenly distributed
between nodes in a cluster. This will put more load on the nodes with more queue leaders.
For example a full-stop upgrade will make all queue leaders migrate to the &quot;upgrader&quot; node -
the one stopped last and started first.
A rolling upgrade of three nodes with two mirrors will also cause all queue leaders to be on the same node.</p>
<p>You can move a queue leader for a queue using a temporary <a href="/rabbitmq-website/docs/3.13/parameters">policy</a> with
<code>ha-mode: nodes</code> and <code>ha-params: [&lt;node&gt;]</code>
The policy can be created via management UI or rabbitmqctl command:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_policy --apply-to queues </span><span class="token parameter variable" style="color:#36acaa">--priority</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> move-my-queue </span><span class="token string" style="color:#e3116c">&#x27;^&lt;queue&gt;$;&#x27;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{&quot;ha-mode&quot;:&quot;nodes&quot;, &quot;ha-params&quot;:[&quot;&lt;new-leader-node&gt;&quot;]}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl clear_policy move-my-queue</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat set_policy </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">apply-to queues </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">priority 100 </span><span class="token function" style="color:#d73a49">move-my</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">queue </span><span class="token string" style="color:#e3116c">&#x27;^&lt;queue&gt;$;&#x27;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{&quot;ha-mode&quot;:&quot;nodes&quot;, &quot;ha-params&quot;:[&quot;&lt;new-leader-node&gt;&quot;]}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat clear_policy </span><span class="token function" style="color:#d73a49">move-my</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">queue</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>A <a href="https://github.com/rabbitmq/support-tools/blob/main/scripts/rebalance-queue-masters" target="_blank" rel="noopener noreferrer">queue leader rebalancing script</a>
is available. It rebalances queue leaders for all queues.</p>
<p>The script has certain assumptions (e.g. the default node name) and can fail to run on
some installations. The script should be considered
experimental. Run it in a non-production environment first.</p>
<p>A <a href="/rabbitmq-website/docs/3.13/man/rabbitmq-queues.8">queue leader rebalance command</a> is available. It rebalances queue leaders for all queues, or those that match the given name pattern. queue leaders for mirrored queues and leaders for quorum queues are also rebalanced in the <a href="/rabbitmq-website/docs/3.13/man/rabbitmq-upgrade.8">post-upgrade command</a>.</p>
<p>There is also a <a href="https://github.com/Ayanda-D/rabbitmq-queue-master-balancer" target="_blank" rel="noopener noreferrer">third-party plugin</a>
that rebalances queue leaders. The plugin has some additional configuration and reporting tools,
but is not supported or verified by the RabbitMQ team. Use at your own risk.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-restart-handling">Handling Node Restarts in Applications<a href="#rabbitmq-restart-handling" class="hash-link" aria-label="Direct link to Handling Node Restarts in Applications" title="Direct link to Handling Node Restarts in Applications">​</a></h2>
<p>In order to reduce or eliminate the downtime, applications (both producers
and consumers) should be able to cope with a server-initiated connection
close. Some client libraries offer automatic connection recovery
to help with this:</p>
<ul>
<li><a href="/rabbitmq-website/client-libraries/java-api-guide#recovery">Java client</a></li>
<li><a href="/rabbitmq-website/client-libraries/dotnet-api-guide#connection-recovery">.NET client</a></li>
<li><a href="http://rubybunny.info/articles/error_handling.html#network_connection_failures" target="_blank" rel="noopener noreferrer">Bunny</a> (Ruby)</li>
</ul>
<p>In most client libraries there is a way to react to a connection closure, for example:</p>
<ul>
<li><a href="https://pika.readthedocs.io/en/stable/modules/connection.html#pika.connection.Connection.add_on_close_callback" target="_blank" rel="noopener noreferrer">Pika</a> (Python)</li>
<li><a href="https://pkg.go.dev/github.com/rabbitmq/amqp091-go#Connection.NotifyClose" target="_blank" rel="noopener noreferrer">Go</a></li>
</ul>
<p>The recovery procedure for many applications follows the same steps:</p>
<ol>
<li>Reconnect</li>
<li>Re-open channels</li>
<li>Restore channel settings (e.g. the <a href="/rabbitmq-website/docs/3.13/confirms"><code>basic.qos</code> setting</a>, publisher confirms)</li>
<li>Recover topology</li>
</ol>
<p>Topology recovery includes the following actions, performed for every channel:</p>
<ol>
<li>Re-declare exchanges declared by the application</li>
<li>Re-declare queues</li>
<li>Recover bindings (both queue and <a href="/rabbitmq-website/docs/3.13/e2e">exchange-to-exchange</a> ones)</li>
<li>Recover consumers</li>
</ol>
<p>This algorithm covers the majority of use cases and is what the
aforementioned automatic recovery feature implements.</p>
<p>During a rolling upgrade when a node is stopped, clients connected to this node
will be disconnected using a server-sent <code>connection.close</code> method and should reconnect to a different node.
This can be achieved by using a load balancer or proxy in front of the cluster
or by specifying multiple server hosts if client library supports this feature.</p>
<p>Many client libraries libraries support host lists, for example:</p>
<ul>
<li><a href="https://rabbitmq.github.io/rabbitmq-java-client/api/current/com/rabbitmq/client/ConnectionFactory.html#newConnection%28com.rabbitmq.client.Address%5B%5D%29" target="_blank" rel="noopener noreferrer">Java client</a></li>
<li><a href="https://github.com/rabbitmq/rabbitmq-dotnet-client/blob/main/projects/RabbitMQ.Client/client/api/ConnectionFactory.cs#L392" target="_blank" rel="noopener noreferrer">.NET client</a></li>
<li><a href="http://api.rubybunny.info/Bunny/Session.html#constructor_details" target="_blank" rel="noopener noreferrer">Bunny</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="windows-upgrade-caveats">Windows<a href="#windows-upgrade-caveats" class="hash-link" aria-label="Direct link to Windows" title="Direct link to Windows">​</a></h2>
<p>If the value of the environment variable <code>COMPUTERNAME</code> does not equal
<code>HOSTNAME</code> (upper vs lower case, or other differences) please see the <a href="/rabbitmq-website/docs/3.13/windows-configuration#computername-vs-hostname">Windows Configuration guide</a>
for instructions on how to upgrade RabbitMQ.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/versioned_docs/version-3.13/upgrade.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/docs/3.13/install-homebrew"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">MacOs using Homebrew</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/docs/3.13/feature-flags"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Feature Flags</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#important-note-on-upgrading-to-312-and-313" class="table-of-contents__link toc-highlight">Important Note on Upgrading to 3.12 and 3.13</a></li><li><a href="#basics" class="table-of-contents__link toc-highlight">Basics</a><ul><li><a href="#in-place" class="table-of-contents__link toc-highlight">In-place Upgrades</a></li><li><a href="#blue-green-deployment-upgrades" class="table-of-contents__link toc-highlight">Blue-Green Deployment Upgrades</a></li><li><a href="#grow-then-shrink-upgrades" class="table-of-contents__link toc-highlight">Grow-then-Shrink Upgrades</a></li></ul></li><li><a href="#rabbitmq-version-upgradability" class="table-of-contents__link toc-highlight">RabbitMQ Version Upgradability</a><ul><li><a href="#release-series-upgradeability-with-rolling-upgrades" class="table-of-contents__link toc-highlight">Release Series Upgradeability with Rolling Upgrades</a></li><li><a href="#release-series-upgradeability-with-full-stop-upgrades" class="table-of-contents__link toc-highlight">Release Series Upgradeability with Full Stop Upgrades</a></li></ul></li><li><a href="#rabbitmq-erlang-version-requirement" class="table-of-contents__link toc-highlight">Erlang Version Requirements</a></li><li><a href="#unsupported-inplace-upgrade" class="table-of-contents__link toc-highlight">Features that Do Not Support In-place Upgrades</a></li><li><a href="#rabbitmq-plugins-compatibility" class="table-of-contents__link toc-highlight">Plugin Compatibility Between Versions</a><ul><li><a href="#management-ui" class="table-of-contents__link toc-highlight">Management Plugin Upgrades</a></li><li><a href="#discontinued-plugins" class="table-of-contents__link toc-highlight">Discontinued Plugins</a></li></ul></li><li><a href="#system-resource-usage" class="table-of-contents__link toc-highlight">Changes in System Resource Usage and Reporting</a></li><li><a href="#clusters" class="table-of-contents__link toc-highlight">Single Node and Cluster Upgrades</a><ul><li><a href="#single-node-upgrade" class="table-of-contents__link toc-highlight">Upgrading a Single Node Installation</a></li><li><a href="#multiple-nodes-upgrade" class="table-of-contents__link toc-highlight">Upgrading Multiple Nodes</a></li><li><a href="#rolling-upgrades" class="table-of-contents__link toc-highlight">Rolling Upgrades</a></li><li><a href="#rolling-upgrades-restarting-nodes" class="table-of-contents__link toc-highlight">When to Restart Nodes</a></li><li><a href="#after-restarting" class="table-of-contents__link toc-highlight">After Restarting All Nodes</a></li></ul></li><li><a href="#grow-then-shrink" class="table-of-contents__link toc-highlight">Grow-then-Shrink Upgrades</a><ul><li><a href="#key-precautions" class="table-of-contents__link toc-highlight">Key Precautions</a></li></ul></li><li><a href="#maintenance-mode" class="table-of-contents__link toc-highlight">Maintenance Mode</a><ul><li><a href="#what-is-maintenance-mode" class="table-of-contents__link toc-highlight">What is Maintenance Mode?</a></li><li><a href="#put-a-node-into-maintenance-mode" class="table-of-contents__link toc-highlight">Put a Node into Maintenance Mode</a></li><li><a href="#revive-a-node-from-maintenance-mode" class="table-of-contents__link toc-highlight">Revive a Node from Maintenance Mode</a></li><li><a href="#verify-maintenance-status-of-a-node" class="table-of-contents__link toc-highlight">Verify Maintenance Status of a Node</a></li></ul></li><li><a href="#full-stop-upgrades" class="table-of-contents__link toc-highlight">Full-Stop Upgrades</a></li><li><a href="#recommended-upgrade-steps" class="table-of-contents__link toc-highlight">Recommended Upgrade Steps</a><ul><li><a href="#understand-what-the-most-recent-release-is" class="table-of-contents__link toc-highlight">Understand What the Most Recent Release Is</a></li><li><a href="#carefully-read-the-release-notes-up-to-the-selected-rabbitmq-version" class="table-of-contents__link toc-highlight">Carefully Read the Release Notes Up to the Selected RabbitMQ Version</a></li><li><a href="#enable-required-feature-flags-before-attempting-the-upgrade" class="table-of-contents__link toc-highlight">Enable Required Feature Flags Before Attempting the Upgrade</a></li><li><a href="#check-currently-used-rabbitmq-version" class="table-of-contents__link toc-highlight">Check Currently Used RabbitMQ Version</a></li><li><a href="#check-erlang-version-requirements" class="table-of-contents__link toc-highlight">Check Erlang Version Requirements</a></li><li><a href="#make-sure-all-package-dependencies-including-erlang-are-available" class="table-of-contents__link toc-highlight">Make Sure All Package Dependencies (including Erlang) are Available.</a></li><li><a href="#if-running-rabbitmq-in-a-cluster-select-the-cluster-upgrade-strategy" class="table-of-contents__link toc-highlight">If running RabbitMQ in a cluster, select the cluster upgrade strategy.</a></li><li><a href="#assess-cluster-health" class="table-of-contents__link toc-highlight">Assess Cluster Health</a></li><li><a href="#ensure-cluster-has-the-capacity-for-upgrading" class="table-of-contents__link toc-highlight">Ensure Cluster Has the Capacity for Upgrading</a></li><li><a href="#take-a-backup" class="table-of-contents__link toc-highlight">Take a Backup</a></li><li><a href="#perform-the-upgrade" class="table-of-contents__link toc-highlight">Perform the Upgrade</a></li><li><a href="#verify-that-the-upgrade-has-succeeded" class="table-of-contents__link toc-highlight">Verify that the Upgrade Has Succeeded</a></li><li><a href="#enable-ff-after-upgrade" class="table-of-contents__link toc-highlight">Enable New Feature Flags</a></li></ul></li><li><a href="#caveats" class="table-of-contents__link toc-highlight">Caveats</a><ul><li><a href="#otp-bugs" class="table-of-contents__link toc-highlight">Known Erlang OTP Bugs that Can Affect Upgrades</a></li><li><a href="#quorum-queues" class="table-of-contents__link toc-highlight">Quorum Queues</a></li><li><a href="#mirrored-queues-synchronisation" class="table-of-contents__link toc-highlight">Mirrored Queues Replica Synchronisation</a></li><li><a href="#mirrored-queue-masters-rebalance" class="table-of-contents__link toc-highlight">Mirrored queue leaders rebalancing</a></li></ul></li><li><a href="#rabbitmq-restart-handling" class="table-of-contents__link toc-highlight">Handling Node Restarts in Applications</a></li><li><a href="#windows-upgrade-caveats" class="table-of-contents__link toc-highlight">Windows</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
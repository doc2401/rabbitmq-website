<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-4.0 docs-doc-page docs-doc-id-mqtt" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">MQTT Plugin | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/mqtt"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="4.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-4.0"><meta data-rh="true" name="docsearch:version" content="4.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-4.0"><meta data-rh="true" property="og:title" content="MQTT Plugin | RabbitMQ"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/mqtt"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/mqtt" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/mqtt" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/docs/4.0">Docs</a><a class="navbar__item navbar__link" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs/4.0/mqtt">4.0</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next/mqtt">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/mqtt">4.1</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/rabbitmq-website/docs/4.0/mqtt">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13/mqtt">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs/4.0">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/release-information">Release Information</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/download">Install and Upgrade</a><button aria-label="Expand sidebar category &#x27;Install and Upgrade&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rabbitmq-website/docs/4.0/use-rabbitmq">How to Use RabbitMQ</a><button aria-label="Collapse sidebar category &#x27;How to Use RabbitMQ&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/publishers">Publishing Messages</a><button aria-label="Expand sidebar category &#x27;Publishing Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/exchanges">Exchanges</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/consumers">Consuming Messages</a><button aria-label="Expand sidebar category &#x27;Consuming Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/queues">Queues</a><button aria-label="Expand sidebar category &#x27;Queues&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/streams">Streams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/channels">Channels</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/reliability">Reliability and Data Safety</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/confirms">Consumer Acknowledgements and Publisher Confirms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/distributed">Network Distribution</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rabbitmq-website/docs/4.0/plugins">Plugins</a><button aria-label="Collapse sidebar category &#x27;Plugins&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/management">Management Plugin</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/federation">Federation Plugin</a><button aria-label="Expand sidebar category &#x27;Federation Plugin&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/shovel">Shovel Plugin</a><button aria-label="Expand sidebar category &#x27;Shovel Plugin&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/stomp">STOMP Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/web-stomp">Web STOMP Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rabbitmq-website/docs/4.0/mqtt">MQTT Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/web-mqtt">Web MQTT Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/stream">Stream Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/installing-plugins">Installing 3rd-party Plugins</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/protocols">Protocols</a><button aria-label="Expand sidebar category &#x27;Protocols&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/client-libraries">Client Libraries</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/manage-rabbitmq">How to Manage RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Manage RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/monitoring">How to Monitor RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Monitor RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->RabbitMQ<!-- --> <b>4.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/rabbitmq-website/docs/mqtt">latest version</a></b> (<!-- -->4.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rabbitmq-website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/4.0/use-rabbitmq"><span itemprop="name">How to Use RabbitMQ</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/4.0/plugins"><span itemprop="name">Plugins</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">MQTT Plugin</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 4.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>MQTT Plugin</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>RabbitMQ supports MQTT versions
<a href="https://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html" target="_blank" rel="noopener noreferrer">3.1</a>,
<a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener noreferrer">3.1.1</a>, and
<a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html" target="_blank" rel="noopener noreferrer">5.0</a>
via a plugin that ships in the core distribution.</p>
<p>This guide covers the following topics:</p>
<ul>
<li><a href="#enabling-plugin">How to enable the plugin</a></li>
<li><a href="#features">Supported MQTT features</a> and <a href="#limitations">limitations</a></li>
<li><a href="#implementation">MQTT plugin implementation overview</a></li>
<li>When (not) to use <a href="#quorum-queues">quorum queues</a></li>
<li><a href="#qos0-queue-type">MQTT QoS 0 queue type</a></li>
<li><a href="#authentication">Users and authentication</a> and <a href="#local-vs-remote">remote connections</a></li>
<li><a href="#config">Key configurable settings</a> of the plugin</li>
<li><a href="#tls">TLS support</a></li>
<li><a href="#virtual-hosts">Virtual hosts</a></li>
<li><a href="#metrics">Metrics</a></li>
<li><a href="#scalability">Performance and scalability check list</a></li>
<li><a href="#proxy-protocol">Proxy protocol</a></li>
<li><a href="#sparkplug-support">Sparkplug support</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-plugin">Enabling the Plugin<a href="#enabling-plugin" class="hash-link" aria-label="Direct link to Enabling the Plugin" title="Direct link to Enabling the Plugin">​</a></h2>
<p>The MQTT plugin is included in the RabbitMQ distribution. Before clients can successfully
connect, it must be enabled on all cluster nodes using <a href="/rabbitmq-website/docs/4.0/man/rabbitmq-plugins.8">rabbitmq-plugins</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_mqtt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="features">Supported MQTT features<a href="#features" class="hash-link" aria-label="Direct link to Supported MQTT features" title="Direct link to Supported MQTT features">​</a></h2>
<p>RabbitMQ supports most MQTT 5.0 features including the following:</p>
<ul>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901235" target="_blank" rel="noopener noreferrer">QoS 0 (at most once)</a> and <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901236" target="_blank" rel="noopener noreferrer">QoS 1 (at least once)</a> publish &amp; subscribe</li>
<li>TLS, OAuth 2.0</li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901039" target="_blank" rel="noopener noreferrer">Clean</a> and non-clean sessions</li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901112" target="_blank" rel="noopener noreferrer">Message Expiry Interval</a></li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901166" target="_blank" rel="noopener noreferrer">Subscription Identifier</a> and <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901169" target="_blank" rel="noopener noreferrer">Subscription Options</a></li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901040" target="_blank" rel="noopener noreferrer">Will messages</a> including <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901062" target="_blank" rel="noopener noreferrer">Will Delay Interval</a></li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901253" target="_blank" rel="noopener noreferrer">Request / Response</a> including interoperability with other protocols such as AMQP 0.9.1 and AMQP 1.0</li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901113" target="_blank" rel="noopener noreferrer">Topic Alias</a></li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901104" target="_blank" rel="noopener noreferrer">Retained</a> messages with the limitations described in section <a href="#retained">Retained Messages and Stores</a></li>
<li><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901285" target="_blank" rel="noopener noreferrer">MQTT over a WebSocket</a> via the <a href="/rabbitmq-website/docs/4.0/web-mqtt">RabbitMQ Web MQTT Plugin</a></li>
</ul>
<p>The <a href="/rabbitmq-website/blog/2023/07/21/mqtt5">MQTT 5.0 blog post</a> provides a complete list of supported MQTT 5.0 features including their usage and implementation details.</p>
<p>MQTT clients can interoperate with other protocols.
For example, MQTT publishers can send messages to AMQP 0.9.1 or AMQP 1.0 consumers if these consumers consume from a queue
that is bound to the MQTT <a href="/rabbitmq-website/tutorials/amqp-concepts#exchange-topic">topic exchange</a> (configured via <code>mqtt.exchange</code> and defaulting to <code>amq.topic</code>).
Likewise an AMQP 0.9.1, AMQP 1.0, or STOMP publisher can send messages to an MQTT subscriber if the publisher publishes to the MQTT topic exchange.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">How the MQTT plugin works<a href="#implementation" class="hash-link" aria-label="Direct link to How the MQTT plugin works" title="Direct link to How the MQTT plugin works">​</a></h2>
<p>RabbitMQ MQTT plugin targets MQTT 3.1, 3.1.1, and 5.0 supporting a broad range
of MQTT clients. It also makes it possible for MQTT clients to interoperate
with <a href="/rabbitmq-website/docs/4.0/protocols">AMQP 0-9-1, AMQP 1.0, and STOMP</a> clients.
There is also support for multi-tenancy.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mapping-mqtt-to-the-amqp-091-model">Mapping MQTT to the AMQP 0.9.1 model<a href="#mapping-mqtt-to-the-amqp-091-model" class="hash-link" aria-label="Direct link to Mapping MQTT to the AMQP 0.9.1 model" title="Direct link to Mapping MQTT to the AMQP 0.9.1 model">​</a></h3>
<p>RabbitMQ core implements the AMQP 0.9.1 protocol.
The plugin builds on top of the AMQP 0.9.1 entities: <a href="/rabbitmq-website/tutorials/amqp-concepts#exchanges">exchanges</a>, <a href="/rabbitmq-website/docs/4.0/queues">queues</a>, and bindings.
Messages published to MQTT topics are routed by an AMQP 0.9.1 topic exchange.
MQTT subscribers consume from queues bound to the topic exchange.</p>
<p>The MQTT plugin creates a dedicated queue per MQTT subscriber. To be more precise, there could be 0, 1, or 2 queues per MQTT session:</p>
<ul>
<li>There are 0 queues for an MQTT session if the MQTT client never sends a <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901161" target="_blank" rel="noopener noreferrer">SUBSCRIBE</a> packet. The MQTT client is only publishing messages.</li>
<li>There is 1 queue for an MQTT session if the MQTT client creates one or multiple subscriptions with the same QoS level.</li>
<li>There are 2 queues for an MQTT session if the MQTT client creates subscriptions with both QoS levels: QoS 0 and QoS 1.</li>
</ul>
<p>When listing queues you will observe the queue naming pattern <code>mqtt-subscription-&lt;MQTT client ID&gt;qos[0|1]</code> where <code>&lt;MQTT client ID&gt;</code> is the MQTT <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901059" target="_blank" rel="noopener noreferrer">client identifier</a> and <code>[0|1]</code> is either <code>0</code> for a QoS 0 subscription or <code>1</code> for a QoS 1 subscription.
Having a separate queue per MQTT subscriber allows every MQTT subscriber to receive its own copy of the application message.</p>
<p>The plugin creates queues transparently for MQTT subscribing clients.
The MQTT specification does not define the concept of queues and MQTT clients are not aware that these queues exist.
A queue is an implementation detail of how RabbitMQ implements the MQTT protocol.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue-types">Queue Types<a href="#queue-types" class="hash-link" aria-label="Direct link to Queue Types" title="Direct link to Queue Types">​</a></h3>
<p>An MQTT client can publish a message to any queue type.
For that to work, a <a href="/rabbitmq-website/docs/4.0/classic-queues">classic queue</a>, <a href="/rabbitmq-website/docs/4.0/quorum-queues">quorum queue</a>, or <a href="/rabbitmq-website/docs/4.0/streams">stream</a> must be bound to the topic exchange with a binding key matching the topic of the <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901100" target="_blank" rel="noopener noreferrer">PUBLISH</a> packet.</p>
<p>The MQTT plugin creates a classic queue, quorum queue, or <a href="#qos0-queue-type">MQTT QoS 0 queue</a> per MQTT subscriber.
By default, the plugin creates a classic queue.</p>
<p>The plugin can be configured to create quorum queues (instead of classic queues) for subscribers whose MQTT session lasts longer than their MQTT network connection.
This is explained in section <a href="#quorum-queues">Quorum Queues</a>.</p>
<p>If <a href="/rabbitmq-website/docs/4.0/feature-flags">feature flag</a> <code>rabbit_mqtt_qos0_queue</code> is enabled, the plugin creates an MQTT QoS 0 queue for QoS 0 subscribers whose MQTT session last as long as their MQTT network connection.
This is explained in section <a href="#qos0-queue-type">MQTT QoS 0 queue type</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue-properties-and-arguments"><a href="/rabbitmq-website/docs/4.0/queues#properties">Queue Properties</a> and <a href="/rabbitmq-website/docs/4.0/queues#optional-arguments">Arguments</a><a href="#queue-properties-and-arguments" class="hash-link" aria-label="Direct link to queue-properties-and-arguments" title="Direct link to queue-properties-and-arguments">​</a></h3>
<p>Since RabbitMQ 3.12 all queues created by the MQTT plugin</p>
<ul>
<li>are <a href="/rabbitmq-website/docs/4.0/queues#durability">durable</a>, i.e. queue metadata is stored on disk.</li>
<li>are <a href="/rabbitmq-website/docs/4.0/queues#exclusive-queues">exclusive</a> if the MQTT session lasts as long as the MQTT network connection.
In that case, RabbitMQ will delete all state for the MQTT client - including its queue - when the network connection (and session) ends.
Only the subscribing MQTT client can consume from its queue.</li>
<li>are not <code>auto-delete</code>. For example, if an MQTT client subscribes to a topic and subsequently unsubscribes, the queue will not be deleted.
However, the queue will be deleted when the MQTT session ends.</li>
<li>have a <a href="/rabbitmq-website/docs/4.0/ttl#queue-ttl">Queue TTL</a> set (queue argument <code>x-expires</code>) if the MQTT session expires eventually (i.e. session expiry is not disabled by the RabbitMQ operator, see below) and outlasts the MQTT network connection.
The Queue TTL (in milliseconds) is determined by the minimum of the <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901048" target="_blank" rel="noopener noreferrer">Session Expiry Interval</a> (in seconds) requested by the MQTT client in the <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901033" target="_blank" rel="noopener noreferrer">CONNECT</a> packet and the server side configured <code>mqtt.max_session_expiry_interval_seconds</code>.</li>
</ul>
<p>The default value for <code>mqtt.max_session_expiry_interval_seconds</code> is 86400 (1 day).
A RabbitMQ operator can force all MQTT sessions to end as soon as their network connections end by setting this parameter to <code>0</code>.</p>
<p>A RabbitMQ operator can allow MQTT sessions to last forever by setting this parameter to <code>infinity</code>.
This carries a risk: short-lived clients that don&#x27;t use clean sessions can leave queues and messages behind, which will consume resources and require manual cleanup.</p>
<p>RabbitMQ deletes any state for the MQTT client when the MQTT session ends.
This state includes the client&#x27;s queue(s) including QoS 0 and QoS 1 messages and the queue bindings (i.e. the client&#x27;s subscriptions).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="topic-level-separator-and-wildcards">Topic level separator and wildcards<a href="#topic-level-separator-and-wildcards" class="hash-link" aria-label="Direct link to Topic level separator and wildcards" title="Direct link to Topic level separator and wildcards">​</a></h3>
<p>The MQTT protocol specification defines slash (&quot;/&quot;) as <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901243" target="_blank" rel="noopener noreferrer">topic level separator</a> whereas
AMQP 0-9-1 defines a dot (&quot;.&quot;) as topic level separator. This plugin translates patterns under the hood
to bridge the two.</p>
<p>For example, MQTT topic <code>cities/london</code> becomes AMQP 0.9.1 topic <code>cities.london</code> and vice versa.
Therefore, when an MQTT client publishes a message with topic <code>cities/london</code>, if an AMQP 0.9.1 client wants to receive that message, it should create a binding from its queue
to the topic exchange with binding key <code>cities.london</code>.</p>
<p>Vice versa, when an AMQP 0.9.1 client publishes a message with topic <code>cities.london</code>, if an MQTT client wants to receive that message, it should create an MQTT subscription with topic filter <code>cities/london</code>.</p>
<p>This has one important limitation: MQTT topics that have dots in them won&#x27;t work as expected and are to be avoided, the same goes for AMQP 0-9-1 routing and binding keys that contains slashes.</p>
<p>Furthermore, MQTT defines the plus sign (&quot;+&quot;) as <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901245" target="_blank" rel="noopener noreferrer">single-level wildcard</a> whereas AMQP 0.9.1
defines the asterisk sign (&quot;*&quot;) to match a single word:</p>
<table><thead><tr><th>MQTT</th><th>AMQP 0.9.1</th><th>Description</th></tr></thead><tbody><tr><td>/ (slash)</td><td>. (dot)</td><td>topic level separator</td></tr><tr><td>+ (plus)</td><td>* (asterisk)</td><td>single-level wildcard (match a single word)</td></tr><tr><td># (hash)</td><td># (hash)</td><td>multi-level wildcard (match zero or more words)</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quorum-queues">Using Quorum Queues<a href="#quorum-queues" class="hash-link" aria-label="Direct link to Using Quorum Queues" title="Direct link to Using Quorum Queues">​</a></h2>
<p>Using the <code>mqtt.durable_queue_type</code> option, it is possible to opt in to use <a href="/rabbitmq-website/docs/4.0/quorum-queues">quorum queues</a> for subscribers whose MQTT session lasts longer than their MQTT network connection.</p>
<p><strong>This value must only be enabled for new clusters</strong> before any clients declare durable subscriptions.
Since a queue type cannot be changed after declaration, if the value of this setting is changed for an existing cluster, clients with an existing durable state would run into a queue type mismatch error and <strong>fail to subscribe</strong>.</p>
<p>Below is a <a href="/rabbitmq-website/docs/4.0/configure#config-file">rabbitmq.conf</a> example that opts in to use quorum queues:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># must ONLY be enabled for new clusters before any clients declare durable subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.durable_queue_type = quorum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Currently, this setting applies to <strong>all</strong> MQTT clients that:</p>
<ol>
<li>subscribe with QoS 1, and</li>
<li>connected with a <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901048" target="_blank" rel="noopener noreferrer">Session Expiry Interval</a> greater than 0 (MQTT 5.0) or set CleanSession to 0 (MQTT 3.1.1)</li>
</ol>
<p>The second condition means that the MQTT session outlasts the MQTT network connection.</p>
<p>While quorum queues are designed for data safety and predictable efficient recovery
from replica failures, they also have downsides. A quorum queue by definition requires
at least three replicas in the cluster. Therefore quorum queues take longer to declare
and delete, and are not a good fit for environments with <a href="/rabbitmq-website/docs/4.0/networking#dealing-with-high-connection-churn">high client connection churn</a> or
environments with many (hundreds of thousands) subscribers.</p>
<p>Quorum queues are a great fit for a few (hundreds) longer lived clients that actually care a great deal about data safety.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="qos0-queue-type">MQTT QoS 0 queue type<a href="#qos0-queue-type" class="hash-link" aria-label="Direct link to MQTT QoS 0 queue type" title="Direct link to MQTT QoS 0 queue type">​</a></h2>
<p>The MQTT plugin creates an MQTT QoS 0 queue if the following three conditions are met:</p>
<ol>
<li><a href="/rabbitmq-website/docs/4.0/feature-flags">Feature flag</a> <code>rabbit_mqtt_qos0_queue</code> is enabled.</li>
<li>The MQTT client subscribes with QoS 0.</li>
<li>The MQTT 5.0 client connects with a <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901048" target="_blank" rel="noopener noreferrer">Session Expiry Interval</a> of 0, or the MQTT 3.1.1 client connects with CleanSession set to 1.</li>
</ol>
<p>The third condition means that the MQTT session lasts only as long as the network connection.</p>
<p>The MQTT QoS 0 queue type can be thought of as a “pseudo” or “virtual” queue:
It is very different from the other queue types (classic queues, quorum queues, and streams) in the sense that this new queue type is neither a separate Erlang process nor does it store messages on disk.
Instead, this queue type is a subset of the Erlang process mailbox.
MQTT messages are directly sent to the MQTT connection process of the subscribing client.
In other words, MQTT messages are sent to any “online” MQTT subscribers.</p>
<p>It is more accurate to think of the queue being &quot;skipped&quot;.
The fact that sending messages directly to the MQTT connection process is implemented as a queue type is to simplify routing of messages and protocol interoperability,
such that messages can not only be sent from the MQTT publishing connection process, but also from an AMQP 0.9.1 <a href="/rabbitmq-website/docs/4.0/channels">channel</a> process.
The latter enables sending messages from an AMQP 0.9.1, AMQP 1.0 or STOMP client directly to the MQTT subscriber connection process skipping a dedicated queue process.</p>
<p>The benefits of using the MQTT QoS 0 queues type are:</p>
<ol>
<li>Support for larger fanouts, e.g. sending a message from the &quot;cloud&quot; (RabbitMQ) to all devices (MQTT clients).</li>
<li>Lower <a href="/rabbitmq-website/docs/4.0/memory-use">memory usage</a></li>
<li>Lower publisher confirm latency</li>
<li>Lower end-to-end latency</li>
</ol>
<p>Because the MQTT QoS 0 queue type has no flow control, MQTT messages might arrive faster in the MQTT connection process mailbox than being delivered from the MQTT connection process to the MQTT subscribing client.
This can happen when the network connection between MQTT subscribing client and RabbitMQ is poor or in a large fan-in scenario where many publishers overload a single MQTT subscribing client.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overload-protection">Overload protection<a href="#overload-protection" class="hash-link" aria-label="Direct link to Overload protection" title="Direct link to Overload protection">​</a></h3>
<p>To protect against high <a href="/rabbitmq-website/docs/4.0/memory-use">memory usage</a> due to MQTT QoS 0 messages piling up in the MQTT connection process mailbox, RabbitMQ intentionally drops QoS 0 messages from the MQTT QoS 0 queue if both conditions are true:</p>
<ol>
<li>the number of messages in the MQTT connection process mailbox exceeds the configured <code>mqtt.mailbox_soft_limit</code> (defaults to 200), and</li>
<li>the socket sending to the MQTT client is busy (not sending fast enough due to TCP backpressure).</li>
</ol>
<p>Note that there can be other messages in the process mailbox (e.g. applications messages sent from the MQTT subscribing client to RabbitMQ or confirmations from another queue type to the MQTT connection process) which are obviously not dropped.
However, these other messages also contribute to the <code>mqtt.mailbox_soft_limit</code>.</p>
<p>Setting <code>mqtt.mailbox_soft_limit</code> to 0 disables the overload protection mechanism meaning QoS 0 messages are never dropped intentionally by RabbitMQ.
Setting <code>mqtt.mailbox_soft_limit</code> to a very high value decreases the likelihood of intentionally dropping QoS 0 messages while increasing the risk of causing a cluster wide memory alarm
(especially if the message payloads are large or if there are many overloaded queues of type <code>rabbit_mqtt_qos0_queue</code>).</p>
<p>The <code>mqtt.mailbox_soft_limit</code> can be thought of a <a href="/rabbitmq-website/docs/4.0/maxlength">queue length limit</a> (although not precisely because, as mentioned previously, the Erlang process mailbox can contain other messages than MQTT application messages).
This is why the configuration key <code>mqtt.mailbox_soft_limit</code> contains the word <code>soft</code>.
The described overload protection mechanism corresponds roughly to <a href="/rabbitmq-website/docs/4.0/maxlength#overflow-behaviour">overflow behaviour</a> <code>drop-head</code> that exists in classic queues and quorum queues.</p>
<p>The following Prometheus metric reported by a given RabbitMQ node shows how many QoS 0 messages were dropped in total across all queues of type <code>rabbit_mqtt_qos0_queue</code> during the lifetime of that node:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq_global_messages_dead_lettered_maxlen_total</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">queue_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;rabbit_mqtt_qos0_queue&quot;</span><span class="token plain">,dead_letter_strategy</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disabled&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <a href="/rabbitmq-website/blog/2023/03/21/native-mqtt#new-mqtt-qos-0-queue-type">Native MQTT</a> blog post describes the MQTT QoS 0 queue type in more detail.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authentication">Users and Authentication<a href="#authentication" class="hash-link" aria-label="Direct link to Users and Authentication" title="Direct link to Users and Authentication">​</a></h2>
<p>MQTT clients will be able to connect provided that they have a set of credentials for an existing user with the appropriate permissions.</p>
<p>For an MQTT connection to succeed, it must successfully authenticate and the user must
have the <a href="/rabbitmq-website/docs/4.0/access-control">appropriate permissions</a> to the virtual host used by the
plugin (see below).</p>
<p>MQTT clients can (and usually do) specify a set of credentials when they connect. The credentials
can be a username and password pair, or a x.509 certificate (see below).</p>
<p>The plugin supports anonymous authentication but its use is highly discouraged and it is a subject
to certain limitations (listed below) enforced for a reasonable level of security
by default.</p>
<p>Users and their permissions can be managed using <a href="/rabbitmq-website/docs/4.0/cli">rabbitmqctl</a>, <a href="/rabbitmq-website/docs/4.0/management">management UI</a>
or <a href="/rabbitmq-website/docs/4.0/management#http-api">HTTP API</a>.</p>
<p>For example, the following commands create a new user for MQTT connections with full access
to the default <a href="/rabbitmq-website/docs/4.0/vhosts">virtual host</a> used by this plugin:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># username and password are both &quot;mqtt-test&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl add_user mqtt-test mqtt-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_permissions </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token plain"> mqtt-test </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_user_tags mqtt-test management</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that colons may not appear in usernames.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="local-vs-remote">Local vs. Remote Client Connections<a href="#local-vs-remote" class="hash-link" aria-label="Direct link to Local vs. Remote Client Connections" title="Direct link to Local vs. Remote Client Connections">​</a></h3>
<p>When an MQTT client provides no login credentials, the plugin uses the
<code>guest</code> account by default which will not allow non-<code>localhost</code>
connections. When connecting from a remote host, here are the options
that make sure remote clients can successfully connect:</p>
<ul>
<li>Create one or more new user(s), grant them full permissions to the virtual host used by the MQTT plugin and make clients
that connect from remote hosts use those credentials. This is the recommended option.</li>
<li>Set <code>anonymous_login_user</code> and <code>anonymous_login_pass</code> to a non-<code>guest</code> user who has the
<a href="/rabbitmq-website/docs/4.0/access-control">appropriate permissions</a>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="anonymous-connections">Anonymous Connections<a href="#anonymous-connections" class="hash-link" aria-label="Direct link to Anonymous Connections" title="Direct link to Anonymous Connections">​</a></h3>
<p>MQTT supports optional authentication (clients may provide no credentials).
Therefore a default set of credentials is used for anonymous connections.</p>
<p>The <code>anonymous_login_user</code> and <code>anonymous_login_pass</code> configuration keys are used to specify
the credentials:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">anonymous_login_user = some-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anonymous_login_pass = s3kRe7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is possible to disable anonymous connections:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.allow_anonymous = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anonymous_login_user = none</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the <code>mqtt.allow_anonymous</code> key is set to <code>false</code> then clients <strong>must</strong> provide credentials.</p>
<p>The use of anonymous connections is highly discouraged and it is a subject
to certain limitations (see above) enforced for a reasonable level of security
by default.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="config">Plugin Configuration<a href="#config" class="hash-link" aria-label="Direct link to Plugin Configuration" title="Direct link to Plugin Configuration">​</a></h2>
<p>Here is a sample <a href="/rabbitmq-website/docs/4.0/configure#config-file">configuration</a> that demonstrates a number of MQTT plugin settings:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.default = 1883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Default MQTT with TLS port is 8883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># mqtt.listeners.ssl.default = 8883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># anonymous connections, if allowed, will use the default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># credentials specified here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.allow_anonymous  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.vhost            = /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.exchange         = amq.topic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.prefetch         = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 24 hours by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.max_session_expiry_interval_seconds = 86400</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcp-listeners">TCP Listeners<a href="#tcp-listeners" class="hash-link" aria-label="Direct link to TCP Listeners" title="Direct link to TCP Listeners">​</a></h3>
<p>When no configuration is specified the MQTT plugin will listen on
all interfaces on port 1883 and have a default user login/passcode
of <code>guest</code>/<code>guest</code>.</p>
<p>To change the listener port, edit your
<a href="/rabbitmq-website/docs/4.0/configure#configuration-files">Configuration file</a>,
to contain a <code>tcp_listeners</code> variable for the <code>rabbitmq_mqtt</code> application.</p>
<p>For example, a minimalistic configuration file which changes the listener
port to 12345 would look like:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.1 = 12345</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>while one which changes the listener to listen only on localhost (for
both IPv4 and IPv6) would look like:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.1 = 127.0.0.1:1883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.2 = ::1:1883</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="listener-opts">TCP Listener Options<a href="#listener-opts" class="hash-link" aria-label="Direct link to TCP Listener Options" title="Direct link to TCP Listener Options">​</a></h3>
<p>The plugin supports TCP listener option configuration.</p>
<p>The settings use a common prefix, <code>mqtt.tcp_listen_options</code>, and control
things such as TCP buffer sizes, inbound TCP connection queue length, whether <a href="/rabbitmq-website/docs/4.0/heartbeats#tcp-keepalives">TCP keepalives</a>
are enabled and so on. See the <a href="/rabbitmq-website/docs/4.0/networking">Networking guide</a> for details.</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.1 = 127.0.0.1:1883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.2 = ::1:1883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.backlog = 4096</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.buffer  = 131072</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.recbuf  = 131072</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.sndbuf  = 131072</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.keepalive = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.nodelay   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.exit_on_close = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.tcp_listen_options.send_timeout  = 120</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tls">TLS Support<a href="#tls" class="hash-link" aria-label="Direct link to TLS Support" title="Direct link to TLS Support">​</a></h3>
<p>To use TLS for MQTT connections, <a href="/rabbitmq-website/docs/4.0/ssl">TLS must be configured</a> in the broker. To enable
TLS-enabled MQTT connections, add a TLS listener for MQTT using the <code>mqtt.listeners.ssl.*</code> configuration keys.</p>
<p>The plugin will use core RabbitMQ server
certificates and key (just like AMQP 0-9-1 and AMQP 1.0 listeners do):</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssl_options.cacertfile = /path/to/ca_certificate.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssl_options.certfile   = /path/to/server_certificate.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssl_options.keyfile    = /path/to/server_key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssl_options.verify     = verify_peer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssl_options.fail_if_no_peer_cert  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default TLS-enabled port for MQTT connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.ssl.default = 8883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.default = 1883</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that RabbitMQ rejects SSLv3 connections by default because that protocol
is known to be compromised.</p>
<p>See the <a href="/rabbitmq-website/docs/4.0/ssl">TLS configuration guide</a> for details.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-hosts">Virtual Hosts<a href="#virtual-hosts" class="hash-link" aria-label="Direct link to Virtual Hosts" title="Direct link to Virtual Hosts">​</a></h3>
<p>RabbitMQ is a multi-tenant system at the core and every connection belongs
to a virtual host. Some messaging protocols have the concept of vhosts,
others don&#x27;t. MQTT falls into the latter category. Therefore the MQTT plugin
needs to provide a way to map connections to vhosts.</p>
<p>The <code>vhost</code> option controls which RabbitMQ vhost the adapter connects to
by default. The <code>vhost</code>
configuration is only consulted if no vhost is provided during connection establishment.
There are several (optional) ways to specify the vhost the client will
connect to.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="port-to-virtual-host-mapping">Port to Virtual Host Mapping<a href="#port-to-virtual-host-mapping" class="hash-link" aria-label="Direct link to Port to Virtual Host Mapping" title="Direct link to Port to Virtual Host Mapping">​</a></h4>
<p>First way is mapping MQTT plugin (TCP or TLS) listener ports to vhosts. The mapping
is specified thanks to the <code>mqtt_port_to_vhost_mapping</code> <a href="/rabbitmq-website/docs/4.0/parameters">global runtime parameter</a>.
Let&#x27;s take the following plugin configuration:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.1 = 1883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.2 = 1884</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.ssl.1 = 8883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.ssl.2 = 8884</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># (other TLS settings are omitted for brevity)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.vhost            = /</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note the plugin listens on ports 1883, 1884, 8883, and 8884. Imagine you
want clients connecting to ports 1883 and 8883 to connect to the <code>vhost1</code> virtual
host, and clients connecting to ports 1884 and 8884 to connect to the <code>vhost2</code>
virtual host. A port-to-vhost mapping can be created by setting the
<code>mqtt_port_to_vhost_mapping</code> global parameter with <code>rabbitmqctl</code>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">HTTP API</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_global_parameter mqtt_port_to_vhost_mapping </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;{&quot;1883&quot;:&quot;vhost1&quot;, &quot;8883&quot;:&quot;vhost1&quot;, &quot;1884&quot;:&quot;vhost2&quot;, &quot;8884&quot;:&quot;vhost2&quot;}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bat set_global_parameter mqtt_port_to_vhost_mapping ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;{&quot;</span><span class="token string" style="color:#e3116c">&quot;1883&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;vhost1&quot;</span><span class="token string" style="color:#e3116c">&quot;, &quot;</span><span class="token string" style="color:#e3116c">&quot;8883&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;vhost1&quot;</span><span class="token string" style="color:#e3116c">&quot;, &quot;</span><span class="token string" style="color:#e3116c">&quot;1884&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;vhost2&quot;</span><span class="token string" style="color:#e3116c">&quot;, &quot;</span><span class="token string" style="color:#e3116c">&quot;8884&quot;</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token string" style="color:#e3116c">&quot;vhost2&quot;</span><span class="token string" style="color:#e3116c">&quot;}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT /api/global-parameters/mqtt_port_to_vhost_mapping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># =&gt; {&quot;value&quot;: {&quot;1883&quot;:&quot;vhost1&quot;, &quot;8883&quot;:&quot;vhost1&quot;, &quot;1884&quot;:&quot;vhost2&quot;, &quot;8884&quot;:&quot;vhost2&quot;}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>If there&#x27;s no mapping for a given port (because the port cannot be found in
the <code>mqtt_port_to_vhost_mapping</code> global parameter JSON document or if the global parameter
isn&#x27;t set at all), the plugin will try to extract the virtual host from the username
(see below) and will ultimately use the <code>vhost</code> plugin config option.</p>
<p>The broker queries the <code>mqtt_port_to_vhost_mapping</code> global parameter value at connection time.
If the value changes, connected clients are not notified or disconnected. They need
to reconnect to switch to a new virtual host.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-host-as-part-of-username">Virtual Host as Part of Username<a href="#virtual-host-as-part-of-username" class="hash-link" aria-label="Direct link to Virtual Host as Part of Username" title="Direct link to Virtual Host as Part of Username">​</a></h4>
<p>Another and more specific way to specify a vhost while connecting is to prepend the vhost
to the username and to separate with a colon.</p>
<p>For example, connecting with</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/:guest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>is equivalent to the default vhost and username, while</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt-vhost:mqtt-username</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>means connecting to the vhost <code>mqtt-host</code> with username <code>mqtt-username</code>.</p>
<p>Specifying the virtual host in the username takes precedence over the port-to-vhost
mapping specified with the <code>mqtt_port_to_vhost_mapping</code> global parameter.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tls-certificate-authentication">Authentication with TLS/x509 client certificates<a href="#tls-certificate-authentication" class="hash-link" aria-label="Direct link to Authentication with TLS/x509 client certificates" title="Direct link to Authentication with TLS/x509 client certificates">​</a></h3>
<p>The plugin can authenticate TLS-enabled connections by extracting
a name from the client&#x27;s TLS (x509) certificate, without using a password.</p>
<p>For safety the server must be <a href="#tls">configured with the TLS options</a>
<code>fail_if_no_peer_cert</code> set to <code>true</code> and <code>verify</code> set to <code>verify_peer</code>, to
force all TLS clients to have a verifiable client certificate.</p>
<p>To switch this feature on, set <code>ssl_cert_login</code> to <code>true</code> for the
<code>rabbitmq_mqtt</code> application. For example:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.ssl_cert_login = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By default this will set the username to an RFC4514-ish string form of
the certificate&#x27;s subject&#x27;s Distinguished Name, similar to that
produced by OpenSSL&#x27;s &quot;-nameopt RFC2253&quot; option.</p>
<p>To use the Common Name instead, add:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssl_cert_login_from = common_name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>to your configuration.</p>
<p>Note that:</p>
<ul>
<li>The authenticated user must exist in the configured authentication / authorisation backend(s).</li>
<li>Clients <strong>must not</strong> supply username and password.</li>
</ul>
<p>You can optionally specify a virtual host for a client certificate by using the <code>mqtt_default_vhosts</code>
<a href="/rabbitmq-website/docs/4.0/parameters">global runtime parameter</a>. The value of this global parameter must contain a JSON document that
maps certificates&#x27; subject&#x27;s Distinguished Name to their target virtual host. Let&#x27;s see how to
map 2 certificates, <code>O=client,CN=guest</code> and <code>O=client,CN=rabbit</code>, to the <code>vhost1</code> and <code>vhost2</code>
virtual hosts, respectively.</p>
<p>Global parameters can be set up with using the following methods:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">bash</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PowerShell</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">HTTP API</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_global_parameter mqtt_default_vhosts </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;{&quot;O=client,CN=guest&quot;: &quot;vhost1&quot;, &quot;O=client,CN=rabbit&quot;: &quot;vhost2&quot;}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_global_parameter mqtt_default_vhosts ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;{&quot;</span><span class="token string" style="color:#e3116c">&quot;O=client,CN=guest&quot;</span><span class="token string" style="color:#e3116c">&quot;: &quot;</span><span class="token string" style="color:#e3116c">&quot;vhost1&quot;</span><span class="token string" style="color:#e3116c">&quot;, &quot;</span><span class="token string" style="color:#e3116c">&quot;O=client,CN=rabbit&quot;</span><span class="token string" style="color:#e3116c">&quot;: &quot;</span><span class="token string" style="color:#e3116c">&quot;vhost2&quot;</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT /api/global-parameters/mqtt_default_vhosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># =&gt; {&quot;value&quot;: {&quot;O=client,CN=guest&quot;: &quot;vhost1&quot;, &quot;O=client,CN=rabbit&quot;: &quot;vhost2&quot;}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>Note that:</p>
<ul>
<li>If the virtual host for a certificate cannot be found (because the certificate
subject&#x27;s DN cannot be found in the <code>mqtt_default_vhosts</code> global parameter JSON
document or if the global parameter isn&#x27;t set at all), the virtual host specified
by the <code>vhost</code> plugin config option will be used.</li>
<li>The broker queries the <code>mqtt_default_vhosts</code> global parameter value at connection time.
If the value changes, connected clients are not notified or disconnected. They need
to reconnect to switch to a new virtual host.</li>
<li>The certificate-to-vhost mapping with the <code>mqtt_default_vhosts</code> global parameter
is considered more specific than the port-to-vhost mapping with the <code>mqtt_port_to_vhost_mapping</code>
global parameter and so takes precedence over it.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="usage-of-client_id-extraction-from-client-certificates-for-authentication">Usage of client_id Extraction from Client Certificates for Authentication<a href="#usage-of-client_id-extraction-from-client-certificates-for-authentication" class="hash-link" aria-label="Direct link to Usage of client_id Extraction from Client Certificates for Authentication" title="Direct link to Usage of client_id Extraction from Client Certificates for Authentication">​</a></h4>
<p>Nodes can be configured to verify that the <code>client_id</code> set on the MQTT connection matches the <code>client_id</code> found in the client&#x27;s certificate.</p>
<p>If they match, RabbitMQ proceeds with the user&#x27;s authentication by passing the user&#x27;s identity along with the <code>client_id</code> to the configured authentication backend(s).
Some authentication backends, like the <code>rabbitmq_auth_backend_http</code>, may use <code>client_id</code> credential in addition to <code>username</code> to make authentication and/or authorization decisions.
If the <code>client_id</code>(s) did not match, RabbitMQ closes the connection with the reason code <code>2</code>, meaning, &quot;the client identifier is not allowed by the server&quot;.</p>
<p>In order to do so, RabbitMQ must first be instructed how to fetch the <code>client_id</code> from the certificate. This is done with the <code>mqtt.ssl_cert_client_id_from</code> configuration key.
The acceptable values are:</p>
<ul>
<li><code>distinguished_name</code>: this is the DN, or <a href="https://en.wikipedia.org/wiki/X.509" target="_blank" rel="noopener noreferrer">distinguished name</a>, of the certificate</li>
<li><code>subject_alternative_name</code>: the Subject Alternative Name or SAN, which comes from a certificate&#x27;s extensions section
Because different ypes of Subject Alternative Names exist, the type may need to be specified as well</li>
</ul>
<p>If <code>mqtt.ssl_cert_client_id_from</code> is set to <code>subject_alternative_name</code>, the type of alternative name can be configured using <code>mqtt.ssl_cert_login_san_type</code>. The default type, used if the setting
is omitted, is <code>dns</code>. The acceptable values are:</p>
<ul>
<li><code>dns</code></li>
<li><code>ip</code></li>
<li><code>email</code></li>
<li><code>uri</code></li>
<li><code>other_name</code></li>
</ul>
<p>A certificate can contain multiple SAN fields of the same type, for example, two alternative DNS names. If this is the case, use the <code>mqtt.ssl_cert_login_san_index</code> configuration key
to specify the index to be used. By default, RabbitMQ will pick the first value, that is, the default value of <code>mqtt.ssl_cert_login_san_index</code> is <code>0</code>.</p>
<p>Below an example where the username is extracted from the certificate&#x27;s distinguished name and the <code>client_id</code> is extracted from
the first SAN (Subject Alternative Name) of type <code>uri</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssl_cert_login_from = distinguished_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.ssl_cert_client_id_from = subject_alternative_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.ssl_cert_login_san_type = uri</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flow"><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901251" target="_blank" rel="noopener noreferrer">Flow Control</a><a href="#flow" class="hash-link" aria-label="Direct link to flow" title="Direct link to flow">​</a></h3>
<p>The <code>prefetch</code> option controls the maximum number of unacknowledged PUBLISH packets with QoS=1 that will be delivered.
This option is interpreted in the same way as <a href="/rabbitmq-website/docs/4.0/consumer-prefetch">consumer prefetch</a>.</p>
<p>An MQTT 5.0 client can define a lower number by setting <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901049" target="_blank" rel="noopener noreferrer">Receive Maximum</a> in the <code>CONNECT</code> packet.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="custom-exchanges">Custom Exchanges<a href="#custom-exchanges" class="hash-link" aria-label="Direct link to Custom Exchanges" title="Direct link to Custom Exchanges">​</a></h2>
<p>The <code>exchange</code> option determines which exchange messages from MQTT clients are published to.
The exchange must be created before clients publish any messages. The exchange is expected to be a <a href="/rabbitmq-website/tutorials/amqp-concepts#exchange-topic">topic exchange</a>.</p>
<p>The default topic exchange <code>amq.topic</code> is pre-declared: It therefore exists when RabbitMQ is started.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="retained">Retained Messages and Stores<a href="#retained" class="hash-link" aria-label="Direct link to Retained Messages and Stores" title="Direct link to Retained Messages and Stores">​</a></h2>
<p>The plugin supports retained messages with the limitations described in this section.
The message store implementation is pluggable and the plugin ships with two implementation out of the box:</p>
<ul>
<li><a href="https://www.erlang.org/doc/man/ets.html" target="_blank" rel="noopener noreferrer">ETS</a>-based (in memory), implemented in module <code>rabbit_mqtt_retained_msg_store_ets</code></li>
<li><a href="https://www.erlang.org/doc/man/dets.html" target="_blank" rel="noopener noreferrer">DETS</a>-based (on disk), implemented in module <code>rabbit_mqtt_retained_msg_store_dets</code></li>
</ul>
<p>Both implementations have limitations and trade-offs.
With the first one, the maximum number of messages that can be retained is limited by RAM.
With the second one, there is a limit of 2 GB per vhost. Both are <strong>node-local</strong>:
Retained messages are neither replicated to nor queried from remote cluster nodes.</p>
<p>An example that works is the following: An MQTT Client publishes a retained message to node A with topic <code>topic/1</code>.
Thereafter another client subscribes with topic filter <code>topic/1</code> on node A.
The new subscriber will receive the retained message.</p>
<p>However, if a client publishes a retained message on node A and another client subsequently subscribes on node B,
that subscribing client will not receive any retained message stored on node A.</p>
<p>Furthermore, if the topic filter contains wildcards (the <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901244" target="_blank" rel="noopener noreferrer">multi-level wildcard character</a> “#” or the <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901245" target="_blank" rel="noopener noreferrer">single-level wildcard character</a> “+”), no retained messages are sent.</p>
<p>To configure the store, use the <code>mqtt.retained_message_store</code> configuration key:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## use DETS (disk-based) store for retained messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.retained_message_store = rabbit_mqtt_retained_msg_store_dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## only used by DETS store (in milliseconds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.retained_message_store_dets_sync_interval = 2000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The value must be a module that implements the store:</p>
<ul>
<li><code>rabbit_mqtt_retained_msg_store_ets</code> for RAM-based</li>
<li><code>rabbit_mqtt_retained_msg_store_dets</code> for disk-based (This is the default value.)</li>
</ul>
<p>These implementations are suitable for development but sometimes won&#x27;t be for production needs.
The MQTT specification does not define consistency or replication requirements for retained
message stores, therefore RabbitMQ allows for custom ones to meet the consistency and
availability needs of a particular environment. For example, stores based on <a href="http://basho.com/riak/" target="_blank" rel="noopener noreferrer">Riak</a>
and <a href="http://cassandra.apache.org/" target="_blank" rel="noopener noreferrer">Cassandra</a> would be suitable for most production environments as
those data stores provide <a href="https://github.com/basho/basho_docs/blob/master/content/riak/kv/2.2.3/using/reference/strong-consistency.md" target="_blank" rel="noopener noreferrer">tunable consistency</a>.</p>
<p>Message stores must implement the <code>rabbit_mqtt_retained_msg_store</code> behaviour.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="metrics">Metrics<a href="#metrics" class="hash-link" aria-label="Direct link to Metrics" title="Direct link to Metrics">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus">Prometheus<a href="#prometheus" class="hash-link" aria-label="Direct link to Prometheus" title="Direct link to Prometheus">​</a></h3>
<p>This plugin emits the Prometheus metrics listed in <a href="https://github.com/rabbitmq/rabbitmq-server/blob/main/deps/rabbitmq_prometheus/metrics.md#global-counters" target="_blank" rel="noopener noreferrer">Global Counters</a>.</p>
<p>The values for Prometheus label <code>protocol</code> are <code>mqtt310</code>, <code>mqtt311</code>, and <code>mqtt50</code> depending on whether the MQTT client uses MQTT 3.1, MQTT 3.1.1, or MQTT 5.0.</p>
<p>The values for Prometheus label <code>queue_type</code> are <code>rabbit_classic_queue</code>, <code>rabbit_quorum_queue</code>, and <code>rabbit_mqtt_qos0_queue</code> depending on the queue type the MQTT client consumes from.
(Note that MQTT clients never consume from <a href="/rabbitmq-website/docs/4.0/streams">streams</a> directly although they can publish messages to streams.)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-management-api">RabbitMQ Management API<a href="#rabbitmq-management-api" class="hash-link" aria-label="Direct link to RabbitMQ Management API" title="Direct link to RabbitMQ Management API">​</a></h3>
<p>The Management API delivers metrics for MQTT Connections (e.g. network traffic from / to client) and for Classic Queues and Quorum Queues (e.g. how many messages they contain).
However, Management API metrics that are tied to AMQP 0.9.1 <a href="/rabbitmq-website/docs/4.0/channels">channels</a>, e.g message rates, are not available since 3.12.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scalability">Performance and Scalability Check List<a href="#scalability" class="hash-link" aria-label="Direct link to Performance and Scalability Check List" title="Direct link to Performance and Scalability Check List">​</a></h2>
<p>MQTT is the standard protocol for the Internet of Things (IoT).
A common IoT workload is that many MQTT devices publish sensor data periodically to the MQTT broker.
There could be hundreds of thousands, sometimes even millions of IoT devices that connect to the MQTT broker.
The blog post <a href="/rabbitmq-website/blog/2023/03/21/native-mqtt">Native MQTT</a> demonstrates performance benchmarks of such workloads.</p>
<p>This section aims at providing a non-exhaustive checklist with tips and tricks to configure RabbitMQ as an efficient MQTT broker that supports many client connections:</p>
<ol>
<li>Set <code>management_agent.disable_metrics_collector = true</code> to disable metrics collection in the <a href="/rabbitmq-website/docs/4.0/management">Management plugin</a>.
The RabbitMQ Management plugin has not been designed for excessive metrics collection.
In fact, metrics delivery via the management API is <a href="/rabbitmq-website/blog/2021/08/21/4.0-deprecation-announcements#disable-metrics-delivery-via-the-management-api--ui">deprecated</a>. Instead, use a tool that has been designed for collecting and querying a huge number of metrics: Prometheus.</li>
<li>MQTT packets and subscriptions with QoS 0 provide much better performance than QoS 1.
Unlike AMQP 0.9.1 and AMQP 1.0, MQTT is not designed to maximise throughput: For example, there are no <a href="/rabbitmq-website/docs/4.0/confirms#consumer-acks-multiple-parameter">multi-acks</a>.
Every <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901100" target="_blank" rel="noopener noreferrer">PUBLISH</a> packet with QoS 1 needs to be acknowledged individually.</li>
<li>Decrease TCP buffer sizes as described in section <a href="#listener-opts">TCP Listener Options</a>.</li>
</ol>
<p>This substantially reduces <a href="/rabbitmq-website/docs/4.0/memory-use">memory usage</a> in environments with many concurrently connected clients.</p>
<ol>
<li>Less topic levels (in an MQTT topic and MQTT topic filter) perform better than more topic levels.
For example, prefer to structure your topic as <code>city/name</code> instead of <code>continent/country/city/name</code>, if possible.
Each topic level in a topic filter currently creates its own entry in the database used by RabbitMQ.
Therefore, creating and deleting many subscriptions will be faster when there are fewer topic levels.
Also, routing messages with fewer topic levels is faster.</li>
<li>In workloads with high subscription churn, increase Mnesia configuration parameter <code>dump_log_write_threshold</code> (e.g. <code>RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=&quot;-mnesia dump_log_write_threshold 20000&quot;</code>)</li>
<li>When connecting many clients, increase the maximum number of Erlang processes (e.g. <code>RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=&quot;+P 10000000</code>)
and the maximum number of open ports (e.g. <code>ERL_MAX_PORTS=10000000</code>).</li>
</ol>
<p>Consult the <a href="/rabbitmq-website/docs/4.0/networking">Networking</a> and <a href="/rabbitmq-website/docs/4.0/configure">Configuration</a> guides for more information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="proxy-protocol">Proxy Protocol<a href="#proxy-protocol" class="hash-link" aria-label="Direct link to Proxy Protocol" title="Direct link to Proxy Protocol">​</a></h2>
<p>The MQTT plugin supports the <a href="http://www.haproxy.org/download/3.1/doc/proxy-protocol.txt" target="_blank" rel="noopener noreferrer">proxy protocol</a>.
This feature is disabled by default, to enable it for MQTT clients:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.proxy_protocol = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>See the <a href="/rabbitmq-website/docs/4.0/networking#proxy-protocol">Networking Guide</a> for more information
about the proxy protocol.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sparkplug-support">Sparkplug Support<a href="#sparkplug-support" class="hash-link" aria-label="Direct link to Sparkplug Support" title="Direct link to Sparkplug Support">​</a></h2>
<p><a href="https://www.cirrus-link.com/mqtt-sparkplug-tahu/" target="_blank" rel="noopener noreferrer">Sparkplug</a> is a specification
that provides guidance for the design of an MQTT system. In Sparkplug,
MQTT topics must start with <code>spAvM.N</code> or <code>spBvM.N</code>, where <code>M</code> and <code>N</code> are integers.
This unfortunately conflicts with the way the RabbitMQ MQTT plugin <a href="#implementation">translates MQTT
topics into AMQP 0.9.1 routing keys</a>.</p>
<p>To solve this, the <code>sparkplug</code> configuration entry can be set to <code>true</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.sparkplug = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the Sparkplug support is enabled, the MQTT plugin will not translate the
<code>spAvM.N</code>/<code>spBvM.N</code> part of the names of topics.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">​</a></h2>
<p>The RabbitMQ MQTT plugin has currently the following limitations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="qos-2">QoS 2<a href="#qos-2" class="hash-link" aria-label="Direct link to QoS 2" title="Direct link to QoS 2">​</a></h3>
<p><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901237" target="_blank" rel="noopener noreferrer">QoS 2: Exactly once delivery</a> is unsupported.</p>
<p>If an MQTT 3.0 or 3.1.1 client publishes a message with QoS 2, RabbitMQ will downgrade the QoS level to 1.
If an MQTT 5.0 client publishes a message with QoS 2, RabbitMQ will disconnect the client with reason code <code>155: QoS not supported</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="re-authentication">Re-authentication<a href="#re-authentication" class="hash-link" aria-label="Direct link to Re-authentication" title="Direct link to Re-authentication">​</a></h3>
<p>RabbitMQ does not support the MQTT 5.0 <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901217" target="_blank" rel="noopener noreferrer">AUTH</a> packet,
and therefore does not support <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901257" target="_blank" rel="noopener noreferrer">re-authentication</a>.</p>
<p>While RabbitMQ supports OAuth 2.0 token renewal for AMQP 1.0, AMQP 0.9.1, and the RabbitMQ stream protocol, RabbitMQ does not support OAuth 2.0 token renewal for MQTT.
If a token expires, RabbitMQ will disconnect the MQTT client with reason code <code>160: Maximum connect time</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shared-subscriptions">Shared Subscriptions<a href="#shared-subscriptions" class="hash-link" aria-label="Direct link to Shared Subscriptions" title="Direct link to Shared Subscriptions">​</a></h3>
<p><a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901250" target="_blank" rel="noopener noreferrer">Shared subscriptions</a> are unsupported.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overlapping-subscriptions">Overlapping Subscriptions<a href="#overlapping-subscriptions" class="hash-link" aria-label="Direct link to Overlapping Subscriptions" title="Direct link to Overlapping Subscriptions">​</a></h3>
<p>Overlapping subscriptions with different QoS levels can result in duplicate messages being delivered.
Applications need to account for this.
For example when the same MQTT client creates a QoS 0 subscription for topic filter <code>/sports/football/#</code> and a QoS 1 subscription for topic filter <code>/sports/#</code>, it will be delivered duplicate messages.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="retained-message-stores">Retained Message Stores<a href="#retained-message-stores" class="hash-link" aria-label="Direct link to Retained Message Stores" title="Direct link to Retained Message Stores">​</a></h3>
<p>As described in <a href="#retained">Retained Messages and Stores</a>, retained messages are stored and queried only node local.
Furthermore, if the topic filter contains wildcards (the multi-level wildcard character “#” or the single-level wildcard character “+”), no retained messages are sent.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="delayed-and-retained-will-mesage">Delayed and Retained Will Mesage<a href="#delayed-and-retained-will-mesage" class="hash-link" aria-label="Direct link to Delayed and Retained Will Mesage" title="Direct link to Delayed and Retained Will Mesage">​</a></h3>
<p>A <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901040" target="_blank" rel="noopener noreferrer">Will Message</a> that is both <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901062" target="_blank" rel="noopener noreferrer">delayed</a> and <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901042" target="_blank" rel="noopener noreferrer">retained</a> is not retained.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="disabling-plugin">Disabling the Plugin<a href="#disabling-plugin" class="hash-link" aria-label="Direct link to Disabling the Plugin" title="Direct link to Disabling the Plugin">​</a></h2>
<p>Before the plugin is disabled on a node, or a node removed from the cluster, it must be decommissioned using <a href="/rabbitmq-website/docs/4.0/cli"><code>rabbitmqctl</code></a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl decommission_mqtt_node </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="retained">Retained Messages and Stores<a href="#retained" class="hash-link" aria-label="Direct link to Retained Messages and Stores" title="Direct link to Retained Messages and Stores">​</a></h2>
<p>The plugin supports retained messages. Message store implementation is pluggable
and the plugin ships with two implementation out of the box:</p>
<ul>
<li>ETS-based (in memory), implemented in the <code>rabbit_mqtt_retained_msg_store_ets</code> module</li>
<li>DETS-based (on disk), implemented in the <code>rabbit_mqtt_retained_msg_store_dets</code></li>
</ul>
<p>Both implementations have limitations and trade-offs.
With the first one, maximum number of messages that can be retained is limited by RAM.
With the second one, there is a limit of 2 GB per vhost. Both are node-local
(messages retained on one broker node are not replicated to other nodes in the cluster).</p>
<p>To configure the store, use <code>rabbitmq_mqtt.retained_message_store</code> configuration key:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.allow_anonymous                     = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.vhost                               = /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.exchange                            = amq.topic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.max_session_expiry_interval_seconds = 1800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.prefetch                            = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## use DETS (disk-based) store for retained messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.retained_message_store = rabbit_mqtt_retained_msg_store_dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## only used by DETS store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.retained_message_store_dets_sync_interval = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.ssl = none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.listeners.tcp.default = 1883</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The value must be a module that implements the store:</p>
<ul>
<li><code>rabbit_mqtt_retained_msg_store_ets</code> for RAM-based</li>
<li><code>rabbit_mqtt_retained_msg_store_dets</code> for disk-based</li>
</ul>
<p>These implementations are suitable for development but sometimes won&#x27;t be for production needs.
MQTT 3.1 specification does not define consistency or replication requirements for retained
message stores, therefore RabbitMQ allows for custom ones to meet the consistency and
availability needs of a particular environment. For example, stores based on <a href="http://basho.com/riak/" target="_blank" rel="noopener noreferrer">Riak</a>
and <a href="http://cassandra.apache.org/" target="_blank" rel="noopener noreferrer">Cassandra</a> would be suitable for most production environments as
those data stores provide <a href="https://github.com/basho/basho_docs/blob/master/content/riak/kv/2.2.3/using/reference/strong-consistency.md" target="_blank" rel="noopener noreferrer">tunable consistency</a>.</p>
<p>Message stores must implement the <code>rabbit_mqtt_retained_msg_store</code> behaviour.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/versioned_docs/version-4.0/mqtt.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/docs/4.0/web-stomp"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Web STOMP Plugin</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/docs/4.0/web-mqtt"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Web MQTT Plugin</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#enabling-plugin" class="table-of-contents__link toc-highlight">Enabling the Plugin</a></li><li><a href="#features" class="table-of-contents__link toc-highlight">Supported MQTT features</a></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">How the MQTT plugin works</a><ul><li><a href="#mapping-mqtt-to-the-amqp-091-model" class="table-of-contents__link toc-highlight">Mapping MQTT to the AMQP 0.9.1 model</a></li><li><a href="#queue-types" class="table-of-contents__link toc-highlight">Queue Types</a></li><li><a href="#queue-properties-and-arguments" class="table-of-contents__link toc-highlight">Queue Properties and Arguments</a></li><li><a href="#topic-level-separator-and-wildcards" class="table-of-contents__link toc-highlight">Topic level separator and wildcards</a></li></ul></li><li><a href="#quorum-queues" class="table-of-contents__link toc-highlight">Using Quorum Queues</a></li><li><a href="#qos0-queue-type" class="table-of-contents__link toc-highlight">MQTT QoS 0 queue type</a><ul><li><a href="#overload-protection" class="table-of-contents__link toc-highlight">Overload protection</a></li></ul></li><li><a href="#authentication" class="table-of-contents__link toc-highlight">Users and Authentication</a><ul><li><a href="#local-vs-remote" class="table-of-contents__link toc-highlight">Local vs. Remote Client Connections</a></li><li><a href="#anonymous-connections" class="table-of-contents__link toc-highlight">Anonymous Connections</a></li></ul></li><li><a href="#config" class="table-of-contents__link toc-highlight">Plugin Configuration</a><ul><li><a href="#tcp-listeners" class="table-of-contents__link toc-highlight">TCP Listeners</a></li><li><a href="#listener-opts" class="table-of-contents__link toc-highlight">TCP Listener Options</a></li><li><a href="#tls" class="table-of-contents__link toc-highlight">TLS Support</a></li><li><a href="#virtual-hosts" class="table-of-contents__link toc-highlight">Virtual Hosts</a></li><li><a href="#tls-certificate-authentication" class="table-of-contents__link toc-highlight">Authentication with TLS/x509 client certificates</a></li><li><a href="#flow" class="table-of-contents__link toc-highlight">Flow Control</a></li></ul></li><li><a href="#custom-exchanges" class="table-of-contents__link toc-highlight">Custom Exchanges</a></li><li><a href="#retained" class="table-of-contents__link toc-highlight">Retained Messages and Stores</a></li><li><a href="#metrics" class="table-of-contents__link toc-highlight">Metrics</a><ul><li><a href="#prometheus" class="table-of-contents__link toc-highlight">Prometheus</a></li><li><a href="#rabbitmq-management-api" class="table-of-contents__link toc-highlight">RabbitMQ Management API</a></li></ul></li><li><a href="#scalability" class="table-of-contents__link toc-highlight">Performance and Scalability Check List</a></li><li><a href="#proxy-protocol" class="table-of-contents__link toc-highlight">Proxy Protocol</a></li><li><a href="#sparkplug-support" class="table-of-contents__link toc-highlight">Sparkplug Support</a></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a><ul><li><a href="#qos-2" class="table-of-contents__link toc-highlight">QoS 2</a></li><li><a href="#re-authentication" class="table-of-contents__link toc-highlight">Re-authentication</a></li><li><a href="#shared-subscriptions" class="table-of-contents__link toc-highlight">Shared Subscriptions</a></li><li><a href="#overlapping-subscriptions" class="table-of-contents__link toc-highlight">Overlapping Subscriptions</a></li><li><a href="#retained-message-stores" class="table-of-contents__link toc-highlight">Retained Message Stores</a></li><li><a href="#delayed-and-retained-will-mesage" class="table-of-contents__link toc-highlight">Delayed and Retained Will Mesage</a></li></ul></li><li><a href="#disabling-plugin" class="table-of-contents__link toc-highlight">Disabling the Plugin</a></li><li><a href="#retained" class="table-of-contents__link toc-highlight">Retained Messages and Stores</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
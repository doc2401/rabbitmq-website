<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-4.0 docs-doc-page docs-doc-id-confirms" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Consumer Acknowledgements and Publisher Confirms | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/confirms"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="4.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-4.0"><meta data-rh="true" name="docsearch:version" content="4.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-4.0"><meta data-rh="true" property="og:title" content="Consumer Acknowledgements and Publisher Confirms | RabbitMQ"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/confirms"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/confirms" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/confirms" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/docs/4.0">Docs</a><a class="navbar__item navbar__link" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs/4.0/confirms">4.0</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next/confirms">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/confirms">4.1</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/rabbitmq-website/docs/4.0/confirms">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13/confirms">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs/4.0">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/release-information">Release Information</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/download">Install and Upgrade</a><button aria-label="Expand sidebar category &#x27;Install and Upgrade&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rabbitmq-website/docs/4.0/use-rabbitmq">How to Use RabbitMQ</a><button aria-label="Collapse sidebar category &#x27;How to Use RabbitMQ&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/publishers">Publishing Messages</a><button aria-label="Expand sidebar category &#x27;Publishing Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/exchanges">Exchanges</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/consumers">Consuming Messages</a><button aria-label="Expand sidebar category &#x27;Consuming Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/queues">Queues</a><button aria-label="Expand sidebar category &#x27;Queues&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/streams">Streams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/channels">Channels</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/reliability">Reliability and Data Safety</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rabbitmq-website/docs/4.0/confirms">Consumer Acknowledgements and Publisher Confirms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/distributed">Network Distribution</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/plugins">Plugins</a><button aria-label="Expand sidebar category &#x27;Plugins&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/protocols">Protocols</a><button aria-label="Expand sidebar category &#x27;Protocols&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/client-libraries">Client Libraries</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/manage-rabbitmq">How to Manage RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Manage RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/monitoring">How to Monitor RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Monitor RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->RabbitMQ<!-- --> <b>4.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/rabbitmq-website/docs/confirms">latest version</a></b> (<!-- -->4.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rabbitmq-website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/4.0/use-rabbitmq"><span itemprop="name">How to Use RabbitMQ</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Consumer Acknowledgements and Publisher Confirms</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 4.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Consumer Acknowledgements and Publisher Confirms</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>This guide covers two related features related to <a href="/rabbitmq-website/docs/4.0/reliability">data safety</a>, consumer Acknowledgements
and publisher confirms:</p>
<ul>
<li><a href="#basics">Why acknowledgements exist</a></li>
<li><a href="#acknowledgement-modes">Manual and automatic</a> acknowledgement modes</li>
<li><a href="#consumer-acks-api-elements">Acknowledgement API</a>, including <a href="#consumer-acks-multiple-parameter">multi-acks</a> and <a href="#consumer-nacks-requeue">requeueing</a></li>
<li><a href="#automatic-requeueing">Automatic requeueing</a> on connection loss or channel closure</li>
<li><a href="#channel-qos-prefetch">Channel prefetch</a> and its <a href="#channel-qos-prefetch-throughput">effects on throughput</a></li>
<li>Most common <a href="#consumer-acks-double-acking">client errors</a></li>
<li><a href="#publisher-confirms">Publisher confirms</a> and related publisher data safety topics</li>
</ul>
<p>and more. Acknowledgements on both consumer and publisher side are important for
data safety in applications that use messaging.</p>
<p>More related topics are covered in the <a href="/rabbitmq-website/docs/4.0/publishers">Publisher</a> and <a href="/rabbitmq-website/docs/4.0/consumers">Consumer</a> guides.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="basics">The Basics<a href="#basics" class="hash-link" aria-label="Direct link to The Basics" title="Direct link to The Basics">​</a></h2>
<p>Systems that use a messaging broker such as RabbitMQ are by
definition distributed. Since protocol methods (messages) sent
are not guaranteed to reach the peer or be successfully processed
by it, both publishers and consumers need a mechanism for
delivery and processing confirmation. Several messaging
protocols supported by RabbitMQ provide such features.
This guide covers the features in AMQP 0-9-1 but the idea
is largely the same in other supported protocols.</p>
<p>Delivery processing acknowledgements from <a href="/rabbitmq-website/docs/4.0/consumers">consumers</a> to RabbitMQ
are known as acknowledgements in messaging protocols; broker
acknowledgements to <a href="/rabbitmq-website/docs/4.0/publishers">publishers</a> are a protocol extension called
<a href="#publisher-confirms">publisher confirms</a>.
Both features build on the same idea and are inspired by TCP.</p>
<p>They are essential for reliable delivery both from publishers
to RabbitMQ nodes and from RabbitMQ nodes to consumers. In other words,
they are <strong>essential for data safety</strong>, for which applications are
responsible as much as RabbitMQ nodes are.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="relation">Are Publisher Confirms Related to Consumer Delivery Acknowledgements?<a href="#relation" class="hash-link" aria-label="Direct link to Are Publisher Confirms Related to Consumer Delivery Acknowledgements?" title="Direct link to Are Publisher Confirms Related to Consumer Delivery Acknowledgements?">​</a></h3>
<p><a href="#publisher-confirms">Publisher confirms</a> and <a href="#consumer-acknowledgements">consumer delivery acknowledgements</a>
are very similar features that solve similar problems in different contexts:</p>
<ol>
<li>Consumer acknowledgements, as the name suggests, cover RabbitMQ communication with consumers</li>
<li>Publisher confirms cover publisher communication with RabbitMQ</li>
</ol>
<p>The two features, however, are entirely orthogonal and unaware of each other.</p>
<p><strong>Publisher confirms are not aware of consumers</strong>: they only cover publisher&#x27;s interactions
with node it is connected to, and the queue (or <a href="/rabbitmq-website/docs/4.0/streams">stream</a>) leader replica.</p>
<p><strong>Consumer acknowledgements are not aware of publishers</strong>: their goal is to confirm
to a RabbitMQ node that a given delivery was successfully received and processed successfully,
so the delivered message can be marked for future deletion.</p>
<p>Sometimes publishing and consuming applications need to communicate via requests and responses
that need an explicit acknowledgement from the peer. <a href="/rabbitmq-website/tutorials">RabbitMQ tutorial #6</a>
demonstrates the basics of how that&#x27;s done, and <a href="/rabbitmq-website/docs/4.0/direct-reply-to">Direct Reply-to</a> provides
a way to do it without declaring a lot of short-lived temporary response queues.</p>
<p>This type of communication, however, is not covered in this guide, and is mentioned only to
contrast it with the much more focussed messaging protocol features described in this guide.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-acknowledgements">(Consumer) Delivery Acknowledgements<a href="#consumer-acknowledgements" class="hash-link" aria-label="Direct link to (Consumer) Delivery Acknowledgements" title="Direct link to (Consumer) Delivery Acknowledgements">​</a></h2>
<p>When RabbitMQ delivers a message to a consumer, it needs to know
when to consider the message to be successfully sent. What kind of logic is
optimal depends on the system. It is therefore primarily an application
decision. In AMQP 0-9-1 it is made when a consumer is registered using
the <code>basic.consume</code> method or a message is fetched on demand
with the <code>basic.get</code> method.</p>
<p>If you prefer a more example-oriented and step-by-step material, consumer acknowledgements are
also covered in <a href="/rabbitmq-website/tutorials">RabbitMQ tutorial #2</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-acks-delivery-tags">Delivery Identifiers: Delivery Tags<a href="#consumer-acks-delivery-tags" class="hash-link" aria-label="Direct link to Delivery Identifiers: Delivery Tags" title="Direct link to Delivery Identifiers: Delivery Tags">​</a></h3>
<p>Before we proceed to discuss other topics it is important to
explain how deliveries are identified (and acknowledgements
indicate their respective deliveries).  When a consumer
(subscription) is registered, messages will be delivered
(pushed) by RabbitMQ using the <code>basic.deliver</code>
method.  The method carries a <code>delivery tag</code>, which
uniquely identifies the delivery on a channel. Delivery tags are
therefore scoped per channel.</p>
<p>Delivery tags are monotonically growing positive
integers and are presented as such by client libraries.
Client library methods that acknowledge deliveries take a delivery tag
as an argument.</p>
<p>Because delivery tags are scoped per channel, deliveries must be
acknowledged on the same channel they were received on. Acknowledging
on a different channel will result in an &quot;unknown delivery tag&quot; protocol
exception and close the channel.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="acknowledgement-modes">Consumer Acknowledgement Modes and Data Safety Considerations<a href="#acknowledgement-modes" class="hash-link" aria-label="Direct link to Consumer Acknowledgement Modes and Data Safety Considerations" title="Direct link to Consumer Acknowledgement Modes and Data Safety Considerations">​</a></h3>
<p>When a node delivers a message to a consumer, it has to decide whether the
message should be considered handled (or at least received) by the consumer. Since
multiple things (client connections, consumer apps, and so on) can fail,
this decision is a data safety concern. Messaging protocols usually provide
a confirmation mechanism that allows consumers to acknowledge deliveries
to the node they are connected to. Whether the mechanism is used is decided
at the time consumer subscribes.</p>
<p>Depending on the acknowledgement mode used, RabbitMQ can consider a message to be
successfully delivered either immediately after it is sent out (written to a TCP socket)
or when an explicit (&quot;manual&quot;) client acknowledgement is received. Manually sent
acknowledgements can be positive or negative and use one of the following protocol methods:</p>
<ul>
<li><code>basic.ack</code> is used for positive acknowledgements</li>
<li><code>basic.nack</code> is used for negative acknowledgements (note: this is a <a href="/rabbitmq-website/docs/4.0/nack">RabbitMQ extension to AMQP 0-9-1</a>)</li>
<li><code>basic.reject</code> is used for negative acknowledgements but has one limitation compared to <code>basic.nack</code></li>
</ul>
<p>How these methods are exposed in client library APIs will be discussed below.</p>
<p>Positive acknowledgements simply instruct RabbitMQ to record a message as delivered and can be discarded.
Negative acknowledgements with <code>basic.reject</code> have the same effect. The difference
is primarily in the semantics: positive acknowledgements assume
a message was successfully processed while their negative counterpart
suggests that a delivery wasn&#x27;t processed but still should be deleted.</p>
<p>In automatic acknowledgement mode, a message is considered
to be successfully delivered immediately after it is
sent. This mode trades off higher throughput (as long as the
consumers can keep up) for reduced safety of delivery and
consumer processing. This mode is often referred to as
&quot;fire-and-forget&quot;.  Unlike with manual acknowledgement
model, if consumers&#x27;s TCP connection or channel is closed
before successful delivery, the message sent by the server will be lost.
Therefore, automatic message acknowledgement <strong>should be considered unsafe</strong>
and not suitable for all workloads.</p>
<p>Another thing that&#x27;s important to consider when using
automatic acknowledgement mode is consumer overload.
Manual acknowledgement mode is typically used with a bounded
channel prefetch which limits the number of outstanding (&quot;in progress&quot;)
deliveries on a channel. With automatic acknowledgements, however, there is
no such limit by definition. Consumers therefore can be overwhelmed by
the rate of deliveries, potentially accumulating a backlog in memory
and running out of heap or getting their process terminated by the OS.
Some client libraries will apply TCP back pressure (stop reading from the socket
until the backlog of unprocessed deliveries drops beyond a certain limit).
Automatic acknowledgement mode is therefore only recommended for consumers
that can process deliveries efficiently and at a steady rate.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-acks-api-elements">Positively Acknowledging Deliveries<a href="#consumer-acks-api-elements" class="hash-link" aria-label="Direct link to Positively Acknowledging Deliveries" title="Direct link to Positively Acknowledging Deliveries">​</a></h3>
<p>API methods used for delivery acknowledgement are usually exposed as operations on a channel in client libraries.
Java client users will use <code>Channel#basicAck</code> and <code>Channel#basicNack</code>
to perform a <code>basic.ack</code> and <code>basic.nack</code>, respectively. Here&#x27;s a Java
client examples that demonstrates a positive acknowledgement:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> autoAck </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> autoAck</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a-consumer-tag&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DefaultConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleDelivery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">Envelope</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">AMQP</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">BasicProperties</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IOException</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> deliveryTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// positively acknowledge a single delivery, the message will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// be discarded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In .NET client the methods are <code>IModel#BasicAck</code> and <code>IModel#BasicNack</code>, respectively.
Here&#x27;s an example that demonstrates a positive acknowledgement with that client:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel (IModel) instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">EventingBasicConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Received </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// positively acknowledge a single delivery, the message will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// be discarded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> consumerTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-acks-multiple-parameter">Acknowledging Multiple Deliveries at Once<a href="#consumer-acks-multiple-parameter" class="hash-link" aria-label="Direct link to Acknowledging Multiple Deliveries at Once" title="Direct link to Acknowledging Multiple Deliveries at Once">​</a></h3>
<p>Manual acknowledgements can be batched to reduce network traffic.
This is done by setting the <code>multiple</code> field of acknowledgement
methods (see above) to <code>true</code>. Note that <code>basic.reject</code> doesn&#x27;t
historically have the field and that&#x27;s why <code>basic.nack</code> was introduced
by RabbitMQ as a protocol extension.</p>
<p>When the <code>multiple</code> field is set to <code>true</code>, RabbitMQ will acknowledge
all outstanding delivery tags up to and including the tag specified in the
acknowledgement. Like everything else related to acknowledgements, this is scoped per channel.
For example, given that there are delivery tags 5, 6, 7, and 8 unacknowledged on channel <code>Ch</code>,
when an acknowledgement frame arrives on that channel with <code>delivery_tag</code> set to <code>8</code>
and <code>multiple</code> set to <code>true</code>, all tags from 5 to 8 will be acknowledged.
If <code>multiple</code> was set to <code>false</code>, deliveries 5, 6, and 7 would still
be unacknowledged.</p>
<p>To acknowledge multiple deliveries with RabbitMQ Java client, pass <code>true</code> for the
<code>multiple</code> parameter to <code>Channel#basicAck</code>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> autoAck </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> autoAck</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a-consumer-tag&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DefaultConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleDelivery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">Envelope</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">AMQP</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">BasicProperties</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IOException</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> deliveryTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// positively acknowledge all deliveries up to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// this delivery tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The idea is very much the same with the .NET client:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel (IModel) instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">EventingBasicConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Received </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// positively acknowledge all deliveries up to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// this delivery tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> consumerTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-nacks-requeue">Negative Acknowledgement and Requeuing of Deliveries<a href="#consumer-nacks-requeue" class="hash-link" aria-label="Direct link to Negative Acknowledgement and Requeuing of Deliveries" title="Direct link to Negative Acknowledgement and Requeuing of Deliveries">​</a></h3>
<p>Sometimes a consumer cannot process a delivery immediately but other instances might
be able to. In this case it may be desired to requeue it and let another consumer receive
and handle it. <code>basic.reject</code> and <code>basic.nack</code> are two protocol
methods that are used for that.</p>
<p>The methods are generally used to negatively acknowledge a delivery. Such deliveries can
be discarded or dead-lettered or requeued by the broker. This behaviour is controlled by the <code>requeue</code> field.
When the field is set to <code>true</code>, the broker will requeue the delivery (or multiple
deliveries, as will be explained shortly) with the specified delivery tag.
Alternatively, when this field is set to <code>false</code>, the message will be routed to a <a href="/rabbitmq-website/docs/4.0/dlx">Dead Letter Exchange</a> if it
is configured, otherwise it will be discarded.</p>
<p>Both methods are usually exposed as operations on a channel in client libraries. Java
client users will use <code>Channel#basicReject</code> and <code>Channel#basicNack</code>
to perform a <code>basic.reject</code> and <code>basic.nack</code>, respectively:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> autoAck </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> autoAck</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a-consumer-tag&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DefaultConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleDelivery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">Envelope</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">AMQP</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">BasicProperties</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IOException</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> deliveryTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// negatively acknowledge, the message will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// be discarded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicReject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> autoAck </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> autoAck</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a-consumer-tag&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DefaultConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleDelivery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">Envelope</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">AMQP</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">BasicProperties</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IOException</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> deliveryTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// requeue the delivery</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicReject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In .NET client the methods are <code>IModel#BasicReject</code> and <code>IModel#BasicNack</code>,
respectively:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel (IModel) instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">EventingBasicConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Received </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// negatively acknowledge, the message will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// be discarded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicReject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> consumerTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel (IModel) instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">EventingBasicConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Received </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// requeue the delivery</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicReject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> consumerTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When a message is requeued, it will be placed to its original
position in its queue, if possible. If not (due to concurrent
deliveries and acknowledgements from other consumers when
multiple consumers share a queue), the message will be requeued
to a position closer to queue head.</p>
<p>Requeued messages may be immediately ready for redelivery depending
on their position in the queue and the prefetch value used by the channels
with active consumers. This means that if all consumers requeue because
they cannot process a delivery due to a transient condition, they will
create a requeue/redelivery loop. Such loops can be costly in terms of
network bandwidth and CPU resources. Consumer implementations can track
the number of redeliveries and reject messages for good (discard them)
or schedule requeueing after a delay.</p>
<p>It is possible to reject or requeue multiple messages at once using the <code>basic.nack</code>
method. This is what differentiates it from <code>basic.reject</code>. It accepts an additional
parameter, <code>multiple</code>. Here&#x27;s a Java client example:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> autoAck </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> autoAck</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a-consumer-tag&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DefaultConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleDelivery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">Envelope</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token class-name">AMQP</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">BasicProperties</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IOException</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> deliveryTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> envelope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// requeue all unacknowledged deliveries up to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// this delivery tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicNack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Things work very similarly with .NET client:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// this example assumes an existing channel (IModel) instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">EventingBasicConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Received </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name keyword" style="color:#00009f">var</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// requeue all unacknowledged deliveries up to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// this delivery tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicNack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeliveryTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">String</span><span class="token plain"> consumerTag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BasicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queueName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="channel-qos-prefetch">Channel Prefetch Setting (QoS)<a href="#channel-qos-prefetch" class="hash-link" aria-label="Direct link to Channel Prefetch Setting (QoS)" title="Direct link to Channel Prefetch Setting (QoS)">​</a></h3>
<p>Messages are delivered (sent) to clients
asynchronously, and there can be more than one message &quot;in
flight&quot; on a channel at any given moment. Manual acknowledgements
from clients are also inherently asynchronous in nature but
flow in the opposite direction.</p>
<p>This means a sliding window of deliveries that are unacknowledged.</p>
<p>For most consumers, it makes sense to limit the size of this window to avoid the
unbounded buffer (heap) growth problem on the consumer end.
This is done by setting a &quot;prefetch count&quot; value using the
<code>basic.qos</code> method. The value defines the max
number of unacknowledged deliveries that are permitted on a
channel. When the number reaches the configured count,
RabbitMQ will stop delivering more messages on the channel
until at least one of the outstanding ones is acknowledged.</p>
<p>A value of <code>0</code> means &quot;no limit&quot;, allowing any number
of unacknowledged messages.</p>
<p>For example, given that there are four deliveries with delivery tags 5, 6, 7, and
8 unacknowledged on channel <code>Ch</code> and channel
<code>Ch</code>&#x27;s prefetch count is set to 4, RabbitMQ will
not push any more deliveries on <code>Ch</code> unless at
least one of the outstanding deliveries is acknowledged.</p>
<p>When an acknowledgement frame arrives on that channel with
<code>delivery_tag</code> set to <code>5</code> (or <code>6</code>, <code>7</code>, or <code>8</code>),
RabbitMQ will notice and deliver one more message.
Acknowledging <a href="#consumer-acks-multiple-parameter">multiple messages at once</a>
will make more than one message available for delivery.</p>
<p>It&#x27;s worth reiterating that the flow of deliveries and
manual client acknowledgements is entirely
asynchronous. Therefore if the prefetch value is changed while
there already are deliveries in flight, a natural race
condition arises and there can temporarily be more than
prefetch count unacknowledged messages on a channel.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="per-channel-per-consumer-and-global-prefetch">Per-channel, Per-consumer and Global Prefetch<a href="#per-channel-per-consumer-and-global-prefetch" class="hash-link" aria-label="Direct link to Per-channel, Per-consumer and Global Prefetch" title="Direct link to Per-channel, Per-consumer and Global Prefetch">​</a></h4>
<p>The QoS setting can be configured for a specific channel or a specific consumer.
The <a href="/rabbitmq-website/docs/4.0/consumer-prefetch">Consumer Prefetch</a> guide explains
the effects of this scoping.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prefetch-and-polling-consumers">Prefetch and Polling Consumers<a href="#prefetch-and-polling-consumers" class="hash-link" aria-label="Direct link to Prefetch and Polling Consumers" title="Direct link to Prefetch and Polling Consumers">​</a></h4>
<p>The QoS prefetch setting has no effect on messages fetched using the <code>basic.get</code>
(&quot;pull API&quot;), even in manual confirmation mode.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="channel-qos-prefetch-throughput">Consumer Acknowledgement Modes, Prefetch and Throughput<a href="#channel-qos-prefetch-throughput" class="hash-link" aria-label="Direct link to Consumer Acknowledgement Modes, Prefetch and Throughput" title="Direct link to Consumer Acknowledgement Modes, Prefetch and Throughput">​</a></h3>
<p>Acknowledgement mode and QoS prefetch value have significant
effect on consumer throughput. In general, increasing
prefetch will improve the rate of message delivery to
consumers. Automatic acknowledgement mode yields best
possible rate of delivery. However, in both cases the number
of delivered but not-yet-processed messages will also
increase, thus increasing consumer RAM consumption.</p>
<p>Automatic acknowledgement mode or manual acknowledgement mode with unlimited prefetch should be used with care.
Consumers that consume a lot of messages without acknowledging will lead
to memory consumption growth on the node they are connected to. Finding
a suitable prefetch value is a matter of trial and error and will vary from
workload to workload. Values in the 100 through 300 range usually offer
optimal throughput and do not run significant risk of overwhelming consumers.
Higher values often <a href="/rabbitmq-website/blog/2014/04/14/finding-bottlenecks-with-rabbitmq-3-3">run into the law of diminishing returns</a>.</p>
<p>Prefetch value of 1 is the most conservative. It will
significantly reduce throughput, in particular in
environments where consumer connection latency is high. For
many applications, a higher value would be appropriate and
optimal.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-requeueing">When Consumers Fail or Lose Connection: Automatic Requeueing<a href="#automatic-requeueing" class="hash-link" aria-label="Direct link to When Consumers Fail or Lose Connection: Automatic Requeueing" title="Direct link to When Consumers Fail or Lose Connection: Automatic Requeueing">​</a></h3>
<p>When manual acknowledgements are used, any delivery
(message) that was not acked is automatically requeued when
the channel (or connection) on which the delivery happened
is closed. This includes TCP connection loss by clients,
consumer application (process) failures, and channel-level
protocol exceptions (covered below).</p>
<p>Note that it takes a period of time to <a href="/rabbitmq-website/docs/4.0/heartbeats">detect an unavailable client</a>.</p>
<p>Due to this behavior, consumers must be prepared to handle redeliveries and otherwise
be implemented with <a href="https://en.wikipedia.org/wiki/Idempotence" target="_blank" rel="noopener noreferrer">idempotence</a> in mind.
Redeliveries will have a special boolean property, <code>redeliver</code>, set to <code>true</code>
by RabbitMQ. For first time deliveries it will be set to <code>false</code>. Note that
a consumer can receive a message that was previously delivered to another consumer.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-acks-double-acking">Client Errors: Double Acking and Unknown Tags<a href="#consumer-acks-double-acking" class="hash-link" aria-label="Direct link to Client Errors: Double Acking and Unknown Tags" title="Direct link to Client Errors: Double Acking and Unknown Tags">​</a></h3>
<p>Should a client acknowledge the same delivery tag more than once,
RabbitMQ will result a channel error such as <code>PRECONDITION_FAILED - unknown delivery tag 100</code>.
The same channel exception will be thrown if an unknown delivery tag is used.</p>
<p>Another scenario in which the broker will complain about an &quot;unknown delivery tag&quot; is when
an acknowledgement, whether positive or negative, is attempted on a channel different from
that on which the delivery was received on. Deliveries must be acknowledged on the same
channel.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="publisher-confirms">Publisher Confirms<a href="#publisher-confirms" class="hash-link" aria-label="Direct link to Publisher Confirms" title="Direct link to Publisher Confirms">​</a></h2>
<p>Networks can fail in less-than-obvious ways and detecting some failures <a href="/rabbitmq-website/docs/4.0/heartbeats">takes time</a>.
Therefore a client that&#x27;s written a protocol frame or a set of frames (e.g. a published message) to
its socket cannot assume that the message has reached the server and was successfully processed.
It could have been lost along the way or its delivery can be significantly delayed.</p>
<p>Using standard AMQP 0-9-1, the only way to guarantee that a
message isn&#x27;t lost is by using transactions -- make the
channel transactional then for each message or set of messages publish, commit.
In this case, transactions are unnecessarily heavyweight and
decrease throughput by a factor of 250.  To remedy this,
a confirmation mechanism was introduced. It mimics the consumer
acknowledgements mechanism already present in the protocol.</p>
<p>To enable confirms, a client sends the
<code>confirm.select</code> method.  Depending on whether
<code>no-wait</code> was set or not, the broker may respond
with a <code>confirm.select-ok</code>.  Once the
<code>confirm.select</code> method is used on a channel, it
is said to be in confirm mode.  A transactional channel
cannot be put into confirm mode and once a channel is in
confirm mode, it cannot be made transactional.</p>
<p>Once a channel is in confirm mode, both the broker and the
client count messages (counting starts at 1 on the first
<code>confirm.select</code>).  The broker then confirms
messages as it handles them by sending a
<code>basic.ack</code> on the same channel. The
<code>delivery-tag</code> field contains the sequence number
of the confirmed message.  The broker may also set the
<code>multiple</code> field in <code>basic.ack</code> to
indicate that all messages up to and including the one with
the sequence number have been handled.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="server-sent-nacks">Negative Acknowledgments for Publishes<a href="#server-sent-nacks" class="hash-link" aria-label="Direct link to Negative Acknowledgments for Publishes" title="Direct link to Negative Acknowledgments for Publishes">​</a></h3>
<p>In exceptional cases when the broker is unable to handle
messages successfully, instead of a <code>basic.ack</code>,
the broker will send a <code>basic.nack</code>.  In this
context, fields of the <code>basic.nack</code> have the same
meaning as the corresponding ones in <code>basic.ack</code>
and the <code>requeue</code> field should be ignored.  By
nack&#x27;ing one or more messages, the broker indicates that it
was unable to process the messages and refuses responsibility
for them; at that point, the client may choose to re-publish
the messages.</p>
<p>After a channel is put into confirm mode, all subsequently
published messages will be confirmed or nack&#x27;d once.  No
guarantees are made as to how soon a message is confirmed.
No message will be both confirmed and nack&#x27;d.</p>
<p><code>basic.nack</code> will only be delivered if an internal
error occurs in the Erlang process responsible for a queue.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-publishes-are-confirmed">When Will Published Messages Be Confirmed by the Broker?<a href="#when-publishes-are-confirmed" class="hash-link" aria-label="Direct link to When Will Published Messages Be Confirmed by the Broker?" title="Direct link to When Will Published Messages Be Confirmed by the Broker?">​</a></h3>
<p>For unroutable messages, the broker will issue a confirm
once the exchange verifies a message won&#x27;t route to any queue
(returns an empty list of queues). If the message is also
published as mandatory, the <code>basic.return</code> is sent
to the client before <code>basic.ack</code>. The same
is true for negative acknowledgements (<code>basic.nack</code>).</p>
<p>For routable messages, the <code>basic.ack</code> is sent when a
message has been accepted by all the queues. For persistent
messages routed to durable queues, this <strong>means persisting
to disk</strong>. For <a href="/rabbitmq-website/docs/4.0/quorum-queues">quorum queues</a>,
this means that a quorum replicas have accepted and confirmed
the message to the elected leader.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="publisher-confirms-latency">Ack Latency for Persistent Messages<a href="#publisher-confirms-latency" class="hash-link" aria-label="Direct link to Ack Latency for Persistent Messages" title="Direct link to Ack Latency for Persistent Messages">​</a></h3>
<p><code>basic.ack</code> for a persistent message routed to a
durable queue will be sent after persisting the message to
disk. The RabbitMQ message store persists messages to disk in
batches after an interval (a few hundred milliseconds) to
minimise the number of fsync(2) calls, or when a queue is idle.</p>
<p>This means that under a constant load, latency for
<code>basic.ack</code> can reach a few hundred milliseconds. To
improve throughput, applications are strongly advised to
process acknowledgements asynchronously (as a stream) or publish
batches of messages and wait for outstanding confirms. The exact
API for this varies between client libraries.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="publisher-confirms-ordering">Ordering Considerations for Publisher Confirms<a href="#publisher-confirms-ordering" class="hash-link" aria-label="Direct link to Ordering Considerations for Publisher Confirms" title="Direct link to Ordering Considerations for Publisher Confirms">​</a></h3>
<p>In most cases, RabbitMQ will acknowledge messages to
publishers in the same order they were published (this
applies for messages published on a single
channel). However, publisher acknowledgements are emitted
asynchronously and can confirm a single message or a group
of messages. The exact moment when a confirm is emitted
depends on the delivery mode of a message (persistent
vs. transient) and the properties of the queue(s) the
message was routed to (see above). Which is to say that
different messages can be considered ready for
acknowledgement at different times. This means that
acknowledgements can arrive in a different order compared to
their respective messages. Applications should not depend on
the order of acknowledgements when possible.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="publisher-confirms-and-guaranteed-delivery">Publisher Confirms and Guaranteed Delivery<a href="#publisher-confirms-and-guaranteed-delivery" class="hash-link" aria-label="Direct link to Publisher Confirms and Guaranteed Delivery" title="Direct link to Publisher Confirms and Guaranteed Delivery">​</a></h3>
<p>A RabbitMQ node can lose persistent messages if it fails before
said messages are written to disk. For instance, consider this scenario:</p>
<ol>
<li>a client publishes a persistent message to a durable queue</li>
<li>a client consumes the message from the queue (noting that the message is persistent and the queue durable), but confirms are not active,</li>
<li>the broker node fails and is restarted, and</li>
<li>the client reconnects and starts consuming messages</li>
</ol>
<p>At this point, the client could reasonably assume that the
message will be delivered again.  This is not the case: the
restart has caused the broker to lose the message.  In order to
guarantee persistence, a client should use confirms.  If the
publisher&#x27;s channel had been in confirm mode, the publisher
would <strong>not</strong> have received an ack for the lost message
(since the message hadn&#x27;t been written to disk yet).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="publisher-confirms-and-guaranteed-delivery">Maximum Delivery Tag<a href="#publisher-confirms-and-guaranteed-delivery" class="hash-link" aria-label="Direct link to Maximum Delivery Tag" title="Direct link to Maximum Delivery Tag">​</a></h3>
<p>Delivery tag is a 64 bit long value, and thus its maximum value
is <code>9223372036854775807</code>. Since delivery tags are scoped per channel,
it is very unlikely that a publisher or consumer will run over this
value in practice.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/versioned_docs/version-4.0/confirms.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/docs/4.0/reliability"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Reliability and Data Safety</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/docs/4.0/distributed"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Network Distribution</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#basics" class="table-of-contents__link toc-highlight">The Basics</a><ul><li><a href="#relation" class="table-of-contents__link toc-highlight">Are Publisher Confirms Related to Consumer Delivery Acknowledgements?</a></li></ul></li><li><a href="#consumer-acknowledgements" class="table-of-contents__link toc-highlight">(Consumer) Delivery Acknowledgements</a><ul><li><a href="#consumer-acks-delivery-tags" class="table-of-contents__link toc-highlight">Delivery Identifiers: Delivery Tags</a></li><li><a href="#acknowledgement-modes" class="table-of-contents__link toc-highlight">Consumer Acknowledgement Modes and Data Safety Considerations</a></li><li><a href="#consumer-acks-api-elements" class="table-of-contents__link toc-highlight">Positively Acknowledging Deliveries</a></li><li><a href="#consumer-acks-multiple-parameter" class="table-of-contents__link toc-highlight">Acknowledging Multiple Deliveries at Once</a></li><li><a href="#consumer-nacks-requeue" class="table-of-contents__link toc-highlight">Negative Acknowledgement and Requeuing of Deliveries</a></li><li><a href="#channel-qos-prefetch" class="table-of-contents__link toc-highlight">Channel Prefetch Setting (QoS)</a></li><li><a href="#channel-qos-prefetch-throughput" class="table-of-contents__link toc-highlight">Consumer Acknowledgement Modes, Prefetch and Throughput</a></li><li><a href="#automatic-requeueing" class="table-of-contents__link toc-highlight">When Consumers Fail or Lose Connection: Automatic Requeueing</a></li><li><a href="#consumer-acks-double-acking" class="table-of-contents__link toc-highlight">Client Errors: Double Acking and Unknown Tags</a></li></ul></li><li><a href="#publisher-confirms" class="table-of-contents__link toc-highlight">Publisher Confirms</a><ul><li><a href="#server-sent-nacks" class="table-of-contents__link toc-highlight">Negative Acknowledgments for Publishes</a></li><li><a href="#when-publishes-are-confirmed" class="table-of-contents__link toc-highlight">When Will Published Messages Be Confirmed by the Broker?</a></li><li><a href="#publisher-confirms-latency" class="table-of-contents__link toc-highlight">Ack Latency for Persistent Messages</a></li><li><a href="#publisher-confirms-ordering" class="table-of-contents__link toc-highlight">Ordering Considerations for Publisher Confirms</a></li><li><a href="#publisher-confirms-and-guaranteed-delivery" class="table-of-contents__link toc-highlight">Publisher Confirms and Guaranteed Delivery</a></li></ul></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a><ul><li><a href="#publisher-confirms-and-guaranteed-delivery" class="table-of-contents__link toc-highlight">Maximum Delivery Tag</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
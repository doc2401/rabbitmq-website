<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-4.0 docs-doc-page docs-doc-id-cluster-formation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Cluster Formation and Peer Discovery | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/cluster-formation"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="4.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-4.0"><meta data-rh="true" name="docsearch:version" content="4.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-4.0"><meta data-rh="true" property="og:title" content="Cluster Formation and Peer Discovery | RabbitMQ"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/cluster-formation"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/cluster-formation" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/4.0/cluster-formation" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/docs/4.0">Docs</a><a class="navbar__item navbar__link" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs/4.0/cluster-formation">4.0</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next/cluster-formation">Next</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/cluster-formation">4.1</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/rabbitmq-website/docs/4.0/cluster-formation">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13/cluster-formation">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs/4.0">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/release-information">Release Information</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/download">Install and Upgrade</a><button aria-label="Expand sidebar category &#x27;Install and Upgrade&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/use-rabbitmq">How to Use RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Use RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rabbitmq-website/docs/4.0/manage-rabbitmq">How to Manage RabbitMQ</a><button aria-label="Collapse sidebar category &#x27;How to Manage RabbitMQ&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/cli">CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/configure">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/relocate">File and Directory Locations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/logging">Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/vhosts">Virtual Hosts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/access-control"> Authentication and Authorization</a><button aria-label="Expand sidebar category &#x27; Authentication and Authorization&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/parameters">Policies and Runtime Parameters</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/metadata-store">Metadata store</a><button aria-label="Expand sidebar category &#x27;Metadata store&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/definitions">Schema Definitions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/4.0/networking">Networking</a><button aria-label="Expand sidebar category &#x27;Networking&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/rabbitmq-website/docs/4.0/clustering">Clustering</a><button aria-label="Collapse sidebar category &#x27;Clustering&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rabbitmq-website/docs/4.0/cluster-formation">Cluster Formation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/partitions">Network Partitions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/clustering-ssl">Using TLS for Inter-node Traffic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/ec2">RabbitMQ on Amazon EC2</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/rabbitmq-website/docs/4.0/memory-use">Resource Management</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/backup">Backup and Restore</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/rabbitmq-website/docs/4.0/runtime">Tuning</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/production-checklist">Deployment Guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/kubernetes/operator/operator-overview">RabbitMQ on Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/4.0/troubleshooting">Troubleshooting RabbitMQ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/4.0/monitoring">How to Monitor RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Monitor RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->RabbitMQ<!-- --> <b>4.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/rabbitmq-website/docs/cluster-formation">latest version</a></b> (<!-- -->4.1<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rabbitmq-website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/4.0/manage-rabbitmq"><span itemprop="name">How to Manage RabbitMQ</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/4.0/clustering"><span itemprop="name">Clustering</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Cluster Formation</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 4.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Cluster Formation and Peer Discovery</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>This guide covers various automation-oriented cluster formation and
peer discovery features. For a general overview of RabbitMQ clustering,
please refer to the <a href="/rabbitmq-website/docs/4.0/clustering">Clustering Guide</a>.</p>
<p>This guide assumes general familiarity with <a href="/rabbitmq-website/docs/4.0/clustering">RabbitMQ clustering</a>
and focuses on the peer discovery subsystem.
For example, it will not cover what <a href="/rabbitmq-website/docs/4.0/networking">ports must be open</a> for inter-node communication, how nodes authenticate to each other, and so on.
Besides discovery mechanisms and <a href="#configuring">their configuration</a>,
this guide also covers closely related topics of <a href="#formation-and-availability">feature availability during cluster formation</a>, <a href="#rejoining">rejoining nodes</a>,
the problem of <a href="#initial-formation-race-condition">initial cluster formation</a> with nodes booting in parallel as well as <a href="#node-health-checks-and-cleanup">additional health checks</a> offered
by some discovery implementations.</p>
<p>The guide also covers the basics of <a href="#troubleshooting">peer discovery troubleshooting</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery">What is Peer Discovery?<a href="#peer-discovery" class="hash-link" aria-label="Direct link to What is Peer Discovery?" title="Direct link to What is Peer Discovery?">​</a></h2>
<p>To form a cluster, new (&quot;blank&quot;) nodes need to be able to discover
their peers. This can be done using a variety of mechanisms (backends).
Some mechanisms assume all cluster members are known ahead of time (for example, listed
in the config file), others are dynamic (nodes can come and go).</p>
<p>All peer discovery mechanisms assume that newly joining nodes will be able to
contact their peers in the cluster and authenticate with them successfully.
The mechanisms that rely on an external service (e.g. DNS or Consul) or API (e.g. AWS or Kubernetes)
require the service(s) or API(s) to be available and reachable on their standard ports.
Inability to reach the services will lead to node&#x27;s inability to join the cluster.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-plugins">Available Discovery Mechanisms<a href="#peer-discovery-plugins" class="hash-link" aria-label="Direct link to Available Discovery Mechanisms" title="Direct link to Available Discovery Mechanisms">​</a></h3>
<p>The following mechanisms are built into the core and always available:</p>
<ul>
<li><a href="#peer-discovery-classic-config">Config file</a></li>
<li><a href="#peer-discovery-dns">Pre-configured DNS A/AAAA records</a></li>
</ul>
<p>Additional peer discovery mechanisms are available via plugins. The following
peer discovery plugins ship with <a href="/rabbitmq-website/release-information">supported RabbitMQ versions</a>:</p>
<ul>
<li><a href="#peer-discovery-aws">AWS (EC2)</a></li>
<li><a href="#peer-discovery-k8s">Kubernetes</a></li>
<li><a href="#peer-discovery-consul">Consul</a></li>
<li><a href="#peer-discovery-etcd">etcd</a></li>
</ul>
<p>The above plugins do not need to be installed but like all <a href="/rabbitmq-website/docs/4.0/plugins">plugins</a> they must be <a href="/rabbitmq-website/docs/4.0/plugins#basics">enabled</a>
or <a href="/rabbitmq-website/docs/4.0/plugins#enabled-plugins-file">preconfigured</a> before they can be used.</p>
<p>For peer discovery plugins, which must be available on node boot, this means they must be enabled before first node boot.
The example below uses <a href="/rabbitmq-website/docs/4.0/cli">rabbitmq-plugins</a>&#x27; <code>--offline</code> mode:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token parameter variable" style="color:#36acaa">--offline</span><span class="token plain"> </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">plugin name</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A more specific example:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token parameter variable" style="color:#36acaa">--offline</span><span class="token plain"> </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_peer_discovery_k8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A node with configuration settings that belong a non-enabled peer discovery plugin will fail
to start and report those settings as unknown.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-configuring-mechanism">Specifying the Peer Discovery Mechanism<a href="#peer-discovery-configuring-mechanism" class="hash-link" aria-label="Direct link to Specifying the Peer Discovery Mechanism" title="Direct link to Specifying the Peer Discovery Mechanism">​</a></h3>
<p>The discovery mechanism to use is specified in the <a href="/rabbitmq-website/docs/4.0/configure">config file</a>,
as are various mechanism-specific settings, for example, discovery service hostnames, credentials, and so
on. <code>cluster_formation.peer_discovery_backend</code> is the key
that controls what discovery module (implementation) is used:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = classic_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The backend can also be specified using its module name. Note that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># module names do not necessarily match plugin names exactly.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The module has to implement the <a href="https://github.com/rabbitmq/rabbitmq-common/blob/master/src/rabbit_peer_discovery_backend.erl" target="_blank" rel="noopener noreferrer">rabbit_peer_discovery_backend</a>
behaviour. Plugins therefore can introduce their own discovery
mechanisms.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-how-does-it-work">How Peer Discovery Works<a href="#peer-discovery-how-does-it-work" class="hash-link" aria-label="Direct link to How Peer Discovery Works" title="Direct link to How Peer Discovery Works">​</a></h3>
<p>When a node starts and detects it doesn&#x27;t have a previously
initialised database, it will check if there&#x27;s a peer
discovery mechanism configured. If that&#x27;s the case, it will
then perform the discovery and attempt to contact each
discovered peer in order. Finally, it will attempt to join the
cluster of the first reachable peer.</p>
<p>Depending on the backend (mechanism) used, the process of peer discovery may involve
contacting external services, for example, an AWS API endpoint, a Consul node or
performing a DNS query. Some backends require nodes to register (tell the backend that the
node is up and should be counted as a cluster member): for example, Consul and etcd both
support registration. With other backends the list of nodes is configured ahead of
time (e.g. config file). Those backends are said to not support node registration.</p>
<p>In some cases node registration is implicit or managed by an external service.
AWS autoscaling groups is a good example: AWS keeps track of group membership,
so nodes don&#x27;t have to (or cannot) explicitly register. However, the list of cluster members
is not predefined. Such backends usually include a no-op registration step
and apply one of the <a href="#initial-formation-race-condition">race condition mitigation mechanisms</a> described below.</p>
<p>If the configured backend supports registration, nodes unregister when they are instructed to stop.</p>
<p>It is possible to opt-out of registration completely with the config option <code>cluster_formation.registration.enabled</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.registration.enabled = false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When configured this way, the node has to be registered manually or using another mechanism,
e.g. by a container orchestrator such as <a href="https://developer.hashicorp.com/nomad/integrations/hashicorp/rabbitmq" target="_blank" rel="noopener noreferrer">Nomad</a> or <a href="https://www.rabbitmq.com/kubernetes/operator/operator-overview" target="_blank" rel="noopener noreferrer">Kubernetes</a>.</p>
<p>If peer discovery isn&#x27;t configured, or it <a href="#discovery-retries">repeatedly fails</a>,
or no peers are reachable, a node that wasn&#x27;t a cluster member in the past
will initialise from scratch and proceed as a standalone node.
Peer discovery progress and outcomes will be <a href="/rabbitmq-website/docs/4.0/logging">logged</a>
by the node.</p>
<p>If a node previously was a cluster member, it will try to contact and rejoin
its &quot;last seen&quot; peer for a period of time. In this case, no peer discovery
will be performed. This is true for all backends.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="formation-and-availability">Cluster Formation and Feature Availability<a href="#formation-and-availability" class="hash-link" aria-label="Direct link to Cluster Formation and Feature Availability" title="Direct link to Cluster Formation and Feature Availability">​</a></h2>
<p>As a general rule, a cluster that is only been partly formed, that is, only a subset of
nodes has joined it <strong>must be considered fully available</strong> by clients.</p>
<p>Individual nodes will accept <a href="/rabbitmq-website/docs/4.0/connections">client connections</a> before the cluster is formed. In such cases,
clients should be prepared to certain features not being available. For instance, <a href="/rabbitmq-website/docs/4.0/quorum-queues">quorum queues</a>
won&#x27;t be available unless the number of cluster nodes matches or exceeds the quorum of configured replica count.</p>
<p>Features behind <a href="/rabbitmq-website/docs/4.0/feature-flags">feature flags</a> may also be unavailable until cluster formation completes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rejoining">Nodes Rejoining Their Existing Cluster<a href="#rejoining" class="hash-link" aria-label="Direct link to Nodes Rejoining Their Existing Cluster" title="Direct link to Nodes Rejoining Their Existing Cluster">​</a></h2>
<p>A new node joining a cluster is just one possible case. Another common scenario
is when an existing cluster member temporarily leaves and then rejoins the cluster.
While the peer discovery subsystem does not affect the behavior described in this section,
it&#x27;s important to understand how nodes behave when they rejoin their cluster after a restart or failure.</p>
<p>Existing cluster members <strong>will not perform peer discovery</strong>. Instead they will try to
contact their previously known peers.</p>
<p>If a node previously was a cluster member, when it boots it will try to contact
its &quot;last seen&quot; peer for a period of time. If the peer is not booted (e.g. when
a full cluster restart or upgrade is performed) or cannot be reached, the node will
retry the operation a number of times.</p>
<p>Default values are <code>10</code> retries and <code>30</code> seconds per attempt,
respectively, or 5 minutes total. In environments where nodes can take a long and/or uneven
time to start it is recommended that the number of retries is increased.</p>
<p>If a node is reset since losing contact with the cluster, it will behave <a href="#peer-discovery-how-does-it-work">like a blank node</a>.
Note that other cluster members might still consider it to be a cluster member, in which case
the two sides will disagree and the node will fail to join. Such reset nodes must also be
removed from the cluster using <a href="/rabbitmq-website/docs/4.0/cli"><code>rabbitmqctl forget_cluster_node</code></a> executed against
an existing cluster member.</p>
<p>If a node was explicitly removed from the cluster by the operator and then reset,
it will be able to join the cluster as a new member. In this case it will behave exactly
<a href="#peer-discovery-how-does-it-work">like a blank node</a> would.</p>
<p>A node rejoining after a node name or host name change can start as <a href="#peer-discovery-how-does-it-work">a blank node</a>
if its data directory path changes as a result. Such nodes will fail to rejoin the cluster.
While the node is offline, its peers can be reset or started with a blank data directory.
In that case the recovering node will fail to rejoin its peer as well since internal data store cluster
identity would no longer match.</p>
<p>Consider the following scenario:</p>
<ol><li>A cluster of 3 nodes, A, B and C is formed</li><li>Node A is shut down</li><li>Node B is reset</li><li>Node A is started</li><li>Node A tries to rejoin B but B&#x27;s cluster identity has changed</li><li>Node B doesn&#x27;t recognise A as a known cluster member because it&#x27;s been reset</li></ol>
<p>in this case node B will reject the clustering attempt from A with an appropriate error
message in the log:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Node &#x27;rabbit@node1.local&#x27; thinks it&#x27;s clustered with node &#x27;rabbit@node2.local&#x27;, but &#x27;rabbit@node2.local&#x27; disagrees</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this case B can be reset again and then will be able to join A, or A
can be reset and will successfully join B.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuring">How to Configure Peer Discovery<a href="#configuring" class="hash-link" aria-label="Direct link to How to Configure Peer Discovery" title="Direct link to How to Configure Peer Discovery">​</a></h2>
<p>Peer discovery plugins are configured just like the core server and other
plugins: using a <a href="/rabbitmq-website/docs/4.0/configure">config file</a>.</p>
<p><code>cluster_formation.peer_discovery_backend</code> is the key that <a href="#peer-discovery-configuring-mechanism">controls what peer discovery backend will be used</a>.
Each backend will also have a number of configuration settings specific to it.
The rest of the guide will cover configurable settings specific to a particular mechanism
as well as provide examples for each one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-classic-config">Config File Peer Discovery Backend<a href="#peer-discovery-classic-config" class="hash-link" aria-label="Direct link to Config File Peer Discovery Backend" title="Direct link to Config File Peer Discovery Backend">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="config-file-peer-discovery-overview">Config File Peer Discovery Overview<a href="#config-file-peer-discovery-overview" class="hash-link" aria-label="Direct link to Config File Peer Discovery Overview" title="Direct link to Config File Peer Discovery Overview">​</a></h3>
<p>The most basic way for a node to discover its cluster peers is to read a list
of nodes from the config file. The set of cluster members is assumed to be known at deployment
time.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a href="#configuration" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>The peer nodes are listed using the <code>cluster_formation.classic_config.nodes</code> config setting:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = classic_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the backend can also be specified using its module name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.classic_config.nodes.1 = rabbit@hostname1.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.classic_config.nodes.2 = rabbit@hostname2.eng.example.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-dns">DNS Peer Discovery Backend<a href="#peer-discovery-dns" class="hash-link" aria-label="Direct link to DNS Peer Discovery Backend" title="Direct link to DNS Peer Discovery Backend">​</a></h2>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>This peer discovery mechanism is sensitive to OS and RabbitMQ configuration that
<a href="/rabbitmq-website/docs/4.0/networking#dns">affects hostname resolution</a>.</p><p>For example, a deployment tool that modifies the <a href="https://en.wikipedia.org/wiki/Hosts_(file)" target="_blank" rel="noopener noreferrer">local host file</a>
can affect (break) this peer discovery mechanism.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dns-peer-discovery-overview">DNS Peer Discovery Overview<a href="#dns-peer-discovery-overview" class="hash-link" aria-label="Direct link to DNS Peer Discovery Overview" title="Direct link to DNS Peer Discovery Overview">​</a></h3>
<p>Another built-in peer discovery mechanism as of RabbitMQ 3.7.0 is DNS-based.
It relies on a pre-configured hostname (&quot;seed hostname&quot;) with DNS A (or AAAA) records and reverse DNS lookups
to perform peer discovery. More specifically, this mechanism will perform the following steps:</p>
<ol>
<li>Query DNS A records of the seed hostname.</li>
<li>For each returned DNS record&#x27;s IP address, perform a reverse DNS lookup.</li>
<li>Append current node&#x27;s prefix (e.g. <code>rabbit</code> in <code>rabbit@hostname1.example.local</code>)
to each hostname and return the result.</li>
</ol>
<p>For example, let&#x27;s consider a seed hostname of
<code>discovery.eng.example.local</code>.  It has 2 DNS A
records that return two IP addresses:
<code>192.168.100.1</code> and
<code>192.168.100.2</code>. Reverse DNS lookups for those IP
addresses return <code>node1.eng.example.local</code> and
<code>node2.eng.example.local</code>, respectively. Current node&#x27;s name is not
set and defaults to <code>rabbit@$(hostname)</code>.
The final list of nodes discovered will contain two nodes: <code>rabbit@node1.eng.example.local</code>
and <code>rabbit@node2.eng.example.local</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-1">Configuration<a href="#configuration-1" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>The seed hostname is set using the <code>cluster_formation.dns.hostname</code> config setting:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the backend can also be specified using its module name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.dns.hostname = discovery.eng.example.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="host-file-modifications-in-containerized-environments">Host File Modifications in Containerized Environments<a href="#host-file-modifications-in-containerized-environments" class="hash-link" aria-label="Direct link to Host File Modifications in Containerized Environments" title="Direct link to Host File Modifications in Containerized Environments">​</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>In some containerized environments, the <a href="https://en.wikipedia.org/wiki/Hosts_(file)" target="_blank" rel="noopener noreferrer">local host file</a> is modified at container
startup time. This can affect hostname resolution on the host and make it impossible for this peer
discovery mechanism to do its job.</p></div></div>
<p>In some containerized environments, the <a href="https://en.wikipedia.org/wiki/Hosts_(file)" target="_blank" rel="noopener noreferrer">local host file</a> is modified at container
startup time, for example, a configuration- or convention-based local hostname can be added to it.</p>
<p>This can affect hostname resolution on the host and make it impossible for this peer
discovery mechanism to do its job.</p>
<p>Podman is one known example of a tool that can perform such host file modifications.
In order to avoid this, set its <a href="https://github.com/containers/common/blob/main/docs/containers.conf.5.md" target="_blank" rel="noopener noreferrer"><code>host_containers_internal_ip</code> setting</a>
must be set to a blank string.</p>
<p>In environments where container-level settings cannot be tuned, the runtime
can be <a href="/rabbitmq-website/docs/4.0/networking#the-inetrc-file">configured to ignore the standard local hosts file</a>
and only use DNS or a pre-configured set of hostname-to-IP address mappings.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-aws">Peer Discovery on AWS (EC2)<a href="#peer-discovery-aws" class="hash-link" aria-label="Direct link to Peer Discovery on AWS (EC2)" title="Direct link to Peer Discovery on AWS (EC2)">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aws-peer-discovery-overview">AWS Peer Discovery Overview<a href="#aws-peer-discovery-overview" class="hash-link" aria-label="Direct link to AWS Peer Discovery Overview" title="Direct link to AWS Peer Discovery Overview">​</a></h3>
<p>An <a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_peer_discovery_aws" target="_blank" rel="noopener noreferrer">AWS (EC2)-specific</a> discovery mechanism
is available via a plugin.</p>
<p>As with any <a href="/rabbitmq-website/docs/4.0/plugins">plugin</a>, it must be enabled before it
can be used. For peer discovery plugins it means they must be <a href="/rabbitmq-website/docs/4.0/plugins#basics">enabled</a>
or <a href="/rabbitmq-website/docs/4.0/plugins#enabled-plugins-file">preconfigured</a> before first node boot:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token parameter variable" style="color:#36acaa">--offline</span><span class="token plain"> </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_peer_discovery_aws</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The plugin provides two ways for a node to discover its peers:</p>
<ul>
<li>Using EC2 instance tags</li>
<li>Using AWS autoscaling group membership</li>
</ul>
<p>Both methods rely on AWS-specific APIs (endpoints) and features and thus cannot work in
other IaaS environments. Once a list of cluster member instances is retrieved,
final node names are computed using instance hostnames or IP addresses.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-aws-credentials">Configuration and Credentials<a href="#peer-discovery-aws-credentials" class="hash-link" aria-label="Direct link to Configuration and Credentials" title="Direct link to Configuration and Credentials">​</a></h3>
<p>Before a node can perform any operations on AWS, it needs to have a set of
AWS account credentials configured. This can be done in a couple of ways:</p>
<ol>
<li>Via <a href="/rabbitmq-website/docs/4.0/configure">config file</a></li>
<li>Using environment variables <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></li>
</ol>
<p><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" target="_blank" rel="noopener noreferrer">EC2 Instance Metadata service</a> for the region will also be consulted.</p>
<p>The following example snippet configures RabbitMQ to use the AWS peer discovery
backend and provides information about AWS region as well as a set of credentials:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the backend can also be specified using its module name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.region = us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.access_key_id = ANIDEXAMPLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.secret_key = WjalrxuTnFEMI/K7MDENG+bPxRfiCYEXAMPLEKEY</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If region is left unconfigured, <code>us-east-1</code> will be used by default.
Sensitive values in configuration file can optionally <a href="/rabbitmq-website/docs/4.0/configure#configuration-encryption">be encrypted</a>.</p>
<p>If an <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-./ec2" target="_blank" rel="noopener noreferrer">IAM role is assigned to EC2 instances</a> running RabbitMQ nodes,
a policy has to be used to <a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html" target="_blank" rel="noopener noreferrer">allow said instances use EC2 Instance Metadata Service</a>.
When the plugin is configured to use Autoscaling group members,
a policy has to <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/control-access-using-iam.html" target="_blank" rel="noopener noreferrer">grant access to describe autoscaling group members</a> (instances).
Below is an example of a policy that covers both use cases:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;Version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;Statement&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;Effect&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Allow&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;Action&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token string" style="color:#e3116c">&quot;autoscaling:DescribeAutoScalingInstances&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token string" style="color:#e3116c">&quot;ec2:DescribeInstances&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;Resource&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-aws-autoscaling-group-membership">Using Autoscaling Group Membership<a href="#peer-discovery-aws-autoscaling-group-membership" class="hash-link" aria-label="Direct link to Using Autoscaling Group Membership" title="Direct link to Using Autoscaling Group Membership">​</a></h3>
<p>When autoscaling-based peer discovery is used, current node&#x27;s EC2 instance autoscaling
group members will be listed and used to produce the list of discovered peers.</p>
<p>To use autoscaling group membership, set the <code>cluster_formation.aws.use_autoscaling_group</code> key
to <code>true</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.region = us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.access_key_id = ANIDEXAMPLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.secret_key = WjalrxuTnFEMI/K7MDENG+bPxRfiCYEXAMPLEKEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.use_autoscaling_group = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-aws-tags">Using EC2 Instance Tags<a href="#peer-discovery-aws-tags" class="hash-link" aria-label="Direct link to Using EC2 Instance Tags" title="Direct link to Using EC2 Instance Tags">​</a></h3>
<p>When tags-based peer discovery is used, the plugin will list EC2 instances
using EC2 API and filter them by configured instance tags. Resulting instance set
will be used to produce the list of discovered peers.</p>
<p>Tags are configured using the <code>cluster_formation.aws.instance_tags</code> key. The example
below uses three tags: <code>region</code>, <code>service</code>, and <code>environment</code>.</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.region = us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.access_key_id = ANIDEXAMPLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.secret_key = WjalrxuTnFEMI/K7MDENG+bPxRfiCYEXAMPLEKEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.instance_tags.region = us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.instance_tags.service = rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.instance_tags.environment = staging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-aws-other-settings">Using Private EC2 Instance IPs<a href="#peer-discovery-aws-other-settings" class="hash-link" aria-label="Direct link to Using Private EC2 Instance IPs" title="Direct link to Using Private EC2 Instance IPs">​</a></h3>
<p>By default peer discovery will use private DNS hostnames to compute node names.
This option is most convenient and is <strong>highly recommended</strong>.</p>
<p>However, it is possible to opt into using private IPs instead by setting
the <code>cluster_formation.aws.use_private_ip</code> key to <code>true</code>. For this setup to work,
<a href="/rabbitmq-website/docs/4.0/configure#customise-environment"><code>RABBITMQ_NODENAME</code> must be set</a> to the private IP address at node
deployment time.</p>
<p><code>RABBITMQ_USE_LONGNAME</code> also has to be set to <code>true</code> or an IP address won&#x27;t be considered a valid
part of node name.</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.region = us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.access_key_id = ANIDEXAMPLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.secret_key = WjalrxuTnFEMI/K7MDENG+bPxRfiCYEXAMPLEKEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.use_autoscaling_group = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.aws.use_private_ip = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-k8s">Peer Discovery on Kubernetes<a href="#peer-discovery-k8s" class="hash-link" aria-label="Direct link to Peer Discovery on Kubernetes" title="Direct link to Peer Discovery on Kubernetes">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-peer-discovery-overview">Kubernetes Peer Discovery Overview<a href="#kubernetes-peer-discovery-overview" class="hash-link" aria-label="Direct link to Kubernetes Peer Discovery Overview" title="Direct link to Kubernetes Peer Discovery Overview">​</a></h3>
<p>A <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a>-based discovery mechanism
is available via <a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_peer_discovery_k8s" target="_blank" rel="noopener noreferrer">a plugin</a>.</p>
<p>As with any <a href="/rabbitmq-website/docs/4.0/plugins">plugin</a>, it must be enabled before it
can be used. For peer discovery plugins it means they must be <a href="/rabbitmq-website/docs/4.0/plugins#basics">enabled</a>
or <a href="/rabbitmq-website/docs/4.0/plugins#enabled-plugins-file">preconfigured</a> before first node boot:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token parameter variable" style="color:#36acaa">--offline</span><span class="token plain"> </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_peer_discovery_k8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="important-prerequisites-and-deployment-considerations">Important: Prerequisites and Deployment Considerations<a href="#important-prerequisites-and-deployment-considerations" class="hash-link" aria-label="Direct link to Important: Prerequisites and Deployment Considerations" title="Direct link to Important: Prerequisites and Deployment Considerations">​</a></h3>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>The recommended option for deploying RabbitMQ to Kubernetes is the <a href="/rabbitmq-website/kubernetes/operator/operator-overview">RabbitMQ Kubernetes Cluster Operator</a>.</p><p>It follows the recommendations listed below.</p></div></div>
<p>With this mechanism, nodes fetch a list of their peers from
a Kubernetes API endpoint using a set of configured values:
a URI scheme, host, port, as well as the token and certificate paths.</p>
<p>If the recommended option of the <a href="/rabbitmq-website/kubernetes/operator/operator-overview">RabbitMQ Kubernetes Cluster Operator</a> cannot be used,
there are several prerequisites and deployment choices that must be taken into
account when deploying RabbitMQ to Kubernetes, with this peer discovery mechanism
and in general.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="use-a-stateful-set">Use a Stateful Set<a href="#use-a-stateful-set" class="hash-link" aria-label="Direct link to Use a Stateful Set" title="Direct link to Use a Stateful Set">​</a></h4>
<p>A RabbitMQ cluster deployed to Kubernetes will use a set of pods. The set must be a <a href="https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/#statefulset" target="_blank" rel="noopener noreferrer">stateful set</a>.
A <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#limitations" target="_blank" rel="noopener noreferrer">headless service</a> must be used to
control <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener noreferrer">network identity of the pods</a>
(their hostnames), which in turn affect RabbitMQ node names.
On the headless service <code>spec</code>, field <code>publishNotReadyAddresses</code> must be set to <code>true</code> to propagate SRV DNS records for its Pods for the purpose of peer discovery.</p>
<p>In addition, since RabbitMQ nodes <a href="/rabbitmq-website/docs/4.0/clustering#hostname-resolution-requirement">resolve their own and peer hostnames during boot</a>,
CoreDNS <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#stable-network-id" target="_blank" rel="noopener noreferrer">caching timeout may need to be decreased</a> from default 30 seconds
to a value in the 5-10 second range.</p>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>CoreDNS <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#stable-network-id" target="_blank" rel="noopener noreferrer">caching timeout may need to be decreased</a>
from default 30 seconds to a value in the 5-10 second range</p></div></div>
<p>If a stateless set is used recreated nodes will not have their persisted data and will start as blank nodes.
This can lead to data loss and higher network traffic volume due to more frequent
data synchronisation of both <a href="/rabbitmq-website/docs/4.0/quorum-queues">quorum queues</a>
and <a href="/rabbitmq-website/docs/4.0/streams">streams</a> on newly joining nodes.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="use-persistent-volumes">Use Persistent Volumes<a href="#use-persistent-volumes" class="hash-link" aria-label="Direct link to Use Persistent Volumes" title="Direct link to Use Persistent Volumes">​</a></h4>
<p>How <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener noreferrer">storage is configured</a>
is generally orthogonal to peer discovery. However, it does not make sense to run a stateful
data service such as RabbitMQ with <a href="/rabbitmq-website/docs/4.0/relocate">node data directory</a> stored on a transient volume.
Use of transient volumes can lead nodes to not have their persisted data after a restart.
This has the same consequences as with stateless sets covered above.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="make-sure-etcrabbitmq-is-mounted-as-writeable">Make Sure <code>/etc/rabbitmq</code> is Mounted as Writeable<a href="#make-sure-etcrabbitmq-is-mounted-as-writeable" class="hash-link" aria-label="Direct link to make-sure-etcrabbitmq-is-mounted-as-writeable" title="Direct link to make-sure-etcrabbitmq-is-mounted-as-writeable">​</a></h4>
<p>RabbitMQ nodes and images may need to update a file under <code>/etc/rabbitmq</code>, the default <a href="/rabbitmq-website/docs/4.0/configure#config-location">configuration file location</a> on Linux. This may involve configuration file generation
performed by the image used, <a href="/rabbitmq-website/docs/4.0/plugins#enabled-plugins-file">enabled plugins file</a> updates,
and so on.</p>
<p>It is therefore highly recommended that <code>/etc/rabbitmq</code> is mounted as writeable and owned by
RabbitMQ&#x27;s effective user (typically <code>rabbitmq</code>).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="use-parallel-podmanagementpolicy">Use Parallel podManagementPolicy<a href="#use-parallel-podmanagementpolicy" class="hash-link" aria-label="Direct link to Use Parallel podManagementPolicy" title="Direct link to Use Parallel podManagementPolicy">​</a></h4>
<p><code>podManagementPolicy: &quot;Parallel&quot;</code> is the recommended option for RabbitMQ clusters.</p>
<p>Because of <a href="/rabbitmq-website/docs/4.0/clustering#restarting">how nodes rejoin their cluster</a>, <code>podManagementPolicy</code> set to <code>OrderedReady</code>
can lead to a deployment deadlock with certain readiness probes:</p>
<ul>
<li>Kubernetes will expect the first node to pass a readiness probe</li>
<li>The readiness probe may require a fully booted node</li>
<li>The node will fully boot after it detects that its peers have come online</li>
<li>Kubernetes will not start any more pods until the first one boots</li>
<li>The deployment therefore is deadlocked</li>
</ul>
<p><code>podManagementPolicy: &quot;Parallel&quot;</code> avoids this problem, and the Kubernetes peer discovery plugin
then deals with the <a href="#initial-formation-race-condition">natural race condition present during parallel cluster formation</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="use-most-basic-health-checks-for-rabbitmq-pod-readiness-probes">Use Most Basic Health Checks for RabbitMQ Pod Readiness Probes<a href="#use-most-basic-health-checks-for-rabbitmq-pod-readiness-probes" class="hash-link" aria-label="Direct link to Use Most Basic Health Checks for RabbitMQ Pod Readiness Probes" title="Direct link to Use Most Basic Health Checks for RabbitMQ Pod Readiness Probes">​</a></h4>
<p>A readiness probe that expects the node to be fully booted and have rejoined its cluster peers
can deadlock a deployment that restarts all RabbitMQ pods and relies on the <code>OrderedReady</code> pod management policy.
Deployments that use the <code>Parallel</code> pod management policy
will not be affected.</p>
<p>One health check that does not expect a node to be fully booted and have schema tables synced is</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># a very basic check that will succeed for the nodes that are currently waiting for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># a peer to sync schema from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-diagnostics </span><span class="token function" style="color:#d73a49">ping</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This basic check would allow the deployment to proceed and the nodes to eventually rejoin each other,
assuming they are <a href="/rabbitmq-website/docs/4.0/upgrade">compatible</a>.</p>
<p>See <a href="/rabbitmq-website/docs/4.0/clustering#restarting-schema-sync">Schema Syncing from Online Peers</a> in the <a href="/rabbitmq-website/docs/4.0/clustering">Clustering guide</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="examples">Examples<a href="#examples" class="hash-link" aria-label="Direct link to Examples" title="Direct link to Examples">​</a></h3>
<p>A minimalistic <a href="https://github.com/rabbitmq/diy-kubernetes-examples" target="_blank" rel="noopener noreferrer">runnable example of Kubernetes peer discovery</a>
mechanism can be found on GitHub.</p>
<p>The example can be run using either MiniKube or Kind.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-2">Configuration<a href="#configuration-2" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>To use Kubernetes for peer discovery, set the <code>cluster_formation.peer_discovery_backend</code>
to <code>k8s</code> or <code>kubernetes</code> or its module name, <code>rabbit_peer_discovery_k8s</code>
(note: the name of the module is slightly different from plugin name):</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the backend can also be specified using its module name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Kubernetes API hostname (or IP address). Default value is kubernetes.default.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-endpoint">Kubernetes API Endpoint<a href="#kubernetes-api-endpoint" class="hash-link" aria-label="Direct link to Kubernetes API Endpoint" title="Direct link to Kubernetes API Endpoint">​</a></h4>
<p>It is possible to configure Kubernetes API port and URI scheme:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 443 is used by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.port = 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https is used by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.scheme = https</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-access-token">Kubernetes API Access Token<a href="#kubernetes-api-access-token" class="hash-link" aria-label="Direct link to Kubernetes API Access Token" title="Direct link to Kubernetes API Access Token">​</a></h4>
<p>Kubernetes token file path is configurable via <code>cluster_formation.k8s.token_path</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default value is /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.token_path = /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It must point to a local file that exists and is readable by RabbitMQ.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-namespace">Kubernetes Namespace<a href="#kubernetes-namespace" class="hash-link" aria-label="Direct link to Kubernetes Namespace" title="Direct link to Kubernetes Namespace">​</a></h4>
<p><code>cluster_formation.k8s.namespace_path</code> controls when the K8S namespace is loaded from:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Default value: /var/run/secrets/kubernetes.io/serviceaccount/namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.namespace_path = /var/run/secrets/kubernetes.io/serviceaccount/namespace</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Just like with the token path key, <code>cluster_formation.k8s.namespace_path</code> must point to a local
file that exists and is readable by RabbitMQ.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-ca-certificate-bundle">Kubernetes API CA Certificate Bundle<a href="#kubernetes-api-ca-certificate-bundle" class="hash-link" aria-label="Direct link to Kubernetes API CA Certificate Bundle" title="Direct link to Kubernetes API CA Certificate Bundle">​</a></h4>
<p>Kubernetes API <a href="/rabbitmq-website/docs/4.0/ssl#certificates-and-keys">CA certificate bundle</a> file path is
configured using <code>cluster_formation.k8s.cert_path</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Where to load the K8S API access token from.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Default value: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.token_path = /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Where to load K8S API CA bundle file from. It will be used when issuing requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># to the K8S API using HTTPS.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Default value: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.cert_path = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Just like with the token path key, <code>cluster_formation.k8s.cert_path</code> must point to a local
file that exists and is readable by RabbitMQ.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="peer-node-pods-can-use-hostnames-or-ip-addresses">Peer Node Pods Can Use Hostnames or IP Addresses<a href="#peer-node-pods-can-use-hostnames-or-ip-addresses" class="hash-link" aria-label="Direct link to Peer Node Pods Can Use Hostnames or IP Addresses" title="Direct link to Peer Node Pods Can Use Hostnames or IP Addresses">​</a></h4>
<p>When a list of peer nodes is computed from a list of pod containers returned by Kubernetes,
either hostnames or IP addresses can be used. This is configurable using the
<code>cluster_formation.k8s.address_type</code> key:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.token_path = /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.cert_path = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.namespace_path = /var/run/secrets/kubernetes.io/serviceaccount/namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># should result set use hostnames or IP addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># of Kubernetes API-reported containers?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># supported values are &quot;hostname&quot; and &quot;ip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.address_type = hostname</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Supported values are <code>ip</code> or <code>hostname</code>. <code>hostname</code> is
the recommended option but has limitations: it can only be used with <a href="https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/#statefulset" target="_blank" rel="noopener noreferrer">stateful sets</a> (also highly recommended)
and <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" target="_blank" rel="noopener noreferrer">headless services</a>.
<code>ip</code> is used by default for better compatibility.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="peer-node-pod-name-suffix">Peer Node Pod Name Suffix<a href="#peer-node-pod-name-suffix" class="hash-link" aria-label="Direct link to Peer Node Pod Name Suffix" title="Direct link to Peer Node Pod Name Suffix">​</a></h5>
<p>It is possible to append a suffix to peer hostnames returned by Kubernetes using
<code>cluster_formation.k8s.hostname_suffix</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.token_path = /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.cert_path = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.namespace_path = /var/run/secrets/kubernetes.io/serviceaccount/namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># no suffix is appended by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.hostname_suffix = rmq.eng.example.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Service name is <code>rabbitmq</code> by default but can be overridden using the
<code>cluster_formation.k8s.service_name</code> key if needed:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.host = kubernetes.default.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.token_path = /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.cert_path = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.namespace_path = /var/run/secrets/kubernetes.io/serviceaccount/namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># overrides Kubernetes service name. Default value is &quot;rabbitmq&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.k8s.service_name = rmq-qa</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-consul">Peer Discovery Using Consul<a href="#peer-discovery-consul" class="hash-link" aria-label="Direct link to Peer Discovery Using Consul" title="Direct link to Peer Discovery Using Consul">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consul-peer-discovery-overview">Consul Peer Discovery Overview<a href="#consul-peer-discovery-overview" class="hash-link" aria-label="Direct link to Consul Peer Discovery Overview" title="Direct link to Consul Peer Discovery Overview">​</a></h3>
<p>A <a href="https://www.consul.io" target="_blank" rel="noopener noreferrer">Consul</a>-based discovery mechanism
is available via <a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_peer_discovery_consul" target="_blank" rel="noopener noreferrer">a plugin</a>.</p>
<p>As with any <a href="/rabbitmq-website/docs/4.0/plugins">plugin</a>, it must be enabled before it
can be used. For peer discovery plugins it means they must be <a href="/rabbitmq-website/docs/4.0/plugins#basics">enabled</a>
or <a href="/rabbitmq-website/docs/4.0/plugins#enabled-plugins-file">preconfigured</a> before first node boot:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token parameter variable" style="color:#36acaa">--offline</span><span class="token plain"> </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_peer_discovery_consul</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The plugin supports Consul 0.8.0 and later versions.</p>
<p>Nodes register with Consul on boot and unregister when they
leave. Prior to registration, nodes will attempt to acquire a
lock in Consul to reduce the probability of a <a href="#initial-formation-race-condition">race condition
during initial cluster formation</a>.
When a node registers with Consul, it will set up a periodic <a href="https://www.consul.io/docs/agent/checks.html" target="_blank" rel="noopener noreferrer">health
check</a> for itself (more on this below).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-3">Configuration<a href="#configuration-3" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>To use Consul for peer discovery, set the <code>cluster_formation.peer_discovery_backend</code>
to <code>consul</code> or its module name, <code>rabbit_peer_discovery_consul</code> (note: the name of the module is
slightly different from plugin name):</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the backend can also be specified using its module name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Consul host (hostname or IP address). Default value is localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="consul-endpoint">Consul Endpoint<a href="#consul-endpoint" class="hash-link" aria-label="Direct link to Consul Endpoint" title="Direct link to Consul Endpoint">​</a></h4>
<p>It is possible to configure Consul port and URI scheme:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 8500 is used by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.port = 8500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># http is used by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.scheme = http</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="consul-acl-token">Consul ACL Token<a href="#consul-acl-token" class="hash-link" aria-label="Direct link to Consul ACL Token" title="Direct link to Consul ACL Token">​</a></h4>
<p>To configure <a href="https://www.consul.io/docs/guides/acl.html" target="_blank" rel="noopener noreferrer">Consul ACL</a> token,
use <code>cluster_formation.consul.acl_token</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.acl_token = acl-token-value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Service name (as registered in Consul) defaults to &quot;rabbitmq&quot; but can be overridden:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># rabbitmq is used by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc = rabbitmq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="service-address">Service Address<a href="#service-address" class="hash-link" aria-label="Direct link to Service Address" title="Direct link to Service Address">​</a></h4>
<p>Service hostname (address) as registered in Consul will be fetched by peers
and therefore must resolve on all nodes.
The hostname can be computed by the plugin or specified by the user. When computed automatically,
a number of nodes and OS properties can be used:</p>
<ul>
<li>Hostname (as returned by <code>gethostname(2)</code>)</li>
<li>Node name (without the <code>rabbit@</code> prefix)</li>
<li>IP address of an NIC (network controller interface)</li>
</ul>
<p>When <code>cluster_formation.consul.svc_addr_auto</code> is set to <code>false</code>,
service name will be taken as is from <code>cluster_formation.consul.svc_addr</code>.
When it is set to <code>true</code>, other options explained below come into play.</p>
<p>In the following example, the service address reported to Consul is
hardcoded to <code>hostname1.rmq.eng.example.local</code> instead of being computed automatically
from the environment:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc = rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># do not compute service address, it will be specified below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_auto = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># service address, will be communicated to other nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr = hostname1.rmq.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use long RabbitMQ node names?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.use_longname = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, the service address reported to Consul is
parsed from node name (the <code>rabbit@</code> prefix will be dropped):</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc = rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># do compute service address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_auto = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># compute service address using node name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_use_nodename = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use long RabbitMQ node names?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.use_longname = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>cluster_formation.consul.svc_addr_use_nodename</code> is a boolean
field that instructs Consul peer discovery backend to compute service address
using RabbitMQ node name.</p>
<p>In the next example, the service address is
computed using hostname as reported by the OS instead of node name:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc = rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># do compute service address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_auto = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># compute service address using host name and not node name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_use_nodename = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use long RabbitMQ node names?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.use_longname = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the example below, the service address is
computed by taking the IP address of a provided NIC, <code>en0</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc = rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># do compute service address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_auto = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># compute service address using the IP address of a NIC, en0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_nic = en0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_use_nodename = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use long RabbitMQ node names?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.use_longname = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="service-port">Service Port<a href="#service-port" class="hash-link" aria-label="Direct link to Service Port" title="Direct link to Service Port">​</a></h4>
<p>Service port as registered in Consul can be overridden. This is only
necessary if RabbitMQ uses a <a href="/rabbitmq-website/docs/4.0/networking">non-standard port</a>
for client (technically AMQP 0-9-1 and AMQP 1.0) connections since default value is 5672.</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 5672 is used by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_port = 6674</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="service-tags-and-metadata">Service Tags and Metadata<a href="#service-tags-and-metadata" class="hash-link" aria-label="Direct link to Service Tags and Metadata" title="Direct link to Service Tags and Metadata">​</a></h4>
<p>It is possible to provide <a href="https://www.consul.io/docs/agent/./services" target="_blank" rel="noopener noreferrer">Consul service tags</a>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Define tags for the RabbitMQ service: &quot;qa&quot; and &quot;3.8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_tags.1 = qa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_tags.2 = 3.8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is possible to configure <a href="https://www.consul.io/docs/agent/./services" target="_blank" rel="noopener noreferrer">Consul service metadata</a>,
which is a map of string keys to string values with certain restrictions
(see Consul documentation to learn more):</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Define metadata for the RabbitMQ service. Both keys and values have a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># maximum length limit enforced by Consul. This can be used to provide additional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># context about the service (RabbitMQ cluster) for operators or other tools.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_meta.owner = team-xyz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_meta.service = service-one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_meta.stats_url = https://service-one.eng.megacorp.local/stats/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="service-health-checks">Service Health Checks<a href="#service-health-checks" class="hash-link" aria-label="Direct link to Service Health Checks" title="Direct link to Service Health Checks">​</a></h4>
<p>When a node registers with Consul, it will set up a periodic <a href="https://www.consul.io/docs/agent/checks.html" target="_blank" rel="noopener noreferrer">health check</a>
for itself. Online nodes will periodically send a health check update to Consul to indicate the service
is available. This interval can be configured:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># health check interval (node TTL) in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_ttl = 40</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A node that failed its <a href="https://www.consul.io/docs/agent/checks.html" target="_blank" rel="noopener noreferrer">health check</a> is considered
to be in the warning state by Consul.
Such nodes can be automatically unregistered by Consul after a
period of time (note: this is a separate interval value from
the TTL above). The period cannot be less than 60 seconds.</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># health check interval (node TTL) in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_ttl = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># how soon should nodes that fail their health checks be unregistered by Consul?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># this value is in seconds and must not be lower than 60 (a Consul requirement)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.deregister_after = 90</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Please see a section on <a href="#node-health-checks-and-cleanup">automatic cleanup of nodes</a> below.</p>
<p>Nodes in the warning state are excluded from peer discovery results
by default. It is possible to opt into including them by setting
<code>cluster_formation.consul.include_nodes_with_warnings</code> to
<code>true</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># health check interval (node TTL) in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_ttl = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># include node in the warning state into discovery result set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.include_nodes_with_warnings = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="opting-out-of-regisration">Opting Out of Regisration<a href="#opting-out-of-regisration" class="hash-link" aria-label="Direct link to Opting Out of Regisration" title="Direct link to Opting Out of Regisration">​</a></h4>
<p>If the configured backend supports registration,
nodes unregister when they are instructed to stop.</p>
<p>It is possible to opt-out of registration completely with the config option
<code>cluster_formation.registration.enabled</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.registration.enabled = false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When configured this way, the node has to be registered manually or using another mechanism,
e.g. by a container orchestrator such as <a href="https://developer.hashicorp.com/nomad/integrations/hashicorp/rabbitmq" target="_blank" rel="noopener noreferrer">Nomad</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="node-name-suffixes">Node Name Suffixes<a href="#node-name-suffixes" class="hash-link" aria-label="Direct link to Node Name Suffixes" title="Direct link to Node Name Suffixes">​</a></h4>
<p>If node name is computed and long node names are used, it is possible to
append a suffix to node names retrieved from Consul. The format is
<code>.node.{domain_suffix}</code>. This can be useful in environments with
DNS conventions, e.g. when all service nodes
are organised in a separate subdomain. Here&#x27;s an example:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc = rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># do compute service address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_auto = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># compute service address using node name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.svc_addr_use_nodename = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use long RabbitMQ node names?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.use_longname = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># append a suffix (node.rabbitmq.example.local) to node names retrieved from Consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.domain_suffix = example.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this setup node names will be computed to <code>rabbit@192.168.100.1.node.example.local</code>
instead of <code>rabbit@192.168.100.1</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="distributed-lock-acquisition">Distributed Lock Acquisition<a href="#distributed-lock-acquisition" class="hash-link" aria-label="Direct link to Distributed Lock Acquisition" title="Direct link to Distributed Lock Acquisition">​</a></h4>
<p>When a node tries to acquire a lock on boot and the lock is already taken,
it will wait for the lock to become available for a limited amount of time. Default value is 300
seconds but it can be configured:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># lock acquisition timeout in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default: 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.consul.lock_wait_time is an alias</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.lock_timeout = 60</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lock key prefix is <code>rabbitmq</code> by default. It can also be overridden:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.host = consul.eng.example.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.lock_timeout = 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># should the Consul key used for locking be prefixed with something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># other than &quot;rabbitmq&quot;?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.consul.lock_prefix = environments-qa</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peer-discovery-etcd">Peer Discovery Using Etcd<a href="#peer-discovery-etcd" class="hash-link" aria-label="Direct link to Peer Discovery Using Etcd" title="Direct link to Peer Discovery Using Etcd">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="etcd-peer-discovery-overview">Etcd Peer Discovery Overview<a href="#etcd-peer-discovery-overview" class="hash-link" aria-label="Direct link to Etcd Peer Discovery Overview" title="Direct link to Etcd Peer Discovery Overview">​</a></h3>
<p>An <a href="https://etcd.io/" target="_blank" rel="noopener noreferrer">etcd</a>-based discovery mechanism
is available via <a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_peer_discovery_etcd" target="_blank" rel="noopener noreferrer">a plugin</a>.</p>
<p>As of RabbitMQ <code>3.8.4</code>, the plugin uses a v3 API, gRPC-based etcd client and
<strong>requires etcd 3.4 or a later version</strong>.</p>
<p>As with any <a href="/rabbitmq-website/docs/4.0/plugins">plugin</a>, it must be enabled before it
can be used. For peer discovery plugins it means they must be <a href="/rabbitmq-website/docs/4.0/plugins#basics">enabled</a>
or <a href="/rabbitmq-website/docs/4.0/plugins#enabled-plugins-file">preconfigured</a> before first node boot:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token parameter variable" style="color:#36acaa">--offline</span><span class="token plain"> </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_peer_discovery_etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nodes register with etcd on boot by creating a key in a conventionally named directory. The keys have
a short (say, a minute) expiration period. The keys are deleted when nodes stop cleanly.</p>
<p>Prior to registration, nodes will attempt to acquire a
lock in etcd to reduce the probability of a <a href="#initial-formation-race-condition">race condition
during initial cluster formation</a>.</p>
<p>Every node&#x27;s key has an associated <a href="https://etcd.io/docs/v3.4.0/dev-guide/interacting_v3/#grant-leases" target="_blank" rel="noopener noreferrer">lease</a>
with a configurable TTL. Nodes keep their key&#x27;s leases alive.
If a node loses connectivity and cannot update its lease, its key will be cleaned up by etcd after TTL expires.
Such nodes won&#x27;t be discovered by newly joining nodes.
If configured, such nodes can be forcefully removed from the cluster.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-4">Configuration<a href="#configuration-4" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="etcd-endpoints-and-authentication">etcd Endpoints and Authentication<a href="#etcd-endpoints-and-authentication" class="hash-link" aria-label="Direct link to etcd Endpoints and Authentication" title="Direct link to etcd Endpoints and Authentication">​</a></h4>
<p>To use etcd for peer discovery, set the <code>cluster_formation.peer_discovery_backend</code>
to <code>etcd</code> or its module name, <code>rabbit_peer_discovery_etcd</code> (note: the name of the module
is slightly different from plugin name).</p>
<p>The plugin requires a configured etcd endpoint for the plugin
to connect to:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the backend can also be specified using its module name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># etcd endpoints. This property is required or peer discovery won&#x27;t be performed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is possible to configure multiple etcd endpoints. The first randomly
chosen one that the plugin can successfully connect to will be used.</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.3 = three.etcd.eng.example.local:2579</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If <a href="https://etcd.io/docs/v3.4.0/op-guide/authentication/" target="_blank" rel="noopener noreferrer">authentication is enabled for etcd</a>, the plugin can be configured to use
a pair of credentials:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.3 = three.etcd.eng.example.local:2579</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.username = rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.password = s3kR37</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is possible to use <a href="/rabbitmq-website/docs/4.0/configure#advanced-config-file">advanced.config</a> file to <a href="/rabbitmq-website/docs/4.0/configure#configuration-encryption">encrypt the password value</a>
listed in the config. In this case all plugin settings must be moved to the advanced config:</p>
<div class="language-erlang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-erlang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">%% advanced.config file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">rabbit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">cluster_formation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">peer_discovery_etcd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">endpoints</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token string" style="color:#e3116c">&quot;one.etcd.eng.example.local:2379&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token string" style="color:#e3116c">&quot;two.etcd.eng.example.local:2479&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token string" style="color:#e3116c">&quot;three.etcd.eng.example.local:2579&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">etcd_prefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;rabbitmq&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">cluster_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">etcd_username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd user&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">etcd_password</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">encrypted</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">&quot;cPAymwqmMnbPXXRVqVzpxJdrS8mHEKuo2V+3vt1u/fymexD9oztQ2G/oJ4PAaSb2c5N/hRJ2aqP/X0VAfx8xOQ==&quot;</span><span class="token punctuation" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">config_entry_decoder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">{</span><span class="token atom">passphrase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">&quot;decryption key passphrase&quot;</span><span class="token punctuation" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="key-naming">Key Naming<a href="#key-naming" class="hash-link" aria-label="Direct link to Key Naming" title="Direct link to Key Naming">​</a></h4>
<p>Directories and keys used by the peer discovery mechanism follow a naming scheme.
Since in etcd <a href="https://etcd.io/docs/v3.4.0/rfc/v3api/" target="_blank" rel="noopener noreferrer">v3 API the key space is flat</a>,
a hardcoded prefix is used. It allows the plugin to predictably perform key range queries
using a well-known prefix:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># for node presence keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/rabbitmq/discovery/{prefix}/clusters/{cluster name}/nodes/{node name}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># for registration lock keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/rabbitmq/locks/{prefix}/clusters/{cluster name}/registration</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here&#x27;s an example of a key that would be used by node <code>rabbit@hostname1</code>
with default user-provided key prefix and cluster name:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/rabbitmq/discovery/rabbitmq/clusters/default/nodes/rabbit@hostname1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Default key prefix is simply &quot;rabbitmq&quot;. It rarely needs overriding but that&#x27;s
supported:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.3 = three.etcd.eng.example.local:2579</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># rabbitmq is used by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.key_prefix = rabbitmq_discovery</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If multiple RabbitMQ clusters share an etcd installation, each cluster must use
a unique name:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.3 = three.etcd.eng.example.local:2579</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default name: &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.cluster_name = staging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="key-leases-and-ttl">Key Leases and TTL<a href="#key-leases-and-ttl" class="hash-link" aria-label="Direct link to Key Leases and TTL" title="Direct link to Key Leases and TTL">​</a></h4>
<p>Key used for node registration will have a lease with a TTL associated with them.
Online nodes will periodically keep the leases alive (refresh). The TTL value can be configured:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.3 = three.etcd.eng.example.local:2579</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># node TTL in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.node_ttl = 40</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Key leases are updated periodically while the node is running and the plugin
remains enabled.</p>
<p>It is possible to forcefully remove the nodes that fail to refresh their keys from the cluster.
This is covered later in this guide.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="locks">Locks<a href="#locks" class="hash-link" aria-label="Direct link to Locks" title="Direct link to Locks">​</a></h4>
<p>When a node tries to acquire a lock on boot and the lock is already taken,
it will wait for the lock to become available for a limited amount of time. Default value is 300
seconds but it can be configured:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># lock acquisition timeout in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># default: 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cluster_formation.consul.lock_wait_time is an alias</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.lock_timeout = 60</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="inspecting-keys">Inspecting Keys<a href="#inspecting-keys" class="hash-link" aria-label="Direct link to Inspecting Keys" title="Direct link to Inspecting Keys">​</a></h4>
<p>In order to list all keys used by the etcd-based peer discovery mechanism, use <code>etcdctl get</code> like so:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">etcdctl get </span><span class="token parameter variable" style="color:#36acaa">--prefix</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token string" style="color:#e3116c">&quot;/rabbitmq&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tls">TLS<a href="#tls" class="hash-link" aria-label="Direct link to TLS" title="Direct link to TLS">​</a></h4>
<p>It is possible to configure the plugin to <a href="/rabbitmq-website/docs/4.0/ssl">use TLS</a> when connecting to etcd.
TLS will be enabled if any of the TLS options listed below are configured, otherwise
connections will use &quot;plain TCP&quot; without TLS.</p>
<p>The plugin acts as a TLS client. A <a href="/rabbitmq-website/docs/4.0/ssl#peer-verification">trusted CA certificate</a> file must
be provided as well as a client certificate and private key pair:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># trusted CA certificate file path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.cacertfile = /path/to/ca_certificate.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># client certificate (public key) file path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.certfile   = /path/to/client_certificate.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># client private key file path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.keyfile    = /path/to/client_key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use TLSv1.2 for connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.versions.1 = tlsv1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># enables peer verification (the plugin will verify the certificate chain of the server)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.verify               = verify_peer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.fail_if_no_peer_cert = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>More <a href="/rabbitmq-website/docs/4.0/ssl">TLS options</a> are supported such as cipher suites and
client-side session renegotiation options:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.peer_discovery_backend = etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.1 = one.etcd.eng.example.local:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.endpoints.2 = two.etcd.eng.example.local:2479</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># trusted CA certificate file path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.cacertfile = /path/to/ca_certificate.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># client certificate (public key) file path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.certfile   = /path/to/client_certificate.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># client private key file path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.keyfile    = /path/to/client_key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use TLSv1.2 for connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.versions.1 = tlsv1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># enables peer verification (the plugin will verify the certificate chain of the server)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.verify               = verify_peer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.fail_if_no_peer_cert = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use secure session renegotiation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.secure_renegotiate   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Explicitly list enabled cipher suites. This can break connectivity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and is not necessary most of the time.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.1  = ECDHE-ECDSA-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.2  = ECDHE-RSA-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.3  = ECDH-ECDSA-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.4  = ECDH-RSA-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.5  = DHE-RSA-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.6  = DHE-DSS-AES256-GCM-SHA384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.7  = ECDHE-ECDSA-AES128-GCM-SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.8  = ECDHE-RSA-AES128-GCM-SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.9  = ECDH-ECDSA-AES128-GCM-SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.10 = ECDH-RSA-AES128-GCM-SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.11 = DHE-RSA-AES128-GCM-SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.etcd.ssl_options.ciphers.12 = DHE-DSS-AES128-GCM-SHA256</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="initial-formation-race-condition">Race Conditions During Initial Cluster Formation<a href="#initial-formation-race-condition" class="hash-link" aria-label="Direct link to Race Conditions During Initial Cluster Formation" title="Direct link to Race Conditions During Initial Cluster Formation">​</a></h2>
<p>For successful cluster formation, only one node should form the cluster initially, that is,
start as a standalone node and initializing its database. If this was not the case, multiple
clusters would be formed instead of just one, violating operator expectations.</p>
<p>Consider a deployment where the entire cluster is provisioned at once and all nodes start in parallel.
In this case, a natural race condition occurs between the starting nodes.
To prevent multiple nodes forming separate clusters, peer discovery backends try to acquire a lock when either
forming the cluster (seeding) or joining a peer. What locks are used varies from backend to backend:</p>
<ul>
<li>Classic config file, K8s, and AWS backends use a built-in <a href="https://erlang.org/doc/man/global.html#set_lock-3" target="_blank" rel="noopener noreferrer">locking library</a> provided by the runtime</li>
<li>The Consul peer discovery backend sets a lock in Consul</li>
<li>The etcd peer discovery backend sets a lock in etcd</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="node-health-checks-and-cleanup">Node Health Checks and Forced Removal<a href="#node-health-checks-and-cleanup" class="hash-link" aria-label="Direct link to Node Health Checks and Forced Removal" title="Direct link to Node Health Checks and Forced Removal">​</a></h2>
<p>Nodes in clusters formed using peer discovery can fail, become unavailable or be permanently
removed (decommissioned). Some operators may want such nodes to be automatically removed
from the cluster after a period of time. Such automated forced removal also can produce
unforeseen side effects, so RabbitMQ does not enforce this behavior. It <strong>should be used
with great care</strong> and only if the side effects are fully understood and considered.</p>
<p>For example, consider a cluster that uses the AWS backend configured to use autoscaling group membership.
If an EC2 instance in that group fails and is later re-created as a new node, its original &quot;incarnation&quot;
will be considered a separate, now permanently unavailable node in the same cluster.</p>
<p>With peer discovery backends that offer dynamic node management (as opposed to, say, a fixed list of nodes
in the configuration file), such unknown nodes can be logged or forcefully removed from the cluster.</p>
<p>They are</p>
<ul>
<li><a href="#peer-discovery-aws">AWS (EC2)</a></li>
<li><a href="#peer-discovery-k8s">Kubernetes</a></li>
<li><a href="#peer-discovery-consul">Consul</a></li>
<li><a href="#peer-discovery-etcd">etcd</a></li>
</ul>
<p>Forced node removal can be dangerous and should be carefully considered. For example,
a node that&#x27;s temporarily unavailable but will be rejoining (or recreated with its
persistent storage re-attached from its previous incarnation) can be kicked
out of the cluster permanently by automatic cleanup, thus failing to rejoin.</p>
<p>Before enabling the configuration keys covered below make sure that a compatible
peer discovery plugin is enabled. If that&#x27;s not the case the node will report
the settings to be unknown and will fail to start.</p>
<p>To log warnings for the unknown nodes,
<code>cluster_formation.node_cleanup.only_log_warning</code> should be set to
<code>true</code>:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Don&#x27;t remove cluster members unknown to the peer discovery backend but log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># warnings.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This setting can only be used if a compatible peer discovery plugin is enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.node_cleanup.only_log_warning = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is the default behavior.</p>
<p>To forcefully delete the unknown nodes from the cluster,
<code>cluster_formation.node_cleanup.only_log_warning</code> should be set to
<code>false</code>.</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Forcefully remove cluster members unknown to the peer discovery backend. Once removed,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the nodes won&#x27;t be able to rejoin. Use this mode with great care!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This setting can only be used if a compatible peer discovery plugin is enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.node_cleanup.only_log_warning = false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that this option should be used with care, in particular
with discovery backends other than AWS.</p>
<p>The cleanup checks are performed periodically. The interval is 60 seconds
by default and can be overridden:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># perform the check every 90 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.node_cleanup.interval = 90</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Some backends (Consul, etcd) support node health checks or TTL. These checks
should not to be confused with <a href="/rabbitmq-website/docs/4.0/monitoring#health-checks">monitoring health checks</a>.
They allow peer discovery services (such as etcd or Consul) keep track of what
nodes are still around (have checked in recently).</p>
<p>With service discovery health checks, nodes set a TTL on their keys and/or periodically
notify their respective discovery service that they are still present. If no notifications
from a node come in after a period of time, the node&#x27;s key will eventually expire (with
Consul, such nodes will be considered to be in a warning state).</p>
<p>With etcd, such nodes will no longer show up in discovery results. With Consul,
they can either be removed (deregistered) or their warning state can be
reported. Please see documentation for those backends to learn more.</p>
<p>Automatic cleanup of absent nodes makes most sense in environments where failed/discontinued nodes
will be replaced with brand new ones (including cases when persistent storage won&#x27;t be re-attached).</p>
<p>When automatic node cleanup is deactivated (switched to the warning mode), operators have to
explicitly remove absent cluster nodes using <a href="/rabbitmq-website/docs/4.0/cli"><code>rabbitmqctl forget_cluster_node</code></a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative-side-effects-of-automatic-removal">Negative Side Effects of Automatic Removal<a href="#negative-side-effects-of-automatic-removal" class="hash-link" aria-label="Direct link to Negative Side Effects of Automatic Removal" title="Direct link to Negative Side Effects of Automatic Removal">​</a></h3>
<p>Automatic node removal has a number of negative side effects operators should be aware of.
A node that&#x27;s temporarily unreachable, for example, because it&#x27;s lost connectivity
to the rest of the network or its VM was temporarily suspended, will be removed and will
then come back. Such node won&#x27;t be able to <a href="#rejoining">rejoin its cluster</a> and will
log a similar message:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Node &#x27;rabbit@node1.local&#x27; thinks it&#x27;s clustered with node &#x27;rabbit@node2.local&#x27;, but &#x27;rabbit@node2.local&#x27; disagrees</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In addition, such nodes can begin to fail their <a href="/rabbitmq-website/docs/4.0/monitoring#health-checks">monitoring health checks</a>,
as they would be in a permanent &quot;partitioned off&quot; state. Even though such nodes might have been
replaced with a new one and the cluster would be operating as expected, such automatically removed
and replaced nodes can produce monitoring false positives.</p>
<p>The list of side effects is not limited to those two scenarios but they all have the same
root cause: an automatically removed node can come back without realising that it&#x27;s been kicked out
of its cluster. Monitoring systems and operators won&#x27;t be immediately aware of that event either.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="discovery-retries">Peer Discovery Failures and Retries<a href="#discovery-retries" class="hash-link" aria-label="Direct link to Peer Discovery Failures and Retries" title="Direct link to Peer Discovery Failures and Retries">​</a></h2>
<p>In latest releases if a peer discovery attempt fail, it will be retried up to a certain number
of times with a delay between each attempt. This is similar to the peer sync retries nodes
perform <a href="/rabbitmq-website/docs/4.0/clustering#restarting">when they come online after a restart</a>.</p>
<p>For example, with the <a href="#peer-discovery-k8s">Kubernetes peer discovery mechanism</a> this means that
Kubernetes API requests that list pods will be retried should they fail. With the AWS mechanism,
EC2 API requests are retried, and so on.</p>
<p>Such retries by no means handle every possible failure scenario but they improve the resilience
of peer discovery and thus cluster and node deployments in practice. However, if clustered
nodes <a href="/rabbitmq-website/docs/4.0/clustering#erlang-cookie">fail to authenticate</a> with each other, retries
will simply merely the inevitable failure of cluster formation.</p>
<p>Nodes that fail to perform peer discovery will <a href="/rabbitmq-website/docs/4.0/logging">log</a> their remaining recovery attempts:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-27 06:35:36.426 [error] &lt;0.277.0&gt; Trying to join discovered peers failed. Will retry after a delay of 500 ms, 4 retries left...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-27 06:35:36.928 [warning] &lt;0.277.0&gt; Could not auto-cluster with node rabbit@hostname2: {badrpc,nodedown}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-27 06:35:36.930 [warning] &lt;0.277.0&gt; Could not auto-cluster with node rabbit@hostname3: {badrpc,nodedown}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-27 06:35:36.930 [error] &lt;0.277.0&gt; Trying to join discovered peers failed. Will retry after a delay of 500 ms, 3 retries left...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-27 06:35:37.432 [warning] &lt;0.277.0&gt; Could not auto-cluster with node rabbit@hostname2: {badrpc,nodedown}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-27 06:35:37.434 [warning] &lt;0.277.0&gt; Could not auto-cluster with node rabbit@hostname3: {badrpc,nodedown}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If a node fails to perform peer discovery and exhausts all retries, <a href="/rabbitmq-website/docs/4.0/logging#debug-logging">enable debug logging</a> is highly recommended for <a href="#troubleshooting">troubleshooting</a>.</p>
<p>The number of retries and the delay can be configured:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># These are the default values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Retry peer discovery operations up to ten times</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.discovery_retry_limit = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 500 milliseconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.discovery_retry_interval = 500</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The defaults cover five seconds of unavailability of services, API endpoints or nodes
involved in peer discovery. These values are sufficient to cover sporadic failures.
They will require increasing in environments where dependent services (DNS, etcd, Consul, etc)
may be provisioned concurrently with RabbitMQ cluster deployment and thus can become
available only after a period of time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="http-proxy-settings">HTTP Proxy Settings<a href="#http-proxy-settings" class="hash-link" aria-label="Direct link to HTTP Proxy Settings" title="Direct link to HTTP Proxy Settings">​</a></h2>
<p>Peer discovery mechanisms that use HTTP to interact with its dependencies (e.g. AWS, Consul
and etcd ones) can proxy their requests using an HTTP proxy.</p>
<p>There are separate proxy settings for HTTP and HTTPS:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># example HTTP and HTTPS proxy servers, values in your environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># will vary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.proxy.http_proxy = 192.168.0.98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.proxy.https_proxy = 192.168.0.98</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Some hosts can be excluded from proxying, e.g. the link-local AWS instance metadata
IP address:</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># example HTTP and HTTPS proxy servers, values in your environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># will vary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.proxy.http_proxy = 192.168.0.98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.proxy.https_proxy = 192.168.0.98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># requests to these hosts won&#x27;t go via proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.proxy.proxy_exclusions.1 = 169.254.169.254</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_formation.proxy.proxy_exclusions.2 = excluded.example.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">​</a></h2>
<p>The peer discovery subsystem and individual mechanism implementations log important
discovery procedure steps at the <code>info</code> log level. More extensive logging
is available at the <code>debug</code> level. Mechanisms that depend on external services
accessible over HTTP will log all outgoing HTTP requests and response codes at <code>debug</code> level.
See the <a href="/rabbitmq-website/docs/4.0/logging">logging guide</a> for more information about logging configuration.</p>
<p>If the log does not contain any entries that demonstrate peer discovery progress, for example, the list
of nodes retrieved by the mechanism or clustering attempts, it may mean that the node already has
an initialised data directory or is already a member of the cluster. In those cases peer discovery
won&#x27;t be performed.</p>
<p>Peer discovery relies on inter-node network connectivity and successful authentication via a shared
secret. Verifying that nodes can communicate with one another and use the expected Erlang cookie value (that&#x27;s also identical across all cluster nodes).
See the main <a href="/rabbitmq-website/docs/4.0/clustering">Clustering guide</a> for more information.</p>
<p>A methodology for network connectivity troubleshooting as well as commonly used
tools are covered in the <a href="/rabbitmq-website/docs/4.0/troubleshooting-networking">Troubleshooting Network Connectivity</a> guide.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/versioned_docs/version-4.0/cluster-formation.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/docs/4.0/clustering"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Clustering Guide</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/docs/4.0/partitions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Network Partitions</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#peer-discovery" class="table-of-contents__link toc-highlight">What is Peer Discovery?</a><ul><li><a href="#peer-discovery-plugins" class="table-of-contents__link toc-highlight">Available Discovery Mechanisms</a></li><li><a href="#peer-discovery-configuring-mechanism" class="table-of-contents__link toc-highlight">Specifying the Peer Discovery Mechanism</a></li><li><a href="#peer-discovery-how-does-it-work" class="table-of-contents__link toc-highlight">How Peer Discovery Works</a></li></ul></li><li><a href="#formation-and-availability" class="table-of-contents__link toc-highlight">Cluster Formation and Feature Availability</a></li><li><a href="#rejoining" class="table-of-contents__link toc-highlight">Nodes Rejoining Their Existing Cluster</a></li><li><a href="#configuring" class="table-of-contents__link toc-highlight">How to Configure Peer Discovery</a></li><li><a href="#peer-discovery-classic-config" class="table-of-contents__link toc-highlight">Config File Peer Discovery Backend</a><ul><li><a href="#config-file-peer-discovery-overview" class="table-of-contents__link toc-highlight">Config File Peer Discovery Overview</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li></ul></li><li><a href="#peer-discovery-dns" class="table-of-contents__link toc-highlight">DNS Peer Discovery Backend</a><ul><li><a href="#dns-peer-discovery-overview" class="table-of-contents__link toc-highlight">DNS Peer Discovery Overview</a></li><li><a href="#configuration-1" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#host-file-modifications-in-containerized-environments" class="table-of-contents__link toc-highlight">Host File Modifications in Containerized Environments</a></li></ul></li><li><a href="#peer-discovery-aws" class="table-of-contents__link toc-highlight">Peer Discovery on AWS (EC2)</a><ul><li><a href="#aws-peer-discovery-overview" class="table-of-contents__link toc-highlight">AWS Peer Discovery Overview</a></li><li><a href="#peer-discovery-aws-credentials" class="table-of-contents__link toc-highlight">Configuration and Credentials</a></li><li><a href="#peer-discovery-aws-autoscaling-group-membership" class="table-of-contents__link toc-highlight">Using Autoscaling Group Membership</a></li><li><a href="#peer-discovery-aws-tags" class="table-of-contents__link toc-highlight">Using EC2 Instance Tags</a></li><li><a href="#peer-discovery-aws-other-settings" class="table-of-contents__link toc-highlight">Using Private EC2 Instance IPs</a></li></ul></li><li><a href="#peer-discovery-k8s" class="table-of-contents__link toc-highlight">Peer Discovery on Kubernetes</a><ul><li><a href="#kubernetes-peer-discovery-overview" class="table-of-contents__link toc-highlight">Kubernetes Peer Discovery Overview</a></li><li><a href="#important-prerequisites-and-deployment-considerations" class="table-of-contents__link toc-highlight">Important: Prerequisites and Deployment Considerations</a></li><li><a href="#examples" class="table-of-contents__link toc-highlight">Examples</a></li><li><a href="#configuration-2" class="table-of-contents__link toc-highlight">Configuration</a></li></ul></li><li><a href="#peer-discovery-consul" class="table-of-contents__link toc-highlight">Peer Discovery Using Consul</a><ul><li><a href="#consul-peer-discovery-overview" class="table-of-contents__link toc-highlight">Consul Peer Discovery Overview</a></li><li><a href="#configuration-3" class="table-of-contents__link toc-highlight">Configuration</a></li></ul></li><li><a href="#peer-discovery-etcd" class="table-of-contents__link toc-highlight">Peer Discovery Using Etcd</a><ul><li><a href="#etcd-peer-discovery-overview" class="table-of-contents__link toc-highlight">Etcd Peer Discovery Overview</a></li><li><a href="#configuration-4" class="table-of-contents__link toc-highlight">Configuration</a></li></ul></li><li><a href="#initial-formation-race-condition" class="table-of-contents__link toc-highlight">Race Conditions During Initial Cluster Formation</a></li><li><a href="#node-health-checks-and-cleanup" class="table-of-contents__link toc-highlight">Node Health Checks and Forced Removal</a><ul><li><a href="#negative-side-effects-of-automatic-removal" class="table-of-contents__link toc-highlight">Negative Side Effects of Automatic Removal</a></li></ul></li><li><a href="#discovery-retries" class="table-of-contents__link toc-highlight">Peer Discovery Failures and Retries</a></li><li><a href="#http-proxy-settings" class="table-of-contents__link toc-highlight">HTTP Proxy Settings</a></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>
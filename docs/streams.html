<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-4.1 docs-doc-page docs-doc-id-streams" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Streams and Superstreams (Partitioned Streams) | RabbitMQ</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" name="twitter:image" content="https://www.rabbitmq.com/rabbitmq-website/img/rabbitmq-social-media-card.svg"><meta data-rh="true" property="og:url" content="https://www.rabbitmq.com/rabbitmq-website/docs/streams"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="4.1"><meta data-rh="true" name="docusaurus_tag" content="docs-default-4.1"><meta data-rh="true" name="docsearch:version" content="4.1"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-4.1"><meta data-rh="true" property="og:title" content="Streams and Superstreams (Partitioned Streams) | RabbitMQ"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/rabbitmq-website/img/rabbitmq-logo.svg"><link data-rh="true" rel="canonical" href="https://www.rabbitmq.com/rabbitmq-website/docs/streams"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/streams" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.rabbitmq.com/rabbitmq-website/docs/streams" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://H10VQIW16Y-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rabbitmq-website/blog/rss.xml" title="RabbitMQ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/rabbitmq-website/blog/atom.xml" title="RabbitMQ Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="RabbitMQ" href="/rabbitmq-website/opensearch.xml">







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,700">
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-domain-script="018ee308-473e-754f-b0c2-cbe82d25512f"></script>
<script>function OptanonWrapper(){}</script>
<script>function setGTM(e,t,o,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var i=t.getElementsByTagName(o)[0],a=t.createElement(o),s="dataLayer"!=n?"&l="+n:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+r+s,i.parentNode.insertBefore(a,i)}var timer;function waitForOnetrustActiveGroups(){document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?(clearTimeout(timer),setGTM(window,document,"script","dataLayer","GTM-TT84L8K")):timer=setTimeout(waitForOnetrustActiveGroups,250)}document.cookie.indexOf("OptanonConsent")>-1&&document.cookie.indexOf("groups=")>-1?setGTM(window,document,"script","dataLayer","GTM-TT84L8K"):waitForOnetrustActiveGroups()</script><link rel="stylesheet" href="/rabbitmq-website/styles.css">
<script src="/rabbitmq-website/runtime~main.js" defer="defer"></script>
<script src="/rabbitmq-website/main.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:var(--ifm-color-primary-contrast-background);color:var(--ifm-font-color-base)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><strong style="font-size: var(--ifm-h4-font-size);"><a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v4.1.0">RabbitMQ 4.1.0 is out</a></strong></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rabbitmq-website/"><div class="navbar__logo"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/rabbitmq-website/img/rabbitmq-logo-with-name.svg" alt="RabbitMQ" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/rabbitmq-website/tutorials">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/rabbitmq-website/docs">Docs</a><a class="navbar__item navbar__link" href="/rabbitmq-website/blog">Blog</a><a class="navbar__item navbar__link" href="/rabbitmq-website/contact">Support</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/rabbitmq-website/docs/streams">4.1</a><ul class="dropdown__menu"><li class=""><strong>Release series</strong></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/next/streams">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/rabbitmq-website/docs/streams">4.1</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/4.0/streams">4.0</a></li><li><a class="dropdown__link" href="/rabbitmq-website/docs/3.13/streams">3.13</a></li><li><a href="https://v3-12.rabbitmq.com/documentation.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.12<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/rabbitmq-website/release-information">Release Information</a></li></ul></div><a href="https://github.com/rabbitmq/rabbitmq-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/docs">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/release-information">Release Information</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/download">Install and Upgrade</a><button aria-label="Expand sidebar category &#x27;Install and Upgrade&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/rabbitmq-website/docs/use-rabbitmq">How to Use RabbitMQ</a><button aria-label="Collapse sidebar category &#x27;How to Use RabbitMQ&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/publishers">Publishing Messages</a><button aria-label="Expand sidebar category &#x27;Publishing Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/exchanges">Exchanges</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/consumers">Consuming Messages</a><button aria-label="Expand sidebar category &#x27;Consuming Messages&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/queues">Queues</a><button aria-label="Expand sidebar category &#x27;Queues&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rabbitmq-website/docs/streams">Streams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/channels">Channels</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/reliability">Reliability and Data Safety</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/confirms">Consumer Acknowledgements and Publisher Confirms</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/docs/distributed">Network Distribution</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/plugins">Plugins</a><button aria-label="Expand sidebar category &#x27;Plugins&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/rabbitmq-website/docs/protocols">Protocols</a><button aria-label="Expand sidebar category &#x27;Protocols&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rabbitmq-website/client-libraries">Client Libraries</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/manage-rabbitmq">How to Manage RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Manage RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/rabbitmq-website/docs/monitoring">How to Monitor RabbitMQ</a><button aria-label="Expand sidebar category &#x27;How to Monitor RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/rabbitmq-website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/rabbitmq-website/docs/use-rabbitmq"><span itemprop="name">How to Use RabbitMQ</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Streams</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 4.1</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Streams and Superstreams (Partitioned Streams)</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">What is a Stream<a href="#overview" class="hash-link" aria-label="Direct link to What is a Stream" title="Direct link to What is a Stream">​</a></h2>
<p>RabbitMQ Streams is a persistent replicated data structure that can complete the same tasks as queues: they buffer messages from producers that are read by consumers.
However, streams differ from queues in two important ways: how messages are stored and consumed.</p>
<p>Streams model an append-only log of messages that can be repeatedly read until they expire.
Streams are always persistent and replicated. A more technical description of this stream behavior is “non-destructive consumer semantics”.</p>
<p>To read messages from a stream in RabbitMQ, one or more consumers subscribe to it and read the same messages as many times as they want.</p>
<p>Data in a stream can be used via a RabbitMQ client library or through a
<a href="https://github.com/rabbitmq/rabbitmq-server/blob/main/deps/rabbitmq_stream/docs/PROTOCOL.adoc" target="_blank" rel="noopener noreferrer">dedicated binary protocol</a> plugin and associated client(s).
The latter option is <strong>highly recommended</strong> as it provides access to all stream-specific features and offers best possible throughput (performance).</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>In addition to streams, RabbitMQ supports partitioned streams called <a href="#super-streams">super streams</a>. They are covered
in more details further in this guide.</p></div></div>
<p>Now, you might be asking the following questions:</p>
<ul>
<li>Do streams replace queues then?</li>
<li>Should I move away from using queues?</li>
</ul>
<p>To answer these questions, streams were not introduced to replace queues but to complement them. Streams open up many opportunities for new RabbitMQ use cases which are described in <a href="#use-cases">Use Cases for Using Streams</a>.</p>
<p>The following information details streams usage, and the administration and maintenance operations for streams.</p>
<p>You should also review the <a href="/rabbitmq-website/docs/stream">stream plugin</a> information to learn more about the usage of streams with the binary RabbitMQ Stream protocol and the <a href="/rabbitmq-website/docs/stream-core-plugin-comparison">stream core and stream plugin comparison page</a> for the feature matrix.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-cases">Use Cases for Using Streams<a href="#use-cases" class="hash-link" aria-label="Direct link to Use Cases for Using Streams" title="Direct link to Use Cases for Using Streams">​</a></h3>
<p>Streams were developed to initially cover 4 messaging use-cases that
existing queue types either can not provide or provide with downsides:</p>
<ol>
<li>
<p>Large fan-outs</p>
<p>When wanting to deliver the same message to multiple subscribers users currently
have to bind a dedicated queue for each consumer. If the number of consumers is
large this becomes potentially inefficient, especially when wanting persistence
and/or replication. Streams will allow any number of consumers to consume
the same messages from the same queue in a non-destructive manner, negating the need
to bind multiple queues. Stream consumers will also be able to read from replicas
allowing read load to be spread across the cluster.</p>
</li>
<li>
<p>Replay (Time-travelling)</p>
<p>As all current RabbitMQ queue types have destructive consume behaviour, i.e. messages
are deleted from the queue when a consumer is finished with them, it is not
possible to re-read messages that have been consumed. Streams will allow
consumers to attach at any point in the log and read from there.</p>
</li>
<li>
<p>Throughput Performance</p>
<p>No persistent queue types are able to deliver throughput that can compete with
any of the existing log based messaging systems. Streams have been designed
with performance as a major goal.</p>
</li>
<li>
<p>Large backlogs</p>
<p>Most RabbitMQ queues are designed to converge towards the empty state and are
optimised as such and can perform worse when there are millions of messages on a
given queue. Streams are designed to store larger amounts of data in an
efficient manner with minimal in-memory overhead.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="usage">How to Use RabbitMQ Streams<a href="#usage" class="hash-link" aria-label="Direct link to How to Use RabbitMQ Streams" title="Direct link to How to Use RabbitMQ Streams">​</a></h2>
<p>An AMQP 0.9.1 client library that can specify <a href="/rabbitmq-website/docs/queues#optional-arguments">optional queue and consumer arguments</a>
will be able to use streams as regular AMQP 0.9.1 queues.</p>
<p>Just like queues, streams have to be declared first.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="declaring">Declaring a RabbitMQ Stream<a href="#declaring" class="hash-link" aria-label="Direct link to Declaring a RabbitMQ Stream" title="Direct link to Declaring a RabbitMQ Stream">​</a></h3>
<p>To declare a stream, set the <code>x-queue-type</code> queue argument to <code>stream</code>
(the default is <code>classic</code>). This argument must be provided by a client
at declaration time; it cannot be set or changed using a <a href="/rabbitmq-website/docs/policies">policy</a>.
This is because policy definition or applicable policy can be changed dynamically but
queue type cannot. It must be specified at the time of declaration.</p>
<p>The following snippet shows how to create a stream with the <a href="/rabbitmq-website/client-libraries/java-api-guide">AMQP 0.9.1 Java client</a>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ConnectionFactory</span><span class="token plain"> factory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConnectionFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Connection</span><span class="token plain"> connection </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Channel</span><span class="token plain"> channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queueDeclare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;my-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// durable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// not exclusive, not auto-delete</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-queue-type&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;stream&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Declaring a queue with an <code>x-queue-type</code> argument set to <code>stream</code> will create a stream
with a replica on each configured RabbitMQ node. Streams are quorum systems
so uneven cluster sizes is strongly recommended.</p>
<p>A stream remains an AMQP 0.9.1 queue, so it can be bound to any exchange after its creation,
just as any other RabbitMQ queue.</p>
<p>If declaring using <a href="/rabbitmq-website/docs/management">management UI</a>, the <code>stream</code> type must be specified using
the queue type drop down menu.</p>
<p>Streams support additional <a href="/rabbitmq-website/docs/queues#optional-arguments">queue arguments</a>
that also can be configured using a <a href="/rabbitmq-website/docs/policies">policy</a></p>
<ul>
<li><code>x-max-length-bytes</code></li>
</ul>
<p>Sets the maximum size of the stream in bytes. See <a href="#retention">retention</a>. Default: not set.</p>
<ul>
<li><code>x-max-age</code></li>
</ul>
<p>Sets the maximum age of the stream. See <a href="#retention">retention</a>. Default: not set.</p>
<ul>
<li><code>x-stream-max-segment-size-bytes</code></li>
</ul>
<p>A stream is divided up into fixed size segment files on disk.
This setting controls the size in bytes of these.
Default: 500000000 bytes.</p>
<ul>
<li><code>x-stream-filter-size-bytes</code></li>
</ul>
<p>The size in bytes of the Bloom filter used for <a href="#filtering">filtering</a>.
The value must be between 16 and 255.
Default: 16 bytes.</p>
<p>While the <code>x-stream-max-segment-size-bytes</code> and <code>x-stream-filter-size-bytes</code> arguments can be configured via a policy, they will <em>only</em> be applied to the stream if the policy is set (exists) at stream declaration time.
If these arguments are changed for a matching but pre-existing stream they <strong>will not be changed</strong> even if the effective policy of the queue record may indicate it is.</p>
<p>Hence it is best to only configure these via queue arguments.</p>
<p>The following example in Java demonstrates how the argument can be set
at stream declaration time in application code:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> arguments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-queue-type&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;stream&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// maximum stream size: 20 GB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-max-length-bytes&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20_000_000_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// size of segment files: 100 MB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-stream-max-segment-size-bytes&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100_000_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// size of stream bloom filter: 32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-stream-filter-size-bytes&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queueDeclare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;my-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// durable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// not exclusive, not auto-delete</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  arguments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="client-operations">Client Operations<a href="#client-operations" class="hash-link" aria-label="Direct link to Client Operations" title="Direct link to Client Operations">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="consuming">Consuming<a href="#consuming" class="hash-link" aria-label="Direct link to Consuming" title="Direct link to Consuming">​</a></h4>
<p>As streams never delete any messages, any consumer can start reading/consuming
from any point in the log. This is controlled by the <code>x-stream-offset</code> consumer argument.
If it is unspecified the consumer will start reading from the next offset written
to the log after the consumer starts. The following values are supported:</p>
<ul>
<li><code>first</code> - start from the first available message in the log</li>
<li><code>last</code> - this starts reading from the last written &quot;chunk&quot; of messages <em>(a chunk
is the storage and transportation unit used in streams, put simply it is a batch
of messages made of several to a few thousands of messages, depending on the ingress)</em></li>
<li><code>next</code> - same as not specifying any offset</li>
<li>Offset - a numerical value specifying an exact offset to attach to the log at.
If this offset does not exist it will clamp to either the start or end of the log respectively.</li>
<li>Timestamp - a timestamp value specifying the point in time to attach to the log at.
It will clamp to the closest offset, if the timestamp is out of range for the stream it will clamp either the start or end of the log respectively.
With AMQP 0.9.1, the timestamp used is POSIX time with an accuracy of one second, that is the number of seconds since 00:00:00 UTC, 1970-01-01.
Be aware consumers can receive messages published a bit before the specified timestamp.</li>
<li>Interval - a string value specifying the time interval relative to current time to attach the log at. Uses the same specification as <code>x-max-age</code> (see <a href="#retention">Retention</a>)</li>
</ul>
<p>The following snippet shows how to use the <code>first</code> offset specification:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicQos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// QoS must be specified</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;my-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-stream-offset&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;first&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// &quot;first&quot; offset specification</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// message processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEnvelope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ack is required</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  consumerTag </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The following snippet shows how to specify a specific offset to consume from:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicQos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// QoS must be specified</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;my-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-stream-offset&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// offset value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// message processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEnvelope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ack is required</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  consumerTag </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The following snippet shows how to specify a specific timestamp to consume from:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// an hour ago</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Date</span><span class="token plain"> timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentTimeMillis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicQos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// QoS must be specified</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;my-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-stream-offset&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// timestamp offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// message processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEnvelope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ack is required</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  consumerTag </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="other-stream-operations">Other Stream Operations<a href="#other-stream-operations" class="hash-link" aria-label="Direct link to Other Stream Operations" title="Direct link to Other Stream Operations">​</a></h4>
<p>The following operations can be used in a similar way to classic and quorum queues
but some have some queue specific behaviour.</p>
<ul>
<li><a href="#declaring">Declaration</a></li>
<li>Queue deletion</li>
<li><a href="/rabbitmq-website/docs/confirms#publisher-confirms">Publisher confirms</a></li>
<li><a href="/rabbitmq-website/docs/consumers">Consumption</a> (subscription): consumption requires QoS
prefetch to be set. The acks works as a credit mechanism to advance the current
offset of the consumer.</li>
<li>Setting <a href="#global-qos">QoS prefetch</a> for consumers</li>
<li><a href="/rabbitmq-website/docs/confirms">Consumer acknowledgements</a> (keep <a href="#global-qos">QoS Prefetch Limitations</a> in mind)</li>
<li>Cancellation of consumers</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="single-active-consumer">Single Active Consumer Feature for Streams<a href="#single-active-consumer" class="hash-link" aria-label="Direct link to Single Active Consumer Feature for Streams" title="Direct link to Single Active Consumer Feature for Streams">​</a></h3>
<p>Single active consumer for streams is a feature available in RabbitMQ 3.11 and more.
It provides <em>exclusive consumption</em> and <em>consumption continuity</em> on a stream.
When several consumer instances sharing the same stream and name enable single active consumer, only one of these instances will be active at a time and so will receive messages.
The other instances will be idle.</p>
<p>The single active consumer feature provides 2 benefits:</p>
<ul>
<li>Messages are processed in order: there is only one consumer at a time.</li>
<li>Consumption continuity is maintained: a consumer from the group will take over if the active one stops or crashes.</li>
</ul>
<p>A <a href="/rabbitmq-website/blog/2022/07/05/rabbitmq-3-11-feature-preview-single-active-consumer-for-streams">blog post</a> provides more details on single active consumer for streams.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="super-streams">Super Streams<a href="#super-streams" class="hash-link" aria-label="Direct link to Super Streams" title="Direct link to Super Streams">​</a></h3>
<p>Super streams are a way to scale out by partitioning a large stream into smaller streams.
They integrate with <a href="#single-active-consumer">single active consumer</a> to preserve message order within a partition.
Super streams are available starting with RabbitMQ 3.11.</p>
<p>A super stream is a logical stream made of individual, regular streams.
It is a way to scale out publishing and consuming with RabbitMQ Streams: a large logical stream is divided into partition streams, splitting up the storage and the traffic on several cluster nodes.</p>
<p>A super stream remains a logical entity: applications see it as one “large” stream, thanks to the smartness of client libraries.
The topology of a super stream is based on the <a href="/rabbitmq-website/tutorials/amqp-concepts">AMQP 0.9.1 model</a>, that is exchange, queues, and bindings between them.</p>
<p>It is possible to create the topology of a super stream with any AMQP 0.9.1 library or with the <a href="/rabbitmq-website/docs/management">management plugin</a>, it requires to create a direct exchange, the &quot;partition&quot; streams, and bind them together.
It may be easier to use the <code>rabbitmq-streams add_super_stream</code> command though.
Here is how to use it to create an <code>invoices</code> super stream with 3 partitions:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-streams add_super_stream invoices </span><span class="token parameter variable" style="color:#36acaa">--partitions</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Use <code>rabbitmq-streams add_super_stream --help</code> to learn more about the command.</p>
<p>Super streams add complexity compared to individual streams, so they should not be considered the default solution for all use cases involving streams.
Consider using super streams only if you are sure you reached the limits of individual streams.</p>
<p>A <a href="/rabbitmq-website/blog/2022/07/13/rabbitmq-3-11-feature-preview-super-streams">blog post</a> provides an overview of super streams.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="filtering">Filtering<a href="#filtering" class="hash-link" aria-label="Direct link to Filtering" title="Direct link to Filtering">​</a></h3>
<p>RabbitMQ Stream provides a server-side filtering feature that avoids reading all the messages of a stream and filtering only on the client side.
This helps to save network bandwidth when a consuming application needs only a subset of messages, e.g. the messages from a given geographical region.</p>
<p>Stream filtering is supported with the <a href="/rabbitmq-website/docs/stream">stream protocol</a>, AMQP 0.9.1, and <a href="/rabbitmq-website/docs/stomp#stream-support">STOMP</a>.
Examples will be using AMQP 0.9.1.</p>
<p>A message must be published with an associated filter value for the filtering feature to work.
This value is specified with the <code>x-stream-filter-value</code> header:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicPublish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// default exchange</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;my-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AMQP</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">BasicProperties</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">headers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;x-stream-filter-value&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;california&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// set filter value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A consumer must use the <code>x-stream-filter</code> argument if it wants to receive only messages for a given filter value:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicQos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// QoS must be specified</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicConsume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;my-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-stream-filter&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;california&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// set filter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">consumerTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// there must be some client-side filter logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;california&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-stream-filter-value&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// message processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">basicAck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEnvelope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeliveryTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ack is required</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  consumerTag </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As shown in the snippet above, there must be some client-side filtering logic as well because server-side filtering is <em>probabilistic</em>: messages that do not match the filter value can still be sent to the consumer.
The server uses a <a href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="noopener noreferrer">Bloom filter</a>, a space-efficient probabilistic data structure, where false positives are possible.
Despite this, the filtering saves some bandwidth, which is its primary goal.</p>
<p>Additional notes on filtering:</p>
<ul>
<li>It is possible to publish messages with and without a filter value in the same stream.</li>
<li>Messages without a filter value are not sent when a filter is set by a consumer.
Set the <code>x-stream-match-unfiltered</code> argument to <code>true</code> to change this behavior and receive <em>unfiltered</em> messages as well.</li>
<li>The <code>x-stream-filter</code> consumer argument accepts a string but also an array of strings to receive messages for different filter values.</li>
</ul>
<p>A <a href="/rabbitmq-website/blog/2023/10/16/stream-filtering">first blog post</a> provides an overview of stream filtering and a <a href="/rabbitmq-website/blog/2023/10/24/stream-filtering-internals">second blog post</a> covers internals.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="feature-comparison">Feature Comparison: Regular Queues versus Streams<a href="#feature-comparison" class="hash-link" aria-label="Direct link to Feature Comparison: Regular Queues versus Streams" title="Direct link to Feature Comparison: Regular Queues versus Streams">​</a></h2>
<p>Streams are not really queues in the traditional sense and thus do not
align very closely with AMQP 0.9.1 queue semantics. Many features that other queue types
support are not supported and will never be due to the nature of the queue type.</p>
<p>An AMQP 0.9.1 client library that can use <a href="/rabbitmq-website/docs/queues">regular queues</a> will be able to use streams
as long as it uses consumer acknowledgements.</p>
<p>Many features will never be supported by streams due to their non-destructive
read semantics.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature-matrix">Feature Matrix<a href="#feature-matrix" class="hash-link" aria-label="Direct link to Feature Matrix" title="Direct link to Feature Matrix">​</a></h3>
<table><thead><tr><th style="text-align:left">Feature</th><th style="text-align:left">Classic</th><th>Stream</th></tr></thead><tbody><tr><td style="text-align:left"><a href="/rabbitmq-website/docs/queues">Non-durable queues</a></td><td style="text-align:left">yes</td><td>no</td></tr><tr><td style="text-align:left"><a href="/rabbitmq-website/docs/queues">Exclusivity</a></td><td style="text-align:left">yes</td><td>no</td></tr><tr><td style="text-align:left">Per message persistence</td><td style="text-align:left">per message</td><td>always</td></tr><tr><td style="text-align:left">Membership changes</td><td style="text-align:left">no</td><td>manual</td></tr><tr><td style="text-align:left"><a href="/rabbitmq-website/docs/ttl">TTL</a></td><td style="text-align:left">yes</td><td>no (but see <a href="#retention">Retention</a>)</td></tr><tr><td style="text-align:left"><a href="/rabbitmq-website/docs/maxlength">Queue length limits</a></td><td style="text-align:left">yes</td><td>no (but see <a href="#retention">Retention</a>)</td></tr><tr><td style="text-align:left">Keeps messages in memory</td><td style="text-align:left">see <a href="/rabbitmq-website/docs/classic-queues#memory">Classic Queues</a></td><td>never</td></tr><tr><td style="text-align:left"><a href="/rabbitmq-website/docs/priority">Message priority</a></td><td style="text-align:left">yes</td><td>no</td></tr><tr><td style="text-align:left"><a href="/rabbitmq-website/docs/consumer-priority">Consumer priority</a></td><td style="text-align:left">yes</td><td>no</td></tr><tr><td style="text-align:left"><a href="/rabbitmq-website/docs/dlx">Dead letter exchanges</a></td><td style="text-align:left">yes</td><td>no</td></tr><tr><td style="text-align:left">Adheres to <a href="/rabbitmq-website/docs/policies">policies</a></td><td style="text-align:left">yes</td><td>yes (see <a href="#retention">Retention</a>)</td></tr><tr><td style="text-align:left">Reacts to <a href="/rabbitmq-website/docs/alarms">memory alarms</a></td><td style="text-align:left">yes</td><td>no (uses minimal RAM)</td></tr><tr><td style="text-align:left">Poison message handling</td><td style="text-align:left">no</td><td>no</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-durable-queues">Non-durable Queues<a href="#non-durable-queues" class="hash-link" aria-label="Direct link to Non-durable Queues" title="Direct link to Non-durable Queues">​</a></h4>
<p>Streams are always durable per their assumed <a href="#use-cases">use cases</a>,
they cannot be <a href="/rabbitmq-website/docs/queues#properties">non-durable</a> like regular queues.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="exclusivity">Exclusivity<a href="#exclusivity" class="hash-link" aria-label="Direct link to Exclusivity" title="Direct link to Exclusivity">​</a></h4>
<p>Streams are always durable per their assumed <a href="#use-cases">use cases</a>, they cannot be
<a href="/rabbitmq-website/docs/queues#exclusive-queues">exclusive</a> like regular queues.
They are not meant to be used as <a href="/rabbitmq-website/docs/queues#temporary-queues">temporary queues</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="global-qos">Global QoS<a href="#global-qos" class="hash-link" aria-label="Direct link to Global QoS" title="Direct link to Global QoS">​</a></h4>
<p>Streams do not support global <a href="/rabbitmq-website/docs/confirms#channel-qos-prefetch">QoS prefetch</a> where a channel sets a single
prefetch limit for all consumers using that channel. If an attempt
is made to consume from a stream from a channel with global QoS enabled
a channel error will be returned.</p>
<p>Use <a href="/rabbitmq-website/docs/consumer-prefetch">per-consumer QoS prefetch</a>, which is the default in several popular clients.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="retention">Data Retention<a href="#retention" class="hash-link" aria-label="Direct link to Data Retention" title="Direct link to Data Retention">​</a></h2>
<p>Streams are implemented as an immutable append-only disk log. This means that
the log will grow indefinitely until the disk runs out. To avoid this undesirable
scenario it is possible to set a retention configuration per stream which will
discard the oldest data in the log based on total log data size and/or age.</p>
<p>There are two parameters that control the retention of a stream.
These can be combined.
These are either set at declaration time using a queue argument or as a policy which can be dynamically updated.
The policy takes precedence over queue arguments.</p>
<ul>
<li>
<p><code>max-age</code>:</p>
<p>valid units: Y, M, D, h, m, s</p>
<p>e.g. <code>7D</code> for a week</p>
</li>
<li>
<p><code>max-length-bytes</code>:</p>
<p>the max total size in bytes</p>
</li>
</ul>
<p>NB: retention is evaluated on per segment basis so there is one more parameter
that comes into effect and that is the segment size of the stream. The stream will
always leave at least one segment in place as long as the segment contains at least
one message.
When using broker-provided <a href="#offset-tracking">offset-tracking</a>, offsets for each consumer
are persisted in the stream itself as non-message data.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance Characteristics<a href="#performance" class="hash-link" aria-label="Direct link to Performance Characteristics" title="Direct link to Performance Characteristics">​</a></h2>
<p>As streams persist all data to disks before doing anything it is recommended
to use the fastest disks possible.</p>
<p>Due to the disk I/O-heavy nature of streams, their throughput decreases
as message sizes increase.</p>
<p>Just like quorum queues, streams are also affected by cluster sizes.
The more replicas a stream has, the lower its throughput generally will
be since more work has to be done to replicate data and achieve consensus.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="replication-factor">Controlling the Initial Replication Factor<a href="#replication-factor" class="hash-link" aria-label="Direct link to Controlling the Initial Replication Factor" title="Direct link to Controlling the Initial Replication Factor">​</a></h3>
<p>The <code>x-initial-cluster-size</code> queue argument controls how many rabbit nodes the initial
stream cluster should span.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="member-management">Managing Stream Replicas<a href="#member-management" class="hash-link" aria-label="Direct link to Managing Stream Replicas" title="Direct link to Managing Stream Replicas">​</a></h3>
<p>Replicas of a stream are explicitly managed by the operator. When a new node is added
to the cluster, it will host no stream replicas unless the operator explicitly adds it
to a replica set of a stream.</p>
<p>When a node has to be decommissioned (permanently removed from the cluster), it must be explicitly
removed from the replica list of all streams it currently hosts replicas for.</p>
<p>Two <a href="/rabbitmq-website/docs/cli">CLI commands</a> are provided to perform the above operations,
<code>rabbitmq-streams add_replica</code> and <code>rabbitmq-streams delete_replica</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-streams add_replica </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">vhost</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">stream-name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-streams delete_replica </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">vhost</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">stream-name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To successfully add and remove replicas the stream coordinator must be
available in the cluster.</p>
<p>Care needs to be taken not to accidentally make a stream unavailable by losing
the quorum whilst performing maintenance operations that involve membership changes.</p>
<p>Because the stream membership isn&#x27;t embedded in the stream itself adding a replica
cannot be made entirely safe at the current time. Hence if there at any time is an
out of sync replica another replica cannot be added and an error will be returned.</p>
<p>When replacing a cluster node, it is safer to first add a new node, wait for it
to become in-sync and then de-commission the node it replaces.</p>
<p>The replication status of a stream can be queried using the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-streams stream_status </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">vhost</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">stream-name</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In addition streams can be restarted using:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-streams restart_stream </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">vhost</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">stream-name</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="behaviour">Stream Behaviour<a href="#behaviour" class="hash-link" aria-label="Direct link to Stream Behaviour" title="Direct link to Stream Behaviour">​</a></h2>
<p>Every stream has a primary writer (the leader) and zero or more replicas.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="leader-election">Leader Election and Failure Handling<a href="#leader-election" class="hash-link" aria-label="Direct link to Leader Election and Failure Handling" title="Direct link to Leader Election and Failure Handling">​</a></h3>
<p>When a new stream is declared, the set of nodes that will host its
replicas is randomly picked, but will always include the node the client that declares the stream is connected to.</p>
<p>Which replica becomes the initial leader is controlled in three ways,
namely, using the <code>x-queue-leader-locator</code> <a href="/rabbitmq-website/docs/queues#optional-arguments">optional queue argument</a>, setting the <code>queue-leader-locator</code>
policy key or by defining the <code>queue_leader_locator</code>
key in <a href="/rabbitmq-website/docs/configure#configuration-files">the configuration file</a>. Here are the possible values:</p>
<ul>
<li><code>client-local</code>: Pick the node the client that declares the stream is connected to. This is the default value.</li>
<li><code>balanced</code>: If there are overall less than 1000 queues (classic queues, quorum queues, and streams),
pick the node hosting the minimum number of stream leaders.
If there are overall more than 1000 queues, pick a random node.</li>
</ul>
<p>A stream requires a quorum of the declared nodes to be available
to function. When a RabbitMQ node hosting a stream&#x27;s
<em>leader</em> fails or is stopped another node hosting one of that
stream&#x27;s <em>replica</em> will be elected leader and resume
operations.</p>
<p>Failed and rejoining replicas will re-synchronise (&quot;catch up&quot;) with the leader.
Similarly to quorum queues queues, a temporary replica failure
does not require a full re-synchronization from the currently elected leader. Only the delta
will be transferred if a re-joining replica is behind the leader. This &quot;catching up&quot; process
does not affect leader availability.</p>
<p>Replicas must be explicitly added.
When a new replica is <a href="#member-management">added</a>, it will synchronise the entire stream state
from the leader, similarly to newly added quorum queue replicas.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="quorum-requirements">Fault Tolerance and Minimum Number of Replicas Online<a href="#quorum-requirements" class="hash-link" aria-label="Direct link to Fault Tolerance and Minimum Number of Replicas Online" title="Direct link to Fault Tolerance and Minimum Number of Replicas Online">​</a></h3>
<p>Consensus systems can provide certain guarantees with regard to data safety.
These guarantees do mean that certain conditions need to be met before they
become relevant such as requiring a minimum of three cluster nodes to provide
fault tolerance and requiring more than half of members to be available to
work at all.</p>
<p>Failure tolerance characteristics of clusters of various size can be described
in a table:</p>
<table><thead><tr><th style="text-align:center">Cluster node count</th><th style="text-align:center">Tolerated number of node failures</th><th style="text-align:center">Tolerant to a network partition</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">not applicable</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">0</td><td style="text-align:center">no</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">1</td><td style="text-align:center">yes</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">1</td><td style="text-align:center">yes if a majority exists on one side</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">2</td><td style="text-align:center">yes</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">2</td><td style="text-align:center">yes if a majority exists on one side</td></tr><tr><td style="text-align:center">7</td><td style="text-align:center">3</td><td style="text-align:center">yes</td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">3</td><td style="text-align:center">yes if a majority exists on one side</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">4</td><td style="text-align:center">yes</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-safety">Data Safety when using Streams<a href="#data-safety" class="hash-link" aria-label="Direct link to Data Safety when using Streams" title="Direct link to Data Safety when using Streams">​</a></h3>
<p>Streams replicate data across multiple nodes and publisher confirms are only
issued once the data has been replicated to a quorum of stream replicas.</p>
<p>Streams always store data on disk, however, they do not explicitly flush (fsync)
the data from the operating system page cache to the underlying storage
medium, instead they rely on the operating system to do as and when required.
This means that an uncontrolled shutdown of a server could result in data loss
for replicas hosted on that node. Although theoretically this opens up the possibility
of confirmed data loss, the chances of this happening during normal operation is
very small and the loss of data on a single node would typically just be re-replicated
from the other nodes in the system.</p>
<p>If more data safety is required then consider using quorum queues instead as no
publisher confirms are issued until at least a quorum of nodes have both written <em>and</em>
flushed the data to disk.</p>
<p><em><em>No guarantees are provided for messages that have not been confirmed using
the publisher confirm mechanism</em></em>. Such messages could be lost &quot;mid-way&quot;, in an operating
system buffer or otherwise fail to reach the stream leader.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="availability">Stream Availability<a href="#availability" class="hash-link" aria-label="Direct link to Stream Availability" title="Direct link to Stream Availability">​</a></h3>
<p>A stream should be able to tolerate a minority of stream replicas becoming unavailable
with no or little effect on availability.</p>
<p>Note that depending on the <a href="/rabbitmq-website/docs/partitions">partition handling strategy</a>
used RabbitMQ may restart itself during recovery and reset the node but as long as that
does not happen, this availability guarantee should hold true.</p>
<p>For example, a stream with three replicas can tolerate one node failure without losing availability.
A stream with five replicas can tolerate two, and so on.</p>
<p>If a quorum of nodes cannot be recovered (say if 2 out of 3 RabbitMQ nodes are
permanently lost) the queue is permanently unavailable and
will most likely need operator involvement to be recovered.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuring Streams<a href="#configuration" class="hash-link" aria-label="Direct link to Configuring Streams" title="Direct link to Configuring Streams">​</a></h2>
<p>For stream protocol port, TLS and other configuration, see the <a href="/rabbitmq-website/docs/stream">Stream plugin guide</a>.
For required stream replication ports see the <a href="/rabbitmq-website/docs/networking#ports">Networking guide</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resource-use">How Streams Use Resources<a href="#resource-use" class="hash-link" aria-label="Direct link to How Streams Use Resources" title="Direct link to How Streams Use Resources">​</a></h2>
<p>Streams usually will have lower CPU and memory footprint than quorum queues.</p>
<p>All data is stored on disk with only unwritten data stored in memory.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="offset-tracking">Offset Tracking when using Streams<a href="#offset-tracking" class="hash-link" aria-label="Direct link to Offset Tracking when using Streams" title="Direct link to Offset Tracking when using Streams">​</a></h2>
<p>When using the broker provided offset tracking features (currently only available
when using the <a href="/rabbitmq-website/docs/stream">Stream plugin</a>) offsets are persisted in the stream
itself as non-message data. This means that as offset persistence is requested the
stream will grow on disk by some small amount per offset persistence request.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="limitations-message-encoding">Message Encoding<a href="#limitations-message-encoding" class="hash-link" aria-label="Direct link to Message Encoding" title="Direct link to Message Encoding">​</a></h3>
<p>Streams internally store their messages as AMQP 1.0 encoded data. This means when
publishing using AMQP 0.9.1 a conversion takes place. Although the AMQP 1.0 data
model is mostly capable of containing all of AMQP 0.9.1&#x27;s data model there are some
limitations. If an AMQP 0.9.1 message contains header entries with complex values
such as arrays or tables these headers will not be converted.
That is because headers are stored as application properties inside the AMQP 1.0 message and these can only
contain values of simple types, such as strings and numbers.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="limitations-ui-metrics">UI Metric Accuracy<a href="#limitations-ui-metrics" class="hash-link" aria-label="Direct link to UI Metric Accuracy" title="Direct link to UI Metric Accuracy">​</a></h3>
<p>Management UI can show a message count that slightly exceeds the actual count in the stream.
Due to the way stream storage is implemented, offset tracking information is also counted as messages, making the message count artificially larger than it is.
This should make no practical difference in most systems.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rabbitmq/rabbitmq-website/tree/main/versioned_docs/version-4.1/streams.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rabbitmq-website/docs/priority"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Priority Queues</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rabbitmq-website/docs/channels"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Channels</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">What is a Stream</a><ul><li><a href="#use-cases" class="table-of-contents__link toc-highlight">Use Cases for Using Streams</a></li></ul></li><li><a href="#usage" class="table-of-contents__link toc-highlight">How to Use RabbitMQ Streams</a><ul><li><a href="#declaring" class="table-of-contents__link toc-highlight">Declaring a RabbitMQ Stream</a></li><li><a href="#client-operations" class="table-of-contents__link toc-highlight">Client Operations</a></li><li><a href="#single-active-consumer" class="table-of-contents__link toc-highlight">Single Active Consumer Feature for Streams</a></li><li><a href="#super-streams" class="table-of-contents__link toc-highlight">Super Streams</a></li><li><a href="#filtering" class="table-of-contents__link toc-highlight">Filtering</a></li></ul></li><li><a href="#feature-comparison" class="table-of-contents__link toc-highlight">Feature Comparison: Regular Queues versus Streams</a><ul><li><a href="#feature-matrix" class="table-of-contents__link toc-highlight">Feature Matrix</a></li></ul></li><li><a href="#retention" class="table-of-contents__link toc-highlight">Data Retention</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance Characteristics</a><ul><li><a href="#replication-factor" class="table-of-contents__link toc-highlight">Controlling the Initial Replication Factor</a></li><li><a href="#member-management" class="table-of-contents__link toc-highlight">Managing Stream Replicas</a></li></ul></li><li><a href="#behaviour" class="table-of-contents__link toc-highlight">Stream Behaviour</a><ul><li><a href="#leader-election" class="table-of-contents__link toc-highlight">Leader Election and Failure Handling</a></li><li><a href="#quorum-requirements" class="table-of-contents__link toc-highlight">Fault Tolerance and Minimum Number of Replicas Online</a></li><li><a href="#data-safety" class="table-of-contents__link toc-highlight">Data Safety when using Streams</a></li><li><a href="#availability" class="table-of-contents__link toc-highlight">Stream Availability</a></li></ul></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuring Streams</a></li><li><a href="#resource-use" class="table-of-contents__link toc-highlight">How Streams Use Resources</a></li><li><a href="#offset-tracking" class="table-of-contents__link toc-highlight">Offset Tracking when using Streams</a></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a><ul><li><a href="#limitations-message-encoding" class="table-of-contents__link toc-highlight">Message Encoding</a></li><li><a href="#limitations-ui-metrics" class="table-of-contents__link toc-highlight">UI Metric Accuracy</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn about RabbitMQ</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/tutorials">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Reach out to the RabbitMQ team</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rabbitmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/rabbitmq/rabbitmq-server/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact?utm_source=rmq_release-information_tableheader&amp;utm_medium=rmq_website&amp;utm_campaign=tanzu">Long Term Commercial Support</a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/contact">Contact Us</a></li><li class="footer__item"><a href="https://www.rabbitmq.com/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Broadcom</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://tanzu.vmware.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VMware Tanzu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/legal.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/rabbitmq-website/trademark-guidelines">Trademark Guidelines</a></li><li class="footer__item"><a href="https://www.vmware.com/help/privacy/california-privacy-rights.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Your California Privacy Rights<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item ot-sdk-show-settings">Cookie Settings</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2005-2025 Broadcom. All Rights Reserved. The term "Broadcom" refers to Broadcom Inc. and/or its subsidiaries.</div></div></div></footer></div>
</body>
</html>